<!-- FULD OG SAMLET FIL: Lager opt√¶lling ‚Äî HTML + CSS + JS (nummereret efter system B) -->
<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0078D4" />
<meta name="description" content="Lager opt√¶lling system til k√∏kken og lager - Scan stregkoder, administrer varelager og generer rapporter" />
<title>Lager opt√¶lling ‚Äî F√¶rdig version v4.14 (2026-01-06 10:43)</title>
<link rel="manifest" href="manifest.json" />
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%230078D4' rx='4'/%3E%3Cg transform='translate(200, 80)'%3E%3Cpath d='M -60 40 L -50 80 L 50 80 L 60 40 L 55 35 L -55 35 Z' fill='%23D4A574' stroke='%238B6F47' stroke-width='2'/%3E%3Cpath d='M -55 35 L -50 30 L 50 30 L 55 35 L 60 40 L -60 40 Z' fill='%23E8C9A0' stroke='%238B6F47' stroke-width='2'/%3E%3Ccircle cx='-30' cy='50' r='3' fill='%23F5E6D3' opacity='0.6'/%3E%3Ccircle cx='0' cy='55' r='2.5' fill='%23F5E6D3' opacity='0.6'/%3E%3Ccircle cx='25' cy='50' r='2' fill='%23F5E6D3' opacity='0.6'/%3E%3C/g%3E%3Ctext x='200' y='50' font-family='serif' font-size='32' font-weight='bold' fill='%23fff' text-anchor='middle'%3EK√òKKEN%3C/text%3E%3C/svg%3E" />
<!-- PWA: Tilf√∏j manifest link for at g√∏re det til en installable app -->

<!-- =========================
     [CSS 1..] STYLES (nummereret)
     ========================= -->
<style>
:root{ --green:#0078D4; --accent:#E3F2FD; --bg:#f9f9f9; --muted:#f6f6f6; --danger:#e74c3c; --mono:"Segoe UI", Roboto, Arial, sans-serif; }
*{box-sizing:border-box}
body{font-family:var(--mono); margin:0; background:var(--bg); color:#222;-webkit-font-smoothing:antialiased}
header{background:var(--green); color:#fff; padding:12px 20px; display:flex; gap:16px; align-items:center; flex-wrap:wrap; border-bottom:4px solid rgba(0,0,0,0.03)}
/* [CSS 2] Logo */
header .logo-wrap{display:flex;align-items:center;gap:16px}
.logo-svg{height:120px; width:120px; border-radius:8px; background:#fff; padding:8px; box-shadow:0 4px 12px rgba(0,0,0,0.15); filter:drop-shadow(0 2px 8px rgba(0,120,212,0.3))}
header h1{margin:0;font-size:20px;font-weight:800}
header p{margin:4px 0 0 0;font-size:13px;font-weight:600;opacity:0.95}
.header-controls{min-width:220px;display:flex;gap:8px;align-items:center}

/* [CSS 3] Navigation */
nav{background:#eee;padding:10px 18px;display:flex;gap:12px;flex-wrap:wrap;border-bottom:1px solid #e6e6e6}
nav .menu-item{cursor:pointer;padding:8px 12px;border-radius:8px;font-weight:700;color:#333}
nav .menu-item.active{background:var(--accent);border:1px solid #93c5fd}

/* [CSS 4] Layout */
#content{padding:18px}
.page{display:block}
.hidden{display:none !important}
.card{background:#fff;padding:12px;border-radius:8px;border:1px solid #e6e6e6}
.section-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
.small{font-size:13px;color:#666}
input,select,textarea{padding:8px;border-radius:8px;border:1px solid #ddd;width:100%;font-size:14px}
button{padding:8px 10px;border-radius:8px;background:var(--green);color:white;border:1px solid rgba(0,0,0,0.06);cursor:pointer;font-weight:700}
button.secondary{background:white;color:#333;border:1px solid #ccc}
button.small{padding:6px 8px;font-size:13px}

/* [CSS 5] Tables */
table{width:100%;border-collapse:collapse;margin-top:12px}
table th,table td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:middle}
table th{background:#fafafa;font-weight:800}

/* [CSS 6] Autocomplete */
.autocomplete-wrapper{position:relative}
.autocomplete-list{position:absolute;left:0;right:0;top:100%;background:white;border:1px solid #ddd;max-height:220px;overflow:auto;z-index:60;border-radius:6px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.autocomplete-item{padding:8px 10px;cursor:pointer}
.autocomplete-item:hover{background:#f6f6f6}

/* [CSS 7] Session indicator */
.session-indicator{display:inline-block;padding:6px 10px;border-radius:8px;background:#fff8e6;color:#6a4f00;border:1px solid #f0d38a;font-weight:700}

/* [CSS 8] Modal */
.modal-backdrop{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1000}
.modal{background:white;border-radius:10px;padding:16px;width:92%;max-width:880px;max-height:86vh;overflow:auto;box-shadow:0 12px 40px rgba(0,0,0,0.25)}
.modal h3{margin-top:0}
.modal .actions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px}
.modal-backdrop.hidden{display:none !important}
#scannerModal .modal{max-width:95vw;width:600px;overflow:visible}
#scannerVideo{max-height:70vh;object-fit:contain;width:100%}
@media (max-width:768px){
  #scannerModal .modal{width:98vw;padding:16px}
  #scannerVideo{max-height:60vh}
}

/* [CSS 9] Labels */
.label-container{display:flex;flex-direction:column;margin-top:15px;gap:15mm;align-items:flex-start;padding-left:20mm}
.label{border:1px solid #000;display:flex;flex-direction:column;align-items:center;justify-content:center;margin:0;padding:8px;box-sizing:border-box;background:#fff;page-break-inside:avoid;break-inside:avoid;margin-bottom:15mm;text-align:center}

/* [CSS 10] Login Modal */
.login-backdrop{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:2000}
.login-modal{background:white;border-radius:12px;padding:24px;width:90%;max-width:400px;box-shadow:0 12px 40px rgba(0,0,0,0.3)}
.login-modal h2{margin-top:0;margin-bottom:16px;color:#333}
.login-modal label{display:block;margin-top:12px;margin-bottom:6px;font-weight:700;color:#555}
.login-modal input[type="password"],
.login-modal input[type="email"],
.login-modal input[type="text"]{width:100%;padding:10px;border:2px solid #ddd;border-radius:6px;font-size:16px;box-sizing:border-box}
.login-modal input[type="password"]:focus,
.login-modal input[type="email"]:focus,
.login-modal input[type="text"]:focus{outline:none;border-color:#0078D4}
.login-modal .error{color:#e74c3c;font-size:13px;margin-top:6px;display:none}
.login-modal .actions{margin-top:20px;display:flex;gap:10px;justify-content:flex-end}
.login-backdrop.hidden{display:none !important}
body.login-active header,
body.login-active nav,
body.login-active #content{display:none}

/* [CSS 11] Number Pad */
.number-pad-btn:hover{
  background:#E3F2FD !important;
  border-color:#005A9E !important;
  transform:scale(1.05);
  box-shadow:0 4px 8px rgba(0,0,0,0.15) !important;
}
.number-pad-btn:active{
  transform:scale(0.98);
  box-shadow:0 1px 2px rgba(0,0,0,0.1) !important;
}
#finishSessionBtnNumberPad:hover:not(:disabled){
  background:#F57C00 !important;
  box-shadow:0 4px 8px rgba(0,0,0,0.25) !important;
}
#finishSessionBtnNumberPad:disabled{
  background:#ccc !important;
  cursor:not-allowed !important;
  opacity:0.6;
}

/* [CSS 12] Misc */
@media print{
  nav,button,input,select{display:none !important} 
  body{background:white;margin:0;padding:0}
  .label-container{display:flex;flex-direction:column;gap:20mm;margin:0;padding:10mm;padding-left:30mm;align-items:flex-start}
  .label{margin-bottom:20mm !important;margin-right:0;margin-top:0;page-break-after:auto;break-after:auto;page-break-inside:avoid;break-inside:avoid;text-align:center}
  .label:not(:last-child){margin-bottom:20mm !important}
  @page{margin:10mm}
}
a{color:#0078D4;text-decoration:underline;cursor:pointer}
a:hover{color:#45a049;text-decoration:none}

/* [CSS 13] Ops√¶tning Sidebar (Word-style) */
.settings-page{display:flex;gap:0;max-width:1400px;margin:0 auto;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.settings-sidebar{width:280px;background:#f8f9fa;border-right:1px solid #e0e0e0;padding:0;min-height:600px;border-radius:8px 0 0 8px;transition:width 0.3s ease, opacity 0.3s ease;position:relative;overflow:hidden}
.settings-sidebar.collapsed{width:0;opacity:0}
.settings-sidebar-toggle{width:30px;height:30px;background:var(--green);color:white;border:none;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;z-index:1000;box-shadow:0 2px 4px rgba(0,0,0,0.2);transition:all 0.3s ease;pointer-events:auto;position:absolute;top:10px;left:10px;visibility:visible !important;opacity:1 !important}
.settings-sidebar-toggle:hover{transform:scale(1.1)}
.settings-sidebar-toggle::after{font-size:16px;line-height:1;content:'‚óÄ'}
.settings-sidebar-toggle[data-state="closed"]::after{content:'‚ñ∂'}
.settings-sidebar-toggle[data-state="open"]::after{content:'‚óÄ'}
#reportsSidebar.collapsed ~ .settings-content .settings-sidebar-toggle::after{content:'‚ñ∂'}
#masterSidebar.collapsed ~ .settings-content .settings-sidebar-toggle::after{content:'‚ñ∂'}
#settingsSidebar.collapsed ~ .settings-content .settings-sidebar-toggle::after{content:'‚ñ∂'}
#reportsSidebar:not(.collapsed) ~ .settings-content .settings-sidebar-toggle::after{content:'‚óÄ'}
#masterSidebar:not(.collapsed) ~ .settings-content .settings-sidebar-toggle::after{content:'‚óÄ'}
#settingsSidebar:not(.collapsed) ~ .settings-content .settings-sidebar-toggle::after{content:'‚óÄ'}
.settings-sidebar .settings-category{padding:16px 20px;font-size:11px;font-weight:700;color:#666;text-transform:uppercase;letter-spacing:0.8px;border-bottom:1px solid #e0e0e0;background:#f0f0f0;display:flex;align-items:center;justify-content:space-between}
.settings-sidebar .settings-item{display:flex;align-items:center;gap:12px;padding:12px 20px;cursor:pointer;border-bottom:1px solid #f0f0f0;color:#333;font-size:14px;transition:all 0.15s;border-left:3px solid transparent}
.settings-sidebar .settings-item:hover{background:#f0f0f0}
.settings-sidebar .settings-item.active{background:#E3F2FD;border-left:3px solid var(--green);font-weight:600;color:#005A9E}
.settings-sidebar .settings-item-icon{font-size:20px;width:28px;text-align:center;flex-shrink:0}
.settings-content{flex:1;padding:32px 40px;background:#fff;border-radius:0 8px 8px 0;transition:margin-left 0.3s ease;position:relative}
.settings-content.sidebar-collapsed{margin-left:0}
.settings-content h2{margin-top:20px;margin-bottom:8px;font-size:28px;color:#333;font-weight:600}
.settings-content .settings-sidebar-toggle{position:absolute;top:10px;left:10px}
.settings-content .settings-description{margin-bottom:32px;color:#666;font-size:14px;line-height:1.6}
.settings-section{display:none;animation:fadeIn 0.25s ease-in}
.settings-section.active{display:block}
.settings-option{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid #f0f0f0;transition:background 0.15s;border-radius:6px;margin-bottom:4px}
.settings-option:hover{background:#fafafa}
.settings-option-label{flex:1;min-width:0}
.settings-option-label h3{margin:0 0 6px 0;font-size:16px;font-weight:600;color:#333}
.settings-option-label p{margin:0;font-size:13px;color:#666;line-height:1.5}
.settings-option-action{flex-shrink:0;margin-left:24px}
.settings-option-action button{min-width:140px;padding:10px 16px;font-size:14px}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
@media (max-width:768px){
  .settings-page{flex-direction:column;max-width:100%}
  .settings-sidebar{width:100%;border-right:none;border-bottom:1px solid #e0e0e0;min-height:auto;border-radius:8px 8px 0 0}
  .settings-content{padding:24px;border-radius:0 0 8px 8px}
  .settings-option{flex-direction:column;align-items:flex-start;gap:12px}
  .settings-option-action{width:100%;margin-left:0}
  .settings-option-action button{width:100%}
}
</style>

<!-- ================================
     KODEBESKYTTELSE - Forhindrer visning af kildekode
     PLACERET I HEAD FOR AT VIRKE MED DET SAMME
     ================================ -->
<script>
(function(){
  'use strict';
  
  // Bloker h√∏jreklik - MEGET AGGRESSIV
  document.addEventListener('contextmenu', function(e){
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    return false;
  }, true);
  
  // Bloker alle keyboard shortcuts til kildekode
  document.addEventListener('keydown', function(e){
    // F12 (Developer Tools)
    if(e.keyCode === 123 || e.key === 'F12' || e.keyCode === 116){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      return false;
    }
    // Ctrl+Shift+I (Chrome DevTools)
    if((e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.key === 'I' || e.key === 'i'))){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      return false;
    }
    // Ctrl+Shift+J (Chrome Console)
    if((e.ctrlKey && e.shiftKey && (e.keyCode === 74 || e.key === 'J' || e.key === 'j'))){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      return false;
    }
    // Ctrl+U (View Source)
    if((e.ctrlKey && (e.keyCode === 85 || e.key === 'u' || e.key === 'U'))){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      return false;
    }
    // Ctrl+S (Save Page)
    if((e.ctrlKey && (e.keyCode === 83 || e.key === 's' || e.key === 'S')) && !e.shiftKey){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      return false;
    }
    // Ctrl+Shift+C (Element Inspector)
    if((e.ctrlKey && e.shiftKey && (e.keyCode === 67 || e.key === 'C' || e.key === 'c'))){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      return false;
    }
    // Ctrl+Shift+K (Firefox Console)
    if((e.ctrlKey && e.shiftKey && (e.keyCode === 75 || e.key === 'K' || e.key === 'k'))){
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      return false;
    }
  }, true);
  
  // Bloker drag and drop
  document.addEventListener('dragstart', function(e){
    e.preventDefault();
    e.stopPropagation();
    return false;
  }, true);
  
  // Bloker tekst markering (valgfrit)
  document.addEventListener('selectstart', function(e){
    // Tillad markering i input felter
    if(e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable)){
      return true;
    }
    e.preventDefault();
    e.stopPropagation();
    return false;
  }, true);
  
  // Bloker copy (valgfrit)
  document.addEventListener('copy', function(e){
    // Tillad copy i input felter
    if(e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable)){
      return true;
    }
    e.preventDefault();
    e.stopPropagation();
    return false;
  }, true);
  
  // Skjul console
  if(typeof console !== 'undefined'){
    console.log = function(){};
    console.warn = function(){};
    console.error = function(){};
    console.info = function(){};
    console.debug = function(){};
    console.table = function(){};
    console.dir = function(){};
    console.dirxml = function(){};
  }
  
  // Forhindre at Developer Tools √•bnes
  let devToolsOpen = false;
  setInterval(function(){
    const threshold = 160;
    if(window.outerHeight - window.innerHeight > threshold || window.outerWidth - window.innerWidth > threshold){
      if(!devToolsOpen){
        devToolsOpen = true;
        alert('‚ö†Ô∏è Developer Tools er ikke tilladt!\n\nLuk Developer Tools og opdater siden.');
      }
    } else {
      devToolsOpen = false;
    }
  }, 1000);
  
  // Bloker inspect element (h√∏jreklik ‚Üí Inspect)
  document.addEventListener('mousedown', function(e){
    if(e.button === 2){ // H√∏jre museknap
      e.preventDefault();
      e.stopPropagation();
      return false;
    }
  }, true);
  
  // Bloker h√∏jreklik p√• body n√•r den er klar
  function blockBodyContextMenu(){
    if(document.body){
      document.body.addEventListener('contextmenu', function(e){
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        return false;
      }, true);
    }
  }
  
  // Pr√∏v med det samme
  blockBodyContextMenu();
  
  // Vent ogs√• til body er klar (hvis den ikke er det endnu)
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', blockBodyContextMenu);
  } else {
    // Dokumentet er allerede indl√¶st
    blockBodyContextMenu();
  }
  
  // Bloker ogs√• p√• window
  window.addEventListener('contextmenu', function(e){
    e.preventDefault();
    e.stopPropagation();
    e.stopImmediatePropagation();
    return false;
  }, true);
  
})();
</script>

</head>
<body>

<!-- =========================
     [HTML 0] LOGIN MODAL
     ========================= -->
<div id="loginModal" class="login-backdrop">
  <div class="login-modal">
    <h2 id="loginTitle">Login</h2>
    <div id="loginError" class="error"></div>
    <div id="loginForm">
      <label for="loginUsername">Brugernavn</label>
      <input type="text" id="loginUsername" placeholder="Indtast brugernavn" autocomplete="username" />
      <label for="loginPassword">Password</label>
      <input type="password" id="loginPassword" placeholder="Indtast password" autocomplete="current-password" />
      <div style="margin-top:8px; text-align:right;">
        <a href="#" onclick="showForgotPassword(); return false;" style="font-size:13px; color:#0078D4;">Glemt password?</a>
      </div>
      <div class="actions">
        <button onclick="attemptLogin()">üîê Login</button>
      </div>
    </div>
    <div id="createPasswordForm" style="display:none">
      <div style="background:#fff3cd; border:2px solid #ffc107; border-radius:8px; padding:16px; margin-bottom:16px;">
        <h3 style="margin:0 0 8px 0; color:#856404;">‚ö†Ô∏è PR√òVEVERSION</h3>
        <p style="margin:0; color:#856404; font-size:13px; line-height:1.5;">
          <strong>Du bruger nu en 30-dages pr√∏veversion!</strong><br>
          Efter 30 dage skal du aktivere en fuld licens for at forts√¶tte.<br>
          Pr√∏veversionen har begr√¶nsninger: Max 50 varer, max 10 rapporter.
        </p>
      </div>
      <p style="margin-bottom:12px; color:#666; font-size:13px;">Opret din konto for at starte. Alle felter er p√•kr√¶vet.</p>
      <label for="userName">Dit navn <span style="color:#e74c3c;">*</span></label>
      <input type="text" id="userName" placeholder="Indtast dit navn" autocomplete="name" required />
      <label for="recoveryEmail">Email <span style="color:#e74c3c;">*</span></label>
      <input type="email" id="recoveryEmail" placeholder="din@email.dk" autocomplete="email" required />
      <p style="margin:4px 0 12px 0; color:#666; font-size:12px;">Email bruges til at nulstille password hvis du glemmer det.</p>
      <label for="newPassword">Opret password <span style="color:#e74c3c;">*</span></label>
      <input type="password" id="newPassword" placeholder="Indtast nyt password (min. 4 tegn)" autocomplete="new-password" required />
      <label for="confirmPassword">Bekr√¶ft password <span style="color:#e74c3c;">*</span></label>
      <input type="password" id="confirmPassword" placeholder="Bekr√¶ft password" autocomplete="new-password" required />
      <div class="actions">
        <button onclick="createPassword()">‚úÖ Opret konto og start pr√∏veversion</button>
      </div>
    </div>
    <div id="forgotPasswordForm" style="display:none">
      <p style="margin-bottom:16px; color:#666;">Indtast din recovery email for at nulstille password. <strong>Kun den email der blev oprettet f√∏rste gang kan bruges.</strong></p>
      <label for="forgotEmail">Recovery email</label>
      <input type="email" id="forgotEmail" placeholder="din@email.dk" autocomplete="email" />
      <div class="actions">
        <button onclick="resetPasswordViaEmail()">üìß Send nulstillingslink</button>
        <button class="secondary" onclick="showLoginForm()">‚¨ÖÔ∏è Tilbage</button>
      </div>
    </div>
    <div id="changePasswordForm" style="display:none">
      <label for="currentPassword">Nuv√¶rende password</label>
      <input type="password" id="currentPassword" placeholder="Indtast nuv√¶rende password" autocomplete="current-password" />
      <label for="changeNewPassword">Nyt password</label>
      <input type="password" id="changeNewPassword" placeholder="Indtast nyt password" autocomplete="new-password" />
      <label for="changeConfirmPassword">Bekr√¶ft nyt password</label>
      <input type="password" id="changeConfirmPassword" placeholder="Bekr√¶ft nyt password" autocomplete="new-password" />
      <hr style="margin:20px 0; border:none; border-top:1px solid #ddd;" />
      <p style="margin-bottom:12px; color:#666; font-size:13px;">Opdater recovery email (kun denne email kan bruges til at nulstille password)</p>
      <label for="changeRecoveryEmail">Ny recovery email</label>
      <input type="email" id="changeRecoveryEmail" placeholder="din@email.dk" autocomplete="email" />
      <div style="margin-top:8px; font-size:12px; color:#666;">
        <strong>Nuv√¶rende recovery email:</strong> <span id="currentRecoveryEmailDisplay">Ingen sat</span>
      </div>
      <div class="actions">
        <button onclick="changePassword()">üîë Skift password</button>
        <button class="secondary" onclick="closeChangePasswordModal()">‚ùå Annuller</button>
      </div>
    </div>
  </div>
</div>

<!-- =========================
     [HTML 1] HEADER + LOGO-UPLOAD
     ========================= -->
<header>
  <div class="logo-wrap">
    <!-- K√∏kken Lager Opt√¶lling Logo -->
    <div class="logo-svg" aria-hidden="true">
      <svg viewBox="0 0 400 300" xmlns="http://www.w3.org/2000/svg" style="height:100%;width:100%;">
        <!-- Hvid baggrund -->
        <rect width="400" height="300" fill="#fff" rx="4"></rect>
        
        <!-- S√¶k med mel/hvede -->
        <g transform="translate(200, 80)">
          <!-- S√¶k -->
          <path d="M -60 40 L -50 80 L 50 80 L 60 40 L 55 35 L -55 35 Z" fill="#D4A574" stroke="#8B6F47" stroke-width="2"></path>
          <!-- S√¶k foldet top -->
          <path d="M -55 35 L -50 30 L 50 30 L 55 35 L 60 40 L -60 40 Z" fill="#E8C9A0" stroke="#8B6F47" stroke-width="2"></path>
          <!-- Indhold i s√¶kken (granul√¶rt) -->
          <circle cx="-30" cy="50" r="3" fill="#F5E6D3" opacity="0.6"></circle>
          <circle cx="0" cy="55" r="2.5" fill="#F5E6D3" opacity="0.6"></circle>
          <circle cx="25" cy="50" r="2" fill="#F5E6D3" opacity="0.6"></circle>
          <circle cx="-15" cy="65" r="2.5" fill="#F5E6D3" opacity="0.6"></circle>
          <circle cx="15" cy="68" r="2" fill="#F5E6D3" opacity="0.6"></circle>
          
          <!-- Ske -->
          <g transform="translate(0, 50)">
            <rect x="-2" y="-15" width="4" height="20" fill="#8B6F47" rx="1"></rect>
            <ellipse cx="0" y="-18" rx="6" ry="3" fill="#8B6F47"></ellipse>
            <circle cx="0" y="-5" r="4" fill="#F5E6D3" opacity="0.8"></circle>
          </g>
        </g>
        
        <!-- "K√òKKEN" tekst over s√¶kken -->
        <text x="200" y="50" font-family="serif" font-size="32" font-weight="bold" fill="#8B6F47" text-anchor="middle">K√òKKEN</text>
        
        <!-- Banner med "Lager Opt√¶lling" -->
        <g transform="translate(200, 200)">
          <!-- Banner baggrund -->
          <rect x="-100" y="-25" width="200" height="50" fill="#fff" stroke="#8B6F47" stroke-width="3" rx="8"></rect>
          <!-- Dekorativ linje -->
          <line x1="-80" y1="0" x2="80" y2="0" stroke="#8B6F47" stroke-width="1.5" opacity="0.5"></line>
          <!-- "Lager" tekst -->
          <text x="0" y="-8" font-family="serif" font-size="24" font-weight="bold" fill="#8B6F47" text-anchor="middle">Lager</text>
          <!-- "Opt√¶lling" tekst -->
          <text x="0" y="15" font-family="serif" font-size="24" font-weight="bold" fill="#8B6F47" text-anchor="middle">Opt√¶lling</text>
        </g>
      </svg>
    </div>
  </div>

  <div style="flex:1;">
    <h1 id="firmaNavn" contenteditable="true">Inds√¶t dit firmanavn her</h1>
    <p id="tagline">Lager opt√¶lling ‚Äì Professionel lageropt√¶lling</p>
  </div>

  <div class="header-controls" style="display:flex; flex-direction:column; align-items:flex-end; gap:8px;">
    <div style="display:flex; gap:8px;">
    <button class="secondary" onclick="showPage('licens'); updateLicenseStatusDisplay();" style="background:rgba(255,255,255,0.2); color:#fff; border-color:rgba(255,255,255,0.3);">üîë Licens</button>
    <button class="secondary" onclick="logout()">üö™ Log ud</button>
    </div>
    <div id="versionDisplay" style="color:#fff; font-size:16px; font-weight:700; text-align:right; padding:8px 12px; background:rgba(255,255,255,0.25); border-radius:6px; border:1px solid rgba(255,255,255,0.35); box-shadow:0 4px 12px rgba(0,0,0,0.15); font-family:'Segoe UI', sans-serif; line-height:1.5;">v4.14<br><span style="font-size:12px; opacity:0.95; letter-spacing:0.2px;">2026-01-06 10:43</span></div>
  </div>
</header>

<!-- =========================
     [HTML 2] NAVIGATION
     ========================= -->
<nav id="topnav">
  <span class="menu-item active" data-target="lageropt" onclick="navClick(event)">üì¶ Lager opt√¶lling</span>
  <span class="menu-item" data-target="opsaetning" onclick="navClick(event)">‚öôÔ∏è Ops√¶tning Lager</span>
  <span class="menu-item" data-target="master" onclick="navClick(event)">üìã Varelager administration</span>
  <span class="menu-item" data-target="rapporter" onclick="navClick(event)">üìä Rapporter</span>
  <span class="menu-item" data-target="labels" onclick="navClick(event)">üè∑Ô∏è Labels</span>
  <span class="menu-item" data-target="leverandor" onclick="navClick(event)">üöö Leverand√∏rer</span>
  <span class="menu-item" data-target="systemOpsaetning" onclick="navClick(event)">‚öôÔ∏è Ops√¶tning</span>
  <span class="menu-item" data-target="vinlager" onclick="navClick(event)">üç∑ Vinlager</span>
</nav>

<!-- =========================
     [HTML 3] CONTENT (Alle sektioner)
     ========================= -->
<div id="content">

  <!-- [HTML 3.1] LAGER OPT√ÜLLING -->
  <section id="lageropt" class="page">
    <div class="section-row" style="align-items:center;">
      <div>
        <h2 style="margin:0">Lager opt√¶lling</h2>
        <div class="small">Scan eller tilf√∏j manuelt. Se opt√¶lling pr. lokation eller samlet.</div>
      </div>
      <div class="right">
        <button onclick="showPage('rapporter')">üìä √Öbn Rapporter</button>
      </div>
    </div>

    <div style="margin-top:14px; display:flex; gap:18px; align-items:flex-start; flex-wrap:wrap;">
      <div style="flex:1; min-width:340px;">

        <div class="section-row" style="margin-top:8px;">
          <button class="secondary" onclick="stopScanner()" id="stopScannerBtn" style="display:none;">‚èπÔ∏è Stop scanner</button>
        </div>

        <div style="margin-top:10px;">
          <button onclick="openStartModal()">‚ñ∂Ô∏è Start ny opt√¶lling</button>
          <button class="secondary" id="finishSessionBtn" onclick="openFinishModal()" disabled>‚úÖ Afslut opt√¶lling</button>
          <button class="secondary" id="cancelSessionBtn" onclick="cancelSession()" disabled style="background:#dc3545; color:white;">‚ùå Annuller opt√¶lling</button>
          <span id="sessionInfo" class="session-indicator hidden"></span>
        </div>

        <table>
          <thead><tr><th>Vare</th><th>M√•leenhed</th><th>Antal</th><th>Pris</th><th>Total</th></tr></thead>
          <tbody id="lagerTable"></tbody>
          <tfoot><tr><th colspan="4">Total</th><th id="totalLager">0 kr.</th></tr></tfoot>
        </table>
      </div>

      <div style="width:360px;">
        <div class="card" style="background:#E3F2FD;border:2px solid #0078D4;">
          <label><strong>S√∏g lokation:</strong></label>
          <div class="autocomplete-wrapper">
            <input type="text" id="lagerLokationSearch" placeholder="Skriv 'a' for alle lokationer, eller bogstaver for at s√∏ge..." autocomplete="off" style="font-size:16px;padding:12px;" />
            <div id="lagerLokationAutocomplete" class="autocomplete-list" style="display:none"></div>
          </div>
          <select id="lagerLokationSelect" style="display:none;" onchange="renderLagerTable(); updateSearchFilter();"></select>
          <p class="small" style="margin-top:4px;color:#005A9E;">üí° Skriv 'a' for alle lokationer, eller bogstaver for at s√∏ge (fx 'f' for Frost)</p>
          
          <label style="margin-top:12px;"><strong>S√∏g vare (varenavn eller stregkode):</strong></label>
          <div class="autocomplete-wrapper">
            <input type="text" id="masterSearch" placeholder="Skriv varenavn eller stregkode - tryk Enter for at tilf√∏je..." autocomplete="off" style="font-size:16px;padding:12px;" />
            <div id="masterAutocomplete" class="autocomplete-list" style="display:none"></div>
          </div>
          <p class="small" style="margin-top:4px;color:#005A9E;">üí° Skriv bare varenavn eller stregkode - s√∏g finder det automatisk! Klik p√• varen i listen eller tryk Enter.</p>
          <select id="masterSelect" style="display:none"></select>
          
          <!-- Vis valgt vare info -->
          <div id="selectedVareInfo" style="margin-top:12px;padding:12px;background:#f0f7ff;border:2px solid #2196F3;border-radius:6px;display:none;">
            <div style="font-weight:bold;font-size:16px;color:#1976D2;margin-bottom:8px;">üì¶ Valgt vare:</div>
            <div id="selectedVareDetails" style="font-size:14px;color:#333;line-height:1.6;"></div>
          </div>
          
          <label style="margin-top:12px"><strong>Antal</strong> <span id="antalUnitLabel" style="color:#0078D4;font-weight:bold;"></span></label>
          <input type="number" id="lagerAntal" value="" min="0" step="0.01" placeholder="Indtast antal..." oninput="updateVareInfo()" style="font-size:20px;padding:14px;text-align:center;border:2px solid #0078D4;border-radius:6px;font-weight:bold;" />
          <div style="display:flex; gap:8px; margin-top:12px;">
            <button onclick="tilfoejLagerFraMaster()" style="background:#0078D4; color:white; font-size:16px; padding:14px; flex:1;font-weight:bold;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">‚úÖ Tilf√∏j til opt√¶lling</button>
            <button class="secondary" onclick="clearCurrentCounts()" style="padding:14px;border-radius:6px;">üîÑ Nulstil</button>
          </div>
          <div class="small" style="margin-top:8px;">Bem√¶rk: Hvis en opt√¶llingsrunde er aktiv, tilf√∏jes registreringer til den aktive opt√¶lling.</div>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 style="margin-top:0">Seneste opt√¶llinger</h3>
          <div id="logPreview" class="small">Ingen opt√¶llinger endnu.</div>
          <div style="margin-top:8px;"><button class="secondary" onclick="showPage('rapporter')">üìã Se hele log</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- [HTML 3.2] OPS√ÜTNING LAGER -->
  <section id="opsaetning" class="page hidden">
    <h2>Ops√¶tning Lager</h2>
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input id="nyLagerNavn" placeholder="Nyt lagernavn" />
      <button onclick="tilfoejLager()">‚ûï Tilf√∏j lager</button>
    </div>
    <p class="small" style="margin-top:10px;">Tr√¶k og slip for at √¶ndre r√¶kkef√∏lge ‚Äî r√¶kkef√∏lgen opdateres i hele systemet.</p>
    <ul id="lagerOpsaetning" style="margin-top:12px; list-style:none; padding:0;"></ul>
  </section>

  <!-- [HTML 3.3] RAPPORTER -->
  <section id="rapporter" class="page hidden">
    <div class="settings-page">
      <div class="settings-sidebar" id="reportsSidebar">
        <div class="settings-category">Rapporter</div>
        <div class="settings-item active" onclick="showReportsSection('active')">
          <span class="settings-item-icon">üìä</span>
          <span>Rapporter</span>
        </div>
        <div class="settings-item" onclick="showReportsSection('archived')">
          <span class="settings-item-icon">üì¶</span>
          <span>Arkiverede Rapporter</span>
        </div>
      </div>
      <div class="settings-content" id="reportsContent">
        <button class="settings-sidebar-toggle" id="reportsToggleBtn" onclick="toggleSidebar('reportsSidebar')" title="Skjul/Vis sidebar"></button>
        <h2>Rapporter</h2>
        <div class="settings-description">Se og administrer rapporter og arkiverede rapporter.</div>
        
        <!-- Active Reports Section -->
        <div id="reports-section-active" class="settings-section active">
          <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px;">
            <label class="small">V√¶lg periode:</label>
            <select id="reportsPeriod" onchange="updateReportsDateInputs(); renderReports()" style="min-width:150px;">
              <option value="all">Alle Rapporter</option>
              <option value="1month">1 M√•ned</option>
              <option value="14days">14 Dage</option>
              <option value="1week">1 uge</option>
              <option value="custom">Fra Dato til Dato</option>
            </select>
            <div id="customDateInputs" style="display:none; gap:8px; align-items:center;">
              <label class="small">Fra:</label>
              <input type="date" id="reportsDateFrom" onchange="renderReports()" style="width:150px;" />
              <label class="small">Til:</label>
              <input type="date" id="reportsDateTo" onchange="renderReports()" style="width:150px;" />
            </div>
            <label class="small">V√¶lg lokation</label>
            <select id="reportsLocation" onchange="renderReports()"><option value="">Alle</option></select>
            <button onclick="fetchReportsFromServer()" style="margin-left:auto; background:#17a2b8; color:white; font-weight:800; padding:10px 16px; font-size:15px; box-shadow:0 2px 8px rgba(23,162,184,0.3);">‚òÅÔ∏è Hent fra Server</button>
          </div>
          
          <div style="margin-top:12px; padding:12px; background:#f5f5f5; border-radius:6px; border:1px solid #ddd;">
            <h3 style="margin-top:0; margin-bottom:8px;">Arkiv indstillinger</h3>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
              <label class="small">Automatisk arkivering:</label>
              <select id="archivePeriod" onchange="saveArchiveSettings()" style="min-width:150px;">
                <option value="0">Ingen automatisk arkivering</option>
                <option value="3">Efter 3 m√•neder</option>
                <option value="6">Efter 6 m√•neder</option>
                <option value="12">Efter 12 m√•neder</option>
              </select>
              <button onclick="checkAndArchiveReports()" class="secondary">üì¶ Arkiver nu (baseret p√• indstilling)</button>
              <span id="archiveStatus" class="small" style="color:#666;"></span>
            </div>
          </div>

          <div style="overflow-x:auto; max-height:600px; overflow-y:auto; position:relative; border:1px solid #ddd; border-radius:4px; margin-top:12px;">
            <table style="width:100%; border-collapse:collapse;">
              <thead style="position:sticky; top:0; z-index:10; background:#fff;">
                <tr>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Dato / Tid</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Handling (Opt√¶llingsnavn)</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Vare / Note</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Antal optalt varer</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Lokation</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Handlinger</th>
                </tr>
              </thead>
              <tbody id="reportsTable"></tbody>
            </table>
          </div>
        </div>
        
        <!-- Archived Reports Section -->
        <div id="reports-section-archived" class="settings-section">
          <div style="margin-bottom:16px; padding:12px; background:#f5f5f5; border-radius:6px; border:1px solid #ddd;">
            <h3 style="margin-top:0; margin-bottom:12px;">S√∏g i arkiverede rapporter</h3>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px;">
              <label class="small">S√∏g efter m√•ned & √•r:</label>
              <input type="month" id="archivedReportsMonth" onchange="renderArchivedReports()" style="padding:6px; border:1px solid #ddd; border-radius:4px;" />
              <button onclick="document.getElementById('archivedReportsMonth').value=''; renderArchivedReports();" class="secondary small">Ryd</button>
            </div>
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
              <label class="small">Eller s√∏g efter specifik dato:</label>
              <input type="date" id="archivedReportsDate" onchange="renderArchivedReports()" style="padding:6px; border:1px solid #ddd; border-radius:4px;" />
              <button onclick="document.getElementById('archivedReportsDate').value=''; renderArchivedReports();" class="secondary small">Ryd</button>
            </div>
            <p class="small" style="margin-top:8px; color:#666; margin-bottom:0;">Rapporter sorteres efter dato (nyeste f√∏rst).</p>
          </div>
          <div style="overflow-x:auto; max-height:600px; overflow-y:auto; position:relative; border:1px solid #ddd; border-radius:4px; background:#fff;">
            <table style="width:100%; border-collapse:collapse;">
              <thead style="position:sticky; top:0; z-index:10; background:#fff;">
                <tr>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Dato / Tid</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Handling (Opt√¶llingsnavn)</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Vare / Note</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Antal optalt varer</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Lokation</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Handlinger</th>
                </tr>
              </thead>
              <tbody id="archivedReportsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- [HTML 3.4] VINLAGER -->
  <section id="vinlager" class="page hidden">
    <div style="min-height:100vh; background:linear-gradient(135deg, #8B0000 0%, #4B0000 100%); padding:40px 20px; position:relative; overflow:hidden;">
      <!-- Dekorativ baggrund -->
      <div style="position:absolute; top:0; left:0; right:0; bottom:0; opacity:0.1; background-image:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext x=%2250%22 y=%2250%22 font-size=%2280%22 fill=%22white%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22%3Eüç∑%3C/text%3E%3C/svg%3E'); background-repeat:repeat; background-size:200px 200px;"></div>
      
      <!-- Indhold -->
      <div style="position:relative; z-index:1; max-width:1200px; margin:0 auto;">
        <!-- Header med skift knap -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px; flex-wrap:wrap; gap:20px;">
          <div>
            <h1 style="color:#fff; font-size:48px; margin:0; text-shadow:2px 2px 4px rgba(0,0,0,0.3); display:flex; align-items:center; gap:20px;">
              <span style="font-size:64px;">üç∑</span>
              <span>Vinlager</span>
            </h1>
            <p style="color:rgba(255,255,255,0.9); font-size:18px; margin:10px 0 0 0;">Din professionelle vinlager administration</p>
          </div>
          <button onclick="showPage('lageropt')" style="background:rgba(255,255,255,0.2); color:#fff; border:2px solid rgba(255,255,255,0.5); padding:12px 24px; border-radius:8px; font-size:16px; font-weight:bold; cursor:pointer; transition:all 0.3s; backdrop-filter:blur(10px);">
            üì¶ Skift til K√∏kken
          </button>
        </div>

        <!-- Hovedindhold -->
        <div style="background:rgba(255,255,255,0.95); border-radius:16px; padding:40px; box-shadow:0 10px 40px rgba(0,0,0,0.3); min-height:500px;">
          <div style="text-align:center; padding:60px 20px;">
            <div style="font-size:120px; margin-bottom:30px;">üç∑</div>
            <h2 style="color:#8B0000; font-size:32px; margin:0 0 20px 0;">Velkommen til Vinlager</h2>
            <p style="color:#666; font-size:18px; max-width:600px; margin:0 auto;">Her kan du administrere dit vinlager. Funktioner tilf√∏jes efterh√•nden.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- [HTML 3.5] LABELS -->
  <section id="labels" class="page hidden">
    <h2>Print Labels</h2>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <label class="small">V√¶lg lokation / gruppe</label>
      <select id="labelSelect" onchange="updateLabelReolSelect()"></select>
      <label class="small" id="labelReolLabel" style="display:none;">V√¶lg reol</label>
      <select id="labelReolSelect" style="display:none; width:auto; min-width:120px;" onchange="updateLabelSingleSelect()">
        <option value="">Alle reoler</option>
      </select>
      <label class="small">Eller v√¶lg enkelt vare</label>
      <select id="labelSingle"><option value="">--- Ingen ---</option></select>
      <label class="small">Antal labels pr. vare</label>
      <input type="number" id="labelCount" value="1" min="1" style="width:100px" />
      <div class="right">
        <button onclick="generateLabels()">üè∑Ô∏è Generer labels</button>
        <button onclick="generateQRCodes()" style="background:#28a745; color:white;">üì± Generer QR-koder</button>
        <button onclick="window.print()">üñ®Ô∏è Print labels</button>
      </div>
    </div>
    <div id="labelContainer" class="label-container"></div>
  </section>

  <!-- [HTML 3.5] LEVERAND√òRER -->
  <section id="leverandor" class="page hidden">
    <h2>Leverand√∏r ops√¶tning</h2>
    <table><thead><tr><th>Firma</th><th>Adresse</th><th>Postnr.</th><th>By</th><th>Kontakt</th><th>Telefon</th><th>Email</th><th>Hjemmeside</th><th>Handling</th></tr></thead>
    <tbody id="leverandorTable"></tbody></table>

    <h3 style="margin-top:12px">Tilf√∏j leverand√∏r</h3>
    <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:8px;">
      <input id="firma" placeholder="Firmanavn" />
      <input id="adresse" placeholder="Adresse" />
      <input id="postnr" placeholder="Postnummer" />
      <input id="by" placeholder="By" />
      <input id="kontakt" placeholder="Kontaktperson" />
      <input id="telefon" placeholder="Telefon" />
      <input id="email" placeholder="Email" />
      <input id="hjemmeside" placeholder="Hjemmeside" />
      <div><button onclick="tilfoejLeverandor()">‚ûï Tilf√∏j leverand√∏r</button></div>
    </div>
  </section>

  <!-- [HTML 3.6] MASTER VARELAGER -->
  <section id="master" class="page hidden">
    <div class="settings-page">
      <div class="settings-sidebar" id="masterSidebar">
        <div class="settings-category">Varelager</div>
        <div class="settings-item active" onclick="showMasterSection('add')">
          <span class="settings-item-icon">‚ûï</span>
          <span>Tilf√∏j ny vare</span>
        </div>
        <div class="settings-item" onclick="showMasterSection('shelf')">
          <span class="settings-item-icon">üìã</span>
          <span>Ops√¶tning af Hylder - reoler & R√¶kkef√∏lge (Drag & Drop)</span>
        </div>
        <div class="settings-item" onclick="showMasterSection('view')">
          <span class="settings-item-icon">üîç</span>
          <span>S√∏g & Se hele Varelager</span>
        </div>
      </div>
      <div class="settings-content">
        <button class="settings-sidebar-toggle" id="masterToggleBtn" onclick="toggleSidebar('masterSidebar')" title="Skjul/Vis sidebar"></button>
        <h2>Varelager administration</h2>
        <div class="settings-description">Administrer varelager, tilf√∏j nye varer, og ops√¶t hylle r√¶kkef√∏lge.</div>
        
        <!-- Add New Item Section -->
        <div id="master-section-add" class="settings-section active">
          <h3 style="margin-top:0; margin-bottom:16px;">Tilf√∏j ny vare</h3>
          <div style="display:flex; gap:12px; align-items:flex-start; flex-wrap:wrap;">
            <div style="width:400px; max-width:100%;">
              <input id="masterVarenavn" placeholder="Varenavn" />
              <input id="masterMaaleenhed" placeholder="M√•leenhed (stk/L/kg)" />
              <input id="masterPris" type="number" step="0.01" placeholder="Pris pr. enhed" />
              <label class="small">Placering (Lager)</label>
              <select id="masterPlaceringFilter"></select>
              <label class="small" style="margin-top:8px;">Reol nummer (valgfrit)</label>
              <input id="masterReolNr" type="text" placeholder="fx 1, 2, 3 eller A, B, C" />
              <label class="small" style="margin-top:8px;">Hylle nummer (valgfrit)</label>
              <input id="masterHylleNr" type="text" placeholder="fx 1, 2, 3 eller A, B, C" />
              <label class="small" style="margin-top:8px;">R√¶kkef√∏lge (0 = automatisk)</label>
              <input id="masterRaekkefoelge" type="number" step="1" placeholder="0 = automatisk" value="0" />
              <div style="margin-top:8px;"><button onclick="tilfoejMasterVare()">‚ûï Tilf√∏j vare</button></div>
            </div>
            <div style="width:320px; margin-left:auto;">
              <h3 style="margin:0">Import/Export Excel/CSV</h3>
              <div style="margin-bottom:8px;">
                <button onclick="downloadExcelTemplate()" style="width:100%; margin-bottom:8px; background:#2196F3; color:white; border-color:#1976D2;">Hent Excel skabelon</button>
              </div>
              <input type="file" id="csvImport" accept=".csv,.xlsx,.xls" />
              <div style="display:flex; gap:8px; margin-top:8px;">
                <button onclick="importCSV()">üì• Importer Excel/CSV</button>
                <button onclick="exportCSV()">üì§ Eksport CSV</button>
              </div>
              <div class="small" style="margin-top:8px; color:#666;">
                <strong>Tip:</strong> Download skabelonen, udfyld den i Excel, og importer den igen.
              </div>
            </div>
          </div>
        </div>
        
        <!-- Shelf Order Section -->
        <div id="master-section-shelf" class="settings-section">
          <h3 style="margin-top:0; margin-bottom:16px;">Ops√¶tning af Hylder - reoler & R√¶kkef√∏lge (Drag & Drop)</h3>
          <div style="padding:16px; background:#f5f5f5; border-radius:8px;">
            <label style="display:block; margin-bottom:8px; font-weight:700; color:#222; font-size:14px;">V√¶lg lager for at se og redigere hylle r√¶kkef√∏lge:</label>
            <select id="hylleLagerSelect" onchange="syncFilterPlacement(); updateHylleReolSelect(); renderHylleRaekkefoelge()" style="margin-top:8px; margin-bottom:8px; width:100%;"></select>
            <label style="display:block; margin-top:12px; margin-bottom:8px; font-weight:700; color:#222; font-size:14px;">V√¶lg reol:</label>
            <select id="hylleReolSelect" onchange="updateHylleHylleSelect(); renderHylleRaekkefoelge()" style="margin-top:4px; margin-bottom:8px; width:100%;">
              <option value="">Alle reoler</option>
            </select>
            <label style="display:block; margin-top:12px; margin-bottom:8px; font-weight:700; color:#222; font-size:14px;">V√¶lg hylle:</label>
            <select id="hylleHylleSelect" onchange="renderHylleRaekkefoelge()" style="margin-top:4px; margin-bottom:12px; width:100%;">
              <option value="">Alle hylder</option>
            </select>
            <p style="margin-top:12px; margin-bottom:0; font-weight:700; color:#222; font-size:14px;">Tr√¶k og slip varer for at √¶ndre r√¶kkef√∏lge ‚Äî r√¶kkef√∏lgen opdateres automatisk!</p>
            <ul id="hylleRaekkefoelgeList" style="margin-top:12px; list-style:none; padding:0;"></ul>
          </div>
        </div>
        
        <!-- View All Items Section -->
        <div id="master-section-view" class="settings-section">
          <h3 style="margin-top:0; margin-bottom:16px;">S√∏g & Se hele Varelager</h3>
          <div style="display:flex; gap:12px; align-items:center; justify-content:flex-end; flex-wrap:wrap; margin-bottom:12px;">
            <label class="small">S√∏g vare:</label>
            <input type="text" id="masterSearchInput" placeholder="S√∏g efter varenavn..." style="width:200px; padding:6px; border:1px solid #ddd; border-radius:4px;" oninput="renderMasterTable()" />
            <label class="small">Filtrer placering:</label>
            <select id="filterPlacement" style="width:auto; min-width:120px; max-width:250px;" onchange="renderMasterTable()"><option value="">Alle</option></select>
            <span class="small" id="masterTableInfo" style="color:#666;"></span>
            <button onclick="uploadVarelagerToServer()" style="background:#17a2b8; color:white; font-weight:800; padding:8px 14px; font-size:14px; box-shadow:0 2px 6px rgba(23,162,184,0.3); margin-left:auto;">‚òÅÔ∏è Upload Varelager til Server</button>
          </div>

          <div style="overflow-x:auto; max-height:600px; overflow-y:auto; position:relative; border:1px solid #ddd; border-radius:4px;">
            <table style="width:100%; border-collapse:collapse;">
              <thead style="position:sticky; top:0; z-index:10; background:#fff;">
                <tr>
                  <th style="background:#f5f5f5; padding:12px; text-align:center; border-bottom:2px solid #ddd; font-weight:bold;">Billede</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Varenavn</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Varenummer</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">M√•leenhed</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Pris</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Lager</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Reol</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Hylle</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">R√¶kkef√∏lge</th>
                  <th style="background:#f5f5f5; padding:12px; text-align:left; border-bottom:2px solid #ddd; font-weight:bold;">Handling</th>
                </tr>
              </thead>
              <tbody id="masterTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- [HTML 3.7] STREGKODE SCANNER (Integreret) -->
  <section id="scanner" class="page hidden">
    <div style="max-width:1200px; margin:0 auto;">
      <h2>üì± Stregkode Scanner</h2>
      <p style="color:#666; margin-bottom:20px;">Scan stregkoder direkte i hovedprogrammet. Data synkroniseres automatisk.</p>
      
      <div id="scannerContainer" style="background:#fff; border-radius:8px; padding:20px; border:1px solid #e6e6e6;">
        <!-- Scanner indhold indl√¶ses her -->
        <div id="scannerContent">
          <p style="text-align:center; color:#666; padding:40px;">Scanner indl√¶ses...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- [HTML 3.8] SYSTEM OPS√ÜTNING -->
  <section id="systemOpsaetning" class="page hidden">
    <div class="settings-page">
      <div class="settings-sidebar" id="settingsSidebar">
        <div class="settings-category">Indstillinger</div>
        <div class="settings-item active" onclick="showSettingsSection('manual')">
          <span class="settings-item-icon">üìñ</span>
          <span>Manual & Vejledning</span>
        </div>
        <div class="settings-item" onclick="showSettingsSection('password')">
          <span class="settings-item-icon">üîë</span>
          <span>Skift password</span>
        </div>
        <div class="settings-item" onclick="showSettingsSection('backup')">
          <span class="settings-item-icon">üíæ</span>
          <span>Backup & Sikkerhed</span>
        </div>
        <div class="settings-item" onclick="showSettingsSection('import')">
          <span class="settings-item-icon">üì•</span>
          <span>Import data</span>
        </div>
        <div class="settings-item" onclick="showSettingsSection('mobile')">
          <span class="settings-item-icon">üì±</span>
          <span>Mobil tilgang</span>
        </div>
        <div class="settings-item" onclick="showSettingsSection('branding')">
          <span class="settings-item-icon">üñºÔ∏è</span>
          <span>Logo & Branding</span>
        </div>
      </div>
      <div class="settings-content">
        <button class="settings-sidebar-toggle" id="settingsToggleBtn" onclick="toggleSidebar('settingsSidebar')" title="Skjul/Vis sidebar"></button>
        <h2>Ops√¶tning</h2>
        <div class="settings-description">Administrer systemindstillinger, sikkerhed, backup og branding.</div>
        
        <!-- Manual Section -->
        <div id="settings-manual" class="settings-section active">
          <div style="margin-bottom:20px;">
            <h3 style="margin-bottom:10px;">üìñ Program Manual</h3>
            <p style="color:#666; margin-bottom:20px;">Komplet vejledning til alle funktioner i programmet. Klik p√• en sektion for at l√¶se mere.</p>
            <button onclick="downloadManualPDF()" style="background:#0078D4; color:white; padding:10px 20px; font-weight:700; border-radius:8px; margin-bottom:20px;">
              üìÑ Download Manual som PDF
            </button>
          </div>
          
          <div id="manualContent" style="max-width:900px;">
            <!-- Manual items will be added here via JavaScript -->
          </div>
        </div>
        
        <!-- Password Section -->
        <div id="settings-password" class="settings-section">
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üîë Skift password</h3>
              <p>Opdater dit login password og recovery email for bedre sikkerhed.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="showChangePasswordModal()">Skift password</button>
            </div>
          </div>
        </div>
        
        <!-- Backup Section -->
        <div id="settings-backup" class="settings-section">
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>‚òÅÔ∏è Backup til Server</h3>
              <p>Upload en komplet backup af al din data til serveren. Alle backups gemmes i en dedikeret backup mappe p√• serveren.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="uploadBackupToServer()" style="background:#17a2b8; color:white; font-weight:700;">‚òÅÔ∏è Upload Backup til Server</button>
            </div>
          </div>
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üì• Hent Backup fra Server</h3>
              <p>Hent en tidligere backup fra serveren. V√¶lg hvilken backup du vil gendanne.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="fetchBackupsFromServer()" style="background:#28a745; color:white; font-weight:700;">üì• Hent Backup fra Server</button>
            </div>
          </div>
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üíæ Download Backup (Lokal)</h3>
              <p>Download en komplet backup af al din data i JSON format. Brug til sikkerhedskopi eller overf√∏rsel.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="exportAllBackup()">Download Backup</button>
            </div>
          </div>
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üîê Backup Login & Licens</h3>
              <p>Download backup af login og licens data. VIGTIGT: Gem denne fil sikkert! Uden den kan du ikke logge ind igen hvis cache slettes.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="exportLoginAndLicense()" style="background:#dc3545; color:white;">üì• Download Login/Licens</button>
            </div>
          </div>
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üì§ Gendan Login & Licens</h3>
              <p>Gendan login og licens data fra en tidligere backup. Brug dette hvis du har slettet browser cache.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="importLoginAndLicense()" style="background:#28a745; color:white;">üì§ Gendan Login/Licens</button>
            </div>
          </div>
        </div>
        
        <!-- Import Section -->
        <div id="settings-import" class="settings-section">
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üì∑ Importer Scanner Data</h3>
              <p>Importer data fra Scanner appen eller eksterne stregkode l√¶sere.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="importScannerData()" style="background:#2196F3; color:white;">Importer Scanner</button>
            </div>
          </div>
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üîÑ Synkroniser Rapporter</h3>
              <p>Tjek automatisk for nye rapporter fra scanner-appen og opdater listen.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="syncReportsFromScanner()" style="background:#4CAF50; color:white;">üîÑ Synkroniser Nu</button>
            </div>
          </div>
        </div>
        
        <!-- Mobile Section -->
        <div id="settings-mobile" class="settings-section">
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üîë Scanner Installation ID</h3>
              <p>Se og synkroniser installation ID med scanner-appen for at sikre de matcher. Vigtigt for korrekt rapport-synkronisering.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="showScannerInstallationId()" style="background:#FF9800; color:white;">üîë Vis/Synkroniser ID</button>
            </div>
          </div>
        </div>
        
        <!-- Branding Section -->
        <div id="settings-branding" class="settings-section">
          <div class="settings-option">
            <div class="settings-option-label">
              <h3>üñºÔ∏è Skift logo</h3>
              <p>Upload et nyt logo til dit firma. Logoet vises i rapporter og p√• dokumenter.</p>
            </div>
            <div class="settings-option-action">
              <button onclick="document.getElementById('logoUpload').click()">V√¶lg logo</button>
              <input id="logoUpload" type="file" accept="image/*" style="display:none" />
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Licens Section -->
  <section id="licens" class="page hidden">
    <div class="card">
      <h2>üîë Licens Information</h2>
      <div id="licenseStatusDisplay" style="padding:20px; background:#f5f5f5; border-radius:8px; margin-top:16px;"></div>
      <div style="margin-top:20px; padding:15px; background:#e3f2fd; border-radius:8px; border-left:4px solid #0078D4;">
        <h3 style="margin-top:0;">üìã Installations-ID</h3>
        <p class="small" style="margin-bottom:8px;">Dette er dit unikke installations-ID. Du skal bruge dette ID n√•r du bestiller en licens.</p>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="text" id="installationIdDisplay" readonly style="flex:1; padding:10px; font-family:monospace; font-size:14px; background:#fff; border:1px solid #ddd; border-radius:4px;" />
          <button onclick="copyInstallationId()" style="background:#0078D4;">üìã Kopier ID</button>
        </div>
        <p class="small" style="margin-top:8px; color:#666;">
          <strong>Vigtigt:</strong> Licenser er bundet til dette installations-ID og kan ikke bruges p√• andre installationer.
        </p>
      </div>
      
      <div style="margin-top:20px; padding:15px; background:#fff3cd; border-radius:8px; border-left:4px solid #ffc107;">
        <h3 style="margin-top:0;">üìÅ Installationsmappe</h3>
        <p class="small" style="margin-bottom:8px;">Programmet er installeret i f√∏lgende mappe:</p>
        <div style="display:flex; gap:8px; align-items:center;">
          <input type="text" id="installationPathDisplay" readonly style="flex:1; padding:10px; font-family:monospace; font-size:13px; background:#fff; border:1px solid #ddd; border-radius:4px;" />
          <button onclick="openInstallationFolder()" style="background:#ffc107; color:#000;">üìÇ √Öbn mappe</button>
        </div>
        <p class="small" style="margin-top:8px; color:#666;">
          <strong>Tip:</strong> Her finder du ogs√• skabelon filen til import af varer.
        </p>
      </div>
      <div style="margin-top:20px;">
        <h3>Aktiver Licens</h3>
        <p class="small">Indtast en gyldig licensn√∏gle for at aktivere fuld licens.</p>
        <div style="display:flex; gap:8px; margin-top:12px;">
          <input type="text" id="licenseKeyInputPage" placeholder="Indtast licensn√∏gle" style="flex:1; padding:10px; font-size:16px; letter-spacing:2px;" />
          <button onclick="activateLicenseFromPage()" style="background:#28a745;">Aktiver Licens</button>
        </div>
        <p class="small" style="margin-top:8px; color:#666;">
          Har du ikke en licensn√∏gle? Kontakt support med dit installations-ID for at f√• en.
        </p>
      </div>
    </div>
  </section>

</div> <!-- END content -->

<!-- =========================
     [HTML 4] MODALS
     ========================= -->
<!-- Start session modal -->
<div id="startModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Start ny opt√¶lling</h3>
    <label>Navn (kan redigeres senere, men ikke efter opt√¶lling er afsluttet)</label>
    <input id="startName" placeholder="Automatisk serienummer genereres..." />
    <label class="small" style="margin-top:8px;">Scope (hvor skal opt√¶llingen g√¶lde)</label>
    <select id="startScope"></select>
    <div class="actions">
      <button class="secondary" onclick="closeStartModal()">Annuller</button>
      <button onclick="confirmStartSession()">Start opt√¶lling</button>
    </div>
  </div>
</div>

<!-- Finish session confirm modal -->
<div id="finishModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true">
    <h3>Bekr√¶ft opt√¶lling f√∏r gem</h3>
    <div id="finishSummary" style="max-height:56vh; overflow:auto; font-size:14px;"></div>
    <div class="actions">
      <button class="secondary" onclick="closeFinishModal()">Tilbage</button>
      <button class="secondary" onclick="cancelSessionFromModal()" style="background:#dc3545; color:white;">‚ùå Annuller opt√¶lling</button>
      <button onclick="confirmFinishSession()">Gem opt√¶lling</button>
    </div>
  </div>
</div>

<!-- Start Opt√¶lling Prompt Modal -->
<div id="startOptaellingPromptModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:400px;">
    <h3 style="color:#005A9E;">‚ö†Ô∏è Ingen aktiv opt√¶lling</h3>
    <p>Du skal f√∏rst starte en opt√¶lling f√∏r du kan s√∏ge efter og tilf√∏je varer.</p>
    <div class="actions" style="margin-top:20px;">
      <button onclick="closeStartOptaellingPrompt(); openStartModal();" style="background:#0078D4; color:white;">‚úÖ Ja, start opt√¶lling</button>
      <button class="secondary" onclick="closeStartOptaellingPrompt()">Annuller</button>
    </div>
  </div>
</div>

<!-- Barcode Scanner Modal -->
<div id="scannerModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:95vw; width:600px;">
    <h3>Stregkode Scanner</h3>
    <div id="scannerStatus" style="margin-bottom:10px; padding:8px; background:#f0f0f0; border-radius:4px; font-size:14px;">
      Starter kamera...
    </div>
    <div id="scannerWarning" style="margin-bottom:10px; padding:10px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:4px; font-size:13px; display:none;">
      <strong>‚ö†Ô∏è Vigtigt:</strong> Kameraet virker kun med HTTPS eller localhost.<br>
      <strong>P√• computeren:</strong> Brug <code>http://localhost:8000</code> i stedet for IP-adresse.<br>
      <strong>P√• telefonen:</strong> Hvis kameraet ikke virker, brug "S√∏g vare" til manuel indtastning.
    </div>
    <video id="scannerVideo" style="width:100%; max-width:100%; border:2px solid #0078D4; border-radius:8px; background:#000; display:none;" autoplay playsinline></video>
    <div id="scannerResult" style="margin-top:10px; padding:10px; background:#E3F2FD; border-radius:4px; display:none;">
      <strong>Scannet:</strong> <span id="scannedVareName"></span>
    </div>
    <div class="actions" style="margin-top:15px;">
      <button class="secondary" onclick="stopScanner()">Luk scanner</button>
    </div>
  </div>
</div>

<!-- Phone Link Modal -->
<div id="phoneLinkModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:500px;">
    <h3>üì± Link til telefon</h3>
    <div id="phoneLinkStatus" style="margin-bottom:15px; padding:10px; background:#f0f0f0; border-radius:4px; font-size:14px;">
      Finder din IP-adresse...
    </div>
    <div id="phoneLinkManual" style="display:none; margin-bottom:15px; padding:15px; background:#fff3cd; border:2px solid #ffc107; border-radius:4px;">
      <p style="margin:0 0 10px 0; font-weight:700;">IP-adresse ikke fundet automatisk</p>
      <p style="margin:0 0 10px 0; font-size:13px; color:#666;">Indtast din computers IP-adresse manuelt:</p>
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
        <input type="text" id="manualIPInput" placeholder="fx 192.168.1.100" style="flex:1; padding:8px; border:2px solid #ddd; border-radius:4px; font-size:14px;" />
        <input type="text" id="manualPortInput" placeholder="8443" value="8443" style="width:80px; padding:8px; border:2px solid #ddd; border-radius:4px; font-size:14px;" />
        <label style="font-size:11px; color:#666; margin-top:4px; display:block;">
          <input type="checkbox" id="useHTTPS" checked style="margin-right:4px;" />
          HTTPS (8443) - Kamera virker!
        </label>
        <button onclick="useManualIP()" style="padding:8px 16px; background:#0078D4; color:white; border:none; border-radius:4px; cursor:pointer; white-space:nowrap;">Brug IP</button>
      </div>
      <div style="background:#fff; padding:10px; border-radius:4px; margin-bottom:8px; font-size:12px;">
        <strong>Hvordan finder jeg min IP-adresse?</strong><br>
        1. Dobbeltklik p√• <code>START_WEBSERVER.bat</code> - den viser din IP<br>
        2. Eller √•bn Kommandoprompt og skriv: <code>ipconfig</code><br>
        3. Find "IPv4-adresse" under din WiFi adapter
      </div>
      <button onclick="retryIPDetection()" class="secondary" style="padding:6px 12px; font-size:12px;">Pr√∏v automatisk igen</button>
    </div>
    <div id="phoneLinkContent" style="display:none;">
      <p style="margin-bottom:12px; color:#666; font-weight:700;">üì± App til din telefon</p>
      <p style="margin-bottom:12px; color:#666; font-size:14px;">Scan QR-koden med din telefon eller kopi√©r linket nedenfor:</p>
      <div style="text-align:center; margin:20px 0;">
        <div id="qrcode" style="display:inline-block; padding:15px; background:#fff; border:2px solid #0078D4; border-radius:8px;"></div>
      </div>
      <div style="margin:15px 0;">
        <label style="display:block; margin-bottom:6px; font-weight:700;">Link til Manuel Opt√¶lling:</label>
        <div style="display:flex; gap:8px;">
          <input type="text" id="phoneLinkInput" readonly style="flex:1; padding:10px; border:2px solid #ddd; border-radius:4px; font-size:14px; background:#f9f9f9;" />
          <button onclick="copyPhoneLink()" style="padding:10px 20px; background:#0078D4; color:white; border:none; border-radius:4px; cursor:pointer; white-space:nowrap;">Kopi√©r</button>
        </div>
      </div>
      <div style="background:#E3F2FD; padding:12px; border-radius:4px; margin-top:15px;">
        <strong>üìã Trin-for-trin guide:</strong>
        <ol style="margin:8px 0 0 20px; padding:0;">
          <li style="margin-bottom:8px;"><strong>1. Start webserveren p√• din computer:</strong> 
            <ul style="margin:4px 0 0 20px; padding:0;">
              <li>Dobbeltklik p√• <code>START_HTTPS_SERVER.bat</code> (anbefalet - virker bedst)</li>
              <li>ELLER dobbeltklik p√• <code>START_WEBSERVER.bat</code></li>
              <li>Lad vinduet v√¶re √•bent - serveren skal k√∏re hele tiden</li>
            </ul>
          </li>
          <li style="margin-bottom:8px;"><strong>2. √Öbn linket p√• din telefon:</strong>
            <ul style="margin:4px 0 0 20px; padding:0;">
              <li>Scan QR-koden med din telefons kamera</li>
              <li>ELLER kopi√©r linket og send det til dig selv (SMS/Email/Messenger)</li>
              <li>√Öbn linket i din telefons browser</li>
            </ul>
          </li>
          <li style="margin-bottom:8px;"><strong>3. Tilf√∏j til hjem-sk√¶rmen:</strong>
            <ul style="margin:4px 0 0 20px; padding:0;">
              <li><strong>Android:</strong> Menu ‚Üí "Tilf√∏j til startsk√¶rm"</li>
              <li><strong>iPhone:</strong> Del-ikon ‚Üí "Tilf√∏j til hjem-sk√¶rm"</li>
            </ul>
          </li>
          <li><strong>4. Tilf√∏j til hjem-sk√¶rmen (Genvej):</strong>
            <ul style="margin:4px 0 0 20px; padding:0;">
              <li><strong>Android (Chrome):</strong> Menu (3 prikker) ‚Üí "Tilf√∏j til startsk√¶rm"</li>
              <li><strong>iPhone (Safari):</strong> Del-ikon (firkant med pil) ‚Üí "Tilf√∏j til hjem-sk√¶rm"</li>
            </ul>
          </li>
          <li><strong>5. Brug appen:</strong> Nu kan du bruge appen direkte fra telefonen med genvej!</li>
        </ol>
        <div style="margin-top:12px; padding:8px; background:#fff; border-radius:4px; font-size:12px;">
          <strong>üí° Tip:</strong> Hvis linket ikke virker, tjek at b√•de computer og telefon er p√• samme WiFi-netv√¶rk.
        </div>
      </div>
      <div id="connectionErrorHelp" style="background:#ffebee; padding:12px; border-radius:4px; margin-top:12px; display:none;">
        <strong style="color:#c62828;">‚ùå F√•r du "n√¶gtede at oprette forbindelse"?</strong>
        <ol style="margin:8px 0 0 20px; padding:0; font-size:13px;">
          <li><strong>Tjek at START_WEBSERVER.bat k√∏rer</strong> - vinduet skal v√¶re √•bent</li>
          <li><strong>Tjek Windows Firewall:</strong>
            <ul style="margin:4px 0 0 20px;">
              <li>√Öbn "Windows Defender Firewall"</li>
              <li>Klik "Tillad en app gennem Firewall"</li>
              <li>Tilf√∏j Python eller tillad port 8000</li>
            </ul>
          </li>
          <li><strong>Pr√∏v at √•bne linket p√• computeren f√∏rst</strong> - hvis det virker der, er problemet WiFi/netv√¶rk</li>
          <li><strong>Tjek at telefonen er p√• samme WiFi</strong> som computeren</li>
        </ol>
      </div>
      <div style="margin-top:12px;">
        <button onclick="testServerConnection()" class="secondary" style="padding:8px 16px; font-size:13px;">üîç Test server forbindelse</button>
        <button onclick="showConnectionHelp()" class="secondary" style="padding:8px 16px; font-size:13px; margin-left:8px;">‚ùì Hj√¶lp - Forbindelse n√¶gtet</button>
        <div id="serverTestResult" style="margin-top:8px; padding:8px; border-radius:4px; display:none;"></div>
      </div>
    </div>
    <div class="actions" style="margin-top:20px;">
      <button class="secondary" onclick="closePhoneLinkModal()">Luk</button>
    </div>
  </div>
</div>

<!-- Import type selection modal -->
<div id="importModal" class="modal-backdrop hidden" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" style="max-width:500px;">
    <h3>V√¶lg import type</h3>
    <p style="margin-bottom:16px;">Hvordan vil du importere filen?</p>
    <div style="display:flex; flex-direction:column; gap:12px;">
      <button onclick="selectImportType('overwrite')" style="text-align:left; padding:12px; background:#fff; border:2px solid #ddd; border-radius:8px; cursor:pointer;">
        <strong>Overskriv varelager</strong><br>
        <small style="color:#666;">Erstat hele varelageret med data fra filen</small>
      </button>
      <button onclick="selectImportType('add')" style="text-align:left; padding:12px; background:#fff; border:2px solid #ddd; border-radius:8px; cursor:pointer;">
        <strong>Tilf√∏j til varelager</strong><br>
        <small style="color:#666;">Tilf√∏j kun nye varer, ignorer eksisterende</small>
      </button>
      <button onclick="selectImportType('update')" style="text-align:left; padding:12px; background:#fff; border:2px solid #ddd; border-radius:8px; cursor:pointer;">
        <strong>Opdater priser</strong><br>
        <small style="color:#666;">Opdater priser for eksisterende varer, tilf√∏j nye varer</small>
      </button>
    </div>
    <div class="actions" style="margin-top:16px;">
      <button class="secondary" onclick="closeImportModal()">Annuller</button>
    </div>
  </div>
</div>

<!-- =========================
     [EXTERNAL LIBRARIES]
     ========================= -->
<!-- jsPDF (for PDF generation) -->
<!-- Pre-genereret installations-ID (hvis tilg√¶ngelig) -->
<script src="installation_id.js" onerror="console.log('installation_id.js ikke fundet - genererer ID ved f√∏rste opstart')"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- JsBarcode (for labels) -->
<script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
<!-- ZXing for barcode scanning -->
<script src="https://unpkg.com/@zxing/library@0.19.1"></script>
<!-- QR Code generator -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<!-- SheetJS for Excel import/export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- =========================
     [JS ALL-IN-ONE ‚Äî nummereret (JS 1.. JS 4.x) ]
     ========================= -->
<script>
/* ======================================================
   [JS 0.1] HELPER FUNCTIONS (flyttet tidligere for bedre tilg√¶ngelighed)
   ====================================================== */
const $ = id => {
  const element = document.getElementById(id);
  if(!element) {
    console.warn(`Element med id "${id}" ikke fundet`);
  }
  return element;
};
function genId(){ return 'id_'+Date.now().toString(36)+'_'+Math.floor(Math.random()*10000); }
function formatTime(ts){ return new Date(ts).toLocaleString(); }

/* ======================================================
   [JS 0] LOGIN SYSTEM
   ====================================================== */
const PASSWORD_KEY = 'k√∏kkenlager_password';
const USERNAME_KEY = 'k√∏kkenlager_username';
const RECOVERY_EMAIL_KEY = 'k√∏kkenlager_recovery_email';
const RECOVERY_EMAIL_HASH_KEY = 'k√∏kkenlager_recovery_email_hash';
let isLoggedIn = false;
let appInitialized = false;

// Simple hash function (ikke kryptografisk sikkert, men bedre end plaintext)
function hashPassword(password, username = ''){
  const combined = username ? `${username}:${password}` : password;
  let hash = 0;
  for(let i=0; i<combined.length; i++){
    const char = combined.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash;
  }
  return hash.toString();
}

function checkPasswordExists(){
  return localStorage.getItem(PASSWORD_KEY) !== null;
}

function attemptLogin(){
  try {
    console.log('attemptLogin kaldt');
    const usernameInput = $('loginUsername');
    const passwordInput = $('loginPassword');
    if(!passwordInput) {
      console.error('Login password input ikke fundet');
      showLoginError('Login input ikke fundet. Genindl√¶s siden.');
      return;
    }
    const username = usernameInput ? usernameInput.value.trim() : '';
    const password = passwordInput.value;
    console.log('Username:', username);
    console.log('Password l√¶ngde:', password ? password.length : 0);
    if(!password){
      showLoginError('Indtast password');
      return;
    }
    const storedHash = localStorage.getItem(PASSWORD_KEY);
    const storedUsername = localStorage.getItem(USERNAME_KEY);
    if(!storedHash) {
      showLoginError('Ingen password sat. Opret password f√∏rst.');
      return;
    }
    
    // Backward compatibility: Hvis der ikke er et brugernavn gemt, accepter kun password
    // Hvis der er et brugernavn gemt, kr√¶v b√•de brugernavn og password
    let loginValid = false;
    if(!storedUsername) {
      // Backward compatibility: Kun password (gammel konto)
    const inputHash = hashPassword(password);
      loginValid = (storedHash === inputHash);
      console.log('Backward compatibility login (kun password)');
    } else {
      // Ny login: Kr√¶v b√•de brugernavn og password
      if(!username) {
        showLoginError('Indtast brugernavn');
        if(usernameInput) usernameInput.focus();
        return;
      }
      if(username.toLowerCase() !== storedUsername.toLowerCase()) {
        showLoginError('Forkert brugernavn eller password');
        passwordInput.value = '';
        if(usernameInput) usernameInput.focus();
        return;
      }
      const inputHash = hashPassword(password, username);
      loginValid = (storedHash === inputHash);
      console.log('Ny login (brugernavn + password)');
    }
    
    console.log('Stored hash:', storedHash);
    // Calculate hash for logging (same as used in validation)
    let finalInputHash;
    if(!storedUsername) {
      finalInputHash = hashPassword(password);
    } else {
      finalInputHash = username ? hashPassword(password, username) : hashPassword(password);
    }
    console.log('Input hash:', finalInputHash);
    console.log('Match:', loginValid);
    if(loginValid){
      console.log('Login succesfuld');
      isLoggedIn = true;
      
      // Track login count and perform security check
      performLoginSecurityCheck();
      
      // Track login count for automatic backup
      trackLoginCount();
      
      hideLoginModal();
    } else {
      console.log('Forkert brugernavn eller password');
      showLoginError('Forkert brugernavn eller password');
      passwordInput.value = '';
      if(usernameInput) usernameInput.value = '';
      if(usernameInput) usernameInput.focus();
      else passwordInput.focus();
    }
  } catch(error) {
    console.error('Fejl ved login:', error);
    showLoginError('Der opstod en fejl. Pr√∏v igen. Fejl: ' + error.message);
  }
}

function createPassword(){
  const userName = $('userName')?.value?.trim();
  const newPass = $('newPassword')?.value;
  const confirmPass = $('confirmPassword')?.value;
  const recoveryEmail = $('recoveryEmail')?.value?.trim();
  
  // Valider navn
  if(!userName || userName.length < 2){
    showLoginError('Navn er p√•kr√¶vet og skal v√¶re mindst 2 tegn');
    return;
  }
  
  // Valider email
  if(!recoveryEmail || !recoveryEmail.includes('@')){
    showLoginError('Email er p√•kr√¶vet og skal v√¶re en gyldig email');
    return;
  }
  
  // Valider password
  if(!newPass || newPass.length < 4){
    showLoginError('Password skal v√¶re mindst 4 tegn');
    return;
  }
  if(newPass !== confirmPass){
    showLoginError('Passwords matcher ikke');
    return;
  }
  
  // S√¶t standard brugernavn hvis der ikke allerede er et
  const defaultUsername = 'mikkelsen67@outlook.dk';
  const usernameToUse = defaultUsername.toLowerCase();
  
  // Gem bruger data
  const emailHash = hashPassword(recoveryEmail.toLowerCase());
  const hash = hashPassword(newPass, usernameToUse); // Hash med brugernavn
  localStorage.setItem(PASSWORD_KEY, hash);
  localStorage.setItem(USERNAME_KEY, usernameToUse); // Gem brugernavn
  localStorage.setItem(RECOVERY_EMAIL_KEY, recoveryEmail.toLowerCase());
  localStorage.setItem(RECOVERY_EMAIL_HASH_KEY, emailHash);
  localStorage.setItem('user_name', userName); // Gem bruger navn
  
  // Start pr√∏veversion automatisk
  const installId = getInstallationId();
  const trialStartDate = Date.now();
  const trialEndDate = trialStartDate + (TRIAL_DAYS * 24 * 60 * 60 * 1000);
  const trialLicense = {
    installationId: installId,
    type: 'trial',
    startDate: trialStartDate,
    endDate: trialEndDate,
    valid: true
  };
  localStorage.setItem(LICENSE_KEY, JSON.stringify(trialLicense));
  
  isLoggedIn = true;
  
  // Vis velkomst besked
  alert(`‚úÖ Velkommen ${userName}!\n\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n‚ö†Ô∏è PR√òVEVERSION AKTIVERET\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nDu har nu adgang til en 30-dages pr√∏veversion.\n\nBEGR√ÜNSNINGER:\n‚Ä¢ Max 50 varer i lageret\n‚Ä¢ Max 10 rapporter\n\nEfter 30 dage skal du aktivere en fuld licens for at forts√¶tte.\n\nG√• til "Licens" menuen for at aktivere din licens.`);
  
  hideLoginModal();
}

function showLoginError(msg){
  const errorEl = $('loginError');
  if(errorEl){
    errorEl.textContent = msg;
    errorEl.style.display = 'block';
    setTimeout(()=>{ errorEl.style.display = 'none'; }, 5000);
  }
}

function hideLoginModal(){
  const modal = $('loginModal');
  if(!modal) return;
  
  // Fjern login-active klasse f√∏rst
  document.body.classList.remove('login-active');
  modal.classList.add('hidden');
  
  // Initialiser app n√•r login er gennemf√∏rt (kun √©n gang)
  if(isLoggedIn && !appInitialized){
    initializeApp();
    appInitialized = true;
  }
}

function logout(){
  if(!confirm('Er du sikker p√• at du vil logge ud?')) return;
  isLoggedIn = false;
  appInitialized = false;
  showLoginModal();
}

function showLoginModal(){
  try {
    const modal = $('loginModal');
    if(!modal) {
      console.error('Login modal ikke fundet');
      return;
    }
    document.body.classList.add('login-active');
    modal.classList.remove('hidden');
    
    // Tjek om dette er en ny installation (har installations-ID fil men ikke password)
    const isNewInstallation = typeof PRE_GENERATED_INSTALLATION_ID !== 'undefined' && 
                               PRE_GENERATED_INSTALLATION_ID && 
                               !checkPasswordExists();
    
    const hasPassword = checkPasswordExists();
    
    // Hvis der ikke er password, vis ALTID registreringsformularen
    if(!hasPassword){
      const title = $('loginTitle');
      const loginForm = $('loginForm');
      const createForm = $('createPasswordForm');
      const forgotForm = $('forgotPasswordForm');
      const changeForm = $('changePasswordForm');
      const userNameInput = $('userName');
      
      if(title) {
        title.textContent = 'Opret konto - Pr√∏veversion';
      }
      if(loginForm) loginForm.style.display = 'none';
      if(createForm) createForm.style.display = 'block';
      if(forgotForm) forgotForm.style.display = 'none';
      if(changeForm) changeForm.style.display = 'none';
      if(userNameInput) {
        setTimeout(() => userNameInput.focus(), 100);
      }
    } else {
      // Der er password - vis login form
      const title = $('loginTitle');
      const loginForm = $('loginForm');
      const createForm = $('createPasswordForm');
      const forgotForm = $('forgotPasswordForm');
      const changeForm = $('changePasswordForm');
      const passwordInput = $('loginPassword');
      const usernameInput = $('loginUsername');
      const usernameLabel = document.querySelector('label[for="loginUsername"]');
      
      if(title) title.textContent = 'Login';
      if(loginForm) loginForm.style.display = 'block';
      if(createForm) createForm.style.display = 'none';
      if(forgotForm) forgotForm.style.display = 'none';
      if(changeForm) changeForm.style.display = 'none';
      
      // SIKRER at brugernavn-feltet altid er synligt
      if(usernameInput) {
        usernameInput.style.display = 'block';
        usernameInput.style.visibility = 'visible';
        usernameInput.style.opacity = '1';
      }
      if(usernameLabel) {
        usernameLabel.style.display = 'block';
        usernameLabel.style.visibility = 'visible';
        usernameLabel.style.opacity = '1';
      }
      
      // Pre-fill brugernavn hvis det er gemt
      try {
        const storedUsername = localStorage.getItem(USERNAME_KEY);
        if(usernameInput && storedUsername) {
          usernameInput.value = storedUsername;
          setTimeout(() => usernameInput.focus(), 100);
        } else if(passwordInput) {
          setTimeout(() => passwordInput.focus(), 100);
        }
      } catch(e) {
        console.warn('Fejl ved pre-fill af brugernavn:', e);
      if(passwordInput) {
        setTimeout(() => passwordInput.focus(), 100);
        }
      }
    }
  } catch(error) {
    console.error('Fejl ved visning af login modal:', error);
  }
}

function showForgotPassword(){
  try {
    const title = $('loginTitle');
    const loginForm = $('loginForm');
    const createForm = $('createPasswordForm');
    const forgotForm = $('forgotPasswordForm');
    const changeForm = $('changePasswordForm');
    const forgotEmailInput = $('forgotEmail');
    
    if(title) title.textContent = 'Glemt password';
    if(loginForm) loginForm.style.display = 'none';
    if(createForm) createForm.style.display = 'none';
    if(forgotForm) forgotForm.style.display = 'block';
    if(changeForm) changeForm.style.display = 'none';
    if(forgotEmailInput) forgotEmailInput.focus();
  } catch(error) {
    console.error('Fejl ved visning af glemt password form:', error);
  }
}

function showLoginForm(){
  try {
    const title = $('loginTitle');
    const loginForm = $('loginForm');
    const createForm = $('createPasswordForm');
    const forgotForm = $('forgotPasswordForm');
    const changeForm = $('changePasswordForm');
    const passwordInput = $('loginPassword');
    const usernameInput = $('loginUsername');
    const usernameLabel = document.querySelector('label[for="loginUsername"]');
    
    if(title) title.textContent = 'Login';
    if(loginForm) loginForm.style.display = 'block';
    if(createForm) createForm.style.display = 'none';
    if(forgotForm) forgotForm.style.display = 'none';
    if(changeForm) changeForm.style.display = 'none';
    
    // SIKRER at brugernavn-feltet altid er synligt
    if(usernameInput) {
      usernameInput.style.display = 'block';
      usernameInput.style.visibility = 'visible';
      usernameInput.style.opacity = '1';
    }
    if(usernameLabel) {
      usernameLabel.style.display = 'block';
      usernameLabel.style.visibility = 'visible';
      usernameLabel.style.opacity = '1';
    }
    
    // Pre-fill brugernavn hvis det er gemt
    const storedUsername = localStorage.getItem(USERNAME_KEY);
    if(usernameInput && storedUsername) {
      usernameInput.value = storedUsername;
      setTimeout(() => usernameInput.focus(), 100);
    } else if(passwordInput) {
      setTimeout(() => passwordInput.focus(), 100);
    }
  } catch(error) {
    console.error('Fejl ved visning af login form:', error);
  }
}

function resetPasswordViaEmail(){
  const email = $('forgotEmail')?.value?.trim();
  if(!email || !email.includes('@')){
    showLoginError('Indtast en gyldig recovery email');
    return;
  }
  
  const storedEmail = localStorage.getItem(RECOVERY_EMAIL_KEY);
  const storedEmailHash = localStorage.getItem(RECOVERY_EMAIL_HASH_KEY);
  const inputEmailHash = hashPassword(email.toLowerCase());
  
  // Tjek b√•de direkte match og hash match for ekstra sikkerhed
  if(!storedEmail || (storedEmail.toLowerCase() !== email.toLowerCase() && storedEmailHash !== inputEmailHash)){
    showLoginError('Denne email er ikke registreret som recovery email. Kun den email der blev oprettet f√∏rste gang kan bruges til at nulstille password.');
    return;
  }
  
  // Generer et midlertidigt nulstillingslink (simuleret)
  // I en rigtig applikation ville dette sendes via email
  const resetCode = Math.random().toString(36).substring(2, 10).toUpperCase();
  localStorage.setItem('k√∏kkenlager_reset_code', resetCode);
  localStorage.setItem('k√∏kkenlager_reset_email', email);
  localStorage.setItem('k√∏kkenlager_reset_expiry', Date.now() + 3600000); // 1 time
  
  // Vis nulstillingskode (i en rigtig app ville dette sendes via email)
  alert(`Nulstillingskode sendt til ${email}\n\nNulstillingskode: ${resetCode}\n\n(Bem√¶rk: I en rigtig applikation ville denne kode blive sendt via email. Indtast koden nedenfor for at nulstille password.)`);
  
  // Vis nulstillingsform
  $('loginTitle').textContent = 'Nulstil password';
  $('forgotPasswordForm').innerHTML = `
    <p style="margin-bottom:16px; color:#666;">Indtast nulstillingskoden og dit nye password</p>
    <label for="resetCode">Nulstillingskode</label>
    <input type="text" id="resetCode" placeholder="Indtast kode" style="text-transform:uppercase" />
    <label for="resetNewPassword">Nyt password</label>
    <input type="password" id="resetNewPassword" placeholder="Indtast nyt password" autocomplete="new-password" />
    <label for="resetConfirmPassword">Bekr√¶ft nyt password</label>
    <input type="password" id="resetConfirmPassword" placeholder="Bekr√¶ft nyt password" autocomplete="new-password" />
    <div class="actions">
      <button onclick="completePasswordReset()">Nulstil password</button>
      <button class="secondary" onclick="showLoginForm()">Tilbage</button>
    </div>
  `;
  $('resetCode').focus();
}

function completePasswordReset(){
  const resetCode = $('resetCode')?.value?.trim().toUpperCase();
  const newPass = $('resetNewPassword')?.value;
  const confirmPass = $('resetConfirmPassword')?.value;
  const storedCode = localStorage.getItem('k√∏kkenlager_reset_code');
  const storedResetEmail = localStorage.getItem('k√∏kkenlager_reset_email');
  const expiry = parseInt(localStorage.getItem('k√∏kkenlager_reset_expiry') || '0');
  
  if(!resetCode || resetCode !== storedCode){
    showLoginError('Ugyldig eller forkert nulstillingskode');
    return;
  }
  
  if(Date.now() > expiry){
    showLoginError('Nulstillingskoden er udl√∏bet. Anmod om en ny.');
    localStorage.removeItem('k√∏kkenlager_reset_code');
    localStorage.removeItem('k√∏kkenlager_reset_email');
    localStorage.removeItem('k√∏kkenlager_reset_expiry');
    showForgotPassword();
    return;
  }
  
  // Valider at email'en matcher den gemte recovery email
  const storedRecoveryEmail = localStorage.getItem(RECOVERY_EMAIL_KEY);
  if(!storedResetEmail || storedResetEmail.toLowerCase() !== storedRecoveryEmail?.toLowerCase()){
    showLoginError('Email validering fejlede. Kun den oprindelige recovery email kan bruges.');
    localStorage.removeItem('k√∏kkenlager_reset_code');
    localStorage.removeItem('k√∏kkenlager_reset_email');
    localStorage.removeItem('k√∏kkenlager_reset_expiry');
    showForgotPassword();
    return;
  }
  
  if(!newPass || newPass.length < 4){
    showLoginError('Password skal v√¶re mindst 4 tegn');
    return;
  }
  
  if(newPass !== confirmPass){
    showLoginError('Passwords matcher ikke');
    return;
  }
  
  // Nulstil password (bevar recovery email)
  // Brug brugernavn hvis det findes
  const storedUsername = localStorage.getItem(USERNAME_KEY);
  const hash = storedUsername ? hashPassword(newPass, storedUsername) : hashPassword(newPass);
  localStorage.setItem(PASSWORD_KEY, hash);
  // Recovery email forbliver u√¶ndret - kun password nulstilles
  
  // Ryd op
  localStorage.removeItem('k√∏kkenlager_reset_code');
  localStorage.removeItem('k√∏kkenlager_reset_email');
  localStorage.removeItem('k√∏kkenlager_reset_expiry');
  
  alert('Password nulstillet! Du kan nu logge ind med dit nye password.');
  showLoginForm();
}

function showChangePasswordModal(){
  const modal = $('loginModal');
  if(!modal) return;
  document.body.classList.add('login-active');
  modal.classList.remove('hidden');
  $('loginTitle').textContent = 'Skift password';
  $('loginForm').style.display = 'none';
  $('createPasswordForm').style.display = 'none';
  $('forgotPasswordForm').style.display = 'none';
  $('changePasswordForm').style.display = 'block';
  
  // Vis nuv√¶rende recovery email
  const currentEmail = localStorage.getItem(RECOVERY_EMAIL_KEY);
  const emailDisplay = $('currentRecoveryEmailDisplay');
  if(emailDisplay){
    emailDisplay.textContent = currentEmail || 'Ingen sat';
  }
  if($('changeRecoveryEmail')){
    $('changeRecoveryEmail').value = currentEmail || '';
  }
  
  $('currentPassword').focus();
}

function closeChangePasswordModal(){
  const modal = $('loginModal');
  if(!modal) return;
  modal.classList.add('hidden');
  document.body.classList.remove('login-active');
  $('currentPassword').value = '';
  $('changeNewPassword').value = '';
  $('changeConfirmPassword').value = '';
  if($('changeRecoveryEmail')){
    $('changeRecoveryEmail').value = '';
  }
}

function changePassword(){
  const currentPass = $('currentPassword')?.value;
  const newPass = $('changeNewPassword')?.value;
  const confirmPass = $('changeConfirmPassword')?.value;
  const newRecoveryEmail = $('changeRecoveryEmail')?.value?.trim();
  
  if(!currentPass){
    showLoginError('Indtast dit nuv√¶rende password');
    return;
  }
  
  // Tjek nuv√¶rende password
  const storedHash = localStorage.getItem(PASSWORD_KEY);
  const storedUsername = localStorage.getItem(USERNAME_KEY);
  // Backward compatibility: Hvis der ikke er brugernavn, brug kun password
  const currentHash = storedUsername ? hashPassword(currentPass, storedUsername) : hashPassword(currentPass);
  if(storedHash !== currentHash){
    showLoginError('Forkert nuv√¶rende password');
    $('currentPassword').value = '';
    return;
  }
  
  // Hvis nyt password er angivet, valider det
  if(newPass){
    if(newPass.length < 4){
      showLoginError('Nyt password skal v√¶re mindst 4 tegn');
      return;
    }
    
    if(newPass !== confirmPass){
      showLoginError('Passwords matcher ikke');
      return;
    }
    
    // Opdater password - brug brugernavn hvis det findes
    const storedUsername = localStorage.getItem(USERNAME_KEY);
    const newHash = storedUsername ? hashPassword(newPass, storedUsername) : hashPassword(newPass);
    localStorage.setItem(PASSWORD_KEY, newHash);
  }
  
  // Hvis ny recovery email er angivet, opdater den
  if(newRecoveryEmail && newRecoveryEmail.includes('@')){
    const emailHash = hashPassword(newRecoveryEmail.toLowerCase());
    localStorage.setItem(RECOVERY_EMAIL_KEY, newRecoveryEmail.toLowerCase());
    localStorage.setItem(RECOVERY_EMAIL_HASH_KEY, emailHash);
    alert('Password og recovery email opdateret!');
  } else if(newPass){
    alert('Password √¶ndret!');
  } else if(newRecoveryEmail && !newRecoveryEmail.includes('@')){
    showLoginError('Recovery email skal v√¶re en gyldig email');
    return;
  }
  
  closeChangePasswordModal();
}

// ================================
// LICENS SYSTEM
// ================================
const LICENSE_KEY = 'license.key';
const TRIAL_DAYS = 30;
const INSTALLATION_ID_KEY = 'app_installation_id';

// Pr√∏veversion begr√¶nsninger
const TRIAL_MAX_VARER = 50;  // Max antal varer i pr√∏veversion
const TRIAL_MAX_REPORTS = 10; // Max antal rapporter i pr√∏veversion

// Tjek om bruger har pr√∏veversion
function isTrialVersion(){
  const licenseStatus = checkLicense();
  return licenseStatus.type === 'trial' && licenseStatus.valid;
}

// Tjek pr√∏veversion begr√¶nsninger
function checkTrialLimits(action){
  if(!isTrialVersion()) return true; // Ingen begr√¶nsninger hvis ikke pr√∏veversion
  
  if(action === 'add_vare'){
    const currentCount = masterVarelager ? masterVarelager.length : 0;
    if(currentCount >= TRIAL_MAX_VARER){
      alert(`‚ö†Ô∏è PR√òVEVERSION BEGR√ÜNSNING\n\nDu har n√•et gr√¶nsen p√• ${TRIAL_MAX_VARER} varer i pr√∏veversionen.\n\nFor at tilf√∏je flere varer, skal du aktivere en fuld licens.\n\nG√• til "Licens" menuen for at aktivere din licens.`);
      return false;
    }
    if(currentCount >= TRIAL_MAX_VARER - 5){
      alert(`‚ö†Ô∏è PR√òVEVERSION ADVARSEL\n\nDu har ${TRIAL_MAX_VARER - currentCount} varer tilbage i pr√∏veversionen.\n\nMax ${TRIAL_MAX_VARER} varer er tilladt i pr√∏veversionen.`);
    }
  }
  
  if(action === 'add_report'){
    const currentCount = reports ? reports.length : 0;
    if(currentCount >= TRIAL_MAX_REPORTS){
      alert(`‚ö†Ô∏è PR√òVEVERSION BEGR√ÜNSNING\n\nDu har n√•et gr√¶nsen p√• ${TRIAL_MAX_REPORTS} rapporter i pr√∏veversionen.\n\nFor at oprette flere rapporter, skal du aktivere en fuld licens.\n\nG√• til "Licens" menuen for at aktivere din licens.`);
      return false;
    }
    if(currentCount >= TRIAL_MAX_REPORTS - 2){
      alert(`‚ö†Ô∏è PR√òVEVERSION ADVARSEL\n\nDu har ${TRIAL_MAX_REPORTS - currentCount} rapporter tilbage i pr√∏veversionen.\n\nMax ${TRIAL_MAX_REPORTS} rapporter er tilladt i pr√∏veversionen.`);
    }
  }
  
  return true;
}

// Generer eller hent unikt installations-ID
function getInstallationId(){
  // Tjek f√∏rst om der er et pre-genereret installations-ID (fra installation)
  // Dette sikrer at hver installation f√•r sit eget unikke ID
  if(typeof PRE_GENERATED_INSTALLATION_ID !== 'undefined' && PRE_GENERATED_INSTALLATION_ID){
    // Brug pre-genereret ID fra installation
    const preId = PRE_GENERATED_INSTALLATION_ID;
    // Gem det i localStorage s√• det bliver brugt fremover
    localStorage.setItem(INSTALLATION_ID_KEY, preId);
    return preId;
  }
  
  // Hvis ikke, tjek localStorage (bagudkompatibilitet)
  let installId = localStorage.getItem(INSTALLATION_ID_KEY);
  if(!installId){
    // Generer unikt ID baseret p√• browser fingerprint og timestamp
    const fingerprint = [
      navigator.userAgent,
      navigator.language,
      screen.width + 'x' + screen.height,
      new Date().getTimezoneOffset(),
      Date.now()
    ].join('|');
    
    // Generer hash af fingerprint
    let hash = 0;
    for(let i = 0; i < fingerprint.length; i++){
      const char = fingerprint.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash;
    }
    
    // Kombiner med timestamp og random
    installId = 'INST-' + Math.abs(hash).toString(36).toUpperCase() + '-' + Date.now().toString(36).toUpperCase() + '-' + Math.floor(Math.random() * 10000).toString(36).toUpperCase();
    localStorage.setItem(INSTALLATION_ID_KEY, installId);
  }
  return installId;
}

function checkLicense(){
  try {
    // Tjek om licensfil eksisterer
    const licenseData = localStorage.getItem('app_license');
    if(!licenseData){
      // Ingen licens - start pr√∏veperiode
      const trialStart = Date.now();
      localStorage.setItem('app_license', JSON.stringify({
        type: 'trial',
        startDate: trialStart,
        endDate: trialStart + (TRIAL_DAYS * 24 * 60 * 60 * 1000),
        licenseKey: null
      }));
      return { valid: true, type: 'trial', daysLeft: TRIAL_DAYS };
    }
    
    const license = JSON.parse(licenseData);
    const now = Date.now();
    
    // Tjek om det er en gyldig licensn√∏gle
    if(license.type === 'full' && license.licenseKey){
      const currentInstallationId = getInstallationId();
      
      // Tjek om installations-ID matcher
      if(license.installationId && license.installationId !== currentInstallationId){
        return { valid: false, message: 'Licensen er ikke gyldig for denne installation. Licensen er bundet til en anden installation.' };
      }
      
      // Valider licensn√∏gle (hash check med installations-ID)
      const keyToHash = license.licenseKeyOnly || license.licenseKey;
      const expectedHash = generateLicenseHash(keyToHash, currentInstallationId);
      if(license.hash === expectedHash && license.endDate && license.endDate > now){
        return { valid: true, type: 'full', daysLeft: Math.ceil((license.endDate - now) / (24 * 60 * 60 * 1000)) };
      }
    }
    
    // Tjek pr√∏veperiode
    if(license.type === 'trial' && license.endDate){
      if(now < license.endDate){
        const daysLeft = Math.ceil((license.endDate - now) / (24 * 60 * 60 * 1000));
        return { valid: true, type: 'trial', daysLeft: daysLeft };
      } else {
        return { valid: false, type: 'trial', daysLeft: 0, message: 'Pr√∏veperioden er udl√∏bet. Indtast en gyldig licensn√∏gle for at forts√¶tte.' };
      }
    }
    
    return { valid: false, message: 'Ugyldig licens. Kontakt support.' };
  } catch(e){
    console.error('Licens fejl:', e);
    return { valid: false, message: 'Fejl ved licensvalidering: ' + e.message };
  }
}

function generateLicenseHash(key, installationId = null){
  // Hash funktion der inkluderer installations-ID hvis angivet
  const dataToHash = installationId ? `${key}|${installationId}` : key;
  let hash = 0;
  for(let i = 0; i < dataToHash.length; i++){
    const char = dataToHash.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // Convert to 32bit integer
  }
  return Math.abs(hash).toString(16);
}

function activateLicense(licenseKey){
  try {
    if(!licenseKey || licenseKey.trim() === ''){
      return { success: false, message: 'Licensn√∏gle m√• ikke v√¶re tom' };
    }
    
    const key = licenseKey.trim();
    const installationId = getInstallationId();
    
    // Valider licensn√∏gle format (kan tilpasses)
    if(key.length < 10){
      return { success: false, message: 'Ugyldig licensn√∏gle format' };
    }
    
    // Tjek om licensn√∏glen indeholder installations-ID
    // Format: LIC-INSTALLATIONID-XXXXX-XXXXX eller LIC-XXXXX-XXXXX-XXXXX
    // Installations-ID kan indeholde bindestreger, s√• vi skal finde det korrekt
    let licenseInstallationId = null;
    let licenseKeyOnly = key;
    
    // Hvis licensn√∏glen starter med LIC-INST, s√• indeholder den installations-ID
    if(key.startsWith('LIC-INST-')){
      // Fjern "LIC-" fra starten
      const withoutLic = key.substring(4); // "INST-XXXXX-XXXXX-XXXXX-UNIQUE-DAYS"
      const parts = withoutLic.split('-');
      
      // Licensn√∏gle format fra generator: LIC-INSTALLATIONID-UNIQUE-DAYS
      // Eksempel: LIC-INST-M3UO1-MIEDCISU-627-ABC123-365
      // Vi ved at sidste del er dage (tal), og n√¶stsidste del er den unikke del (base36)
      // Installations-ID er alt f√∏r den unikke del
      
      // Find sidste del (dage) - skal v√¶re et tal
      const lastPart = parts[parts.length - 1];
      if(/^\d+$/.test(lastPart) && parts.length >= 3){
        // Sidste del er dage - installations-ID er alt undtagen de sidste 2 dele (unik del + dage)
        // Eksempel: parts = ["INST", "M3UO1", "MIEDCISU", "627", "ABC123", "365"]
        // Installations-ID = "INST-M3UO1-MIEDCISU-627" (f√∏rste 4 dele)
        // Unik del = "ABC123-365" (sidste 2 dele)
        licenseInstallationId = parts.slice(0, parts.length - 2).join('-');
        const uniquePart = parts.slice(parts.length - 2).join('-');
        licenseKeyOnly = 'LIC-' + uniquePart;
      }
    }
    
    // Valider at installations-ID matcher
    if(licenseInstallationId && licenseInstallationId !== installationId){
      return { success: false, message: 'Licensn√∏glen er ikke gyldig for denne installation. Licensen er bundet til en anden installation. Forventet: ' + installationId + ', Fandt: ' + licenseInstallationId };
    }
    
    // Generer hash med installations-ID
    const hash = generateLicenseHash(licenseKeyOnly, installationId);
    
    // Beregn udl√∏bsdato (1 √•r fra nu, eller tilpass efter behov)
    const endDate = Date.now() + (365 * 24 * 60 * 60 * 1000);
    
    localStorage.setItem('app_license', JSON.stringify({
      type: 'full',
      licenseKey: key,
      licenseKeyOnly: licenseKeyOnly,
      installationId: installationId,
      hash: hash,
      startDate: Date.now(),
      endDate: endDate
    }));
    
    return { success: true, message: 'Licens aktiveret succesfuldt!' };
  } catch(e){
    return { success: false, message: 'Fejl ved aktivering: ' + e.message };
  }
}

function showLicenseModal(){
  const licenseStatus = checkLicense();
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.id = 'licenseModal';
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal" style="max-width:500px;">
      <h3>${licenseStatus.valid ? 'Licens Status' : 'Licens P√•kr√¶vet'}</h3>
      <div style="padding:16px;">
        ${licenseStatus.valid ? 
          `<p style="color:#28a745; font-weight:bold;">‚úÖ ${licenseStatus.type === 'trial' ? 'Pr√∏veperiode aktiv' : 'Licens aktiv'}</p>
           <p>${licenseStatus.type === 'trial' ? `Dage tilbage: ${licenseStatus.daysLeft}` : `Licens gyldig til: ${new Date(licenseStatus.endDate || Date.now() + 365*24*60*60*1000).toLocaleDateString('da-DK')}`}</p>
           ${licenseStatus.type === 'trial' ? '<p style="color:#856404; font-size:14px;">Indtast en gyldig licensn√∏gle for at aktivere fuld licens.</p>' : ''}` :
          `<p style="color:#dc3545; font-weight:bold;">‚ùå ${licenseStatus.message || 'Licens p√•kr√¶vet'}</p>`
        }
        <div style="margin-top:20px;">
          <label><strong>Licensn√∏gle:</strong></label>
          <input type="text" id="licenseKeyInput" placeholder="Indtast licensn√∏gle" style="width:100%; margin-top:8px; padding:10px; font-size:16px; letter-spacing:2px;" />
        </div>
      </div>
      <div class="actions">
        <button class="secondary" onclick="closeLicenseModal()">Luk</button>
        <button onclick="activateLicenseFromModal()" style="background:#28a745;">Aktiver Licens</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

function closeLicenseModal(){
  const modal = document.getElementById('licenseModal');
  if(modal) modal.remove();
}

function activateLicenseFromModal(){
  const input = document.getElementById('licenseKeyInput');
  if(!input) return;
  const result = activateLicense(input.value);
  if(result.success){
    alert(result.message);
    closeLicenseModal();
    location.reload();
  } else {
    alert('Fejl: ' + result.message);
  }
}

function activateLicenseFromPage(){
  const input = document.getElementById('licenseKeyInputPage');
  if(!input) return;
  const result = activateLicense(input.value);
  if(result.success){
    alert(result.message);
    updateLicenseStatusDisplay();
    if(input) input.value = '';
    location.reload();
  } else {
    alert('Fejl: ' + result.message);
  }
}

function updateLicenseStatusDisplay(){
  const display = document.getElementById('licenseStatusDisplay');
  if(!display) return;
  
  // Opdater installations-ID display
  const installIdDisplay = document.getElementById('installationIdDisplay');
  if(installIdDisplay){
    installIdDisplay.value = getInstallationId();
  }
  
  // Opdater installationsmappe display
  const installPathDisplay = document.getElementById('installationPathDisplay');
  if(installPathDisplay){
    installPathDisplay.value = getInstallationPath();
  }
  
  const licenseStatus = checkLicense();
  if(licenseStatus.valid){
    const statusHtml = `
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="font-size:32px;">‚úÖ</span>
        <div>
          <h3 style="margin:0; color:#28a745;">${licenseStatus.type === 'trial' ? 'Pr√∏veperiode Aktiv' : 'Licens Aktiv'}</h3>
          <p style="margin:4px 0 0 0; color:#666;">
            ${licenseStatus.type === 'trial' 
              ? `Dage tilbage: <strong>${licenseStatus.daysLeft}</strong> dage` 
              : `Licens gyldig til: <strong>${new Date(licenseStatus.endDate || Date.now() + 365*24*60*60*1000).toLocaleDateString('da-DK')}</strong>`
            }
          </p>
          ${licenseStatus.type === 'trial' ? '<p style="margin:8px 0 0 0; color:#856404; font-size:14px;">Indtast en gyldig licensn√∏gle for at aktivere fuld licens.</p>' : ''}
        </div>
      </div>
    `;
    display.innerHTML = statusHtml;
  } else {
    const statusHtml = `
      <div style="display:flex; align-items:center; gap:12px;">
        <span style="font-size:32px;">‚ùå</span>
        <div>
          <h3 style="margin:0; color:#dc3545;">Licens P√•kr√¶vet</h3>
          <p style="margin:4px 0 0 0; color:#666;">${licenseStatus.message || 'Indtast en gyldig licensn√∏gle for at forts√¶tte.'}</p>
        </div>
      </div>
    `;
    display.innerHTML = statusHtml;
  }
}

function getInstallationPath(){
  // Pr√∏v at finde installationsmappen baseret p√• HTML filens placering
  try {
    // Hvis vi k√∏rer fra fil system, kan vi bruge window.location
    const currentPath = window.location.pathname || window.location.href;
    
    // Fjern filnavn fra stien
    let folderPath = currentPath;
    if(folderPath.includes('/')){
      folderPath = folderPath.substring(0, folderPath.lastIndexOf('/'));
    } else if(folderPath.includes('\\')){
      folderPath = folderPath.substring(0, folderPath.lastIndexOf('\\'));
    }
    
    // Hvis det er file:// protocol, konverter til Windows sti
    if(folderPath.startsWith('/')){
      // file:///C:/Users/... -> C:/Users/...
      folderPath = folderPath.substring(1).replace(/\//g, '\\');
    }
    
    // Standard placering hvis vi ikke kan finde det
    if(!folderPath || folderPath === '' || folderPath === '/'){
      return '%USERPROFILE%\\Documents\\k√∏kkenlager opt√¶lling';
    }
    
    return folderPath;
  } catch(e){
    console.warn('Kunne ikke finde installationsmappe:', e);
    return '%USERPROFILE%\\Documents\\k√∏kkenlager opt√¶lling';
  }
}

function openInstallationFolder(){
  const path = getInstallationPath();
  // Pr√∏v at √•bne mappen (virker kun hvis programmet k√∏rer fra fil system)
  try {
    // For Windows: pr√∏v at √•bne via file:// URL
    const folderUrl = 'file:///' + path.replace(/\\/g, '/');
    window.open(folderUrl, '_blank');
  } catch(e){
    alert('Kunne ikke √•bne mappen automatisk.\n\nInstallationsmappe:\n' + path + '\n\n√Öbn denne mappe manuelt i File Explorer.');
  }
}

function copyInstallationId(){
  const installIdDisplay = document.getElementById('installationIdDisplay');
  if(!installIdDisplay) return;
  
  installIdDisplay.select();
  installIdDisplay.setSelectionRange(0, 99999); // For mobile devices
  
  try {
    navigator.clipboard.writeText(installIdDisplay.value).then(() => {
      alert('‚úÖ Installations-ID kopieret til udklipsholder!');
    }).catch(() => {
      // Fallback
      document.execCommand('copy');
      alert('‚úÖ Installations-ID kopieret til udklipsholder!');
    });
  } catch(e) {
    // Fallback
    document.execCommand('copy');
    alert('‚úÖ Installations-ID kopieret til udklipsholder!');
  }
}

// Allow Enter key to submit - h√•ndteres i DOMContentLoaded nedenfor

/* ======================================================
   [JS 1] GLOBALS & HELPERS
   ====================================================== */
 // [JS 1.1] core data
let masterVarelager = [];
let lagerData = {};
let lagerLokationer = ['K√∏l','Frost','T√∏revare','Gr√∏nt'];
const APP_VERSION = '4.35';
const BUILD_DATE = '2026-01-07';
const BUILD_TIME = '12:45';

// Opdater versionsnummer i header
function updateVersionDisplay(){
  const versionDisplay = document.getElementById('versionDisplay');
  if(versionDisplay){
    versionDisplay.innerHTML = `v${APP_VERSION}<br><span style="font-size:12px; opacity:0.95; letter-spacing:0.2px;">${BUILD_DATE} ${BUILD_TIME}</span>`;
  }
  // Opdater ogs√• i title
  document.title = `Lager opt√¶lling ‚Äî F√¶rdig version v${APP_VERSION} (${BUILD_DATE} ${BUILD_TIME})`;
  
  // VIGTIGT: N√•r version opdateres, skal der laves backup!
  // Backup oprettes automatisk n√•r version opdateres via terminal kommando
  // Backup fil: "programmet backup\k√∏kkenlagerprogram_v${APP_VERSION}.html"
}
let leverandorer = [];
let reports = [];
let archivedReports = [];
let archivePeriod = 0; // 0 = ingen, 3 = 3 m√•neder, 6 = 6 m√•neder, 12 = 12 m√•neder
let activeSession = null;
let sessionCounter = 0;
let postnummerCache = {};
let postnrLookupTimeout = null;
let editingLeverandorIndex = null;

// $, genId og formatTime er allerede defineret tidligere i koden
function downloadFile(content, filename, type='text/plain'){ const b = new Blob([content], {type}); const url = URL.createObjectURL(b); const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url); }

/* ================================
   [JS 1.2] LOCALSTORAGE - Auto Save/Load
   ================================ */
const STORAGE_KEY = 'k√∏kkenlager_data';

function saveAllData(){
  try{
    // Ensure installation ID is included
    const installationId = getInstallationId();
    
    const dataToSave = {
      installationId: installationId, // Store main program installation ID
      masterVarelager,
      lagerData,
      lagerLokationer,
      leverandorer,
      reports,
      archivedReports,
      archivePeriod,
      sessionCounter,
      activeSession,
      version: '1.0',
      savedAt: Date.now()
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
  }catch(err){
    console.warn('Kunne ikke gemme data:', err);
  }
}

function loadAllData(){
  try{
    const saved = localStorage.getItem(STORAGE_KEY);
    if(!saved) return false;
    const data = JSON.parse(saved);
    if(data.masterVarelager) masterVarelager = data.masterVarelager;
    if(data.lagerData) lagerData = data.lagerData;
    if(data.lagerLokationer) {
      lagerLokationer = data.lagerLokationer;
    } else {
      // Hvis lagerLokationer ikke findes i data, brug standard
      if(!lagerLokationer || lagerLokationer.length === 0){
        lagerLokationer = ['K√∏l', 'Frost', 'T√∏revare', 'Gr√∏nt'];
      }
    }
    // Sikr at lagerLokationer er korrekt initialiseret
    if(!lagerLokationer || !Array.isArray(lagerLokationer)){
      lagerLokationer = ['K√∏l', 'Frost', 'T√∏revare', 'Gr√∏nt'];
    }
    if(data.leverandorer) leverandorer = data.leverandorer;
    if(data.reports) reports = data.reports;
    if(data.archivedReports) archivedReports = data.archivedReports;
    if(data.archivePeriod !== undefined) archivePeriod = data.archivePeriod;
    if(data.sessionCounter !== undefined) sessionCounter = data.sessionCounter;
    if(data.activeSession) activeSession = data.activeSession;
    return true;
  }catch(err){
    console.warn('Kunne ikke indl√¶se data:', err);
    return false;
  }
}

/* Ensure modals hidden at load og setup event listeners */
document.addEventListener('DOMContentLoaded', ()=>{
  try {
    // Vis login f√∏rst
    showLoginModal();
    
    // Allow Enter key to submit i login forms
    const loginUser = $('loginUsername');
    const loginPass = $('loginPassword');
    const newPass = $('newPassword');
    const confirmPass = $('confirmPassword');
    if(loginUser) {
      loginUser.addEventListener('keypress', (e)=>{ 
        if(e.key==='Enter') {
          const pass = $('loginPassword');
          if(pass) pass.focus();
        }
      });
    }
    if(loginPass) {
      loginPass.addEventListener('keypress', (e)=>{ 
        if(e.key==='Enter') attemptLogin(); 
      });
    }
    const userName = $('userName');
    if(userName) {
      userName.addEventListener('keypress', (e)=>{ 
        if(e.key==='Enter') {
          const email = $('recoveryEmail');
          if(email) email.focus();
        }
      });
    }
    if(newPass) {
      newPass.addEventListener('keypress', (e)=>{ 
        if(e.key==='Enter') {
          const confirm = $('confirmPassword');
          if(confirm) confirm.focus();
        }
      });
    }
    if(confirmPass) {
      confirmPass.addEventListener('keypress', (e)=>{ 
        if(e.key==='Enter') createPassword(); 
      });
    }
    
    // Tillad Enter key i stregkode input (konsolideret fra anden listener)
    const barcodeInput = $('manualBarcodeInput');
    if(barcodeInput){
      barcodeInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter'){
          tilfoejFraStregkode();
        }
      });
    }
    
    // Skjul alle modals ved opstart
    ['startModal','finishModal','importModal','scannerModal','phoneLinkModal'].forEach(id=>{
      const el = $(id);
      if(!el) {
        console.warn(`Modal med id "${id}" ikke fundet`);
        return;
      }
      el.classList.add('hidden');
      el.style.display = 'none';
    });
    
    // App initialiseres kun efter succesfuldt login (se hideLoginModal)
  } catch(error) {
    console.error('Fejl ved DOMContentLoaded initialisering:', error);
  }
});

function initializeApp(){
  // Opdater version display
  updateVersionDisplay();
  
  // Tjek licens igen ved initialisering
  const licenseStatus = checkLicense();
  if(!licenseStatus.valid){
    showLicenseModal();
    return;
  }
  
  // Sikr at login-active er fjernet
  document.body.classList.remove('login-active');
  
  // Brug en lille delay for at sikre CSS √¶ndringen er anvendt
  setTimeout(() => {
    // Pr√∏v at indl√¶se gemte data
    const hasData = loadAllData();
    
    // Fjern Vinlager fra lagerLokationer hvis det findes (kun for ops√¶tning lager)
    if(lagerLokationer.includes('Vinlager')){
      lagerLokationer = lagerLokationer.filter(loc => loc !== 'Vinlager');
      saveAllData();
    }
    
    // Ved ny installation: Start ALTID med tomt lager (ingen demo data)
    const isNewInstallation = typeof PRE_GENERATED_INSTALLATION_ID !== 'undefined' && 
                               PRE_GENERATED_INSTALLATION_ID;
    
    if(!hasData){
      if(isNewInstallation){
        // Ny installation: Start med tomt lager (ingen demo data)
        masterVarelager = [];
        lagerData = {};
        // Opret tomme lokationer hvis de ikke findes
        if(!lagerLokationer || lagerLokationer.length === 0){
          lagerLokationer = ['K√∏l', 'Frost', 'T√∏revare', 'Gr√∏nt'];
        }
        // Fjern Vinlager fra lagerLokationer hvis det findes
        if(lagerLokationer.includes('Vinlager')){
          lagerLokationer = lagerLokationer.filter(loc => loc !== 'Vinlager');
        }
        lagerLokationer.forEach(l => {
          if(!lagerData[l]) lagerData[l] = {};
        });
        reports = [];
        archivedReports = [];
        leverandorer = [];
        saveAllData(); // Gem tomt lager
      } else {
        // Gammel installation uden data: Seed demo (bagudkompatibilitet)
        seedDemo();
      }
    }
    
    updateAllSelects();
    renderMasterTable();
    renderLagerOpsaetning();
    renderLagerTable();
    
    // Indl√¶s arkiv indstillinger
    const archivePeriodSelect = $('archivePeriod');
    if(archivePeriodSelect){
      archivePeriodSelect.value = archivePeriod || 0;
    }
    
    // Opdater dato inputs
    updateReportsDateInputs();
    
    // Tjek automatisk arkivering hvis aktiveret (f√∏r renderReports)
    if(archivePeriod > 0){
      checkAndArchiveReports(false); // false = ingen alert ved automatisk kald
    }
    
    renderReports();
    renderArchivedReports();
    updateLogPreview();
    setupPostnummerLookup();
    // Initialiser hylle reol/hylle dropdowns
    updateHylleReolSelect();
    updateHylleHylleSelect();
    
    // Tjek for manuel opt√¶lling data ved opstart
    checkForManualCountingData();
    
    // Optimerede interval checks - √©n samlet funktion i stedet for tre separate
    let lastSaveTime = Date.now();
    let lastManualCheckTime = Date.now();
    let lastReportsCheckTime = Date.now();
    
    // Samlet interval funktion der h√•ndterer alle periodiske opgaver
    setInterval(function() {
      try {
        const now = Date.now();
        
        // Auto-save hver 30 sekunder
        if(now - lastSaveTime >= 30000) {
          saveAllData();
          lastSaveTime = now;
        }
        
        // Tjek for manuel opt√¶lling data hver 10 sekunder
        if(now - lastManualCheckTime >= 10000) {
          checkForManualCountingData();
          lastManualCheckTime = now;
        }
        
        // Tjek for nye rapporter automatisk hver 5 sekunder
        if(now - lastReportsCheckTime >= 5000) {
          const storageKey = 'k√∏kkenlager_data';
          const mainData = localStorage.getItem(storageKey);
          if(mainData) {
            try {
              const data = JSON.parse(mainData);
              if(data.reports && Array.isArray(data.reports)) {
                // Check if reports count changed
                if(data.reports.length !== reports.length) {
                  // Reload reports from localStorage
                  reports = data.reports;
                  // Update sessionCounter
                  if(data.sessionCounter !== undefined) {
                    sessionCounter = data.sessionCounter;
                  }
                  // Refresh display if on reports page
                  const reportsSection = document.getElementById('rapporter');
                  if(reportsSection && !reportsSection.classList.contains('hidden')) {
                    renderReports();
                    updateLogPreview();
                  }
                  console.log('Reports automatically refreshed. Count:', reports.length);
                }
              }
            } catch(e) {
              console.error('Error checking reports:', e);
            }
          }
          lastReportsCheckTime = now;
        }
      } catch(error) {
        console.error('Fejl i interval check:', error);
      }
    }, 5000); // K√∏r hver 5 sekunder, men udf√∏r opgaver baseret p√• deres individuelle intervaller
    
    // Gem data n√•r siden lukkes
    window.addEventListener('beforeunload', ()=>{
      saveAllData();
      stopScanner(); // Luk scanner hvis aktiv
    });
    
    // Setup logo upload handler
    const logoUpload = $('logoUpload');
    if(logoUpload){
      logoUpload.addEventListener('change', function(e){
        const file = e.target.files[0];
        if(!file) return;
        if(!file.type.startsWith('image/')){
          alert('V√¶lg en billedfil');
          return;
        }
        const reader = new FileReader();
        reader.onload = function(e){
          const logoDataURL = e.target.result;
          // Gem logo i localStorage
          try {
            localStorage.setItem('custom_logo', logoDataURL);
          } catch(err) {
            console.warn('Kunne ikke gemme logo:', err);
          }
          // Opdater logo i UI
          const logoWrap = document.querySelector('.logo-svg');
          if(logoWrap){
            logoWrap.innerHTML = `<img src="${logoDataURL}" style="width:100%;height:100%;object-fit:contain;" alt="Logo" />`;
          }
          saveAllData(); // Gem ogs√• i hoveddata
        };
        reader.readAsDataURL(file);
      });
    }
    
    // Indl√¶s gemt logo ved opstart
    try {
      const savedLogo = localStorage.getItem('custom_logo');
      if(savedLogo){
        const logoWrap = document.querySelector('.logo-svg');
        if(logoWrap){
          logoWrap.innerHTML = `<img src="${savedLogo}" style="width:100%;height:100%;object-fit:contain;" alt="Logo" />`;
        }
      }
    } catch(err) {
      console.warn('Kunne ikke indl√¶se gemt logo:', err);
    }
  }, 50);
}

/* update selects used in UI */
function updateAllSelects(){
  const lagerSel = $('lagerLokationSelect');
  if(lagerSel){
    lagerSel.innerHTML = '';
    lagerSel.add(new Option('Alle opt√¶llinger',''));
    lagerLokationer.forEach(l => lagerSel.add(new Option(l,l)));
  }
  ['reportsLocation','filterPlacement','masterPlaceringFilter','labelSelect','startScope','hylleLagerSelect','optalLagerSelect'].forEach(id=>{
    const s = $(id);
    if(!s) return;
    s.innerHTML='';
    if(id==='reportsLocation' || id==='filterPlacement') s.add(new Option('Alle',''));
    if(id==='startScope') s.add(new Option('Alle lokationer',''));
    if(id==='hylleLagerSelect' || id==='optalLagerSelect') s.add(new Option('V√¶lg lager...',''));
    lagerLokationer.forEach(l => s.add(new Option(l,l)));
    
    // Auto-size dropdown for filterPlacement
    if(id === 'filterPlacement'){
      setTimeout(() => autoSizeSelect(s), 100); // Delay for at sikre DOM er klar
    }
  });
  lagerLokationer.forEach(l => { if(!lagerData[l]) lagerData[l] = {}; });
}

// Auto-size select dropdown baseret p√• indhold
function autoSizeSelect(selectElement){
  if(!selectElement) return;
  
  // Opret en midlertidig element for at m√•le tekst bredde
  const tempSelect = document.createElement('select');
  tempSelect.style.position = 'absolute';
  tempSelect.style.visibility = 'hidden';
  tempSelect.style.height = 'auto';
  tempSelect.style.width = 'auto';
  tempSelect.style.fontSize = window.getComputedStyle(selectElement).fontSize;
  tempSelect.style.fontFamily = window.getComputedStyle(selectElement).fontFamily;
  document.body.appendChild(tempSelect);
  
  let maxWidth = 120; // Minimum bredde
  
  // M√•l hver option
  for(let i = 0; i < selectElement.options.length; i++){
    const option = selectElement.options[i];
    tempSelect.innerHTML = '';
    const tempOption = document.createElement('option');
    tempOption.textContent = option.textContent;
    tempSelect.appendChild(tempOption);
    
    const width = tempSelect.scrollWidth;
    if(width > maxWidth){
      maxWidth = width;
    }
  }
  
  document.body.removeChild(tempSelect);
  
  // S√¶t bredde med padding (max 250px, min 120px)
  const finalWidth = Math.max(120, Math.min(maxWidth + 40, 250));
  selectElement.style.width = finalWidth + 'px';
}

// Opdater s√∏gefelt n√•r lager √¶ndres
function updateSearchFilter(){
  const lagerSelect = $('lagerLokationSelect');
  const masterSearch = $('masterSearch');
  const locationSearch = $('lagerLokationSearch');
  if(!lagerSelect || !masterSearch) return;
  const selectedLager = lagerSelect.value;
  
  // Opdater lokation s√∏gefelt
  if(locationSearch && selectedLager){
    locationSearch.value = selectedLager;
  } else if(locationSearch && !selectedLager){
    locationSearch.value = '';
  }
  
  if(selectedLager){
    masterSearch.placeholder = `S√∏g i ${selectedLager}...`;
    // Ryd s√∏gefelt n√•r lager √¶ndres
    masterSearch.value = '';
    const autocomplete = $('masterAutocomplete');
    if(autocomplete){
      autocomplete.innerHTML = '';
      autocomplete.style.display = 'none';
    }
  } else {
    masterSearch.placeholder = 'Skriv varenavn eller stregkode - tryk Enter for at tilf√∏je...';
  }
}

/* ================================
   [JS 2] OPS√ÜTNING LAGER (drag/drop)
   ================================ */
function tilfoejLager(){ const name = $('nyLagerNavn').value.trim(); if(!name) return alert('Indtast lagernavn'); if(lagerLokationer.includes(name)) return alert('Lokation findes allerede'); lagerLokationer.push(name); $('nyLagerNavn').value=''; renderLagerOpsaetning(); updateAllSelects(); saveAllData(); }
function resetLocations(){ if(confirm('Reset til demo-lokationer?')){ lagerLokationer=['K√∏l','Frost','T√∏revare','Gr√∏nt']; renderLagerOpsaetning(); updateAllSelects(); saveAllData(); } }
function renderLagerOpsaetning(){
  const ul=$('lagerOpsaetning'); if(!ul) return; ul.innerHTML='';
  lagerLokationer.forEach((loc,i)=>{
    const li = document.createElement('li'); li.draggable=true; li.dataset.index=i;
    li.style.display="flex"; li.style.alignItems="center"; li.style.justifyContent="space-between";
    li.style.padding="6px 10px"; li.style.border="1px solid #ccc"; li.style.borderRadius="6px"; li.style.background="#fff"; li.style.marginBottom="8px";
    li.innerHTML = `<strong>${loc}</strong> <button class="secondary small" onclick="deleteLocation(${i})">üóëÔ∏è Slet</button>`;
    li.addEventListener('dragstart', ()=> li.classList.add('dragging')); li.addEventListener('dragend', ()=> li.classList.remove('dragging'));
    ul.appendChild(li);
  });
  ul.addEventListener('dragover', e=>{
    e.preventDefault();
    const dragging = ul.querySelector('.dragging'); if(!dragging) return;
    const after = getDragAfterElement(ul, e.clientY);
    if(after==null) ul.appendChild(dragging); else ul.insertBefore(dragging, after);
  });
  ul.addEventListener('drop', ()=>{
    const newOrder=[]; ul.querySelectorAll('li').forEach(li=> newOrder.push(li.querySelector('strong').textContent));
    lagerLokationer = newOrder; updateAllSelects(); renderLagerOpsaetning();
  });
}
function getDragAfterElement(container,y){ const els=[...container.querySelectorAll('li:not(.dragging)')]; return els.reduce((closest,child)=>{ const box = child.getBoundingClientRect(); const offset = y - box.top - box.height/2; if(offset<0 && offset>closest.offset) return {offset, element:child}; return closest; }, {offset:Number.NEGATIVE_INFINITY}).element || null; }
function deleteLocation(i){ if(!confirm('Slet lokation?')) return; const name = lagerLokationer[i]; lagerLokationer.splice(i,1); delete lagerData[name]; renderLagerOpsaetning(); updateAllSelects(); saveAllData(); }

/* ======================================================
   [JS 3] MASTER VARELAGER ‚Äî FIXED VERSION
   ====================================================== */

function renderMasterTable(){
    const t = $('masterTable');
    if (!t) return;
    t.innerHTML = "";

    const filter = $('filterPlacement')?.value || "";
    const searchText = ($('masterSearchInput')?.value || "").toLowerCase().trim();

    // Filtrer og sorter
    let filtered = [...masterVarelager];
    
    // S√∏g efter tekst
    if (searchText) {
        filtered = filtered.filter(v => 
            (v.navn || '').toLowerCase().includes(searchText) ||
            (v.placering || '').toLowerCase().includes(searchText) ||
            (v.maaleenhed || '').toLowerCase().includes(searchText)
        );
    }
    
    // Filtrer efter placering
    if (filter) {
        filtered = filtered.filter(v => v.placering === filter);
    }

    // Sorter efter placering, derefter reolNr, derefter hylleNr, derefter r√¶kkef√∏lge
    const sorted = filtered.sort((a, b) => {
        if (a.placering !== b.placering) return (a.placering || '').localeCompare(b.placering || '');
        if ((a.reolNr || '') !== (b.reolNr || '')) return (a.reolNr || '').localeCompare(b.reolNr || '');
        if ((a.hylleNr || '') !== (b.hylleNr || '')) return (a.hylleNr || '').localeCompare(b.hylleNr || '');
        if (a.raekkefoelge !== b.raekkefoelge) return (a.raekkefoelge || 0) - (b.raekkefoelge || 0);
        return 0;
    });

    // Opdater info tekst
    const infoEl = $('masterTableInfo');
    if (infoEl) {
        if (searchText || filter) {
            infoEl.textContent = `Viser ${sorted.length} af ${masterVarelager.length} varer`;
        } else {
            infoEl.textContent = `Total: ${masterVarelager.length} varer`;
        }
    }

    // Pagination - vis kun f√∏rste 30 varer ad gangen for bedre performance
    const itemsPerPage = 30;
    const currentPage = window.masterTablePage || 1;
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const paginatedItems = sorted.slice(startIndex, endIndex);

    paginatedItems.forEach(v => {
        const tr = document.createElement("tr");
        
        // Billede cell - klikbart for at uploade nyt billede
        let imageCell = '<td style="text-align:center; padding:8px;">';
        if(v.billede) {
            imageCell += `<img src="${v.billede}" alt="${v.navn}" style="width:60px; height:60px; object-fit:contain; border:2px solid #0078D4; border-radius:4px; cursor:pointer;" onclick="uploadVareImage('${v.id}')" title="Klik for at uploade nyt billede">`;
        } else {
            imageCell += `<div style="width:60px; height:60px; border:2px dashed #ccc; border-radius:4px; display:flex; align-items:center; justify-content:center; cursor:pointer; color:#999; font-size:11px;" onclick="uploadVareImage('${v.id}')" title="Klik for at uploade billede">+ Billede</div>`;
        }
        imageCell += '</td>';

        tr.innerHTML = `
            ${imageCell}
            <td onclick="editMasterName('${v.id}')" style="cursor:pointer">${v.navn}</td>
            <td onclick="editMasterVarenummer('${v.id}')" style="cursor:pointer; color:#0066cc; font-weight:600;">${v.varenummer || '-'}</td>
            <td onclick="editMasterUnit('${v.id}')" style="cursor:pointer">${v.maaleenhed}</td>
            <td onclick="editMasterPrice('${v.id}')" style="cursor:pointer">${v.pris.toFixed(2)} kr.</td>
            <td onclick="editMasterLocation('${v.id}')" style="cursor:pointer">${v.placering || '-'}</td>
            <td onclick="editMasterReolNr('${v.id}')" style="cursor:pointer">${v.reolNr || '-'}</td>
            <td onclick="editMasterHylleNr('${v.id}')" style="cursor:pointer">${v.hylleNr || '-'}</td>
            <td onclick="editMasterRaekkefoelge('${v.id}')" style="cursor:pointer">${v.raekkefoelge || 0}</td>
            <td><button class="secondary small" onclick="deleteMasterVare('${v.id}')">üóëÔ∏è Slet</button></td>
        `;
        t.appendChild(tr);
    });

    // Tilf√∏j pagination controls hvis der er flere sider
    if (sorted.length > itemsPerPage) {
        const totalPages = Math.ceil(sorted.length / itemsPerPage);
        const paginationRow = document.createElement('tr');
        paginationRow.style.background = '#f9f9f9';
        paginationRow.innerHTML = `
            <td colspan="10" style="text-align:center; padding:12px;">
                <button class="secondary small" onclick="window.masterTablePage = Math.max(1, (window.masterTablePage || 1) - 1); renderMasterTable();" ${currentPage === 1 ? 'disabled' : ''}>‚óÄ Forrige</button>
                <span style="margin:0 12px; color:#666;">Side ${currentPage} af ${totalPages} (${sorted.length} varer)</span>
                <button class="secondary small" onclick="window.masterTablePage = Math.min(${totalPages}, (window.masterTablePage || 1) + 1); renderMasterTable();" ${currentPage === totalPages ? 'disabled' : ''}>N√¶ste ‚ñ∂</button>
            </td>
        `;
        t.appendChild(paginationRow);
    } else {
        window.masterTablePage = 1; // Reset hvis der er f√¶rre end itemsPerPage
    }

    // update dropdowns (single & labels)
    updateLabelSingleSelect();

    const masterSelect = $('masterSelect');
    if (masterSelect) {
        masterSelect.innerHTML = "";
        masterVarelager.forEach(v => {
            const displayText = v.varenummer ? `${v.navn} (${v.varenummer})` : v.navn;
            masterSelect.add(new Option(displayText, v.id));
        });
    }
}

/* ======================================================
   [JS 3.1] REDIGERINGSFUNKTIONER (NYT)
   ====================================================== */

function uploadVareImage(id){
    const v = masterVarelager.find(x=>x.id===id);
    if(!v) return;
    
    // Opret skjult file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.style.display = 'none';
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        // Tjek filtype
        if (!file.type.startsWith('image/')) {
            alert('‚ö†Ô∏è V√¶lg venligst en billedfil (jpg, png, etc.)');
            return;
        }
        
        // Tjek filst√∏rrelse (max 2MB)
        if (file.size > 2 * 1024 * 1024) {
            alert('‚ö†Ô∏è Billedet er for stort. Maksimal st√∏rrelse er 2MB. Komprimer billedet og pr√∏v igen.');
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64 = e.target.result;
            v.billede = base64;
            renderMasterTable();
            renderLagerTable();
            saveAllData();
            alert('‚úÖ Billede opdateret!');
        };
        reader.onerror = function() {
            alert('‚ùå Fejl ved indl√¶sning af billede. Pr√∏v igen.');
        };
        reader.readAsDataURL(file);
        
        // Fjern input element
        document.body.removeChild(input);
    };
    
    // Tilf√∏j til DOM og trigger click
    document.body.appendChild(input);
    input.click();
}

function editMasterName(id){
    const v = masterVarelager.find(x=>x.id===id);
    const ny = prompt("Nyt varenavn:", v.navn);
    if(ny===null) return;
    v.navn = ny.trim();
    renderMasterTable();
    renderLagerTable();
    renderReports();
    saveAllData();
}

function editMasterUnit(id){
    const v = masterVarelager.find(x=>x.id===id);
    const ny = prompt("Ny m√•leenhed:", v.maaleenhed);
    if(ny===null) return;
    v.maaleenhed = ny.trim();
    renderMasterTable();
    renderLagerTable();
    saveAllData();
}

function editMasterPrice(id){
    const v = masterVarelager.find(x=>x.id===id);
    const ny = prompt("Ny pris:", v.pris);
    if(ny===null) return;
    const n = parseFloat(ny);
    if(isNaN(n)) return alert("Ugyldig pris");
    v.pris = n;
    renderMasterTable();
    renderLagerTable();
    renderReports();
    saveAllData();
}

function editMasterLocation(id){
    const v = masterVarelager.find(x=>x.id===id);
    const ny = prompt("Ny placering (skriv pr√¶cis en lokation):", v.placering);
    if(ny===null) return;
    v.placering = ny.trim();
    renderMasterTable();
    renderLagerTable();
    updateAllSelects();
    // Opdater vinlager hvis varen er i Vinlager
    if(v.placering === 'Vinlager' && $('vinlager') && !$('vinlager').classList.contains('hidden')){
      renderVinlager();
    }
    // Opdater hylle dropdowns hvis det aktuelle lager er valgt
    if($('hylleLagerSelect') && $('hylleLagerSelect').value === v.placering){
      updateHylleReolSelect();
      updateHylleHylleSelect();
      renderHylleRaekkefoelge();
    }
    saveAllData();
}

function editMasterReolNr(id){
    const v = masterVarelager.find(x=>x.id===id);
    const ny = prompt("Reol nummer (fx 1, 2, 3 eller A, B, C):", v.reolNr || '');
    if(ny===null) return;
    v.reolNr = ny.trim() || null;
    renderMasterTable();
    updateAllSelects();
    // Opdater hylle dropdowns hvis det aktuelle lager er valgt
    if($('hylleLagerSelect') && $('hylleLagerSelect').value === v.placering){
      updateHylleReolSelect();
      updateHylleHylleSelect();
      renderHylleRaekkefoelge();
    }
    saveAllData();
}

function editMasterHylleNr(id){
    const v = masterVarelager.find(x=>x.id===id);
    const ny = prompt("Hylle nummer (fx 1, 2, 3 eller A, B, C):", v.hylleNr || '');
    if(ny===null) return;
    v.hylleNr = ny.trim() || null;
    renderMasterTable();
    updateAllSelects();
    // Opdater hylle dropdowns hvis det aktuelle lager er valgt
    if($('hylleLagerSelect') && $('hylleLagerSelect').value === v.placering){
      updateHylleReolSelect();
      updateHylleHylleSelect();
      renderHylleRaekkefoelge();
    }
    saveAllData();
}

function editMasterVarenummer(id){
    const v = masterVarelager.find(x=>x.id===id);
    const ny = prompt("Varenummer:", v.varenummer || '');
    if(ny===null) return;
    v.varenummer = ny.trim() || null;
    renderMasterTable();
    renderLagerTable();
    saveAllData();
}

function editMasterRaekkefoelge(id){
    const v = masterVarelager.find(x=>x.id===id);
    const ny = prompt("R√¶kkef√∏lge (0 = automatisk, h√∏jere tal = kommer f√∏rst):", v.raekkefoelge || 0);
    if(ny===null) return;
    const n = parseFloat(ny);
    if(isNaN(n)) return alert("Ugyldigt tal");
    v.raekkefoelge = n;
    renderMasterTable();
    updateAllSelects();
    // Opdater hylle r√¶kkef√∏lge listen hvis det aktuelle lager er valgt
    if($('hylleLagerSelect') && $('hylleLagerSelect').value === v.placering){
      renderHylleRaekkefoelge();
    }
    saveAllData();
}

/* ======================================================
   [JS 3.2] TILF√òJ MASTER VARE
   ====================================================== */
function tilfoejMasterVare(){
    // Tjek pr√∏veversion begr√¶nsning
    if(!checkTrialLimits('add_vare')){
      return; // Stop hvis begr√¶nsning n√•et
    }
    
    const navn = $('masterVarenavn')?.value.trim();
    const maaleenhed = $('masterMaaleenhed')?.value.trim() || 'stk';
    const pris = parseFloat($('masterPris')?.value) || 0;
    const placering = $('masterPlaceringFilter')?.value || '';
    let reolNr = $('masterReolNr')?.value.trim() || '';
    let hylleNr = $('masterHylleNr')?.value.trim() || '';
    let raekkefoelge = parseFloat($('masterRaekkefoelge')?.value) || 0;
    
    if(!navn) return alert('Indtast varenavn');
    
    // Hvis reolNr ikke er angivet, generer automatisk baseret p√• eksisterende varer i samme lager
    if(!reolNr && placering){
      const varerISammeLager = masterVarelager.filter(v => v.placering === placering && v.reolNr);
      if(varerISammeLager.length > 0){
        // Find h√∏jeste reol nummer og tilf√∏j 1
        const reolNumre = varerISammeLager.map(v => {
          const num = parseInt(v.reolNr);
          return isNaN(num) ? 0 : num;
        }).filter(n => n > 0);
        if(reolNumre.length > 0){
          reolNr = String(Math.max(...reolNumre) + 1);
        } else {
          reolNr = '1';
        }
      } else {
        reolNr = '1';
      }
    }
    
    // Hvis hylleNr ikke er angivet, generer automatisk baseret p√• eksisterende varer i samme lager/reol
    if(!hylleNr && placering){
      const varerISammeLager = masterVarelager.filter(v => v.placering === placering && (!reolNr || v.reolNr === reolNr) && v.hylleNr);
      if(varerISammeLager.length > 0){
        // Find h√∏jeste hylle nummer og tilf√∏j 1
        const hylleNumre = varerISammeLager.map(v => {
          const num = parseInt(v.hylleNr);
          return isNaN(num) ? 0 : num;
        }).filter(n => n > 0);
        if(hylleNumre.length > 0){
          hylleNr = String(Math.max(...hylleNumre) + 1);
        } else {
          hylleNr = '1';
        }
      } else {
        hylleNr = '1';
      }
    }
    
    // Hvis r√¶kkef√∏lge ikke er angivet, s√¶t til h√∏jeste + 1
    if(raekkefoelge === 0 && placering){
      const varerISammeLager = masterVarelager.filter(v => v.placering === placering);
      if(varerISammeLager.length > 0){
        const maxRaekkefoelge = Math.max(...varerISammeLager.map(v => v.raekkefoelge || 0));
        raekkefoelge = maxRaekkefoelge + 1;
      } else {
        raekkefoelge = 1;
      }
    }
    
    masterVarelager.push({ id: genId(), navn, maaleenhed, pris, placering, reolNr: reolNr || null, hylleNr: hylleNr || null, raekkefoelge: raekkefoelge || 0 });
    $('masterVarenavn').value = '';
    $('masterMaaleenhed').value = '';
    $('masterPris').value = '';
    $('masterReolNr').value = '';
    $('masterHylleNr').value = '';
    $('masterRaekkefoelge').value = '0';
    renderMasterTable();
    if($('hylleLagerSelect') && $('hylleLagerSelect').value === placering){
      updateHylleReolSelect();
      updateHylleHylleSelect();
      renderHylleRaekkefoelge();
    }
    updateAllSelects();
    // Opdater vinlager hvis varen er i Vinlager
    if(placering === 'Vinlager' && $('vinlager') && !$('vinlager').classList.contains('hidden')){
      renderVinlager();
    }
    saveAllData();
}

// Synkroniser "Filtrer placering" med "Hylle R√¶kkef√∏lge" sektionen
function syncFilterPlacement(){
  const hylleLagerSelect = $('hylleLagerSelect');
  const filterPlacement = $('filterPlacement');
  if(hylleLagerSelect && filterPlacement){
    filterPlacement.value = hylleLagerSelect.value || '';
    // Opdater tabellen s√• den viser samme lager
    renderMasterTable();
  }
}

// Opdater reol dropdown baseret p√• valgt lager
function updateHylleReolSelect(){
  const lagerSelect = $('hylleLagerSelect');
  const reolSelect = $('hylleReolSelect');
  const hylleSelect = $('hylleHylleSelect');
  
  if(!lagerSelect || !reolSelect) return;
  
  const selectedLager = lagerSelect.value;
  reolSelect.innerHTML = '<option value="">Alle reoler</option>';
  hylleSelect.innerHTML = '<option value="">Alle hylder</option>';
  
  if(!selectedLager) return;
  
  // Hent alle unikke reoler i det valgte lager
  const varer = masterVarelager.filter(v => v.placering === selectedLager && v.reolNr);
  const unikkeReoler = [...new Set(varer.map(v => v.reolNr).filter(r => r))].sort();
  
  unikkeReoler.forEach(reol => {
    reolSelect.add(new Option(`Reol ${reol}`, reol));
  });
}

// Opdater hylle dropdown baseret p√• valgt lager og reol
function updateHylleHylleSelect(){
  const lagerSelect = $('hylleLagerSelect');
  const reolSelect = $('hylleReolSelect');
  const hylleSelect = $('hylleHylleSelect');
  
  if(!lagerSelect || !reolSelect || !hylleSelect) return;
  
  const selectedLager = lagerSelect.value;
  const selectedReol = reolSelect.value;
  
  hylleSelect.innerHTML = '<option value="">Alle hylder</option>';
  
  if(!selectedLager) return;
  
  // Hent alle unikke hylder i det valgte lager (og reol hvis valgt)
  let varer = masterVarelager.filter(v => v.placering === selectedLager);
  if(selectedReol){
    varer = varer.filter(v => v.reolNr === selectedReol);
  }
  const unikkeHylder = [...new Set(varer.map(v => v.hylleNr).filter(h => h))].sort((a, b) => {
    // Sorter numerisk hvis begge er tal, ellers alfabetisk
    const numA = parseInt(a);
    const numB = parseInt(b);
    if(!isNaN(numA) && !isNaN(numB)) return numA - numB;
    return a.localeCompare(b);
  });
  
  unikkeHylder.forEach(hylle => {
    hylleSelect.add(new Option(`Hylle ${hylle}`, hylle));
  });
}

// Render hylle r√¶kkef√∏lge med drag-and-drop
function renderHylleRaekkefoelge(){
  const lagerSelect = $('hylleLagerSelect');
  const reolSelect = $('hylleReolSelect');
  const hylleSelect = $('hylleHylleSelect');
  const list = $('hylleRaekkefoelgeList');
  if(!lagerSelect || !list) return;
  
  const selectedLager = lagerSelect.value;
  const selectedReol = reolSelect ? reolSelect.value : '';
  const selectedHylle = hylleSelect ? hylleSelect.value : '';
  
  if(!selectedLager){
    list.innerHTML = '<li style="padding:12px; color:#666; font-style:italic;">V√¶lg et lager for at se hylle r√¶kkef√∏lge</li>';
    return;
  }
  
  // Filtrer varer baseret p√• lager, reol og hylle
  let varer = masterVarelager.filter(v => v.placering === selectedLager);
  
  // Hvis reol er valgt, vis kun varer fra den specifikke reol
  if(selectedReol){
    varer = varer.filter(v => v.reolNr === selectedReol);
  }
  
  // Hvis hylle er valgt, vis kun varer fra den specifikke hylle
  // Bem√¶rk: Hvis reol ogs√• er valgt, er varer allerede filtreret p√• reol, s√• dette filtrerer p√• b√•de reol og hylle
  if(selectedHylle){
    varer = varer.filter(v => v.hylleNr === selectedHylle);
  }
  
  // Sorter varer
  varer.sort((a, b) => {
    // Hvis reol er valgt men hylle ikke er valgt, sorter f√∏rst efter hylle
    if(selectedReol && !selectedHylle){
      const hylleA = a.hylleNr || '';
      const hylleB = b.hylleNr || '';
      // Sorter hylle numerisk hvis begge er tal, ellers alfabetisk
      const numA = parseInt(hylleA);
      const numB = parseInt(hylleB);
      if(!isNaN(numA) && !isNaN(numB)){
        if(numA !== numB) return numA - numB; // Hylle 1 f√∏rst, derefter 2, 3, osv.
      } else {
        if(hylleA !== hylleB) return hylleA.localeCompare(hylleB);
      }
      // Hvis samme hylle, sorter efter r√¶kkef√∏lge
      const raekkefoelgeA = a.raekkefoelge || 0;
      const raekkefoelgeB = b.raekkefoelge || 0;
      return raekkefoelgeA - raekkefoelgeB; // R√¶kkef√∏lge 1 f√∏rst, derefter 2, 3, osv.
    }
    
    // Hvis b√•de reol og hylle er valgt, eller ingen af dem er valgt, sorter efter r√¶kkef√∏lge
    const raekkefoelgeA = a.raekkefoelge || 0;
    const raekkefoelgeB = b.raekkefoelge || 0;
    if (raekkefoelgeA !== raekkefoelgeB) return raekkefoelgeA - raekkefoelgeB; // Lavere tal f√∏rst (1, 2, 3...)
    
    // Hvis samme r√¶kkef√∏lge, sorter efter reol og hylle
    if ((a.reolNr || '') !== (b.reolNr || '')) {
      const reolA = parseInt(a.reolNr) || 0;
      const reolB = parseInt(b.reolNr) || 0;
      if(reolA !== 0 && reolB !== 0) return reolA - reolB;
      return (a.reolNr || '').localeCompare(b.reolNr || '');
    }
    
    // Sorter hylle numerisk hvis begge er tal, ellers alfabetisk
    const hylleA = parseInt(a.hylleNr) || 0;
    const hylleB = parseInt(b.hylleNr) || 0;
    if(hylleA !== 0 && hylleB !== 0 && hylleA !== hylleB) return hylleA - hylleB;
    return (a.hylleNr || '').localeCompare(b.hylleNr || '');
  });
  
  list.innerHTML = '';
  if(varer.length === 0){
    let msg = 'Ingen varer fundet';
    if(selectedLager) msg += ` i ${selectedLager}`;
    if(selectedReol) msg += `, Reol ${selectedReol}`;
    if(selectedHylle) msg += `, Hylle ${selectedHylle}`;
    list.innerHTML = `<li style="padding:12px; color:#666; font-style:italic;">${msg}</li>`;
    return;
  }
  
  varer.forEach((v, index) => {
    const li = document.createElement('li');
    li.draggable = true;
    li.dataset.vareid = v.id;
    li.style.display = 'flex';
    li.style.alignItems = 'center';
    li.style.justifyContent = 'space-between';
    li.style.padding = '10px 12px';
    li.style.border = '1px solid #ccc';
    li.style.borderRadius = '6px';
    li.style.background = '#fff';
    li.style.marginBottom = '8px';
    li.style.cursor = 'move';
    // Beregn r√¶kkef√∏lge baseret p√• position (1, 2, 3, 4, 5 osv.)
    const raekkefoelgeNummer = index + 1;
    li.innerHTML = `
      <div style="flex:1; display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
        <span class="raekkefoelge-nummer" style="color:#999; font-weight:bold; min-width:30px; text-align:right;">${raekkefoelgeNummer}.</span>
        <strong style="flex:1; min-width:150px;">${v.navn}</strong>
        ${v.reolNr ? `<span style="color:#9C27B0; font-weight:500;">Reol ${v.reolNr}</span>` : ''}
        <span style="color:#666;">Hylle ${v.hylleNr || '-'}</span>
        <span class="raekkefoelge-text" style="color:#999; font-size:12px;">R√¶kkef√∏lge: ${v.raekkefoelge || raekkefoelgeNummer}</span>
      </div>
    `;
    li.addEventListener('dragstart', (e) => {
      li.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    li.addEventListener('dragend', () => {
      li.classList.remove('dragging');
    });
    list.appendChild(li);
  });
  
  // Drag and drop funktionalitet - brug enklere tilgang med event delegation
  // Fjern eksisterende listeners ved at klone listen (dette nulstiller event listeners)
  const listClone = list.cloneNode(false);
  Array.from(list.children).forEach(child => listClone.appendChild(child));
  list.parentNode.replaceChild(listClone, list);
  const finalList = $('hylleRaekkefoelgeList');
  if(!finalList) return;
  
  // Drag and drop funktionalitet
  finalList.addEventListener('dragover', function(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const dragging = finalList.querySelector('.dragging');
    if(!dragging) return;
    const after = getDragAfterElement(finalList, e.clientY);
    if(after == null) finalList.appendChild(dragging);
    else finalList.insertBefore(dragging, after);
  }, false);
  
  finalList.addEventListener('drop', function(e) {
    e.preventDefault();
    const dragging = finalList.querySelector('.dragging');
    if(!dragging) return;
    
    const newOrder = [];
    finalList.querySelectorAll('li').forEach(li => {
      const vareid = li.dataset.vareid;
      if(vareid) newOrder.push(vareid);
    });
    
    // Opdater r√¶kkef√∏lge baseret p√• ny position (1, 2, 3, 4, 5 osv.)
    newOrder.forEach((vareid, index) => {
      const v = masterVarelager.find(x => x.id === vareid);
      if(v){
        v.raekkefoelge = index + 1;
      }
    });
    
    // Opdater visningen med nye r√¶kkef√∏lge numre
    finalList.querySelectorAll('li').forEach((li, index) => {
      const nummerSpan = li.querySelector('.raekkefoelge-nummer');
      const raekkefoelgeSpan = li.querySelector('.raekkefoelge-text');
      if(nummerSpan){
        nummerSpan.textContent = `${index + 1}.`;
      }
      if(raekkefoelgeSpan){
        raekkefoelgeSpan.textContent = `R√¶kkef√∏lge: ${index + 1}`;
      }
    });
    
    dragging.classList.remove('dragging');
    renderMasterTable();
    saveAllData();
  }, false);
}

function deleteMasterVare(id){
    if(!confirm('Slet vare fra master varelager?')) return;
    const index = masterVarelager.findIndex(v => v.id === id);
    if(index !== -1){
        masterVarelager.splice(index, 1);
        renderMasterTable();
        updateAllSelects();
        // Opdater hylle dropdowns og listen
        updateHylleReolSelect();
        updateHylleHylleSelect();
        renderHylleRaekkefoelge();
        renderLagerTable();
        saveAllData();
    }
}

/* ======================================================
   [JS 3.3] FILTERDROP DOWN ‚Äì FUNGERER NU
   ====================================================== */

if($('filterPlacement')){
    $('filterPlacement').addEventListener("change", function(){
      renderMasterTable();
      // Opdater Hylle R√¶kkef√∏lge sektionen til at vise samme lager
      const selectedLager = this.value;
      const hylleLagerSelect = $('hylleLagerSelect');
      if(hylleLagerSelect && selectedLager){
        hylleLagerSelect.value = selectedLager;
        updateHylleReolSelect();
        updateHylleHylleSelect();
        renderHylleRaekkefoelge();
      } else if(hylleLagerSelect && !selectedLager){
        // Hvis "Alle" er valgt, nulstil hylle sektionen
        hylleLagerSelect.value = '';
        updateHylleReolSelect();
        updateHylleHylleSelect();
        renderHylleRaekkefoelge();
      }
    });
}

/* ================================
   [JS 4] AUTOCOMPLETE + MANUAL ADD
   ================================ */
(function setupAutocomplete(){
  const masterSearch = $('masterSearch'), masterAutocomplete = $('masterAutocomplete');
  if(!masterSearch || !masterAutocomplete) return;
  
  function getFilteredVarelager(){
    const lagerSelect = $('lagerLokationSelect');
    const selectedLager = lagerSelect ? lagerSelect.value : '';
    if(!selectedLager) return masterVarelager; // Hvis intet lager valgt, vis alle
    return masterVarelager.filter(v => v.placering === selectedLager);
  }
  
  masterSearch.addEventListener('input', function(){
    // Tjek om opt√¶lling er startet f√∏r man kan s√∏ge
    if(!activeSession){
      this.value = '';
      showStartOptaellingPrompt();
      return;
    }
    
    const txt = this.value.trim().toLowerCase();
    masterAutocomplete.innerHTML = ''; masterAutocomplete.style.display='none';
    delete this.dataset.vareid;
    if(txt.length < 1) return;
    // S√∏g b√•de i varenavn og ID (stregkode) - kun i valgt lager
    const filtered = getFilteredVarelager();
    const matches = filtered.filter(v=> 
      v.navn.toLowerCase().includes(txt) || 
      v.id.toLowerCase().includes(txt)
    );
    if(matches.length===0) return;
    // Sorter matches efter r√¶kkef√∏lge, derefter reolNr, derefter hylleNr
    matches.sort((a, b) => {
      if (a.raekkefoelge !== b.raekkefoelge) return (b.raekkefoelge || 0) - (a.raekkefoelge || 0);
      if ((a.reolNr || '') !== (b.reolNr || '')) return (a.reolNr || '').localeCompare(b.reolNr || '');
      return (a.hylleNr || '').localeCompare(b.hylleNr || '');
    });
    matches.slice(0,50).forEach(v=>{
      const item = document.createElement('div');
      item.className='autocomplete-item';
      const maaleenhed = v.maaleenhed || 'stk';
      const isIdMatch = v.id.toLowerCase().includes(txt) && !v.navn.toLowerCase().includes(txt);
      const reolInfo = v.reolNr ? ` <span style="color:#9C27B0;font-weight:700;">Reol: ${v.reolNr}</span>` : '';
      const hylleInfo = v.hylleNr ? ` <span style="color:#FF9800;font-weight:700;">Hylle: ${v.hylleNr}</span>` : '';
      item.innerHTML = `<strong>${v.navn}</strong> <span style="color:#0078D4; font-weight:700; margin-left:8px;">[${maaleenhed}]</span>${reolInfo}${hylleInfo}${isIdMatch ? ' <span style="color:#2196F3;font-size:11px;">(ID: '+v.id+')</span>' : ''}<br><small style="color:#666">${v.placering?('Lager: '+v.placering):'Ingen placering'}</small>`;
      item.addEventListener('click', ()=>{ 
        // Tjek om opt√¶lling er startet
        if(!activeSession){
          showStartOptaellingPrompt();
          return;
        }
        
        masterSearch.value = v.navn; 
        masterSearch.dataset.vareid = v.id; 
        masterAutocomplete.innerHTML=''; 
        masterAutocomplete.style.display='none';
        // Vis vare info
        updateVareInfoDisplay(v);
        // Ryd antal-feltet
        const antalInput = $('lagerAntal');
        if(antalInput) antalInput.value = '';
        // Fokuser automatisk p√• antal-feltet
        setTimeout(() => {
          if(antalInput){
            antalInput.focus();
          }
        }, 150);
      });
      masterAutocomplete.appendChild(item);
    });
    masterAutocomplete.style.display='block';
  });
  
  // Tillad Enter key til at tilf√∏je f√∏rste match automatisk
  masterSearch.addEventListener('keypress', function(e){
      if(e.key === 'Enter'){
        e.preventDefault();
        
        // Tjek om opt√¶lling er startet
        if(!activeSession){
          showStartOptaellingPrompt();
          return;
        }
      
      const txt = this.value.trim();
      if(!txt) return;
      
      // Pr√∏v at finde eksakt match f√∏rst - kun i valgt lager
      const filtered = getFilteredVarelager();
      let vare = filtered.find(v => v.navn.toLowerCase() === txt.toLowerCase() || v.id === txt);
      
      // Hvis ingen eksakt match, brug f√∏rste i autocomplete
      if(!vare){
        const matches = filtered.filter(v=>
          v.navn.toLowerCase().includes(txt.toLowerCase()) ||
          v.id.toLowerCase().includes(txt.toLowerCase())
        );
        if(matches.length > 0) vare = matches[0];
      }
      
      if(vare){
        this.value = vare.navn;
        this.dataset.vareid = vare.id;
        masterAutocomplete.innerHTML='';
        masterAutocomplete.style.display='none';
        // Fokuser automatisk p√• antal-feltet og vis talpad
        setTimeout(() => {
          const antalInput = $('lagerAntal');
          if(antalInput){
            antalInput.focus();
            antalInput.select();
          }
        }, 150);
      } else {
        alert('Vare ikke fundet. Pr√∏v at s√∏ge efter varenavn.');
      }
    }
  });
  
  document.addEventListener('click', e=>{ if(!e.target.closest('.autocomplete-wrapper')){ masterAutocomplete.innerHTML=''; masterAutocomplete.style.display='none'; }});
})();

// Autocomplete til lokation s√∏gning
(function setupLocationAutocomplete(){
  const locationSearch = $('lagerLokationSearch');
  const locationAutocomplete = $('lagerLokationAutocomplete');
  const locationSelect = $('lagerLokationSelect');
  if(!locationSearch || !locationAutocomplete || !locationSelect) return;
  
  locationSearch.addEventListener('input', function(){
    const txt = this.value.trim().toLowerCase();
    locationAutocomplete.innerHTML = '';
    locationAutocomplete.style.display = 'none';
    
    if(txt.length < 1){
      locationSelect.value = '';
      renderLagerTable();
      updateSearchFilter();
      return;
    }
    
    // Hvis brugeren skriver 'a', vis alle lokationer + "Alle opt√¶llinger"
    let matches = [];
    if(txt === 'a' || txt === 'A'){
      matches = ['Alle opt√¶llinger', ...lagerLokationer];
    } else {
      // Find matchende lokationer
      matches = lagerLokationer.filter(l => l.toLowerCase().includes(txt));
      // Hvis "Alle opt√¶llinger" matcher, tilf√∏j den ogs√•
      if('Alle opt√¶llinger'.toLowerCase().includes(txt)){
        matches.unshift('Alle opt√¶llinger');
      }
    }
    
    if(matches.length === 0){
      locationAutocomplete.innerHTML = '<div class="autocomplete-item" style="padding:12px;color:#999;font-style:italic;">Ingen lokationer fundet</div>';
      locationAutocomplete.style.display = 'block';
      return;
    }
    
    matches.forEach(loc => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.innerHTML = `<strong>${loc}</strong>`;
      item.addEventListener('click', () => {
        if(loc === 'Alle opt√¶llinger'){
          locationSearch.value = '';
          locationSelect.value = '';
        } else {
          locationSearch.value = loc;
          locationSelect.value = loc;
        }
        locationAutocomplete.innerHTML = '';
        locationAutocomplete.style.display = 'none';
        renderLagerTable();
        updateSearchFilter();
        // Automatisk fokus p√• "S√∏g vare" feltet efter valg
        setTimeout(() => {
          const masterSearch = $('masterSearch');
          if(masterSearch){
            masterSearch.focus();
          }
        }, 100);
      });
      locationAutocomplete.appendChild(item);
    });
    
    locationAutocomplete.style.display = 'block';
  });
  
  // Enter key for at v√¶lge f√∏rste match
  locationSearch.addEventListener('keypress', function(e){
    if(e.key === 'Enter'){
      e.preventDefault();
      const txt = this.value.trim().toLowerCase();
      if(!txt) return;
      
      let matches = [];
      if(txt === 'a'){
        matches = ['Alle opt√¶llinger', ...lagerLokationer];
      } else {
        matches = lagerLokationer.filter(l => l.toLowerCase().includes(txt));
        if('Alle opt√¶llinger'.toLowerCase().includes(txt)){
          matches.unshift('Alle opt√¶llinger');
        }
      }
      
      if(matches.length > 0){
        const firstMatch = matches[0];
        if(firstMatch === 'Alle opt√¶llinger'){
          this.value = '';
          locationSelect.value = '';
        } else {
          this.value = firstMatch;
          locationSelect.value = firstMatch;
        }
        locationAutocomplete.innerHTML = '';
        locationAutocomplete.style.display = 'none';
        renderLagerTable();
        updateSearchFilter();
        // Automatisk fokus p√• "S√∏g vare" feltet
        setTimeout(() => {
          const masterSearch = $('masterSearch');
          if(masterSearch){
            masterSearch.focus();
          }
        }, 100);
      }
    }
  });
  
  // Luk autocomplete n√•r man klikker udenfor
  document.addEventListener('click', e => {
    if(!e.target.closest('#lagerLokationSearch') && !e.target.closest('#lagerLokationAutocomplete')){
      locationAutocomplete.innerHTML = '';
      locationAutocomplete.style.display = 'none';
    }
  });
  
  // Opdater s√∏gefelt n√•r dropdown √¶ndres (hvis nogen √¶ndrer det programmatisk)
  locationSelect.addEventListener('change', function(){
    if(this.value && locationSearch.value !== this.value){
      locationSearch.value = this.value;
    }
  });
})();

// Talpad funktionalitet
// Vis prompt for at starte opt√¶lling
function showStartOptaellingPrompt(){
  const modal = $('startOptaellingPromptModal');
  if(modal){
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden', 'false');
  }
}

function closeStartOptaellingPrompt(){
  const modal = $('startOptaellingPromptModal');
  if(modal){
    modal.classList.add('hidden');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }
}

// Vis valgt vare info
function updateVareInfoDisplay(vare){
  const vareInfo = $('selectedVareInfo');
  const vareDetails = $('selectedVareDetails');
  const antalUnitLabel = $('antalUnitLabel');
  
  if(!vareInfo || !vareDetails || !vare) return;
  
  const maaleenhed = vare.maaleenhed || 'stk';
  const pris = vare.pris || 0;
  const placering = vare.placering || 'Ingen placering';
  const reolNr = vare.reolNr || '';
  const hylleNr = vare.hylleNr || '';
  
  let detailsHTML = `<strong style="color:#1976D2;font-size:16px;">${vare.navn}</strong><br>`;
  detailsHTML += `<span style="color:#0078D4;font-weight:bold;">M√•leenhed: ${maaleenhed}</span><br>`;
  detailsHTML += `Pris: <strong>${pris.toFixed(2)} kr.</strong> pr. ${maaleenhed}<br>`;
  detailsHTML += `Lager: ${placering}`;
  if(reolNr){
    detailsHTML += ` | Reol: <span style="color:#9C27B0;font-weight:bold;">${reolNr}</span>`;
  }
  if(hylleNr){
    detailsHTML += ` | Hylle: <span style="color:#FF9800;font-weight:bold;">${hylleNr}</span>`;
  }
  
  vareDetails.innerHTML = detailsHTML;
  vareInfo.style.display = 'block';
  
  // Opdater antal label
  if(antalUnitLabel){
    antalUnitLabel.textContent = `(${maaleenhed})`;
  }
  
  // Opdater step baseret p√• m√•leenhed
  const antalInput = $('lagerAntal');
  if(antalInput){
    // Hvis det er stk, brug step 1, ellers step 0.01 for kg/L etc.
    if(maaleenhed.toLowerCase() === 'stk' || maaleenhed.toLowerCase() === 'stk.'){
      antalInput.step = '1';
    } else {
      antalInput.step = '0.01';
    }
  }
  
  updateVareInfo(); // Opdater total
}

// Opdater vare info med antal og total
function updateVareInfo(){
  const masterSearch = $('masterSearch');
  const vareInfo = $('selectedVareInfo');
  const vareDetails = $('selectedVareDetails');
  const antalInput = $('lagerAntal');
  
  if(!masterSearch || !vareInfo || !vareDetails) return;
  
  const vareId = masterSearch.dataset.vareid;
  if(!vareId || vareInfo.style.display === 'none'){
    return; // Ingen vare valgt
  }
  
  const vare = masterVarelager.find(v => v.id === vareId);
  if(!vare) return;
  
  const maaleenhed = vare.maaleenhed || 'stk';
  const pris = vare.pris || 0;
  const placering = vare.placering || 'Ingen placering';
  const reolNr = vare.reolNr || '';
  const hylleNr = vare.hylleNr || '';
  
  const antalStr = antalInput ? antalInput.value.trim() : '';
  const antal = parseFloat(antalStr);
  
  let detailsHTML = `<strong style="color:#1976D2;font-size:16px;">${vare.navn}</strong><br>`;
  detailsHTML += `<span style="color:#0078D4;font-weight:bold;">M√•leenhed: ${maaleenhed}</span><br>`;
  detailsHTML += `Pris: <strong>${pris.toFixed(2)} kr.</strong> pr. ${maaleenhed}<br>`;
  detailsHTML += `Lager: ${placering}`;
  if(reolNr){
    detailsHTML += ` | Reol: <span style="color:#9C27B0;font-weight:bold;">${reolNr}</span>`;
  }
  if(hylleNr){
    detailsHTML += ` | Hylle: <span style="color:#FF9800;font-weight:bold;">${hylleNr}</span>`;
  }
  
  // Hvis antal er indtastet, vis total
  if(antalStr && !isNaN(antal) && antal > 0){
    const total = antal * pris;
    detailsHTML += `<br><div style="margin-top:8px;padding:8px;background:#E3F2FD;border-radius:4px;border-left:4px solid #0078D4;">`;
    detailsHTML += `<strong>Antal: ${antal.toFixed(antal % 1 === 0 ? 0 : 2)} ${maaleenhed}</strong><br>`;
    detailsHTML += `<strong style="font-size:16px;color:#005A9E;">Total: ${total.toFixed(2)} kr.</strong>`;
    detailsHTML += `</div>`;
  }
  
  vareDetails.innerHTML = detailsHTML;
}

// Ryd vare info n√•r s√∏gefeltet ryddes
(function setupVareInfoClearing(){
  const masterSearch = $('masterSearch');
  if(!masterSearch) return;
  
  masterSearch.addEventListener('input', function(){
    if(!this.value.trim() || !this.dataset.vareid){
      const vareInfo = $('selectedVareInfo');
      const antalUnitLabel = $('antalUnitLabel');
      if(vareInfo) vareInfo.style.display = 'none';
      if(antalUnitLabel) antalUnitLabel.textContent = '';
    }
  });
})();
function tilfoejLagerFraMaster(){
  // Tjek om opt√¶lling er startet
  if(!activeSession){
    alert('‚ö†Ô∏è Ingen aktiv opt√¶lling!\n\nDu skal f√∏rst starte en opt√¶lling f√∏r du kan tilf√∏je varer.\n\nKlik p√• "Start ny opt√¶lling" for at begynde.');
    return;
  }
  
  const masterSearch = $('masterSearch');
  const vareId = (masterSearch && masterSearch.dataset && masterSearch.dataset.vareid) ? masterSearch.dataset.vareid : ($('masterSelect') ? $('masterSelect').value : null);
  const antalInput = $('lagerAntal');
  const antalStr = antalInput ? antalInput.value.trim() : '';
  const antal = parseFloat(antalStr);
  
  if(!vareId){
    alert('V√¶lg en vare f√∏rst (klik i autocomplete-listen eller s√∏g efter varen)');
    return;
  }
  
  if(!antalStr || antalStr === '' || isNaN(antal) || antal <= 0){
    alert('‚ö†Ô∏è Indtast et antal st√∏rre end 0!\n\nDu skal indtaste et gyldigt antal f√∏r du kan tilf√∏je varen.');
    if(antalInput){
      antalInput.focus();
    }
    return;
  }
  
  const v = masterVarelager.find(x=>x.id===vareId);
  if(!v) return alert('Varen findes ikke i master varelageret');
  const loc = v.placering || '';
  const ok = addToSessionOrWarn(loc, vareId, antal);
  if(ok){ 
    if(masterSearch){ 
      masterSearch.value=''; 
      delete masterSearch.dataset.vareid; 
    } 
    if(antalInput) antalInput.value = '';
    // Skjul vare info
    const vareInfo = $('selectedVareInfo');
    if(vareInfo) vareInfo.style.display = 'none';
    const antalUnitLabel = $('antalUnitLabel');
    if(antalUnitLabel) antalUnitLabel.textContent = '';
  }
}

/* Simpel stregkode indtastning - virker p√• alle enheder */
function tilfoejFraStregkode(){
  const barcodeInput = $('manualBarcodeInput');
  if(!barcodeInput) return alert('Input felt ikke fundet');
  
  const stregkode = barcodeInput.value.trim();
  if(!stregkode){
    alert('Indtast en stregkode');
    barcodeInput.focus();
    return;
  }
  
  // Find vare med denne stregkode (vare ID skal matche stregkoden)
  const vare = masterVarelager.find(v => v.id === stregkode || v.navn === stregkode);
  
  if(!vare){
    // Pr√∏v at s√∏ge efter stregkoden i varenavn
    const matches = masterVarelager.filter(v => 
      v.navn.toLowerCase().includes(stregkode.toLowerCase()) ||
      v.id.toLowerCase().includes(stregkode.toLowerCase())
    );
    
    if(matches.length === 0){
      alert(`Vare ikke fundet for stregkode: ${stregkode}\n\nBem√¶rk: Stregkoden skal matche vare ID eller varenavn.\n\nDu kan:\n1. Tilf√∏je varen i "Varelager administration" f√∏rst\n2. Eller s√∏ge efter varen i stedet`);
      barcodeInput.focus();
      return;
    } else if(matches.length === 1){
      // Pr√¶cis 1 match - brug den
      const vareId = matches[0].id;
      const antal = parseFloat($('lagerAntal')?.value) || 1;
      const loc = matches[0].placering || '';
      const ok = addToSessionOrWarn(loc, vareId, antal);
      if(ok){
        barcodeInput.value = '';
        barcodeInput.focus();
        if($('lagerAntal')) $('lagerAntal').value = 1;
        barcodeInput.style.borderColor = '#0078D4';
        setTimeout(() => { barcodeInput.style.borderColor = '#ddd'; }, 500);
      }
      return;
    } else {
      // Flere matches - vis liste
      let msg = `Fundet ${matches.length} varer der matcher "${stregkode}":\n\n`;
      matches.forEach((v, i) => {
        msg += `${i+1}. ${v.navn} (ID: ${v.id})\n`;
      });
      msg += `\nBrug s√∏gefunktionen i stedet for at v√¶lge den rigtige vare.`;
      alert(msg);
      barcodeInput.focus();
      return;
    }
  }
  
  // Vare fundet - tilf√∏j til opt√¶lling
  const antal = parseFloat($('lagerAntal')?.value) || 1;
  const loc = vare.placering || '';
  const ok = addToSessionOrWarn(loc, vare.id, antal);
  
  if(ok){
    barcodeInput.value = '';
    barcodeInput.focus();
    if($('lagerAntal')) $('lagerAntal').value = 1;
    // Vis bekr√¶ftelse
    barcodeInput.style.borderColor = '#0078D4';
    setTimeout(() => { barcodeInput.style.borderColor = '#ddd'; }, 500);
  }
}

// Stregkode input Enter key handler er nu flyttet til hoved DOMContentLoaded listener (linje ~1280)

/* ================================
   [JS 5] SESSION (Start / Finish / Preview)
   ================================ */
function openStartModal(){ 
  updateAllSelects(); 
  if($('startScope')) $('startScope').value=''; 
  // Generer automatisk unikt serienummer
  sessionCounter++;
  const autoName = `OPTA-${String(sessionCounter).padStart(6, '0')}`;
  if($('startName')) $('startName').value = autoName;
  const modal = $('startModal'); 
  modal.classList.remove('hidden'); 
  modal.style.display='flex'; 
  modal.setAttribute('aria-hidden','false'); 
}
function closeStartModal(){ const modal = $('startModal'); modal.classList.add('hidden'); modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
function confirmStartSession(){ 
  const nameInput = $('startName') ? $('startName').value.trim() : ''; 
  const scope = $('startScope') ? $('startScope').value || '' : ''; 
  // Brug indtastet navn eller generer automatisk serienummer
  let name = nameInput;
  if(!name){
    // Generer automatisk hvis tomt - sessionCounter er allerede √∏get i openStartModal
    name = `OPTA-${String(sessionCounter).padStart(6, '0')}`;
  }
  activeSession = { id: genId(), name, scope, tsStart: Date.now(), counts: {}, editable: true }; 
  if(activeSession.scope) activeSession.counts[activeSession.scope] = {}; 
  const info = $('sessionInfo'); 
  if(info){ 
    info.classList.remove('hidden'); 
    info.innerHTML = `<span id="sessionNameDisplay" style="cursor:pointer;text-decoration:underline;color:#2196F3;" onclick="editSessionName()" title="Klik for at redigere navn">${activeSession.name}</span> ‚Äî ${activeSession.scope || 'Alle lokationer'}`; 
  } 
  const finishBtn = $('finishSessionBtn'); 
  if(finishBtn) finishBtn.disabled = false; 
  const cancelBtn = $('cancelSessionBtn'); 
  if(cancelBtn) cancelBtn.disabled = false; 
  closeStartModal(); 
  renderLagerTable(); 
  updateLogPreview(); 
  saveAllData(); 
}

function cancelSession(){
  if(!activeSession) {
    alert('Ingen aktiv opt√¶lling at annullere.');
    return;
  }
  
  if(!confirm('Er du sikker p√• at du vil annullere denne opt√¶lling?\n\nAlle indtastede data vil blive slettet og der bliver ikke lavet en rapport.\n\nDette kan ikke fortrydes.')){
    return;
  }
  
  // Nulstil activeSession
  activeSession = null;
  
  // Opdater UI
  const info = $('sessionInfo');
  if(info){
    info.classList.add('hidden');
    info.textContent = '';
  }
  
  const finishBtn = $('finishSessionBtn');
  if(finishBtn) finishBtn.disabled = true;
  
  const cancelBtn = $('cancelSessionBtn');
  if(cancelBtn) cancelBtn.disabled = true;
  
  // Luk finishModal hvis den er √•ben
  closeFinishModal();
  
  // Opdater tabeller
  renderLagerTable();
  updateLogPreview();
  saveAllData();
  
  alert('Opt√¶lling annulleret. Du kan nu starte en ny opt√¶lling.');
}

function cancelSessionFromModal(){
  closeFinishModal();
  cancelSession();
}

function editSessionName(){
  if(!activeSession || !activeSession.editable) return;
  const currentName = activeSession.name;
  const newName = prompt('Rediger opt√¶llingsnavn (kun f√∏r opt√¶lling er afsluttet):', currentName);
  if(newName === null || newName.trim() === '') return;
  activeSession.name = newName.trim();
  const info = $('sessionInfo');
  if(info){
    const nameDisplay = $('sessionNameDisplay');
    if(nameDisplay){
      nameDisplay.textContent = activeSession.name;
    } else {
      info.innerHTML = `<span id="sessionNameDisplay" style="cursor:pointer;text-decoration:underline;" onclick="editSessionName()" title="Klik for at redigere navn">${activeSession.name}</span> ‚Äî ${activeSession.scope || 'Alle lokationer'}`;
    }
  }
  saveAllData();
}

function openFinishModal(){ 
  if(!activeSession) return alert('Ingen aktiv opt√¶lling'); 
  const counts = activeSession.counts || {}; 
  const container = $('finishSummary'); 
  if(!container) return alert('Finish modal ikke fundet'); 
  let html = `<p><strong>${activeSession.name}</strong> ‚Äî ${activeSession.scope || 'Alle lokationer'} ‚Äî Start: ${formatTime(activeSession.tsStart)}</p>`; 
  let grandTotal = 0; 
  const locs = Object.keys(counts).filter(l => Object.keys(counts[l]||{}).some(id => Number(counts[l][id])>0)); 
  const confirmBtn = document.querySelector('#finishModal .actions button:last-child');
  
  if(locs.length === 0){ 
    html += `<div style="padding:20px; background:#fff3cd; border:2px solid #ffc107; border-radius:8px; margin-top:16px;">
      <p style="margin:0; font-weight:700; color:#856404; font-size:16px;">‚ö†Ô∏è Opt√¶lling er tom</p>
      <p style="margin:8px 0 0 0; color:#856404; font-size:14px;">Der er ikke indtastet nogen varer i denne opt√¶lling. Der bliver ikke lavet en rapport.</p>
      <p style="margin:8px 0 0 0; color:#856404; font-size:14px;">Tilf√∏j varer til opt√¶llingen f√∏r du afslutter den.</p>
    </div>`;
    if(confirmBtn) confirmBtn.disabled = true;
    if(confirmBtn) confirmBtn.style.opacity = '0.5';
    if(confirmBtn) confirmBtn.style.cursor = 'not-allowed';
  } else { 
    locs.forEach(loc=>{ 
      html += `<h4 style="margin-bottom:6px">${loc}</h4>`; 
      html += `<table style="width:100%;border-collapse:collapse;margin-bottom:8px"><thead><tr><th style="border:1px solid #ddd;padding:6px">Vare</th><th style="border:1px solid #ddd;padding:6px">Enhed</th><th style="border:1px solid #ddd;padding:6px">Antal</th><th style="border:1px solid #ddd;padding:6px">Pris</th><th style="border:1px solid #ddd;padding:6px">Linjetotal</th></tr></thead><tbody>`; 
      let subtotal=0; 
      Object.keys(counts[loc]||{}).forEach(vid=>{ 
        const antal = Number(counts[loc][vid])||0; 
        if(antal<=0) return; 
        const v = masterVarelager.find(m=>m.id===vid); 
        const navn = v ? v.navn : `Ukendt (${vid})`; 
        const maale = v ? (v.maaleenhed||'-') : '-'; 
        const pris = v ? (Number(v.pris)||0) : 0; 
        const linje = antal * pris; 
        subtotal += linje; 
        html += `<tr><td style="border:1px solid #ddd;padding:6px">${navn}</td><td style="border:1px solid #ddd;padding:6px">${maale}</td><td style="border:1px solid #ddd;padding:6px">${antal}</td><td style="border:1px solid #ddd;padding:6px">${pris.toFixed(2)} kr.</td><td style="border:1px solid #ddd;padding:6px">${linje.toFixed(2)} kr.</td></tr>`; 
      }); 
      html += `</tbody><tfoot><tr><td colspan="4" style="border:1px solid #ddd;padding:6px;text-align:right"><strong>Subtotal:</strong></td><td style="border:1px solid #ddd;padding:6px"><strong>${subtotal.toFixed(2)} kr.</strong></td></tr></tfoot></table>`; 
      grandTotal += subtotal; 
    }); 
    html += `<p style="font-weight:800">Samlet total: ${grandTotal.toFixed(2)} kr.</p>`; 
    if(confirmBtn) confirmBtn.disabled = false;
    if(confirmBtn) confirmBtn.style.opacity = '1';
    if(confirmBtn) confirmBtn.style.cursor = 'pointer';
  } 
  container.innerHTML = html; 
  const modal = $('finishModal'); 
  modal.classList.remove('hidden'); 
  modal.style.display='flex'; 
  modal.setAttribute('aria-hidden','false'); 
}

function closeFinishModal(){ const modal = $('finishModal'); modal.classList.add('hidden'); modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }

function confirmFinishSession(){ 
  if(!activeSession) return alert('Ingen aktiv opt√¶lling'); 
  const details = []; 
  let grandTotal=0; 
  Object.keys(activeSession.counts||{}).forEach(loc=>{ 
    Object.keys(activeSession.counts[loc]||{}).forEach(vid=>{ 
      const antal = Number(activeSession.counts[loc][vid])||0; 
      if(antal<=0) return; 
      const v = masterVarelager.find(m=>m.id===vid); 
      const navn = v ? v.navn : ('id:'+vid); 
      const maaleenhed = v ? v.maaleenhed || '-' : '-'; 
      const pris = v ? (Number(v.pris)||0) : 0; 
      const linjetotal = antal * pris; 
      grandTotal += linjetotal; 
      const detailItem = { vareId: vid, navn, maaleenhed, pris, antal, linjetotal, placering: loc }; 
      if(v && v.reolNr) detailItem.reolNr = v.reolNr;
      if(v && v.hylleNr) detailItem.hylleNr = v.hylleNr;
      if(v && v.varenummer) detailItem.varenummer = v.varenummer; 
      if(v && v.hylleNr) detailItem.hylleNr = v.hylleNr; 
      details.push(detailItem); 
    }); 
  }); 
  
  // Tjek om opt√¶lling er tom
  if(details.length === 0 || grandTotal === 0){
    alert('‚ö†Ô∏è Opt√¶lling er tom\n\nDer er ikke indtastet nogen varer i denne opt√¶lling. Der bliver ikke lavet en rapport.\n\nTilf√∏j varer til opt√¶llingen f√∏r du afslutter den.');
    return;
  }
  
  // Tjek pr√∏veversion begr√¶nsning f√∏r oprettelse af rapport
  if(!checkTrialLimits('add_report')){
    return; // Stop hvis begr√¶nsning n√•et
  }
  
  const report = { ts: Date.now(), handling: activeSession.name, type:'session', scope: activeSession.scope || '', details, total: grandTotal }; 
  reports.unshift(report); 
  activeSession = null; 
  const info = $('sessionInfo'); 
  if(info){ info.classList.add('hidden'); info.textContent=''; } 
  const finishBtn = $('finishSessionBtn'); 
  if(finishBtn) finishBtn.disabled = true; 
  const finishBtnNumberPad = $('finishSessionBtnNumberPad'); 
  if(finishBtnNumberPad) finishBtnNumberPad.disabled = true; 
  const cancelBtn = $('cancelSessionBtn');
  if(cancelBtn) cancelBtn.disabled = true;
  closeFinishModal(); 
  renderReports(); 
  renderLagerTable(); 
  updateLogPreview(); 
  saveAllData(); 
  alert('Opt√¶lling gemt som rapport.'); 
}

/* ================================
   [JS 6] ADD TO SESSION or PERMANENT
   ================================ */
function addToSessionOrWarn(lokation, vareId, antal){
  if(!vareId) return false;
  if(activeSession){
    const item = masterVarelager.find(m=>m.id===vareId) || {};
    let loc = lokation || item.placering || '';
    if(!loc) loc = activeSession.scope || '';
    if(!loc) loc = '';
    if(!activeSession.counts[loc]) activeSession.counts[loc] = {};
    activeSession.counts[loc][vareId] = (Number(activeSession.counts[loc][vareId])||0) + Number(antal);
    renderLagerTable();
    updateLogPreview();
    saveAllData();
    return true;
  } else {
    if(!confirm('Der er ingen aktiv opt√¶llingsrunde. √ònsker du at gemme denne √¶ndring direkte i permanent lager? (OK = gem, Annuller = afbryd)')) return false;
    const v = masterVarelager.find(m=>m.id===vareId);
    const loc = (v && v.placering) ? v.placering : (lokation || '');
    if(!loc) return alert('Varen mangler placering i master varelageret. Tilf√∏j placering f√∏rst.');
    if(!lagerData[loc]) lagerData[loc] = {};
    lagerData[loc][vareId] = (Number(lagerData[loc][vareId])||0) + Number(antal);
    reports.unshift({ ts: Date.now(), handling: 'Tilf√∏jet permanent', vare: v ? v.navn : ('id:'+vareId), antal, placering: loc, type:'single', total: (v ? (Number(v.pris)||0)*antal : 0) });
    renderLagerTable(); renderReports(); updateLogPreview();
    // Opdater vinlager hvis sektionen er aktiv
    if($('vinlager') && !$('vinlager').classList.contains('hidden')){
      renderVinlager();
    }
    saveAllData();
    return true;
  }
}

/* ================================
   [JS 7] RENDER LAGER TABLE
   ================================ */
function renderLagerTable(){
  const sel = $('lagerLokationSelect'); if(!sel) return;
  const loc = sel.value;
  const tbody = $('lagerTable'); if(!tbody) return;
  tbody.innerHTML=''; let total = 0;

  if(activeSession){
    const counts = activeSession.counts || {};
    if(loc === ''){
      const aggregated = {};
      Object.keys(counts).forEach(lg => {
        Object.keys(counts[lg]||{}).forEach(vid=>{
          const antal = Number(counts[lg][vid])||0;
          if(antal <=0) return;
          aggregated[vid] = aggregated[vid] || { antal:0, breakdown:{} };
          aggregated[vid].antal += antal;
          aggregated[vid].breakdown[lg] = (aggregated[vid].breakdown[lg]||0) + antal;
        });
      });
      Object.keys(aggregated).forEach(vid=>{
        const v = masterVarelager.find(m=>m.id===vid);
        const navn = v ? v.navn : ('id:'+vid);
        const maale = v ? (v.maaleenhed||'-') : '-';
        const pris = v ? (Number(v.pris)||0) : 0;
        const antal = aggregated[vid].antal;
        const sum = antal * pris; total += sum;
        const breakdownText = Object.entries(aggregated[vid].breakdown).map(e=>`${e[0]}:${e[1]}`).join(', ');
        const varenummer = v ? (v.varenummer || '') : '';
        const varenummerDisplay = varenummer ? `<br><small style="color:#0066cc;font-weight:600;">Varenr: ${varenummer}</small>` : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${navn}${varenummerDisplay}<br><small style="color:#666">${breakdownText}</small></td><td>${maale}</td><td class="lager-antal" style="cursor:pointer" onclick="editSessionCount('${vid}','')">${antal}</td><td>${pris.toFixed(2)} kr.</td><td>${sum.toFixed(2)} kr.</td>`;
        tbody.appendChild(tr);
      });
    } else {
      Object.keys(counts[loc]||{}).forEach(vid=>{
        const antal = Number(counts[loc][vid])||0;
        if(antal<=0) return;
        const v = masterVarelager.find(m=>m.id===vid);
        const navn = v ? v.navn : ('id:'+vid);
        const maale = v ? (v.maaleenhed||'-') : '-';
        const pris = v ? (Number(v.pris)||0) : 0;
        const sum = antal * pris; total += sum;
        const varenummer = v ? (v.varenummer || '') : '';
        const varenummerDisplay = varenummer ? `<br><small style="color:#0066cc;font-weight:600;">Varenr: ${varenummer}</small>` : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${navn}${varenummerDisplay}</td><td>${maale}</td><td class="lager-antal" style="cursor:pointer" onclick="editSessionCount('${vid}','${loc}')">${antal}</td><td>${pris.toFixed(2)} kr.</td><td>${sum.toFixed(2)} kr.</td>`;
        tbody.appendChild(tr);
      });
    }
    const info = $('sessionInfo'); if(info){ info.classList.remove('hidden'); const nameDisplay = activeSession.editable ? `<span id="sessionNameDisplay" style="cursor:pointer;text-decoration:underline;color:#2196F3;" onclick="editSessionName()" title="Klik for at redigere navn">${activeSession.name}</span>` : activeSession.name; info.innerHTML = `${nameDisplay} ‚Äî ${activeSession.scope || 'Alle lokationer'}`; }
    const finishBtn = $('finishSessionBtn'); if(finishBtn) finishBtn.disabled = false;
    const cancelBtn = $('cancelSessionBtn'); if(cancelBtn) cancelBtn.disabled = false;
  } else {
    // Ingen aktiv opt√¶lling - vis tom tabel med besked
    const tr = document.createElement('tr');
    tr.innerHTML = `<td colspan="5" style="text-align:center;padding:20px;color:#666;font-style:italic;">Ingen aktiv opt√¶lling. Klik p√• "Start ny opt√¶lling" for at begynde.</td>`;
    tbody.appendChild(tr);
    total = 0;
    const info = $('sessionInfo'); if(info) info.classList.add('hidden');
    const finishBtn = $('finishSessionBtn'); if(finishBtn) finishBtn.disabled = true;
    const finishBtnNumberPad = $('finishSessionBtnNumberPad'); if(finishBtnNumberPad) finishBtnNumberPad.disabled = true;
    const cancelBtn = $('cancelSessionBtn'); if(cancelBtn) cancelBtn.disabled = true;
  }
  $('totalLager').textContent = total.toFixed(2) + ' kr.';
}

/* ================================
   [JS 7.1] RENDER VINLAGER MED STATISTIK
   ================================ */
function calculateVinlagerStats(){
  const vinlagerVarer = masterVarelager.filter(v => v.placering === 'Vinlager');
  const vinlagerData = lagerData['Vinlager'] || {};
  
  let totalValue = 0;
  let totalBottles = 0;
  let totalItems = 0;
  let totalPrice = 0;
  let itemsWithPrice = 0;
  
  vinlagerVarer.forEach(v => {
    const antal = Number(vinlagerData[v.id] || 0);
    if(antal > 0){
      totalItems++;
      const pris = Number(v.pris) || 0;
      const v√¶rdi = antal * pris;
      totalValue += v√¶rdi;
      
      // T√¶l flasker (hvis m√•leenhed er "stk", "flaske", "fl", eller lignende)
      const maaleenhed = (v.maaleenhed || '').toLowerCase();
      if(maaleenhed.includes('stk') || maaleenhed.includes('flaske') || maaleenhed.includes('fl') || maaleenhed === 'stk' || maaleenhed === ''){
        totalBottles += antal;
      }
      
      if(pris > 0){
        totalPrice += pris;
        itemsWithPrice++;
      }
    }
  });
  
  const avgPrice = itemsWithPrice > 0 ? totalPrice / itemsWithPrice : 0;
  
  return {
    totalValue,
    totalBottles,
    totalItems,
    avgPrice
  };
}

function renderVinlager(){
  const tbody = $('vinlagerTable');
  const emptyDiv = $('vinlagerEmpty');
  if(!tbody) return;
  
  // Hent alle varer i Vinlager
  let vinlagerVarer = masterVarelager.filter(v => v.placering === 'Vinlager');
  const vinlagerData = lagerData['Vinlager'] || {};
  
  // Filtrer baseret p√• s√∏gning
  const searchTerm = ($('vinlagerSearch')?.value || '').toLowerCase().trim();
  if(searchTerm){
    vinlagerVarer = vinlagerVarer.filter(v => 
      (v.navn || '').toLowerCase().includes(searchTerm)
    );
  }
  
  // Sorter
  const sortBy = $('vinlagerSort')?.value || 'name';
  vinlagerVarer.sort((a, b) => {
    const antalA = Number(vinlagerData[a.id] || 0);
    const antalB = Number(vinlagerData[b.id] || 0);
    const prisA = Number(a.pris) || 0;
    const prisB = Number(b.pris) || 0;
    const v√¶rdiA = antalA * prisA;
    const v√¶rdiB = antalB * prisB;
    
    switch(sortBy){
      case 'name':
        return (a.navn || '').localeCompare(b.navn || '');
      case 'name-desc':
        return (b.navn || '').localeCompare(a.navn || '');
      case 'value':
        return v√¶rdiB - v√¶rdiA;
      case 'value-asc':
        return v√¶rdiA - v√¶rdiB;
      case 'antal':
        return antalB - antalA;
      case 'antal-asc':
        return antalA - antalB;
      default:
        return 0;
    }
  });
  
  // Beregn statistik
  const stats = calculateVinlagerStats();
  
  // Opdater statistik kort
  const totalValueEl = $('vinlagerTotalValue');
  const totalBottlesEl = $('vinlagerTotalBottles');
  const totalItemsEl = $('vinlagerTotalItems');
  const avgPriceEl = $('vinlagerAvgPrice');
  
  if(totalValueEl) totalValueEl.textContent = stats.totalValue.toFixed(2) + ' kr.';
  if(totalBottlesEl) totalBottlesEl.textContent = stats.totalBottles.toLocaleString('da-DK');
  if(totalItemsEl) totalItemsEl.textContent = stats.totalItems.toLocaleString('da-DK');
  if(avgPriceEl) avgPriceEl.textContent = stats.avgPrice.toFixed(2) + ' kr.';
  
  // Render tabel
  tbody.innerHTML = '';
  
  if(vinlagerVarer.length === 0){
    if(emptyDiv) emptyDiv.style.display = 'block';
    return;
  }
  
  if(emptyDiv) emptyDiv.style.display = 'none';
  
  let totalValue = 0;
  vinlagerVarer.forEach(v => {
    const antal = Number(vinlagerData[v.id] || 0);
    const pris = Number(v.pris) || 0;
    const v√¶rdi = antal * pris;
    totalValue += v√¶rdi;
    
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #eee';
    tr.innerHTML = `
      <td style="padding:12px;">${v.navn || 'Ukendt'}</td>
      <td style="padding:12px;">${v.maaleenhed || '-'}</td>
      <td style="padding:12px; text-align:right; font-weight:bold;">${antal.toLocaleString('da-DK')}</td>
      <td style="padding:12px; text-align:right;">${pris.toFixed(2)} kr.</td>
      <td style="padding:12px; text-align:right; font-weight:bold; color:#2196F3;">${v√¶rdi.toFixed(2)} kr.</td>
      <td style="padding:12px;">${v.reolNr ? 'Reol ' + v.reolNr : ''}${v.reolNr && v.hylleNr ? ' / ' : ''}${v.hylleNr ? 'Hylle ' + v.hylleNr : ''}</td>
    `;
    tbody.appendChild(tr);
  });
  
  // Tilf√∏j total r√¶kke
  const totalRow = document.createElement('tr');
  totalRow.style.background = '#f5f5f5';
  totalRow.style.fontWeight = 'bold';
  totalRow.innerHTML = `
    <td style="padding:12px;" colspan="2"><strong>TOTAL</strong></td>
    <td style="padding:12px; text-align:right;"></td>
    <td style="padding:12px; text-align:right;"></td>
    <td style="padding:12px; text-align:right; color:#2196F3; font-size:16px;">${totalValue.toFixed(2)} kr.</td>
    <td style="padding:12px;"></td>
  `;
  tbody.appendChild(totalRow);
}

/* edit session count inline */
function editSessionCount(vareId, selectedLoc){
  if(!activeSession) return alert('Ingen aktiv opt√¶llingsrunde');
  let locToEdit = selectedLoc && selectedLoc !== '' ? selectedLoc : null;
  if(!locToEdit){
    const locs = Object.keys(activeSession.counts||{}).filter(l=> (activeSession.counts[l] && activeSession.counts[l][vareId]));
    if(locs.length === 1) locToEdit = locs[0];
    else {
      const choice = prompt('Indtast lokation hvor du vil rette antallet (skriv pr√¶cis lokationsnavn):', locs[0] || '');
      if(choice === null) return;
      locToEdit = choice;
      if(!activeSession.counts[locToEdit]) activeSession.counts[locToEdit] = {};
    }
  }
  const current = Number((activeSession.counts[locToEdit] && activeSession.counts[locToEdit][vareId]) || 0);
  const ny = prompt(`Ret antal for varen (lokation: ${locToEdit})`, String(current));
  if(ny === null) return;
  const nyNum = parseFloat(ny);
  if(Number.isNaN(nyNum) || nyNum < 0) return alert('Ugyldigt antal');
  activeSession.counts[locToEdit][vareId] = nyNum;
  updateLogPreview();
  renderLagerTable();
  saveAllData();
}

/* edit permanent counts */
function editCount(vareId, loc){
  if(activeSession) return alert('Sluk for aktiv opt√¶llingsrunde f√∏r du redigerer permanent lager her.');
  const current = Number((lagerData[loc] && lagerData[loc][vareId]) || 0);
  const ny = prompt(`Ret permanent antal for varen (lokation: ${loc || 'Alle/ukendt'})`, String(current));
  if(ny === null) return;
  const nyNum = parseFloat(ny);
  if(Number.isNaN(nyNum) || nyNum < 0) return alert('Ugyldigt antal');
  if(!loc) return alert('Dette redigeringsfelt kr√¶ver en lokation');
  if(!lagerData[loc]) lagerData[loc] = {};
  lagerData[loc][vareId] = nyNum;
  reports.unshift({ ts: Date.now(), handling: 'Redigeret permanent antal', vare: (masterVarelager.find(m=>m.id===vareId)||{}).navn || vareId, antal: nyNum, placering: loc, type:'single' });
  renderLagerTable(); renderReports(); updateLogPreview();
  saveAllData();
}

/* clear counts for location */
function clearCurrentCounts(){
  const lok = $('lagerLokationSelect') ? $('lagerLokationSelect').value : '';
  if(!lok) return alert('V√¶lg en lokation');
  if(!confirm(`Nulstil opt√¶lling for lokation: ${lok}?`)) return;
  if(activeSession){
    if(activeSession.counts && activeSession.counts[lok]) activeSession.counts[lok] = {};
    reports.unshift({ ts: Date.now(), handling: `${activeSession ? activeSession.name : 'Manuel'} - Nulstil lokation`, vare:'-', antal:0, placering: lok });
    updateLogPreview(); renderLagerTable(); renderReports();
    saveAllData();
  } else {
    lagerData[lok] = {};
    reports.unshift({ ts: Date.now(), handling: 'Nulstil lokation', vare:'-', antal:0, placering: lok });
    renderLagerTable(); renderReports(); updateLogPreview();
    saveAllData();
  }
}

/* ================================
   [JS 10] BARCODE SCANNER
   ================================ */
let scannerActive = false;
let scannerStream = null;
let codeReader = null;
let lastScannedCode = null;
let scanCooldown = 1000; // 1 sekund mellem scans

async function startScanner(){
  if(scannerActive){
    stopScanner();
    return;
  }
  
  // Tjek om ZXing er tilg√¶ngelig
  if(typeof ZXing === 'undefined' || !ZXing.BrowserMultiFormatReader){
    alert('Barcode scanner library ikke indl√¶st. Genindl√¶s siden og pr√∏v igen.');
    return;
  }
  
  // Tjek om vi er p√• HTTPS eller localhost (p√•kr√¶vet for kamera)
  const isSecure = window.location.protocol === 'https:' || 
                   window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1';
  
  if(!isSecure){
    const hostname = window.location.hostname;
    const protocol = window.location.protocol;
    const port = window.location.port || '8000';
    
    // Vis advarsel om HTTPS/localhost krav
    const useLocalhost = confirm(
      '‚ö†Ô∏è KAMERA KR√ÜVER HTTPS ELLER LOCALHOST\n\n' +
      'Du bruger: ' + protocol + '//' + hostname + ':' + port + '\n\n' +
      'P√• din telefon skal du bruge HTTPS for at f√• adgang til kameraet.\n\n' +
      'L√òSNINGER:\n' +
      '1. P√• computeren: Brug http://localhost:8000 i stedet\n' +
      '2. P√• telefonen: Du skal bruge HTTPS (se nedenfor)\n\n' +
      'Vil du forts√¶tte alligevel? (Det vil sandsynligvis fejle)'
    );
    
    if(!useLocalhost){
      // Vis instruktioner
      const instructions = 
        'üì± KAMERA P√Ö TELEFON - INSTRUKTIONER:\n\n' +
        'Kameraet kr√¶ver HTTPS p√• telefonen. Du har 2 muligheder:\n\n' +
        'MULIGHED 1: Brug manuel indtastning i stedet\n' +
        '- I stedet for at scanne, kan du indtaste stregkoden manuelt\n' +
        '- Klik p√• "S√∏g vare" og indtast stregkoden\n\n' +
        'MULIGHED 2: Opret HTTPS server (avanceret)\n' +
        '- Dette kr√¶ver SSL-certifikat og er kompliceret\n' +
        '- Anbefalet: Brug manuel indtastning i stedet\n\n' +
        'P√• computeren kan du bruge:\n' +
        'http://localhost:8000/k√∏kkenlager24 password (nyt pas) import scan.html\n' +
        'Dette virker med kameraet!';
      
      alert(instructions);
      return;
    }
  }
  
  const modal = $('scannerModal');
  const video = $('scannerVideo');
  const status = $('scannerStatus');
  const result = $('scannerResult');
  const warning = $('scannerWarning');
  
  if(!modal || !video || !status) return;
  
  // Vis modal
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  
  // Vis/skjul advarsel baseret p√• om vi er p√• HTTPS/localhost
  if(warning){
    if(isSecure){
      warning.style.display = 'none';
    } else {
      warning.style.display = 'block';
    }
  }
  
  status.textContent = 'Starter kamera...';
  status.style.background = '#fff3cd';
  result.style.display = 'none';
  video.style.display = 'none';
  
  try {
    // Tjek om getUserMedia er tilg√¶ngelig
    if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
      throw new Error('Kamera API ikke tilg√¶ngelig. Brug HTTPS eller localhost.');
    }
    
    // F√• adgang til kamera
    const stream = await navigator.mediaDevices.getUserMedia({
      video: {
        facingMode: 'environment', // Brug bagkamera p√• mobil
        width: { ideal: 1280 },
        height: { ideal: 720 }
      }
    });
    
    scannerStream = stream;
    video.srcObject = stream;
    video.style.display = 'block';
    scannerActive = true;
    
    // Vent p√• at video faktisk starter at spille
    try {
      await new Promise((resolve, reject) => {
        const timeout = setTimeout(() => {
          // Timeout - men forts√¶t alligevel, video kan stadig virke
          console.warn('Video timeout, men forts√¶tter...');
          resolve();
        }, 3000);
        
        const tryPlay = () => {
          video.play().then(() => {
            clearTimeout(timeout);
            resolve();
          }).catch(err => {
            // Ignorer play fejl - video kan stadig v√¶re klar
            console.warn('Video play fejl (ignoreres):', err);
            clearTimeout(timeout);
            resolve();
          });
        };
        
        if(video.readyState >= 2){
          // Video er allerede klar
          tryPlay();
        } else {
          video.onloadedmetadata = tryPlay;
          video.oncanplay = tryPlay;
        }
      });
    } catch(videoErr){
      console.warn('Video start fejl (ignoreres):', videoErr);
      // Forts√¶t alligevel - video kan stadig virke
    }
    
    // Initialiser ZXing code reader
    const { BrowserMultiFormatReader } = ZXing;
    codeReader = new BrowserMultiFormatReader();
    
    status.textContent = 'Peger p√• stregkoden...';
    status.style.background = '#E3F2FD';
    
    // Opdater knapper
    const scannerBtn = $('scannerBtn');
    const stopBtn = $('stopScannerBtn');
    if(scannerBtn) scannerBtn.style.display = 'none';
    if(stopBtn) stopBtn.style.display = 'inline-block';
    
    // Vent lidt mere for at video kan starte korrekt
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Start scanning - VIGTIGT: Send video elementet, ikke video.id!
    try {
      // Tjek om video faktisk spiller
      if(video.readyState < 2){
        // Vent lidt mere hvis video ikke er klar
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      // ZXing API: decodeFromVideoDevice(deviceId, videoElement, callback)
      // deviceId = null betyder auto-select kamera
      // videoElement = video DOM elementet
      console.log('Starter scanning med video element:', video);
      console.log('Video readyState:', video.readyState);
      console.log('Video playing:', !video.paused);
      
      codeReader.decodeFromVideoDevice(null, video, (result, err) => {
        if(result){
          console.log('Scan resultat modtaget:', result);
          // H√•ndter b√•de .text og .getText() metoder
          let code = null;
          if(typeof result === 'string'){
            code = result;
          } else if(result.text){
            code = result.text;
          } else if(result.getText){
            code = result.getText();
          } else {
            code = String(result);
          }
          
          if(code){
            console.log('Scannet stregkode:', code);
            handleScannedCode(code);
          } else {
            console.warn('Ingen stregkode i resultat:', result);
          }
        }
        if(err){
          // NotFoundException er normalt - betyder bare at der ikke er fundet en stregkode endnu
          // Ignorer disse fejl da de er forventede
          const isNormalError = err.name === 'NotFoundException' || 
                               err.name === 'NotFoundError' || 
                               err.name === 'NoDeviceFoundError' ||
                               (err.message && (err.message.includes('No QR') || err.message.includes('not found')));
          
          if(!isNormalError){
            console.error('Scan fejl:', err);
            // Vis fejl hvis det ikke er en "ikke fundet" fejl
            if(status){
              status.textContent = 'Scan fejl: ' + (err.message || err.name || 'Ukendt fejl');
              status.style.background = '#ffebee';
              // Reset efter 3 sekunder
              setTimeout(() => {
                if(status){
                  status.textContent = 'Peger p√• stregkoden...';
                  status.style.background = '#E3F2FD';
                }
              }, 3000);
            }
          }
        }
      });
      
      console.log('Scanning startet');
      
      // Opdater status
      status.textContent = 'Peger p√• stregkoden...';
      status.style.background = '#E3F2FD';
      
    } catch(scanErr){
      console.error('Fejl ved start af scanning:', scanErr);
      if(status){
        status.textContent = 'Fejl ved start af scanning: ' + (scanErr.message || scanErr);
        status.style.background = '#ffebee';
      }
      alert('Kunne ikke starte scanning. Pr√∏v at genindl√¶se siden.\n\nFejl: ' + (scanErr.message || scanErr));
    }
    
  } catch(err){
    console.error('Kamera fejl:', err);
    scannerActive = false;
    
    let errorMsg = '';
    let instructions = '';
    
    if(err.name === 'NotAllowedError'){
      errorMsg = 'Kamera tilladelse n√¶gtet.';
      instructions = 
        'Giv tilladelse til kamera:\n' +
        '1. Klik p√• kamera-ikonet i browserens adresselinje\n' +
        '2. V√¶lg "Tillad" for kamera\n' +
        '3. Genindl√¶s siden og pr√∏v igen';
    } else if(err.name === 'NotFoundError'){
      errorMsg = 'Ingen kamera fundet.';
      instructions = 'Tjek at dit kamera er tilsluttet og ikke bruges af andre programmer.';
    } else if(err.message && err.message.includes('HTTPS')){
      errorMsg = 'Kamera kr√¶ver HTTPS eller localhost.';
      instructions = 
        'P√• computeren: Brug http://localhost:8000 i stedet for IP-adresse\n' +
        'P√• telefonen: Kameraet virker ikke med HTTP. Brug manuel indtastning i stedet.';
    } else {
      errorMsg = 'Kunne ikke starte scanner: ' + (err.message || err.name || 'Ukendt fejl');
      instructions = 
        'Pr√∏v:\n' +
        '1. Genindl√¶s siden\n' +
        '2. Tjek browser tilladelser for kamera\n' +
        '3. Brug localhost p√• computeren i stedet for IP-adresse';
    }
    
    status.textContent = errorMsg;
    status.style.background = '#ffebee';
    status.style.padding = '12px';
    status.style.whiteSpace = 'pre-line';
    status.innerHTML = '<strong>' + errorMsg + '</strong><br><br>' + instructions;
    
    alert(errorMsg + '\n\n' + instructions);
  }
}

function handleScannedCode(code){
  const now = Date.now();
  
  // Undg√• duplikat scans
  if(lastScannedCode === code && (now - (lastScannedCode.time || 0)) < scanCooldown){
    return;
  }
  
  lastScannedCode = { code, time: now };
  
  // Find vare med dette ID
  const vare = masterVarelager.find(v => v.id === code);
  
  const status = $('scannerStatus');
  const result = $('scannerResult');
  const scannedName = $('scannedVareName');
  
  if(!vare){
    status.textContent = 'Vare ikke fundet: ' + code;
    status.style.background = '#ffebee';
    result.style.display = 'none';
    
    // Vis fejl i 2 sekunder
    setTimeout(() => {
      if(status) status.textContent = 'Peger p√• stregkoden...';
      if(status) status.style.background = '#E3F2FD';
    }, 2000);
    return;
  }
  
  // Vare fundet - tilf√∏j til opt√¶lling
  const antal = 1; // Standard antal ved scanning
  const lokation = vare.placering || '';
  
  const success = addToSessionOrWarn(lokation, vare.id, antal);
  
  if(success){
    status.textContent = '‚úì Vare tilf√∏jet: ' + vare.navn;
    status.style.background = '#c8e6c9';
    
    if(result && scannedName){
      result.style.display = 'block';
      scannedName.textContent = vare.navn + ' (' + antal + ' ' + (vare.maaleenhed || 'stk') + ')';
    }
    
    // Vis success i 1.5 sekunder, derefter tilbage til scanning
    setTimeout(() => {
      if(status) status.textContent = 'Peger p√• stregkoden...';
      if(status) status.style.background = '#E3F2FD';
      if(result) result.style.display = 'none';
    }, 1500);
    
    // Opdater lager tabel
    renderLagerTable();
    updateLogPreview();
    saveAllData();
  } else {
    status.textContent = 'Kunne ikke tilf√∏je vare';
    status.style.background = '#ffebee';
  }
}

function stopScanner(){
  scannerActive = false;
  
  // Stop video stream
  if(scannerStream){
    scannerStream.getTracks().forEach(track => track.stop());
    scannerStream = null;
  }
  
  // Stop code reader
  if(codeReader){
    codeReader.reset();
    codeReader = null;
  }
  
  // Skjul modal
  const modal = $('scannerModal');
  const video = $('scannerVideo');
  const status = $('scannerStatus');
  const result = $('scannerResult');
  
  if(modal){
    modal.classList.add('hidden');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }
  
  if(video){
    video.srcObject = null;
  }
  
  if(status){
    status.textContent = '';
    status.style.background = '#f0f0f0';
  }
  
  if(result){
    result.style.display = 'none';
  }
  
  // Opdater knapper
  const scannerBtn = $('scannerBtn');
  const stopBtn = $('stopScannerBtn');
  if(scannerBtn) scannerBtn.style.display = 'inline-block';
  if(stopBtn) stopBtn.style.display = 'none';
  
  lastScannedCode = null;
}

/* ================================
   [JS 8] RAPPORTER + PDF (DEL 3)
   ================================ */
function renderReports(){
  const tbody = $('reportsTable'); if(!tbody) return;
  const locFilter = $('reportsLocation') ? $('reportsLocation').value : '';
  const periodFilter = $('reportsPeriod') ? $('reportsPeriod').value : 'all';
  
  // Beregn dato filter
  let dateFrom = null;
  let dateTo = null;
  const now = Date.now();
  
  if(periodFilter === '1week'){
    dateFrom = now - (7 * 24 * 60 * 60 * 1000);
  } else if(periodFilter === '14days'){
    dateFrom = now - (14 * 24 * 60 * 60 * 1000);
  } else if(periodFilter === '1month'){
    dateFrom = now - (30 * 24 * 60 * 60 * 1000);
  } else if(periodFilter === 'custom'){
    const fromInput = $('reportsDateFrom');
    const toInput = $('reportsDateTo');
    if(fromInput && fromInput.value){
      dateFrom = new Date(fromInput.value).getTime();
    }
    if(toInput && toInput.value){
      dateTo = new Date(toInput.value).getTime() + (24 * 60 * 60 * 1000) - 1; // Slut p√• dagen
    }
  }
  
  tbody.innerHTML=''; let shown=0;
  const visibleReports = [];
  
  // F√∏rst filtrer rapporterne
  for(let i=0;i<reports.length;i++){
    const r = reports[i];
    
    // Filtrer efter lokation
    if(locFilter){
      if(r.scope && r.scope !== locFilter){
        if(!(r.scope === '' && r.details?.some(d=> d.placering === locFilter))) continue;
      }
    }
    
    // Filtrer efter dato
    if(dateFrom && r.ts < dateFrom) continue;
    if(dateTo && r.ts > dateTo) continue;
    
    visibleReports.push({ report: r, originalIndex: i });
  }
  
  // Tilf√∏j "Vis PDF (Alle)" knap i f√∏rste r√¶kke hvis der er rapporter
  if(visibleReports.length > 0){
    const headerRow = document.createElement('tr');
    headerRow.style.background = '#f9f9f9';
    headerRow.innerHTML = `<td colspan="5" style="text-align:right; padding:8px 12px; font-weight:bold; color:#666;">Vis alle rapporter:</td><td style="white-space:nowrap; padding:8px 12px;"><button class="secondary small" onclick="viewAllReportsPDF()" style="margin-right:4px;">üìÑ Vis PDF (Alle)</button></td>`;
    tbody.appendChild(headerRow);
  }
  
  // Vis alle filtrerede rapporter - scrollbar h√•ndterer visning af 6 ad gangen
  visibleReports.forEach(({ report: r, originalIndex: i }, index) => {
    const tr = document.createElement('tr');
    const title = r.handling;
    const summary = r.type === 'session' ? `${r.details.length} linjer ‚Äî ${r.total.toFixed(2)} kr.` : (r.vare || '-');
    
    // Beregn total antal for sessions (sum af alle antal i details)
    let antalDisplay = '';
    if(r.type === 'session'){
      if(r.details && r.details.length > 0){
        const totalAntal = r.details.reduce((sum, d) => sum + (Number(d.antal) || 0), 0);
        antalDisplay = totalAntal.toString();
      } else {
        antalDisplay = '-';
      }
    } else {
      antalDisplay = (r.antal || '').toString();
    }
    
    // Bestem lokation - for sessions, saml alle unikke lokationer fra details
    let lokationDisplay = '';
    if(r.type === 'session'){
      if(r.details && r.details.length > 0){
        const uniqueLocs = [...new Set(r.details.map(d => d.placering).filter(p => p))];
        lokationDisplay = uniqueLocs.length > 0 ? uniqueLocs.join(', ') : (r.scope || '-');
      } else {
        lokationDisplay = r.scope || '-';
      }
    } else {
      lokationDisplay = r.scope || r.placering || '-';
    }
    
    // Check if report was imported from server
    const isFromServer = r.importedFromServer || r.gistId;
    const serverBadge = isFromServer ? '<span style="background:#17a2b8; color:white; padding:3px 8px; border-radius:4px; font-size:11px; margin-left:8px; font-weight:600; display:inline-block;" title="Hentet fra server">‚òÅÔ∏è Server</span>' : '<span style="background:#28a745; color:white; padding:3px 8px; border-radius:4px; font-size:11px; margin-left:8px; font-weight:600; display:inline-block;" title="Lokal opt√¶lling">üì± Lokal</span>';
    
    tr.innerHTML = `<td>${formatTime(r.ts)}</td><td>${title}${serverBadge}</td><td>${summary}</td><td>${antalDisplay}</td><td>${lokationDisplay}</td><td style="white-space:nowrap"><button class="secondary small" onclick="viewReportPDF(${i})" style="margin-right:4px;">üìÑ Vis PDF</button><button class="secondary small" onclick="exportReportPDF(${i})" style="margin-right:4px;">üíæ Download</button><button class="secondary small" onclick="moveReportToArchive(${i})" style="background:#FF9800; color:white;">üì¶ Arkiver</button></td>`;
    tbody.appendChild(tr); shown++;
  });
  
  if(shown === 0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#666;">Ingen rapporter fundet for de valgte filtre</td></tr>';
  }
}

function updateReportsDateInputs(){
  const periodSelect = $('reportsPeriod');
  const customInputs = $('customDateInputs');
  if(!periodSelect || !customInputs) return;
  
  if(periodSelect.value === 'custom'){
    customInputs.style.display = 'flex';
  } else {
    customInputs.style.display = 'none';
  }
}

function saveArchiveSettings(){
  const select = $('archivePeriod');
  if(!select) return;
  archivePeriod = parseInt(select.value) || 0;
  saveAllData();
  const status = $('archiveStatus');
  if(status){
    if(archivePeriod > 0){
      status.textContent = `‚úì Indstilling gemt: Rapporter arkiveres automatisk efter ${archivePeriod} m√•neder`;
      status.style.color = '#0078D4';
    } else {
      status.textContent = '‚úì Indstilling gemt: Ingen automatisk arkivering';
      status.style.color = '#666';
    }
  }
}

function checkAndArchiveReports(showAlert = true){
  if(archivePeriod === 0){
    if(showAlert){
      alert('Ingen automatisk arkivering er aktiveret. V√¶lg en periode i dropdown menuen f√∏rst.');
    }
    return;
  }
  
  const now = Date.now();
  const archiveThreshold = archivePeriod * 30 * 24 * 60 * 60 * 1000; // Konverter m√•neder til millisekunder
  const cutoffDate = now - archiveThreshold;
  
  let archivedCount = 0;
  const reportsToKeep = [];
  
  for(let i = 0; i < reports.length; i++){
    if(reports[i].ts < cutoffDate){
      archivedReports.push(reports[i]);
      archivedCount++;
    } else {
      reportsToKeep.push(reports[i]);
    }
  }
  
  reports = reportsToKeep;
  saveAllData();
  
  const status = $('archiveStatus');
  if(status){
    if(archivedCount > 0){
      status.textContent = `‚úì ${archivedCount} rapport(er) arkiveret (√¶ldre end ${archivePeriod} m√•neder)`;
      status.style.color = '#0078D4';
    } else {
      if(showAlert){
        status.textContent = 'Ingen rapporter at arkivere (alle er nyere end den valgte periode)';
        status.style.color = '#666';
      } else {
        status.textContent = '';
      }
    }
  }
  
  if(archivedCount > 0 || showAlert){
    renderReports();
    renderArchivedReports(); // Opdater ogs√• arkiverede rapporter
    if(status && archivedCount > 0){
      setTimeout(() => {
        if(status) status.textContent = '';
      }, 5000);
    }
  }
}

function moveReportToArchive(index){
  if(!confirm('Er du sikker p√• at du vil flytte denne rapport til arkiv?')){
    return;
  }
  
  if(index < 0 || index >= reports.length){
    alert('Ugyldig rapport index');
    return;
  }
  
  const report = reports[index];
  archivedReports.push(report);
  reports.splice(index, 1);
  
  // Sorter arkiverede rapporter efter dato (nyeste f√∏rst)
  archivedReports.sort((a, b) => b.ts - a.ts);
  
  saveAllData();
  renderReports();
  renderArchivedReports();
  alert('Rapport flyttet til arkiv');
}

function renderArchivedReports(){
  const tbody = $('archivedReportsTable');
  if(!tbody) return;
  tbody.innerHTML = '';
  
  if(archivedReports.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#666;">Ingen arkiverede rapporter</td></tr>';
    return;
  }
  
  // Hent s√∏gekriterier
  const monthFilter = $('archivedReportsMonth')?.value || '';
  const dateFilter = $('archivedReportsDate')?.value || '';
  
  // Filtrer rapporter
  let filtered = [...archivedReports];
  
  if(monthFilter){
    // Filtrer efter m√•ned/√•r (format: YYYY-MM)
    const [year, month] = monthFilter.split('-');
    filtered = filtered.filter(r => {
      const reportDate = new Date(r.ts);
      return reportDate.getFullYear() === parseInt(year) && 
             (reportDate.getMonth() + 1) === parseInt(month);
    });
  }
  
  if(dateFilter){
    // Filtrer efter specifik dato
    const filterDate = new Date(dateFilter);
    const filterDateStart = new Date(filterDate.getFullYear(), filterDate.getMonth(), filterDate.getDate()).getTime();
    const filterDateEnd = filterDateStart + (24 * 60 * 60 * 1000) - 1;
    filtered = filtered.filter(r => r.ts >= filterDateStart && r.ts <= filterDateEnd);
  }
  
  // Sorter efter dato (nyeste f√∏rst)
  const sorted = filtered.sort((a, b) => b.ts - a.ts);
  
  if(sorted.length === 0){
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#666;">Ingen rapporter fundet for de valgte s√∏gekriterier</td></tr>';
    return;
  }
  
  sorted.forEach((r, i) => {
    const tr = document.createElement('tr');
    const title = r.handling;
    const summary = r.type === 'session' ? `${r.details.length} linjer ‚Äî ${r.total.toFixed(2)} kr.` : (r.vare || '-');
    
    // Beregn total antal for sessions
    let antalDisplay = '';
    if(r.type === 'session'){
      if(r.details && r.details.length > 0){
        const totalAntal = r.details.reduce((sum, d) => sum + (Number(d.antal) || 0), 0);
        antalDisplay = totalAntal.toString();
      } else {
        antalDisplay = '-';
      }
    } else {
      antalDisplay = (r.antal || '').toString();
    }
    
    // Bestem lokation
    let lokationDisplay = '';
    if(r.type === 'session'){
      if(r.details && r.details.length > 0){
        const uniqueLocs = [...new Set(r.details.map(d => d.placering).filter(p => p))];
        lokationDisplay = uniqueLocs.length > 0 ? uniqueLocs.join(', ') : (r.scope || '-');
      } else {
        lokationDisplay = r.scope || '-';
      }
    } else {
      lokationDisplay = r.scope || r.placering || '-';
    }
    
    // Check if report was imported from server
    const isFromServer = r.importedFromServer || r.gistId;
    const serverBadge = isFromServer ? '<span style="background:#17a2b8; color:white; padding:3px 8px; border-radius:4px; font-size:11px; margin-left:8px; font-weight:600; display:inline-block;" title="Hentet fra server">‚òÅÔ∏è Server</span>' : '<span style="background:#28a745; color:white; padding:3px 8px; border-radius:4px; font-size:11px; margin-left:8px; font-weight:600; display:inline-block;" title="Lokal opt√¶lling">üì± Lokal</span>';
    
    tr.innerHTML = `<td>${formatTime(r.ts)}</td><td>${title}${serverBadge}</td><td>${summary}</td><td>${antalDisplay}</td><td>${lokationDisplay}</td><td style="white-space:nowrap"><button class="secondary small" onclick="viewArchivedReportPDF(${i})" style="margin-right:4px;">üìÑ Vis PDF</button><button class="secondary small" onclick="exportArchivedReportPDF(${i})">üíæ Download</button></td>`;
    tbody.appendChild(tr);
  });
}

async function viewArchivedReportPDF(index){
  if(index < 0 || index >= archivedReports.length){
    alert('Ugyldig rapport index');
    return;
  }
  const r = archivedReports[index];
  if(!r) return alert('Rapport ikke fundet');
  try {
    const pdfUrl = await generateReportPDF(r, true);
    if(pdfUrl){
      window.open(pdfUrl, '_blank');
    }
  } catch(err){
    alert('Fejl ved visning af PDF: ' + err.message);
  }
}

async function exportArchivedReportPDF(index){
  if(index < 0 || index >= archivedReports.length){
    alert('Ugyldig rapport index');
    return;
  }
  const r = archivedReports[index];
  if(!r) return alert('Rapport ikke fundet');
  try {
    const doc = await generateReportPDF(r, false);
    const filename = `rapport_${(r.handling||'optaelling').replace(/[^\w\-]+/g,'_')}_${r.ts}.pdf`;
    doc.save(filename);
  } catch(err){
    alert('Fejl ved download af PDF: ' + err.message);
  }
}

async function getLogoDataURL(){
  // Tjek f√∏rst om der er et uploaded logo (img tag)
  const imgTag = document.querySelector('.logo-svg img');
  if(imgTag && imgTag.src){
    // Hvis det er en data URL, returner den direkte
    if(imgTag.src.startsWith('data:')){
      return imgTag.src;
    }
    // Hvis det er en fil URL, konverter til data URL
    try {
      const response = await fetch(imgTag.src);
      const blob = await response.blob();
      return await new Promise(resolve=>{
        const reader = new FileReader();
        reader.onload = ()=> resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    } catch(e) {
      console.warn('Kunne ikke konvertere logo:', e);
    }
  }
  
  // Ellers brug standard SVG
  const svgWrap = document.querySelector('.logo-svg svg');
  if(!svgWrap) return null;
  // serialize inline svg to data URL
  const svg = svgWrap.outerHTML;
  const blob = new Blob([svg], {type:'image/svg+xml;charset=utf-8'});
  return await new Promise(resolve=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(reader.result);
    reader.readAsDataURL(blob);
  });
}

// Generer PDF dokument (delt funktionalitet)
async function generateReportPDF(r, forView = false){
  const { jsPDF } = window.jspdf;
  if(!jsPDF) return alert('jsPDF mangler');
  const doc = new jsPDF({ unit:'mm', format:'a4' }); let y=15; const margin=15;
  const titleStartX = margin + 2; // X position where title starts
  const tableLeft = margin; // Table starts at margin (same as title frame)
  // Title frame is 180mm wide from margin, so table should match that
  const titleFrameWidth = 180; // Width of title frame
  const tableRight = margin + titleFrameWidth; // Match title frame width exactly
  const tableWidth = tableRight - tableLeft; // Width matches title frame width (180mm)
  
  const logo = await getLogoDataURL(); if(logo){ try{ doc.addImage(logo,'SVG',margin,y,40,15); y+=20; }catch(e){ y+=5; } }
  const startContentY = y; // Remember where content starts for side borders
  
  // Titel med ramme
  doc.setDrawColor(100, 100, 100);
  doc.setLineWidth(0.5);
  doc.setFillColor(245, 245, 245);
  doc.rect(margin, y-5, 180, 10, 'FD');
  doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text(r.handling, titleStartX, y+2); y+=12;
  doc.setFont('helvetica','normal'); doc.setFontSize(11); doc.text(`Dato: ${formatTime(r.ts)}`, titleStartX, y); y+=8;
  
  // Function to draw side borders on current page
  const drawSideBorders = (fromY, toY) => {
    doc.setDrawColor(150, 150, 150);
    doc.setLineWidth(0.5);
    // Left border
    doc.line(tableLeft, fromY, tableLeft, toY);
    // Right border
    doc.line(tableRight, fromY, tableRight, toY);
  };
  
  // Calculate column positions based on header text widths - exactly match header width
  doc.setFont('helvetica','bold'); doc.setFontSize(9);
  // Use fixed column widths to prevent overlap - varenavn gets most space
  const colVarenavn = titleStartX; // Start at same position as title (margin+2)
  const colVarenavnWidth = 60; // Varenavn column width (mm) - reduced to make room for varenummer
  const colVarenummer = colVarenavn + colVarenavnWidth + 2; // 2mm padding
  const colVarenummerWidth = 20; // Varenummer column width
  const colReol = colVarenummer + colVarenummerWidth + 2;
  const colReolWidth = 12;
  const colHylle = colReol + colReolWidth + 2;
  const colHylleWidth = 12;
  const colAntal = colHylle + colHylleWidth + 2;
  const colAntalWidth = 25;
  const colPris = colAntal + colAntalWidth + 2;
  const colPrisWidth = 20;
  const colLinjetotal = colPris + colPrisWidth + 2;
  const colLinjetotalWidth = 25;
  
  if(r.type === 'session' && r.details && r.details.length > 0){
    // Sorter efter placering, derefter reolNr, derefter hylleNr
    const sortedDetails = [...r.details].sort((a, b) => {
      if(a.placering !== b.placering) return (a.placering || '').localeCompare(b.placering || '');
      if((a.reolNr || '') !== (b.reolNr || '')) return (a.reolNr || '').localeCompare(b.reolNr || '');
      const hylleA = parseInt(a.hylleNr) || 0;
      const hylleB = parseInt(b.hylleNr) || 0;
      if(hylleA !== hylleB) return hylleA - hylleB;
      return (a.hylleNr || '').localeCompare(b.hylleNr || '');
    });
    
    // Grupp√©r efter placering -> reolNr -> hylleNr
    const grouped = {};
    sortedDetails.forEach(d => {
      const loc = d.placering || 'Ukendt lokation';
      if(!grouped[loc]) grouped[loc] = {};
      const reol = d.reolNr || 'Ingen reol';
      if(!grouped[loc][reol]) grouped[loc][reol] = {};
      const hylle = d.hylleNr || 'Ingen hylle';
      if(!grouped[loc][reol][hylle]) grouped[loc][reol][hylle] = [];
      grouped[loc][reol][hylle].push(d);
    });
    
    let grandTotal = 0;
    let headerShown = false;
    let pageStartY = y; // Track where current page content started
    
    // Vis header √©n gang f√∏rst med ramme
    if(y>250){ doc.addPage(); y=15; pageStartY = y; }
    doc.setDrawColor(150, 150, 150);
    doc.setFillColor(240, 240, 240);
    doc.setLineWidth(0.3);
    doc.rect(tableLeft, y-3, tableWidth, 5, 'FD');
    doc.setFont('helvetica','bold'); doc.setFontSize(10);
    doc.text('Varenavn', colVarenavn, y+1);
    doc.text('Varenummer', colVarenummer, y+1);
    doc.text('Reol', colReol, y+1);
    doc.text('Hylle', colHylle, y+1);
    doc.text('Antal optalt varer', colAntal, y+1);
    doc.text('Pris', colPris, y+1);
    doc.text('Linjetotal', colLinjetotal, y+1);
    y+=6;
    doc.setDrawColor(200, 200, 200);
    doc.line(tableLeft, y, tableRight, y);
    y+=3;
    headerShown = true;
    
    // Gennemg√• grupperet struktur
    for(const loc of Object.keys(grouped)){
      let locSubtotal = 0;
      
      for(const reol of Object.keys(grouped[loc])){
        for(const hylle of Object.keys(grouped[loc][reol])){
          const items = grouped[loc][reol][hylle];
          
          items.forEach(it => {
            if(y>275){ 
              // Draw side borders on previous page before adding new page
              drawSideBorders(pageStartY, y);
              doc.addPage(); 
              y=15;
              pageStartY = y;
              // Gentag header p√• ny side med ramme
              doc.setDrawColor(150, 150, 150);
              doc.setFillColor(240, 240, 240);
              doc.setLineWidth(0.3);
              doc.rect(tableLeft, y-3, tableWidth, 5, 'FD');
              doc.setFont('helvetica','bold'); doc.setFontSize(10);
              doc.text('Varenavn', colVarenavn, y+1);
              doc.text('Varenummer', colVarenummer, y+1);
              doc.text('Reol', colReol, y+1);
              doc.text('Hylle', colHylle, y+1);
              doc.text('Antal optalt varer', colAntal, y+1);
              doc.text('Pris', colPris, y+1);
              doc.text('Linjetotal', colLinjetotal, y+1);
              y+=6;
              doc.setDrawColor(200, 200, 200);
              doc.line(tableLeft, y, tableRight, y);
              y+=3;
            }
            
            // Alternerende baggrund for r√¶kker
            const rowIndex = items.indexOf(it);
            if(rowIndex % 2 === 0){
              doc.setFillColor(255, 255, 255);
            } else {
              doc.setFillColor(250, 250, 250);
            }
            doc.rect(tableLeft, y-2, tableWidth, 4, 'F');
            
            // Varenavn - show full name, wrap if needed
            doc.setFont('helvetica','normal'); doc.setFontSize(10);
            const vareTekst = String(it.navn || '');
            
            // Get varenummer from item or masterVarelager
            let varenummer = it.varenummer || '';
            if(!varenummer && it.vareId){
              const v = masterVarelager.find(m => m.id === it.vareId);
              if(v && v.varenummer){
                varenummer = v.varenummer;
              }
            }
            
            // Use fixed width for varenavn column - adjust font size to fit (varenummer has its own column)
            const availableWidth = colVarenavnWidth; // Use fixed width
            
            // Use smaller font if text is too long, but keep on one line
            let fontSize = 10;
            doc.setFontSize(fontSize);
            let textWidth = doc.getTextWidth(vareTekst);
            if(textWidth > availableWidth){
              // Try smaller font sizes
              for(let fs = 9; fs >= 7; fs -= 0.5){
                doc.setFontSize(fs);
                textWidth = doc.getTextWidth(vareTekst);
                if(textWidth <= availableWidth){
                  fontSize = fs;
                  break;
                }
              }
            }
            
            // Set font size and display on one line - truncate if still too long
            doc.setFontSize(fontSize);
            if(textWidth > availableWidth){
              // Truncate text to fit
              let truncated = vareTekst;
              while(doc.getTextWidth(truncated + '...') > availableWidth && truncated.length > 0){
                truncated = truncated.slice(0, -1);
              }
              doc.text(truncated + '...', colVarenavn, y+1);
            } else {
              doc.text(vareTekst, colVarenavn, y+1);
            }
            
            // Reset font size for other columns
            doc.setFontSize(10);
            
            // Varenummer - in its own column
            const varenummerTekst = varenummer || '-';
            doc.text(varenummerTekst, colVarenummer, y+1);
            
            // Reol
            let reolTekst = '-';
            if(it.reolNr){
              reolTekst = String(it.reolNr);
            } else if(it.vareId){
              const v = masterVarelager.find(m => m.id === it.vareId);
              if(v && v.reolNr){
                reolTekst = String(v.reolNr);
              }
            }
            doc.text(reolTekst, colReol, y+1);
            
            // Hylle
            let hylleTekst = '-';
            if(it.hylleNr){
              hylleTekst = String(it.hylleNr);
            } else if(it.vareId){
              const v = masterVarelager.find(m => m.id === it.vareId);
              if(v && v.hylleNr){
                hylleTekst = String(v.hylleNr);
              }
            }
            doc.text(hylleTekst, colHylle, y+1);
            
            // Antal med enhed
            const antalMedEnhed = `${it.antal || 0} ${it.maaleenhed || ''}`;
            doc.text(antalMedEnhed, colAntal, y+1);
            
            // Pris
            const prisText = (it.pris||0).toFixed(2)+' kr.';
            doc.text(prisText, colPris, y+1);
            
            // Linjetotal
            const linjetotalText = (it.linjetotal||0).toFixed(2)+' kr.';
            doc.text(linjetotalText, colLinjetotal, y+1);
            
            // Linje under r√¶kke
            doc.setDrawColor(220, 220, 220);
            doc.setLineWidth(0.1);
            doc.line(tableLeft, y+2, tableRight, y+2);
            
            y+=5;
            locSubtotal += Number(it.linjetotal||0);
          });
        }
      }
      
      // Vis lokation total efter alle varer i den lokation med ramme
      if(y>270){ 
        drawSideBorders(pageStartY, y);
        doc.addPage(); 
        y=15; 
        pageStartY = y;
      }
      doc.setDrawColor(150, 150, 150);
      doc.setFillColor(245, 245, 245);
      doc.setLineWidth(0.4);
      doc.rect(tableLeft, y-3, tableWidth, 6, 'FD');
      doc.setFont('helvetica','bold'); doc.setFontSize(11);
      doc.text(`Total ${loc}: ${locSubtotal.toFixed(2)} kr.`, tableLeft + 2, y+2);
      y+=10;
      
      grandTotal += locSubtotal;
    }
    
    // Draw side borders on last page before grand total
    drawSideBorders(pageStartY, y);
    
    // Samlet total med ramme - right-aligned
    if(y>260){ doc.addPage(); y=15; pageStartY = y; }
    doc.setDrawColor(100, 100, 100);
    doc.setFillColor(235, 235, 235);
    doc.setLineWidth(0.6);
    doc.rect(tableLeft, y-4, tableWidth, 8, 'FD');
    doc.setFont('helvetica','bold'); doc.setFontSize(13);
    const samletTotalText = `Samlet total: ${grandTotal.toFixed(2)} kr.`;
    const textWidth = doc.getTextWidth(samletTotalText);
    // Right-align: position from right edge minus padding
    doc.text(samletTotalText, tableRight - textWidth - 2, y+3);
    // Draw side borders around total
    drawSideBorders(y-4, y+4);
  } else {
    // Enkeltst√•ende rapport
    let singlePageStartY = y;
    // Header med ramme
    doc.setDrawColor(150, 150, 150);
    doc.setFillColor(240, 240, 240);
    doc.setLineWidth(0.3);
    doc.rect(tableLeft, y-3, tableWidth, 5, 'FD');
    doc.setFont('helvetica','bold'); doc.setFontSize(10);
    doc.text('Varenavn', tableLeft+2, y+1);
    doc.text('Reol', tableLeft+37, y+1);
    doc.text('Hylle', tableLeft+52, y+1);
    doc.text('Antal optalt varer', tableLeft+62, y+1);
    doc.text('Lokation', tableLeft+122, y+1);
    y+=6;
    doc.setDrawColor(200, 200, 200);
    doc.line(tableLeft, y, tableRight, y);
    y+=3;
    
    // Data r√¶kke med baggrund
    doc.setFillColor(255, 255, 255);
    doc.rect(tableLeft, y-2, tableWidth, 4, 'F');
    doc.setFont('helvetica','normal'); doc.setFontSize(10);
    doc.text(String(r.vare || '-'), tableLeft+2, y+1);
    
    // Find varen for at f√• reol, hylle og enhed
    const v = masterVarelager.find(m => m.navn === r.vare || m.id === r.vareId);
    const reolTekst = v && v.reolNr ? String(v.reolNr) : '-';
    const hylleTekst = v && v.hylleNr ? String(v.hylleNr) : '-';
    const enhed = v ? (v.maaleenhed || '') : '';
    const antalMedEnhed = r.antal ? `${r.antal} ${enhed}`.trim() : '-';
    
    doc.text(reolTekst, tableLeft+37, y+1);
    doc.text(hylleTekst, tableLeft+52, y+1);
    doc.text(antalMedEnhed, tableLeft+62, y+1);
    doc.text(String(r.placering || r.scope || '-'), tableLeft+122, y+1);
    
    // Linje under
    doc.setDrawColor(220, 220, 220);
    doc.line(tableLeft, y+2, tableRight, y+2);
    y+=6;
    
    if(r.total){
      doc.setDrawColor(150, 150, 150);
      doc.setFillColor(245, 245, 245);
      doc.setLineWidth(0.4);
      doc.rect(tableLeft, y-3, tableWidth, 6, 'FD');
      doc.setFont('helvetica','bold'); doc.setFontSize(11);
      const totalText = `Total: ${r.total.toFixed(2)} kr.`;
      const totalTextWidth = doc.getTextWidth(totalText);
      // Right-align total
      doc.text(totalText, tableRight - totalTextWidth - 2, y+2);
    }
    
    // Draw side borders for single report
    drawSideBorders(singlePageStartY, y);
  }
  
  if(forView){
    return doc.output('bloburl');
  } else {
    return doc;
  }
}

// Vis PDF i browser
async function viewReportPDF(index){
  const r = reports[index]; if(!r) return alert('Rapport ikke fundet');
  try {
    const pdfUrl = await generateReportPDF(r, true);
    if(pdfUrl){
      window.open(pdfUrl, '_blank');
    }
  } catch(err){
    alert('Fejl ved visning af PDF: ' + err.message);
  }
}

// Download PDF
async function exportReportPDF(index){
  const r = reports[index]; if(!r) return alert('Rapport ikke fundet');
  try {
    const doc = await generateReportPDF(r, false);
    const filename = `rapport_${(r.handling||'optaelling').replace(/[^\w\-]+/g,'_')}_${r.ts}.pdf`;
    doc.save(filename);
  } catch(err){
    alert('Fejl ved download af PDF: ' + err.message);
  }
}

async function viewAllReportsPDF(){
  const { jsPDF } = window.jspdf; if(!jsPDF) return alert('jsPDF mangler');
  try {
    const doc = new jsPDF({ unit:'mm', format:'a4' }); let y=15; const margin=15;
    const logo = await getLogoDataURL(); if(logo){ try{ doc.addImage(logo,'SVG',margin,y,40,15); y+=20; }catch(e){ y+=5; } }
    
    // Titel med ramme
    doc.setDrawColor(100, 100, 100);
    doc.setLineWidth(0.5);
    doc.rect(margin, y-5, 180, 8);
    doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('Samlet rapport', margin+2, y+2); y+=12;
    
    for(let i=0;i<reports.length;i++){
      const r = reports[i];
      if(y>260){ doc.addPage(); y=15; }
      
      // Rapport header med ramme
      doc.setDrawColor(150, 150, 150);
      doc.setLineWidth(0.3);
      doc.rect(margin, y-4, 180, 6);
      doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text(`${r.handling} ‚Äî ${formatTime(r.ts)}`, margin+2, y+1); y+=8;
      
      if(r.type === 'session' && r.details && r.details.length > 0){
        const byLoc = {}; (r.details||[]).forEach(d=>{ if(!byLoc[d.placering]) byLoc[d.placering]=[]; byLoc[d.placering].push(d); });
        for(const loc of Object.keys(byLoc)){
          if(y>260){ doc.addPage(); y=15; }
          
          // Lokation header
          doc.setDrawColor(180, 180, 180);
          doc.setFillColor(240, 240, 240);
          doc.rect(margin, y-3, 180, 5, 'FD');
          doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text(loc, margin+2, y+1); y+=7;
          
          // Tabel header
          doc.setDrawColor(200, 200, 200);
          doc.setFillColor(250, 250, 250);
          doc.rect(margin, y-3, 180, 4, 'FD');
          doc.setFont('helvetica','bold'); doc.setFontSize(9);
          doc.text('Varenavn', margin+2, y+1);
          doc.text('Antal', margin+100, y+1);
          doc.text('Total', margin+150, y+1);
          y+=6;
          doc.line(margin, y, 195, y);
          y+=2;
          
          let subtotal=0;
          byLoc[loc].forEach((d, idx)=>{
            if(y>275){ doc.addPage(); y=15; }
            
            // Alternerende baggrund
            if(idx % 2 === 0){
              doc.setFillColor(255, 255, 255);
            } else {
              doc.setFillColor(248, 248, 248);
            }
            doc.rect(margin, y-2, 180, 4, 'F');
            
            doc.setFont('helvetica','normal'); doc.setFontSize(9);
            doc.text(`${d.navn}`, margin+2, y+1);
            doc.text(`${d.antal} ${d.maaleenhed || ''}`, margin+100, y+1);
            doc.text(`${(d.linjetotal||0).toFixed(2)} kr.`, margin+150, y+1);
            
            // Linje under hver r√¶kke
            doc.setDrawColor(220, 220, 220);
            doc.line(margin, y+2, 195, y+2);
            
            y+=5;
            subtotal += d.linjetotal;
          });
          
          // Subtotal med ramme
          if(y>270){ doc.addPage(); y=15; }
          doc.setDrawColor(150, 150, 150);
          doc.setFillColor(245, 245, 245);
          doc.rect(margin+140, y-3, 55, 5, 'FD');
          doc.setFont('helvetica','bold'); doc.setFontSize(10);
          doc.text(`Subtotal ${loc}: ${subtotal.toFixed(2)} kr.`, margin+142, y+1);
          y+=8;
        }
      }
      y+=4;
    }
    
    const pdfUrl = doc.output('bloburl');
    if(pdfUrl){
      window.open(pdfUrl, '_blank');
    }
  } catch(err){
    alert('Fejl ved visning af PDF: ' + err.message);
  }
}

/* CSV eksport */
function exportReportsCSV(){
  if(reports.length===0) return alert('Ingen rapporter at eksportere.');
  let csv = "Dato;Opt√¶lling;Vare;Antal;Pris;Total;Placering\n";
  reports.forEach(r=>{
    if(r.type==='session'){
      r.details.forEach(d=>{
        csv += `${formatTime(r.ts)};${r.handling};${d.navn};${d.antal};${d.pris};${d.linjetotal};${d.placering}\n`;
      });
    } else {
      csv += `${formatTime(r.ts)};${r.handling};${r.vare||''};${r.antal||''};;;${r.placering||''}\n`;
    }
  });
  downloadFile(csv,'rapporter.csv','text/csv');
}

/* ================================
   [JS 9] LABELS / LEVERAND√òRER / CSV IMPORT / BACKUP (DEL 4)
   ================================ */
function generateLabels(){
  const container = $('labelContainer'); if(!container) return; container.innerHTML='';
  const count = parseInt($('labelCount')?.value) || 1;
  const selectedLoc = $('labelSelect')?.value || '';
  const selectedReol = $('labelReolSelect')?.value || '';
  const single = $('labelSingle')?.value || '';
  let items = [];
  if(single){ 
    const found = masterVarelager.find(v=>v.id===single); 
    if(found) items=[found]; 
  }
  else if(selectedLoc){
    items = masterVarelager.filter(v => {
      if(v.placering !== selectedLoc) return false;
      // Hvis reol er valgt, filtrer ogs√• p√• reol
      if(selectedReol && v.reolNr !== selectedReol) return false;
      return true;
    });
  }
  items.forEach(v=>{
    for(let i=0;i<count;i++){
      const d = document.createElement('div'); d.className='label'; d.style.width='90mm'; d.style.height='50mm';
      
      // Build info text - show m√¶ngde, lokation, reol but hide ID
      let infoText = '';
      if (v.maaleenhed) {
        infoText += v.maaleenhed;
      }
      if (v.placering) {
        if (infoText) infoText += ' ‚Ä¢ ';
        infoText += v.placering;
      }
      if (v.reolNr) {
        if (infoText) infoText += ' ';
        infoText += 'Reol ' + v.reolNr;
      }
      if (v.hylleNr) {
        if (infoText) infoText += ' ';
        infoText += 'Hylle ' + v.hylleNr;
      }
      
      // Use stregkode if available, otherwise use id (for backward compatibility)
      const barcodeValue = v.stregkode || v.id;
      
      d.innerHTML = `<strong style="font-size:14px; margin-bottom:4px;">${v.navn}</strong>${infoText ? `<div style="font-size:11px; color:#666; margin-bottom:6px;">${infoText}</div>` : ''}<svg class="barcode"></svg>`;
      container.appendChild(d);
      try{ 
        // Use stregkode if available, otherwise id
        JsBarcode(d.querySelector('.barcode'), barcodeValue, { 
          format:'CODE128', 
          displayValue:false, // Hide the text value (don't show ID)
          width:2, 
          height:40,
          margin:2
        }); 
      }catch(e){
        console.error('Barcode generation error:', e);
      }
    }
  });
}

function generateQRCodes(){
  const container = $('labelContainer'); if(!container) return; container.innerHTML='';
  const count = parseInt($('labelCount')?.value) || 1;
  const selectedLoc = $('labelSelect')?.value || '';
  const selectedReol = $('labelReolSelect')?.value || '';
  const single = $('labelSingle')?.value || '';
  let items = [];
  if(single){ 
    const found = masterVarelager.find(v=>v.id===single); 
    if(found) items=[found]; 
  }
  else if(selectedLoc){
    items = masterVarelager.filter(v => {
      if(v.placering !== selectedLoc) return false;
      // Hvis reol er valgt, filtrer ogs√• p√• reol
      if(selectedReol && v.reolNr !== selectedReol) return false;
      return true;
    });
  }
  items.forEach(v=>{
    for(let i=0;i<count;i++){
      const d = document.createElement('div'); d.className='label'; d.style.width='90mm'; d.style.height='50mm';
      
      // Build info text - show m√¶ngde, lokation, reol but hide ID
      let infoText = '';
      if (v.maaleenhed) {
        infoText += v.maaleenhed;
      }
      if (v.placering) {
        if (infoText) infoText += ' ‚Ä¢ ';
        infoText += v.placering;
      }
      if (v.reolNr) {
        if (infoText) infoText += ' ';
        infoText += 'Reol ' + v.reolNr;
      }
      if (v.hylleNr) {
        if (infoText) infoText += ' ';
        infoText += 'Hylle ' + v.hylleNr;
      }
      
      // Use stregkode if available, otherwise use id (for backward compatibility)
      const qrCodeValue = v.stregkode || v.id;
      
      // Create a div for QR code
      const qrDiv = document.createElement('div');
      qrDiv.id = `qrcode-${v.id}-${i}`;
      qrDiv.style.width = '100%';
      qrDiv.style.height = 'auto';
      qrDiv.style.display = 'flex';
      qrDiv.style.justifyContent = 'center';
      qrDiv.style.alignItems = 'center';
      qrDiv.style.marginTop = '8px';
      
      d.innerHTML = `<strong style="font-size:14px; margin-bottom:4px;">${v.navn}</strong>${infoText ? `<div style="font-size:11px; color:#666; margin-bottom:6px;">${infoText}</div>` : ''}`;
      d.appendChild(qrDiv);
      container.appendChild(d);
      
      try{ 
        // Generate QR code using QRCode library
        if (typeof QRCode !== 'undefined') {
          new QRCode(qrDiv, {
            text: qrCodeValue,
            width: 120,
            height: 120,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H
          });
        } else {
          console.error('QRCode library not loaded');
          qrDiv.innerHTML = '<div style="color:#999; font-size:10px;">QR-kode bibliotek ikke indl√¶st</div>';
        }
      }catch(e){
        console.error('QR code generation error:', e);
        qrDiv.innerHTML = '<div style="color:#999; font-size:10px;">Fejl ved generering af QR-kode</div>';
      }
    }
  });
}

// Opdater reol dropdown baseret p√• valgt lokation
function updateLabelReolSelect(){
  const labelSelect = $('labelSelect');
  const labelReolSelect = $('labelReolSelect');
  const labelReolLabel = $('labelReolLabel');
  
  if(!labelSelect || !labelReolSelect || !labelReolLabel) return;
  
  const selectedLoc = labelSelect.value;
  
  // Skjul reol dropdown hvis ingen lokation er valgt
  if(!selectedLoc){
    labelReolSelect.style.display = 'none';
    labelReolLabel.style.display = 'none';
    labelReolSelect.value = '';
    return;
  }
  
  // Hent alle unikke reoler i den valgte lokation
  const varer = masterVarelager.filter(v => v.placering === selectedLoc && v.reolNr);
  const unikkeReoler = [...new Set(varer.map(v => v.reolNr).filter(r => r))].sort();
  
  // Hvis der er reoler, vis dropdown
  if(unikkeReoler.length > 0){
    labelReolSelect.style.display = 'inline-block';
    labelReolLabel.style.display = 'inline-block';
    
    // Opdater dropdown
    labelReolSelect.innerHTML = '<option value="">Alle reoler</option>';
    unikkeReoler.forEach(reol => {
      labelReolSelect.add(new Option(`Reol ${reol}`, reol));
    });
  } else {
    // Hvis ingen reoler, skjul dropdown
    labelReolSelect.style.display = 'none';
    labelReolLabel.style.display = 'none';
    labelReolSelect.value = '';
  }
  
  // Opdater enkelt vare dropdown
  updateLabelSingleSelect();
}

// Opdater enkelt vare dropdown baseret p√• valgt lokation og reol
function updateLabelSingleSelect(){
  const labelSelect = $('labelSelect');
  const labelReolSelect = $('labelReolSelect');
  const labelSingle = $('labelSingle');
  
  if(!labelSelect || !labelSingle) return;
  
  const selectedLoc = labelSelect.value;
  const selectedReol = labelReolSelect?.value || '';
  
  // Opdater dropdown
  labelSingle.innerHTML = '<option value="">--- Ingen ---</option>';
  
  if(selectedLoc){
    let varer = masterVarelager.filter(v => v.placering === selectedLoc);
    
    // Hvis reol er valgt, filtrer ogs√• p√• reol
    if(selectedReol){
      varer = varer.filter(v => v.reolNr === selectedReol);
    }
    
    // Sorter varer
    varer.sort((a, b) => {
      if(a.navn < b.navn) return -1;
      if(a.navn > b.navn) return 1;
      return 0;
    });
    
    varer.forEach(v => {
      labelSingle.add(new Option(v.navn, v.id));
    });
  } else {
    // Hvis ingen lokation er valgt, vis alle varer
    masterVarelager.forEach(v => {
      labelSingle.add(new Option(v.navn, v.id));
    });
  }
}

/* Leverand√∏rer */
function tilfoejLeverandor(){ const l={ firma:$('firma')?.value.trim(), adresse:$('adresse')?.value.trim(), postnr:$('postnr')?.value.trim(), by:$('by')?.value.trim(), kontakt:$('kontakt')?.value.trim(), telefon:$('telefon')?.value.trim(), email:$('email')?.value.trim(), hjemmeside:$('hjemmeside')?.value.trim() }; if(!l.firma) return alert('Indtast firmanavn'); leverandorer.push(l); clearLeverandorForm(); renderLeverandorTable(); saveAllData(); }
function clearLeverandorForm(){ $('firma').value=''; $('adresse').value=''; $('postnr').value=''; $('by').value=''; $('kontakt').value=''; $('telefon').value=''; $('email').value=''; $('hjemmeside').value=''; editingLeverandorIndex = null; const addBtn = document.querySelector('#leverandor button[onclick*="tilfoejLeverandor"]'); if(addBtn && addBtn.textContent.includes('Opdater')){ addBtn.textContent='Tilf√∏j leverand√∏r'; addBtn.onclick = tilfoejLeverandor; } }
function renderLeverandorTable(){ const t=$('leverandorTable'); if(!t) return; t.innerHTML=''; leverandorer.forEach((l,i)=>{ const tr=document.createElement('tr'); const emailLink = l.email ? `<a href="mailto:${l.email}" style="color:#0078D4;text-decoration:underline;cursor:pointer">${l.email}</a>` : '-'; const websiteLink = l.hjemmeside ? (l.hjemmeside.startsWith('http') ? l.hjemmeside : `https://${l.hjemmeside}`) : ''; const websiteDisplay = l.hjemmeside ? `<a href="${websiteLink}" target="_blank" rel="noopener noreferrer" style="color:#0078D4;text-decoration:underline;cursor:pointer">${l.hjemmeside}</a>` : '-'; tr.innerHTML=`<td>${l.firma}</td><td>${l.adresse}</td><td>${l.postnr}</td><td>${l.by}</td><td>${l.kontakt}</td><td>${l.telefon}</td><td>${emailLink}</td><td>${websiteDisplay}</td><td style="white-space:nowrap"><button class="secondary small" onclick="editLeverandor(${i})">‚úèÔ∏è Rediger</button> <button class="secondary small" onclick="removeLeverandor(${i})">üóëÔ∏è Slet</button></td>`; t.appendChild(tr); }); }
function removeLeverandor(i){ if(!confirm('Slet leverand√∏r?')) return; leverandorer.splice(i,1); renderLeverandorTable(); saveAllData(); }
function editLeverandor(i){ const l=leverandorer[i]; if(!l) return; editingLeverandorIndex = i; $('firma').value=l.firma||''; $('adresse').value=l.adresse||''; $('postnr').value=l.postnr||''; $('by').value=l.by||''; $('kontakt').value=l.kontakt||''; $('telefon').value=l.telefon||''; $('email').value=l.email||''; $('hjemmeside').value=l.hjemmeside||''; const addBtn = document.querySelector('#leverandor button[onclick="tilfoejLeverandor()"]'); if(addBtn){ addBtn.textContent='Opdater leverand√∏r'; const originalOnclick = addBtn.onclick; addBtn.onclick = ()=>{ const updated={ firma:$('firma')?.value.trim(), adresse:$('adresse')?.value.trim(), postnr:$('postnr')?.value.trim(), by:$('by')?.value.trim(), kontakt:$('kontakt')?.value.trim(), telefon:$('telefon')?.value.trim(), email:$('email')?.value.trim(), hjemmeside:$('hjemmeside')?.value.trim() }; if(!updated.firma) return alert('Indtast firmanavn'); if(editingLeverandorIndex !== null && editingLeverandorIndex < leverandorer.length){ leverandorer[editingLeverandorIndex] = updated; } clearLeverandorForm(); renderLeverandorTable(); saveAllData(); addBtn.textContent='Tilf√∏j leverand√∏r'; addBtn.onclick = originalOnclick; editingLeverandorIndex = null; }; } }

function setupPostnummerLookup(){
  const postInput = $('postnr');
  if(!postInput || typeof fetch !== 'function') return;
  postInput.addEventListener('input', ()=>{
    if(postnrLookupTimeout) clearTimeout(postnrLookupTimeout);
    postnrLookupTimeout = setTimeout(()=> resolvePostnummer(postInput.value), 250);
  });
  postInput.addEventListener('blur', ()=> resolvePostnummer(postInput.value, true));
}

async function resolvePostnummer(value, forceClear=false){
  const byInput = $('by');
  if(!byInput) return;
  const trimmed = (value||'').trim();
  if(!/^\d{4}$/.test(trimmed)){
    if(forceClear) byInput.value = '';
    return;
  }
  const city = await fetchPostnummer(trimmed);
  if(city) byInput.value = city;
  else if(forceClear) byInput.value = '';
}

async function fetchPostnummer(postnr){
  if(postnummerCache[postnr] !== undefined) return postnummerCache[postnr];
  try{
    const res = await fetch(`https://api.dataforsyningen.dk/postnumre/${postnr}`);
    if(!res.ok) throw new Error('Postnummer ikke fundet');
    const data = await res.json();
    const cityName = data?.navn || '';
    postnummerCache[postnr] = cityName;
    return cityName;
  }catch(err){
    console.warn('Postnummer opslag fejlede', err);
    postnummerCache[postnr] = '';
    return '';
  }
}

/* CSV/Excel import/export for master */
function downloadExcelTemplate(){
  try {
    // Check if SheetJS is available
    if(typeof XLSX === 'undefined'){
      alert('‚ùå Excel bibliotek ikke indl√¶st.\n\nPr√∏v at genindl√¶se siden (Ctrl+F5).');
      return;
    }

    // Create a new workbook
    const wb = XLSX.utils.book_new();
    
    // Helper function to categorize items
    function kategoriserVare(navn) {
      const navnLower = navn.toLowerCase();
      // Fisk
      if(navnLower.includes('laks') || navnLower.includes('torsk') || navnLower.includes('sej') || 
         navnLower.includes('r√∏dsp√¶tte') || navnLower.includes('krebs') || navnLower.includes('musling') ||
         navnLower.includes('√∏sters') || navnLower.includes('hummer') || navnLower.includes('krabbe') ||
         navnLower.includes('reje') || navnLower.includes('makrel') || navnLower.includes('√∏rred') ||
         navnLower.includes('sardine') || navnLower.includes('tun') || navnLower.includes('sashimi') ||
         navnLower.includes('kaviar') || navnLower.includes('tobiko') || navnLower.includes('masago') ||
         navnLower.includes('uni') || navnLower.includes('bl√¶ksprutte') || navnLower.includes('languster') ||
         navnLower.includes('kammusling') || navnLower.includes('pighud') || navnLower.includes('s√∏pindsvin') ||
         navnLower.includes('s√∏stjerne')) return 'fisk';
      // Fjerkr√¶
      if(navnLower.includes('kylling') || navnLower.includes('h√∏ne') || navnLower.includes('and') ||
         navnLower.includes('g√•s') || navnLower.includes('kalkun')) return 'fjerkr√¶';
      // Oksek√∏d
      if(navnLower.includes('oksek√∏d') || navnLower.includes('okse') || navnLower.includes('b√∏f') ||
         navnLower.includes('steg') && !navnLower.includes('frosne')) return 'oksek√∏d';
      // Svinek√∏d
      if(navnLower.includes('svinek√∏d') || navnLower.includes('svin') || navnLower.includes('skinke') ||
         navnLower.includes('bacon') || navnLower.includes('p√∏lse') || navnLower.includes('medister') ||
         navnLower.includes('frikadelle') || navnLower.includes('hamburgerryg') || navnLower.includes('wienere') ||
         navnLower.includes('salami') || navnLower.includes('pepperoni') || navnLower.includes('chorizo') ||
         navnLower.includes('rullep√∏lse') || navnLower.includes('leverpostej')) return 'svinek√∏d';
      // Kalv/Lam
      if(navnLower.includes('kalv') || navnLower.includes('lam') || navnLower.includes('lammek√∏d')) return 'kalv_lam';
      // Frugter
      if(navnLower.includes('jordb√¶r') || navnLower.includes('bl√•b√¶r') || navnLower.includes('hindb√¶r') ||
         navnLower.includes('√¶ble') || navnLower.includes('p√¶re') || navnLower.includes('banan') ||
         navnLower.includes('appelsin') || navnLower.includes('citron') || navnLower.includes('lime') ||
         navnLower.includes('druer') || navnLower.includes('melon') || navnLower.includes('vandmelon')) return 'frugt';
      // Salater
      if(navnLower.includes('salat') || navnLower.includes('spinat') || navnLower.includes('rucola') ||
         navnLower.includes('iceberg') || navnLower.includes('romaine') || navnLower.includes('mizuna') ||
         navnLower.includes('tatsoi') || navnLower.includes('komatsuna') || navnLower.includes('choy sum') ||
         navnLower.includes('bok choy') || navnLower.includes('kinesisk k√•l') || navnLower.includes('savoyk√•l') ||
         navnLower.includes('gr√∏nk√•l') || navnLower.includes('k√•lrabi') || navnLower.includes('mangold') ||
         navnLower.includes('r√∏dbede blade') || navnLower.includes('karse') || navnLower.includes('b√∏rneradise')) return 'salat';
      // Gr√∏nsager
      if(navnLower.includes('guler√∏d') || navnLower.includes('selleri') || navnLower.includes('broccoli') ||
         navnLower.includes('blomk√•l') || navnLower.includes('rosenk√•l') || navnLower.includes('asparges') ||
         navnLower.includes('zucchini') || navnLower.includes('aubergine') || navnLower.includes('squash') ||
         navnLower.includes('kartofel') || navnLower.includes('r√∏dbed') || navnLower.includes('radise') ||
         navnLower.includes('k√•l') || navnLower.includes('pastinak') || navnLower.includes('palerod') ||
         navnLower.includes('knoldselleri') || navnLower.includes('agurk') || navnLower.includes('tomater') ||
         navnLower.includes('peberfrugt') || navnLower.includes('chili') || navnLower.includes('l√∏g') ||
         navnLower.includes('porre') || navnLower.includes('hvidl√∏g')) return 'gr√∏nsag';
      // B√¶r (frosne)
      if(navnLower.includes('frosne') && (navnLower.includes('jordb√¶r') || navnLower.includes('bl√•b√¶r') ||
         navnLower.includes('hindb√¶r') || navnLower.includes('b√¶r'))) return 'b√¶r';
      // Is
      if(navnLower.includes('is') || navnLower.includes('ispind') || navnLower.includes('sorbet') ||
         navnLower.includes('gelato')) return 'is';
      // Mejeri
      if(navnLower.includes('m√¶lk') || navnLower.includes('fl√∏de') || navnLower.includes('yoghurt') ||
         navnLower.includes('skyr') || navnLower.includes('kvark') || navnLower.includes('r√∏mme') ||
         navnLower.includes('creme fraiche') || navnLower.includes('k√¶rnem√¶lk') || navnLower.includes('buttermilk') ||
         navnLower.includes('ost') || navnLower.includes('mozzarella') || navnLower.includes('feta') ||
         navnLower.includes('cheddar') || navnLower.includes('gouda') || navnLower.includes('brie') ||
         navnLower.includes('camembert') || navnLower.includes('hytteost') || navnLower.includes('philadelphia') ||
         navnLower.includes('sm√∏r') || navnLower.includes('√¶g')) return 'mejeri';
      // Krydderier/Urter
      if(navnLower.includes('koriander') || navnLower.includes('basilikum') || navnLower.includes('persille') ||
         navnLower.includes('dild') || navnLower.includes('timian') || navnLower.includes('rosmarin') ||
         navnLower.includes('oregano') || navnLower.includes('mynte') || navnLower.includes('citronmelisse') ||
         navnLower.includes('lavendel') || navnLower.includes('salvie') || navnLower.includes('estragon') ||
         navnLower.includes('laurb√¶r') || navnLower.includes('kanel') || navnLower.includes('peber') ||
         navnLower.includes('ingef√¶r') || navnLower.includes('hvidl√∏g')) return 'krydderi';
      return 'andet';
    }
    
    // Helper function to generate items organized by category
    function genererKategoriseredeVarer(placering, kategorier) {
      const resultat = [];
      let totalVarer = 0;
      let globalRaekkefoelge = 1; // Global r√¶kkef√∏lge across all categories
      let varenummerCounter = 1000; // Start varenummer counter
      
      // Process each category
      Object.keys(kategorier).forEach((kategori, katIndex) => {
        const kategoriData = kategorier[kategori];
        const varer = kategoriData.varer || [];
        const reolStart = kategoriData.reolStart || 1;
        const reolSlut = kategoriData.reolSlut || reolStart;
        const hylderPerReol = kategoriData.hylderPerReol || 5;
        const varerPerHylle = kategoriData.varerPerHylle || 5;
        
    let vareIndex = 0;
    
        // Expand varer to fill category - use all available varer
        const expandedVarer = [];
        const targetCount = (reolSlut - reolStart + 1) * hylderPerReol * varerPerHylle;
        // Use all varer from the array, repeat if needed to reach targetCount
        while(expandedVarer.length < targetCount) {
          varer.forEach((vare, idx) => {
            if(expandedVarer.length < targetCount) {
              let navn = vare[0];
              if(expandedVarer.length >= varer.length) {
                const num = Math.floor(expandedVarer.length / varer.length) + 1;
                navn = `${vare[0]} ${num > 1 ? num : ''}`.trim();
              }
              expandedVarer.push([navn, vare[1], vare[2]]);
            }
          });
          // Safety break to prevent infinite loop
          if(expandedVarer.length === 0 && varer.length === 0) break;
        }
        
        // Distribute across reoler and hylder - use all available varer
        for(let reol = reolStart; reol <= reolSlut; reol++) {
          for(let hylle = 1; hylle <= hylderPerReol; hylle++) {
            for(let i = 0; i < varerPerHylle; i++) {
              if(vareIndex < expandedVarer.length) {
                const vare = expandedVarer[vareIndex];
                // Ensure price is a number, not a string
                const pris = parseFloat(vare[2]) || 0;
                resultat.push({
                  Varenavn: String(vare[0] || ''),
                  Varenummer: String(varenummerCounter++), // Auto-generate varenummer starting from 1000
                  M√•leenhed: String(vare[1] || 'stk'),
                  Pris: pris,
                  Placering: String(placering || ''),
                  Reol: String(reol || ''),
                  Hylle: String(hylle || ''),
                  R√¶kkef√∏lge: String(globalRaekkefoelge || '0')
                });
          vareIndex++;
                totalVarer++;
                globalRaekkefoelge++;
        }
      }
    }
        }
      });
      
    return resultat;
  }
  
    // Organize items by category for each location
    // K√∏l: Mejeri (reol 1), K√∏d (reol 2), Fisk (reol 3), Gr√∏ntsager (reol 4)
    const koelKategorier = {
      mejeri: {
        varer: [
          ['M√¶lk', 'L', '12.50'],
          ['√Üg', 'stk', '25.00'], ['Yoghurt', 'stk', '8.50'],
          ['Sm√∏r', 'stk', '15.00'], ['Ost', 'kg', '85.00'], ['Fl√∏de', 'L', '22.00'],
          ['Koldsk√•l', 'L', '16.00'], ['Skyr', 'stk', '9.00'], ['Kvark', 'stk', '7.50'],
          ['R√∏mme', 'L', '20.00'], ['Creme fraiche', 'L', '24.00'], ['K√¶rnem√¶lk', 'L', '10.00'],
          ['Buttermilk', 'L', '11.00'], ['Mozzarella', 'stk', '28.00'], ['Feta', 'stk', '32.00'],
          ['Cheddar', 'kg', '95.00'], ['Gouda', 'kg', '88.00'], ['Brie', 'stk', '45.00'],
          ['Camembert', 'stk', '42.00'], ['Hytteost', 'stk', '12.00'], ['Philadelphia', 'stk', '18.00'],
          ['Juice', 'L', '18.00'], ['S√∏dm√¶lk', 'L', '12.00'], ['Letm√¶lk', 'L', '11.50'],
          ['Skummetm√¶lk', 'L', '10.50'], ['Minim√¶lk', 'L', '11.00'], ['K√¶rnem√¶lk', 'L', '10.00'],
          ['Piskefl√∏de', 'L', '28.00'], ['Kaffefl√∏de', 'L', '24.00'], ['Matadorm√¶lk', 'L', '13.00'],
          ['√Üg √∏kologisk', 'stk', '32.00'], ['√Üg fritg√•ende', 'stk', '28.00'], ['√Üg bur', 'stk', '22.00'],
          ['Yoghurt natur', 'stk', '8.00'], ['Yoghurt vanilje', 'stk', '9.00'], ['Yoghurt jordb√¶r', 'stk', '9.50'],
          ['Yoghurt bl√•b√¶r', 'stk', '9.50'], ['Yoghurt hindb√¶r', 'stk', '9.50'], ['Yoghurt citron', 'stk', '9.00'],
          ['Skyr natur', 'stk', '9.00'], ['Skyr vanilje', 'stk', '10.00'], ['Skyr jordb√¶r', 'stk', '10.50'],
          ['Skyr bl√•b√¶r', 'stk', '10.50'], ['Kvark natur', 'stk', '7.00'], ['Kvark vanilje', 'stk', '8.00'],
          ['Kvark jordb√¶r', 'stk', '8.50'], ['R√∏mme 18%', 'L', '20.00'], ['R√∏mme 38%', 'L', '24.00'],
          ['Creme fraiche 38%', 'L', '24.00'], ['Creme fraiche 42%', 'L', '26.00'], ['Sm√∏r s√∏dt', 'stk', '15.00'],
          ['Sm√∏r saltet', 'stk', '15.50'], ['Sm√∏r √∏kologisk', 'stk', '18.00'], ['Ost cheddar', 'kg', '95.00'],
          ['Ost gouda', 'kg', '88.00'], ['Ost emmentaler', 'kg', '92.00'], ['Ost gruyere', 'kg', '105.00'],
          ['Ost parmesan', 'kg', '125.00'], ['Ost pecorino', 'kg', '115.00'], ['Ost manchego', 'kg', '98.00'],
          ['Ost roquefort', 'kg', '135.00'], ['Ost gorgonzola', 'kg', '128.00'], ['Ost stilton', 'kg', '142.00'],
          ['Ost brie', 'stk', '45.00'], ['Ost camembert', 'stk', '42.00'], ['Ost chevre', 'stk', '38.00'],
          ['Ost mozzarella', 'stk', '28.00'], ['Ost burrata', 'stk', '55.00'], ['Ost ricotta', 'stk', '32.00'],
          ['Ost mascarpone', 'stk', '48.00'], ['Ost feta', 'stk', '32.00'], ['Ost halloumi', 'stk', '35.00'],
          ['Ost paneer', 'stk', '28.00'], ['Ost queso fresco', 'stk', '30.00'], ['Ost cottage cheese', 'stk', '22.00'],
          ['Ost cream cheese', 'stk', '18.00'], ['Ost hytteost', 'stk', '12.00'], ['Ost philadelphia', 'stk', '18.00'],
          ['Juice appelsin', 'L', '18.00'], ['Juice √¶ble', 'L', '16.00'], ['Juice jordb√¶r', 'L', '20.00'],
          ['Juice bl√•b√¶r', 'L', '22.00'], ['Juice hindb√¶r', 'L', '24.00'], ['Juice citron', 'L', '19.00'],
          ['Juice lime', 'L', '21.00'], ['Juice grapefrugt', 'L', '20.00'], ['Juice ananas', 'L', '23.00'],
          ['Juice mango', 'L', '25.00'], ['Juice passionsfrugt', 'L', '26.00'], ['Juice guava', 'L', '24.00'],
          ['Juice papaya', 'L', '22.00'], ['Juice granat√¶ble', 'L', '28.00'], ['Juice kranber', 'L', '27.00'],
          ['Juice kirseb√¶r', 'L', '26.00'], ['Juice fersken', 'L', '24.00'], ['Juice nektarin', 'L', '23.00'],
          ['Juice p√¶re', 'L', '21.00'], ['Juice drue', 'L', '20.00'], ['Juice melon', 'L', '22.00'],
          ['Juice vandmelon', 'L', '21.00'], ['Juice kiwi', 'L', '25.00'], ['Juice kokos', 'L', '30.00']
        ],
        reolStart: 1, reolSlut: 1, hylderPerReol: 5, varerPerHylle: 5
      },
      k√∏d: {
        varer: [
          ['Kylling', 'kg', '75.00'], ['Oksek√∏d', 'kg', '125.00'], ['Svinek√∏d', 'kg', '85.00'],
          ['Hakket oksek√∏d', 'kg', '95.00'], ['Hakket svinek√∏d', 'kg', '65.00'],
          ['Kyllingebryst', 'kg', '110.00'], ['Kyllingel√•r', 'kg', '55.00'], ['Kyllingevinger', 'kg', '45.00'],
          ['Skinke', 'kg', '125.00'], ['Bacon', 'kg', '95.00'], ['P√∏lser', 'kg', '65.00'],
          ['Wienere', 'kg', '55.00'], ['Medister', 'kg', '75.00'], ['Frikadeller', 'kg', '85.00'],
          ['Hamburgerryg', 'kg', '95.00'], ['Kogt skinke', 'kg', '115.00'], ['R√∏get skinke', 'kg', '105.00'],
          ['Parma skinke', 'kg', '195.00'], ['Serrano skinke', 'kg', '185.00'], ['Salami', 'kg', '125.00'],
          ['Pepperoni', 'kg', '135.00'], ['Chorizo', 'kg', '145.00'], ['P√∏lse p√• d√•se', 'stk', '18.00'],
          ['Rullep√∏lse', 'kg', '95.00'], ['Leverpostej', 'stk', '22.00'], ['Kylling hele', 'kg', '65.00'],
          ['Kylling filet', 'kg', '105.00'], ['Kylling k√∏d', 'kg', '70.00'], ['Kylling hals', 'kg', '35.00'],
          ['Kylling lever', 'kg', '45.00'], ['Kylling hjerte', 'kg', '50.00'], ['Kylling mave', 'kg', '40.00'],
          ['Oksefilet', 'kg', '185.00'], ['Okse entrecote', 'kg', '165.00'], ['Okse ribeye', 'kg', '175.00'],
          ['Okse t-bone', 'kg', '195.00'], ['Okse porterhouse', 'kg', '205.00'], ['Okse sirloin', 'kg', '155.00'],
          ['Okse rumpsteak', 'kg', '145.00'], ['Okse brisket', 'kg', '135.00'], ['Okse chuck', 'kg', '125.00'],
          ['Okse shank', 'kg', '115.00'], ['Okse short ribs', 'kg', '165.00'], ['Okse oxtail', 'kg', '155.00'],
          ['Okse tongue', 'kg', '145.00'], ['Okse liver', 'kg', '95.00'], ['Okse kidney', 'kg', '85.00'],
          ['Okse heart', 'kg', '75.00'], ['Okse brain', 'kg', '65.00'], ['Okse tripe', 'kg', '55.00'],
          ['Svinefilet', 'kg', '125.00'], ['Svine kotelet', 'kg', '95.00'], ['Svine ribben', 'kg', '85.00'],
          ['Svine skulder', 'kg', '75.00'], ['Svine l√•r', 'kg', '65.00'], ['Svine hals', 'kg', '55.00'],
          ['Svine kind', 'kg', '85.00'], ['Svine hale', 'kg', '75.00'], ['Svine f√∏dder', 'kg', '45.00'],
          ['Svine √∏rer', 'kg', '35.00'], ['Svine snude', 'kg', '25.00'], ['Svine lever', 'kg', '55.00'],
          ['Svine nyrer', 'kg', '45.00'], ['Svine hjerte', 'kg', '40.00'], ['Svine lunger', 'kg', '30.00'],
          ['Svine mave', 'kg', '35.00'], ['Svine tarm', 'kg', '25.00'], ['Svine blod', 'L', '15.00'],
          ['And hele', 'kg', '95.00'], ['Andebryst', 'kg', '125.00'], ['Andel√•r', 'kg', '85.00'],
          ['G√•s hele', 'kg', '135.00'], ['G√•sebryst', 'kg', '165.00'], ['G√•sel√•r', 'kg', '115.00'],
          ['Kalkun hele', 'kg', '85.00'], ['Kalkunbryst', 'kg', '125.00'], ['Kalkunl√•r', 'kg', '75.00'],
          ['Kalkunvinger', 'kg', '55.00'], ['Kalkun hals', 'kg', '35.00'], ['Kalkun lever', 'kg', '45.00'],
          ['Hare', 'kg', '145.00'], ['Kanin', 'kg', '125.00'], ['Vildt svin', 'kg', '165.00'],
          ['Vildt hjort', 'kg', '185.00'], ['Vildt r√•dyr', 'kg', '195.00'], ['Vildt fasan', 'kg', '155.00'],
          ['Vildt and', 'kg', '175.00'], ['Vildt g√•s', 'kg', '185.00'], ['Vildt kalkun', 'kg', '165.00']
        ],
        reolStart: 2, reolSlut: 2, hylderPerReol: 5, varerPerHylle: 5
      },
      fisk: {
        varer: [
          ['R√∏get laks', 'kg', '180.00'], ['R√∏get √∏rred', 'kg', '165.00'], ['Gravad laks', 'kg', '195.00'],
          ['R√∏get makrel', 'stk', '15.00'], ['Hummer', 'stk', '125.00'], ['Rejer', 'kg', '220.00'],
          ['Krabber', 'kg', '185.00'], ['Laks', 'kg', '145.00'], ['Torsk', 'kg', '95.00'],
          ['Sej', 'kg', '85.00'], ['R√∏dsp√¶tte', 'kg', '75.00'], ['Krebs', 'kg', '195.00'],
          ['Muslinger', 'kg', '65.00'], ['Bl√•muslinger', 'kg', '45.00'], ['√òsters', 'stk', '25.00'],
          ['Hummus', 'stk', '22.00'], ['Tzatziki', 'stk', '19.00'], ['Aioli', 'stk', '16.00'],
          ['Remoulade', 'stk', '14.00'], ['Mayonnaise', 'stk', '12.00'], ['Ketchup', 'stk', '8.00'],
          ['Sennep', 'stk', '9.00'], ['H√∏nsesalat', 'stk', '35.00'], ['Tunsalat', 'stk', '28.00'],
          ['Rejesalat', 'stk', '45.00'], ['Krabsalat', 'stk', '38.00'], ['Kartoffelsalat', 'stk', '25.00'],
          ['Coleslaw', 'stk', '22.00'], ['Tabouleh', 'stk', '28.00'], ['Quinoa salat', 'stk', '32.00'],
          ['Feta salat', 'stk', '35.00'], ['C√¶sar salat', 'stk', '38.00'], ['Nicoise salat', 'stk', '42.00'],
          ['Waldorf salat', 'stk', '32.00'], ['Gr√¶sk salat', 'stk', '35.00'], ['Caprese salat', 'stk', '45.00'],
          ['Bruschetta', 'stk', '28.00'], ['Antipasti', 'stk', '55.00'], ['Oliven', 'kg', '65.00'],
          ['Syltede agurker', 'stk', '15.00'], ['Syltede r√∏dbeder', 'stk', '12.00'], ['Syltede l√∏g', 'stk', '14.00'],
          ['Cornichoner', 'stk', '18.00'], ['Kapers', 'stk', '25.00'], ['Ansjoser', 'stk', '35.00'],
          ['Sardiner', 'stk', '22.00'], ['Makrel i tomat', 'stk', '18.00'], ['Tun i olie', 'stk', '28.00'],
          ['Tun i vand', 'stk', '25.00'], ['Laks i d√•se', 'stk', '45.00'], ['Krebs i d√•se', 'stk', '38.00'],
          ['Rejer i glas', 'stk', '55.00'], ['Krabber i glas', 'stk', '48.00'], ['Muslinger i glas', 'stk', '32.00'],
          ['√òsters i glas', 'stk', '65.00'], ['Hummer i glas', 'stk', '125.00'], ['Kaviar', 'stk', '195.00'],
          ['Laks kaviar', 'stk', '145.00'], ['Tobiko', 'stk', '165.00'], ['Masago', 'stk', '125.00'],
          ['Uni', 'stk', '225.00'], ['Sashimi laks', 'kg', '195.00'], ['Sashimi tun', 'kg', '225.00'],
          ['Sashimi torsk', 'kg', '165.00'], ['Sashimi sej', 'kg', '155.00'], ['Sashimi rejer', 'kg', '245.00']
        ],
        reolStart: 3, reolSlut: 3, hylderPerReol: 5, varerPerHylle: 5
      },
      gr√∏ntsager: {
        varer: [
          ['R√∏dbeder', 'stk', '11.00'], ['Agurk', 'stk', '6.00'], ['Tomater', 'kg', '35.00'],
          ['Salat', 'stk', '12.00'], ['Guler√∏dder', 'kg', '14.00'], ['Selleri', 'stk', '12.00'],
          ['Broccoli', 'stk', '18.00'], ['Blomk√•l', 'stk', '16.00'], ['Rosenk√•l', 'kg', '28.00'],
          ['Asparges', 'kg', '65.00'], ['Zucchini', 'kg', '25.00'], ['Aubergine', 'kg', '35.00'],
          ['Squash', 'kg', '22.00'], ['Kartofler', 'kg', '12.00'], ['S√∏de kartofler', 'kg', '18.00'],
          ['Guler√∏dder baby', 'kg', '28.00'], ['Radiser', 'stk', '8.00'], ['K√•l', 'stk', '14.00'],
          ['R√∏dk√•l', 'stk', '16.00'], ['Spidsk√•l', 'stk', '12.00'], ['Pak choi', 'stk', '18.00'],
          ['Pastinak', 'kg', '22.00'], ['Palerods', 'kg', '18.00'], ['Knoldselleri', 'kg', '25.00'],
          ['Peberfrugt r√∏d', 'kg', '45.00'], ['Peberfrugt gul', 'kg', '42.00'], ['Peberfrugt orange', 'kg', '44.00'],
          ['Peberfrugt gr√∏n', 'kg', '38.00'], ['Chili', 'kg', '85.00'], ['L√∏g', 'kg', '12.00'],
          ['R√∏dl√∏g', 'kg', '15.00'], ['Hvidl√∏g', 'kg', '45.00'], ['Porrer', 'stk', '8.00'],
          ['Cherrytomater', 'kg', '45.00'], ['Roma tomater', 'kg', '38.00'], ['Beefsteak tomater', 'kg', '42.00'],
          ['Kirseb√¶rtomater', 'kg', '48.00'], ['Druetomater', 'kg', '52.00'], ['P√¶retomater', 'kg', '50.00'],
          ['Cocktailtomater', 'kg', '55.00'], ['Dattertomater', 'kg', '58.00'], ['Plumtomater', 'kg', '40.00'],
          ['Oxheart tomater', 'kg', '45.00'], ['Brandywine tomater', 'kg', '50.00'], ['Heirloom tomater', 'kg', '65.00'],
          ['San Marzano tomater', 'kg', '48.00'], ['Roma tomater 2', 'kg', '38.00'], ['Beefsteak tomater 2', 'kg', '42.00'],
          ['Kirseb√¶rtomater 2', 'kg', '48.00'], ['Druetomater 2', 'kg', '52.00'], ['P√¶retomater 2', 'kg', '50.00'],
          ['Cocktailtomater 2', 'kg', '55.00'], ['Dattertomater 2', 'kg', '58.00'], ['Plumtomater 2', 'kg', '40.00']
        ],
        reolStart: 4, reolSlut: 4, hylderPerReol: 5, varerPerHylle: 5
      }
    };
    
    // Frost: Fisk (reol 1-2), Fjerkr√¶ (reol 3), Oksek√∏d (reol 4), Svinek√∏d (reol 5), Kalv/Lam (reol 6), Gr√∏nsager (reol 7-8), B√¶r (reol 9), Is (reol 10)
    const frostKategorier = {
      fisk: {
        varer: [
          ['Frosne fiskefilet', 'kg', '85.00'], ['Frosne rejer', 'kg', '195.00'], ['Frosne laks', 'kg', '145.00'],
          ['Frosne torsk', 'kg', '95.00'], ['Frosne sej', 'kg', '85.00'], ['Frosne r√∏dsp√¶tte', 'kg', '75.00'],
          ['Frosne krebs', 'kg', '195.00'], ['Frosne muslinger', 'kg', '65.00'], ['Frosne bl√•muslinger', 'kg', '45.00'],
          ['Frosne √∏sters', 'stk', '25.00'], ['Frosne hummer', 'kg', '295.00'], ['Frosne krabber', 'kg', '195.00'],
          ['Frosne languster', 'kg', '275.00'], ['Frosne kammuslinger', 'kg', '225.00'], ['Frosne pighuder', 'kg', '185.00'],
          ['Frosne s√∏pindsvin', 'kg', '195.00'], ['Frosne s√∏stjerne', 'kg', '175.00'], ['Frosne bl√¶ksprutte', 'kg', '185.00'],
          ['Frosne fiskest√¶nger', 'kg', '45.00'], ['Frosne fiskefrikadeller', 'kg', '65.00'], ['Frosne makrel', 'kg', '75.00'],
          ['Frosne sild', 'kg', '65.00'], ['Frosne ansjoser', 'kg', '85.00'], ['Frosne sardiner', 'kg', '55.00'],
          ['Frosne tun', 'kg', '125.00'], ['Frosne laks filet', 'kg', '155.00'], ['Frosne torsk filet', 'kg', '105.00'],
          ['Frosne sej filet', 'kg', '95.00'], ['Frosne r√∏dsp√¶tte filet', 'kg', '85.00'], ['Frosne kuller', 'kg', '75.00'],
          ['Frosne skrubbe', 'kg', '65.00'], ['Frosne fladfisk', 'kg', '85.00'], ['Frosne torskest√¶nger', 'kg', '55.00'],
          ['Frosne laksest√¶nger', 'kg', '65.00'], ['Frosne fiskekager', 'kg', '75.00'], ['Frosne fiskeboller', 'kg', '85.00'],
          ['Frosne fiskep√∏lser', 'kg', '95.00'], ['Frosne fiskeburger', 'kg', '105.00'], ['Frosne fiskekroketter', 'kg', '115.00'],
          ['Frosne fiskefrikadeller', 'kg', '65.00'], ['Frosne fiskefileter', 'kg', '95.00'], ['Frosne fiskestykker', 'kg', '85.00'],
          ['Frosne fiskeskiver', 'kg', '75.00'], ['Frosne fisketern', 'kg', '65.00'], ['Frosne fiskemix', 'kg', '55.00'],
          ['Frosne rejer store', 'kg', '225.00'], ['Frosne rejer mellem', 'kg', '195.00'], ['Frosne rejer sm√•', 'kg', '165.00'],
          ['Frosne krabber hele', 'kg', '205.00'], ['Frosne krabber k√∏d', 'kg', '185.00'], ['Frosne krabber kl√∏r', 'kg', '195.00'],
          ['Frosne hummer hele', 'kg', '305.00'], ['Frosne hummer halv', 'kg', '295.00'], ['Frosne hummer kl√∏r', 'kg', '315.00'],
          ['Frosne languster hele', 'kg', '285.00'], ['Frosne languster halv', 'kg', '275.00'], ['Frosne languster hale', 'kg', '265.00'],
          ['Frosne kammuslinger store', 'kg', '235.00'], ['Frosne kammuslinger mellem', 'kg', '225.00'], ['Frosne kammuslinger sm√•', 'kg', '215.00'],
          ['Frosne pighuder store', 'kg', '195.00'], ['Frosne pighuder mellem', 'kg', '185.00'], ['Frosne pighuder sm√•', 'kg', '175.00'],
          ['Frosne s√∏pindsvin store', 'kg', '205.00'], ['Frosne s√∏pindsvin mellem', 'kg', '195.00'], ['Frosne s√∏pindsvin sm√•', 'kg', '185.00'],
          ['Frosne s√∏stjerne store', 'kg', '185.00'], ['Frosne s√∏stjerne mellem', 'kg', '175.00'], ['Frosne s√∏stjerne sm√•', 'kg', '165.00'],
          ['Frosne bl√¶ksprutte hele', 'kg', '195.00'], ['Frosne bl√¶ksprutte tentakler', 'kg', '185.00'], ['Frosne bl√¶ksprutte krop', 'kg', '175.00']
        ],
        reolStart: 1, reolSlut: 2, hylderPerReol: 5, varerPerHylle: 5
      },
      fjerkr√¶: {
        varer: [
          ['Frosne kylling', 'kg', '65.00'], ['Frosne kyllingebryst', 'kg', '95.00'], ['Frosne kyllingel√•r', 'kg', '55.00'],
          ['Frosne kylling nuggets', 'kg', '55.00'], ['Frosne kyllingefileter', 'kg', '75.00'], ['Frosne kyllingespyd', 'kg', '65.00'],
          ['Frosne kyllingewings', 'kg', '55.00'], ['Frosne kyllingedrumsticks', 'kg', '60.00'], ['Frosne kylling hele', 'kg', '65.00'],
          ['Frosne kylling halv', 'kg', '60.00'], ['Frosne kylling kvart', 'kg', '58.00'], ['Frosne kylling hals', 'kg', '35.00'],
          ['Frosne kylling lever', 'kg', '45.00'], ['Frosne kylling hjerte', 'kg', '50.00'], ['Frosne kylling mave', 'kg', '40.00'],
          ['Frosne and hele', 'kg', '95.00'], ['Frosne andebryst', 'kg', '125.00'], ['Frosne andel√•r', 'kg', '85.00'],
          ['Frosne and halv', 'kg', '90.00'], ['Frosne and kvart', 'kg', '88.00'], ['Frosne and hals', 'kg', '45.00'],
          ['Frosne and lever', 'kg', '55.00'], ['Frosne and hjerte', 'kg', '60.00'], ['Frosne and mave', 'kg', '50.00'],
          ['Frosne g√•s hele', 'kg', '135.00'], ['Frosne g√•sebryst', 'kg', '165.00'], ['Frosne g√•sel√•r', 'kg', '115.00'],
          ['Frosne g√•s halv', 'kg', '130.00'], ['Frosne g√•s kvart', 'kg', '128.00'], ['Frosne g√•s hals', 'kg', '55.00'],
          ['Frosne g√•s lever', 'kg', '65.00'], ['Frosne g√•s hjerte', 'kg', '70.00'], ['Frosne g√•s mave', 'kg', '60.00'],
          ['Frosne kalkun hele', 'kg', '85.00'], ['Frosne kalkunbryst', 'kg', '125.00'], ['Frosne kalkunl√•r', 'kg', '75.00'],
          ['Frosne kalkun halv', 'kg', '80.00'], ['Frosne kalkun kvart', 'kg', '78.00'], ['Frosne kalkunvinger', 'kg', '55.00'],
          ['Frosne kalkun hals', 'kg', '35.00'], ['Frosne kalkun lever', 'kg', '45.00'], ['Frosne kalkun hjerte', 'kg', '50.00'],
          ['Frosne kalkun mave', 'kg', '40.00'], ['Frosne fasan hele', 'kg', '155.00'], ['Frosne fasanbryst', 'kg', '185.00'],
          ['Frosne fasanl√•r', 'kg', '135.00'], ['Frosne fasan halv', 'kg', '150.00'], ['Frosne fasan kvart', 'kg', '148.00'],
          ['Frosne fasan hals', 'kg', '65.00'], ['Frosne fasan lever', 'kg', '75.00'], ['Frosne fasan hjerte', 'kg', '80.00'],
          ['Frosne fasan mave', 'kg', '70.00'], ['Frosne h√∏ne hele', 'kg', '75.00'], ['Frosne h√∏nebryst', 'kg', '105.00'],
          ['Frosne h√∏nel√•r', 'kg', '65.00'], ['Frosne h√∏ne halv', 'kg', '70.00'], ['Frosne h√∏ne kvart', 'kg', '68.00'],
          ['Frosne h√∏ne hals', 'kg', '35.00'], ['Frosne h√∏ne lever', 'kg', '45.00'], ['Frosne h√∏ne hjerte', 'kg', '50.00'],
          ['Frosne h√∏ne mave', 'kg', '40.00'], ['Frosne kalkun nuggets', 'kg', '65.00'], ['Frosne kalkun fileter', 'kg', '85.00'],
          ['Frosne kalkun spyd', 'kg', '75.00'], ['Frosne kalkun wings', 'kg', '65.00'], ['Frosne kalkun drumsticks', 'kg', '70.00']
        ],
        reolStart: 3, reolSlut: 3, hylderPerReol: 5, varerPerHylle: 5
      },
      oksek√∏d: {
        varer: [
          ['Frosne oksek√∏d', 'kg', '125.00'], ['Frosne oksek√∏dboller', 'kg', '95.00'], ['Frosne hakkeb√∏ffer', 'kg', '90.00'],
          ['Frosne b√∏ffer', 'kg', '125.00'], ['Frosne steg', 'kg', '115.00'], ['Frosne oksefilet', 'kg', '185.00'],
          ['Frosne okse entrecote', 'kg', '165.00'], ['Frosne okse ribeye', 'kg', '175.00'], ['Frosne okse t-bone', 'kg', '195.00'],
          ['Frosne okse porterhouse', 'kg', '205.00'], ['Frosne okse sirloin', 'kg', '155.00'], ['Frosne okse rumpsteak', 'kg', '145.00'],
          ['Frosne okse brisket', 'kg', '135.00'], ['Frosne okse chuck', 'kg', '125.00'], ['Frosne okse shank', 'kg', '115.00'],
          ['Frosne okse short ribs', 'kg', '165.00'], ['Frosne okse oxtail', 'kg', '155.00'], ['Frosne okse tongue', 'kg', '145.00'],
          ['Frosne okse liver', 'kg', '95.00'], ['Frosne okse kidney', 'kg', '85.00'], ['Frosne okse heart', 'kg', '75.00'],
          ['Frosne okse brain', 'kg', '65.00'], ['Frosne okse tripe', 'kg', '55.00'], ['Frosne okse ground', 'kg', '105.00'],
          ['Frosne okse mince', 'kg', '100.00'], ['Frosne okse cubes', 'kg', '115.00'], ['Frosne okse strips', 'kg', '125.00'],
          ['Frosne okse chunks', 'kg', '120.00'], ['Frosne okse pieces', 'kg', '110.00'], ['Frosne okse roast', 'kg', '130.00'],
          ['Frosne okse stew', 'kg', '120.00'], ['Frosne okse soup', 'kg', '115.00'], ['Frosne okse stock', 'L', '25.00'],
          ['Frosne okse broth', 'L', '22.00'], ['Frosne okse consomme', 'L', '28.00'], ['Frosne okse demi-glace', 'L', '35.00'],
          ['Frosne okse jus', 'L', '30.00'], ['Frosne okse gravy', 'L', '20.00'], ['Frosne okse sauce', 'L', '18.00'],
          ['Frosne okse marinade', 'L', '15.00'], ['Frosne okse rub', 'kg', '45.00'], ['Frosne okse seasoning', 'kg', '42.00'],
          ['Frosne okse spice mix', 'kg', '40.00'], ['Frosne okse herbs', 'kg', '38.00'], ['Frosne okse pepper', 'kg', '35.00'],
          ['Frosne okse salt', 'kg', '12.00'], ['Frosne okse garlic', 'kg', '25.00'], ['Frosne okse onion', 'kg', '15.00'],
          ['Frosne okse carrot', 'kg', '18.00'], ['Frosne okse celery', 'kg', '20.00'], ['Frosne okse leek', 'kg', '22.00'],
          ['Frosne okse mushroom', 'kg', '35.00'], ['Frosne okse tomato', 'kg', '28.00'], ['Frosne okse wine', 'L', '45.00'],
          ['Frosne okse brandy', 'L', '65.00'], ['Frosne okse cognac', 'L', '85.00'], ['Frosne okse sherry', 'L', '55.00'],
          ['Frosne okse port', 'L', '75.00'], ['Frosne okse madeira', 'L', '70.00'], ['Frosne okse marsala', 'L', '68.00']
        ],
        reolStart: 4, reolSlut: 4, hylderPerReol: 5, varerPerHylle: 5
      },
      svinek√∏d: {
        varer: [
          ['Frosne svinek√∏d', 'kg', '85.00'], ['Frosne svinek√∏dboller', 'kg', '75.00'], ['Frosne k√∏dboller', 'kg', '85.00'],
          ['Frosne frikadeller', 'kg', '70.00'], ['Frosne koteletter', 'kg', '95.00'], ['Frosne ribben', 'kg', '85.00'],
          ['Frosne skinke', 'kg', '105.00'], ['Frosne bacon', 'kg', '95.00'], ['Frosne p√∏lser', 'kg', '65.00'],
          ['Frosne wienere', 'kg', '55.00'], ['Frosne medister', 'kg', '75.00'], ['Frosne leverpostej', 'kg', '45.00'],
          ['Frosne rullep√∏lse', 'kg', '95.00'], ['Frosne hamburgerryg', 'kg', '95.00'], ['Frosne kogt skinke', 'kg', '115.00'],
          ['Frosne r√∏get skinke', 'kg', '105.00'], ['Frosne parma skinke', 'kg', '195.00'], ['Frosne serrano skinke', 'kg', '185.00'],
          ['Frosne salami', 'kg', '125.00'], ['Frosne pepperoni', 'kg', '135.00'], ['Frosne chorizo', 'kg', '145.00'],
          ['Frosne svinefilet', 'kg', '125.00'], ['Frosne svine skulder', 'kg', '75.00'], ['Frosne svine l√•r', 'kg', '65.00'],
          ['Frosne svine hals', 'kg', '55.00'], ['Frosne svine kind', 'kg', '85.00'], ['Frosne svine hale', 'kg', '75.00'],
          ['Frosne svine f√∏dder', 'kg', '45.00'], ['Frosne svine √∏rer', 'kg', '35.00'], ['Frosne svine snude', 'kg', '25.00'],
          ['Frosne svine lever', 'kg', '55.00'], ['Frosne svine nyrer', 'kg', '45.00'], ['Frosne svine hjerte', 'kg', '40.00'],
          ['Frosne svine lunger', 'kg', '30.00'], ['Frosne svine mave', 'kg', '35.00'], ['Frosne svine tarm', 'kg', '25.00'],
          ['Frosne svine blod', 'L', '15.00'], ['Frosne svine hoved', 'kg', '35.00'], ['Frosne svine hjerne', 'kg', '45.00'],
          ['Frosne svine tunge', 'kg', '55.00'], ['Frosne svine kindbens', 'kg', '65.00'], ['Frosne svine spareribs', 'kg', '75.00'],
          ['Frosne svine baby back ribs', 'kg', '85.00'], ['Frosne svine country ribs', 'kg', '75.00'], ['Frosne svine st louis ribs', 'kg', '80.00'],
          ['Frosne svine kassler', 'kg', '95.00'], ['Frosne svine schnitzel', 'kg', '105.00'], ['Frosne svine escalope', 'kg', '115.00'],
          ['Frosne svine cutlet', 'kg', '95.00'], ['Frosne svine chop', 'kg', '100.00'], ['Frosne svine steak', 'kg', '110.00'],
          ['Frosne svine roast', 'kg', '90.00'], ['Frosne svine shoulder', 'kg', '80.00'], ['Frosne svine leg', 'kg', '70.00'],
          ['Frosne svine belly', 'kg', '85.00'], ['Frosne svine jowl', 'kg', '75.00'], ['Frosne svine hock', 'kg', '65.00'],
          ['Frosne svine trotter', 'kg', '55.00'], ['Frosne svine tail', 'kg', '45.00'], ['Frosne svine head', 'kg', '35.00'],
          ['Frosne svine cheek', 'kg', '85.00'], ['Frosne svine tongue', 'kg', '75.00'], ['Frosne svine brain', 'kg', '65.00'],
          ['Frosne svine tripe', 'kg', '55.00'], ['Frosne svine chitterlings', 'kg', '45.00'], ['Frosne svine cracklings', 'kg', '35.00']
        ],
        reolStart: 5, reolSlut: 5, hylderPerReol: 5, varerPerHylle: 5
      },
      kalv_lam: {
        varer: [
          ['Frosne lammek√∏d', 'kg', '145.00'], ['Frosne lam filet', 'kg', '185.00'], ['Frosne lam rack', 'kg', '195.00'],
          ['Frosne lam leg', 'kg', '165.00'], ['Frosne lam shoulder', 'kg', '155.00'], ['Frosne lam shank', 'kg', '145.00'],
          ['Frosne lam chops', 'kg', '175.00'], ['Frosne lam cutlets', 'kg', '185.00'], ['Frosne lam stew', 'kg', '155.00'],
          ['Frosne lam ground', 'kg', '165.00'], ['Frosne lam mince', 'kg', '160.00'], ['Frosne lam cubes', 'kg', '170.00'],
          ['Frosne lam strips', 'kg', '180.00'], ['Frosne lam chunks', 'kg', '175.00'], ['Frosne lam pieces', 'kg', '170.00'],
          ['Frosne kalvek√∏d', 'kg', '155.00'], ['Frosne kalve filet', 'kg', '195.00'], ['Frosne kalve cutlet', 'kg', '185.00'],
          ['Frosne kalve chop', 'kg', '175.00'], ['Frosne kalve steak', 'kg', '195.00'], ['Frosne kalve roast', 'kg', '185.00'],
          ['Frosne kalve stew', 'kg', '175.00'], ['Frosne kalve ground', 'kg', '185.00'], ['Frosne kalve mince', 'kg', '180.00'],
          ['Frosne kalve cubes', 'kg', '190.00'], ['Frosne kalve strips', 'kg', '200.00'], ['Frosne kalve chunks', 'kg', '195.00'],
          ['Frosne kalve pieces', 'kg', '190.00'], ['Frosne kalve shoulder', 'kg', '180.00'], ['Frosne kalve leg', 'kg', '190.00'],
          ['Frosne kalve shank', 'kg', '180.00'], ['Frosne kalve breast', 'kg', '170.00'], ['Frosne kalve neck', 'kg', '160.00'],
          ['Frosne kalve ribs', 'kg', '185.00'], ['Frosne kalve liver', 'kg', '95.00'], ['Frosne kalve kidney', 'kg', '85.00'],
          ['Frosne kalve heart', 'kg', '75.00'], ['Frosne kalve brain', 'kg', '65.00'], ['Frosne kalve tongue', 'kg', '75.00'],
          ['Frosne kalve sweetbreads', 'kg', '125.00'], ['Frosne kalve tripe', 'kg', '55.00'], ['Frosne kalve tail', 'kg', '85.00'],
          ['Frosne kalve head', 'kg', '45.00'], ['Frosne kalve cheek', 'kg', '95.00'], ['Frosne kalve shank', 'kg', '180.00'],
          ['Frosne kalve osso buco', 'kg', '185.00'], ['Frosne kalve veal', 'kg', '195.00'], ['Frosne kalve escalope', 'kg', '205.00'],
          ['Frosne kalve schnitzel', 'kg', '195.00'], ['Frosne kalve parmigiana', 'kg', '185.00'], ['Frosne kalve piccata', 'kg', '195.00'],
          ['Frosne kalve marsala', 'kg', '205.00'], ['Frosne kalve saltimbocca', 'kg', '215.00'], ['Frosne kalve milanese', 'kg', '195.00'],
          ['Frosne kalve cordon bleu', 'kg', '225.00'], ['Frosne kalve kiev', 'kg', '235.00'], ['Frosne kalve holstein', 'kg', '245.00'],
          ['Frosne kalve wiener schnitzel', 'kg', '255.00'], ['Frosne kalve j√§gerschnitzel', 'kg', '265.00'], ['Frosne kalve rahmschnitzel', 'kg', '275.00']
        ],
        reolStart: 6, reolSlut: 6, hylderPerReol: 5, varerPerHylle: 5
      },
      gr√∏nsager: {
        varer: [
          ['Frosne √¶rter', 'stk', '18.00'], ['Frosne b√∏nner', 'stk', '16.00'], ['Frosne majs', 'stk', '15.00'],
          ['Frosne spinat', 'stk', '20.00'], ['Frosne broccolini', 'stk', '22.00'], ['Frosne asparges', 'stk', '35.00'],
          ['Frosne guler√∏dder', 'stk', '14.00'], ['Frosne kartofler', 'kg', '18.00'], ['Frosne pommes frites', 'kg', '22.00'],
          ['Frosne broccoli', 'stk', '20.00'], ['Frosne blomk√•l', 'stk', '18.00'], ['Frosne rosenk√•l', 'kg', '28.00'],
          ['Frosne zucchini', 'kg', '25.00'], ['Frosne aubergine', 'kg', '35.00'], ['Frosne squash', 'kg', '22.00'],
          ['Frosne s√∏de kartofler', 'kg', '20.00'], ['Frosne kartoffelb√•de', 'kg', '24.00'], ['Frosne kartoffel wedges', 'kg', '26.00'],
          ['Frosne kartoffel chips', 'kg', '28.00'], ['Frosne kartoffel croquettes', 'kg', '30.00'], ['Frosne kartoffel gnocchi', 'kg', '32.00'],
          ['Frosne gr√∏nne b√∏nner', 'stk', '17.00'], ['Frosne hvide b√∏nner', 'stk', '18.00'], ['Frosne sorte b√∏nner', 'stk', '19.00'],
          ['Frosne kidney b√∏nner', 'stk', '20.00'], ['Frosne garbanzo b√∏nner', 'stk', '21.00'], ['Frosne lima b√∏nner', 'stk', '22.00'],
          ['Frosne edamame', 'stk', '25.00'], ['Frosne sojab√∏nner', 'stk', '24.00'], ['Frosne mungb√∏nner', 'stk', '23.00'],
          ['Frosne linser', 'stk', '22.00'], ['Frosne kik√¶rter', 'stk', '21.00'], ['Frosne quinoa', 'stk', '35.00'],
          ['Frosne bulgur', 'stk', '28.00'], ['Frosne couscous', 'stk', '32.00'], ['Frosne ris', 'stk', '25.00'],
          ['Frosne pasta', 'stk', '28.00'], ['Frosne nudler', 'stk', '30.00'], ['Frosne ramen', 'stk', '32.00'],
          ['Frosne soba', 'stk', '35.00'], ['Frosne udon', 'stk', '38.00'], ['Frosne vermicelli', 'stk', '33.00'],
          ['Frosne glass noodles', 'stk', '36.00'], ['Frosne rice noodles', 'stk', '34.00'], ['Frosne egg noodles', 'stk', '31.00'],
          ['Frosne wonton', 'stk', '40.00'], ['Frosne dumplings', 'stk', '42.00'], ['Frosne potstickers', 'stk', '44.00'],
          ['Frosne spring rolls', 'stk', '38.00'], ['Frosne egg rolls', 'stk', '36.00'], ['Frosne bao buns', 'stk', '35.00'],
          ['Frosne mantou', 'stk', '33.00'], ['Frosne scallion pancakes', 'stk', '32.00'], ['Frosne potstickers', 'stk', '44.00']
        ],
        reolStart: 7, reolSlut: 8, hylderPerReol: 5, varerPerHylle: 5
      },
      b√¶r: {
        varer: [
          ['Frosne jordb√¶r', 'stk', '25.00'], ['Frosne bl√•b√¶r', 'stk', '28.00'], ['Frosne hindb√¶r', 'stk', '30.00'],
          ['Frosne bromb√¶r', 'stk', '32.00'], ['Frosne boysenb√¶r', 'stk', '34.00'], ['Frosne loganb√¶r', 'stk', '33.00'],
          ['Frosne tayb√¶r', 'stk', '35.00'], ['Frosne multeb√¶r', 'stk', '36.00'], ['Frosne solb√¶r', 'stk', '38.00'],
          ['Frosne stikkelsb√¶r', 'stk', '37.00'], ['Frosne ribs', 'stk', '28.00'], ['Frosne stikkelsb√¶r r√∏de', 'stk', '36.00'],
          ['Frosne stikkelsb√¶r sorte', 'stk', '38.00'], ['Frosne stikkelsb√¶r hvide', 'stk', '37.00'], ['Frosne jordb√¶r hele', 'stk', '26.00'],
          ['Frosne jordb√¶r halve', 'stk', '25.00'], ['Frosne jordb√¶r skiver', 'stk', '24.00'], ['Frosne bl√•b√¶r store', 'stk', '30.00'],
          ['Frosne bl√•b√¶r mellem', 'stk', '28.00'], ['Frosne bl√•b√¶r sm√•', 'stk', '26.00'], ['Frosne hindb√¶r hele', 'stk', '32.00'],
          ['Frosne hindb√¶r halve', 'stk', '31.00'], ['Frosne hindb√¶r skiver', 'stk', '30.00'], ['Frosne bromb√¶r hele', 'stk', '34.00'],
          ['Frosne bromb√¶r halve', 'stk', '33.00'], ['Frosne bromb√¶r skiver', 'stk', '32.00'], ['Frosne boysenb√¶r hele', 'stk', '36.00'],
          ['Frosne boysenb√¶r halve', 'stk', '35.00'], ['Frosne boysenb√¶r skiver', 'stk', '34.00'], ['Frosne loganb√¶r hele', 'stk', '35.00'],
          ['Frosne loganb√¶r halve', 'stk', '34.00'], ['Frosne loganb√¶r skiver', 'stk', '33.00'], ['Frosne tayb√¶r hele', 'stk', '37.00'],
          ['Frosne tayb√¶r halve', 'stk', '36.00'], ['Frosne tayb√¶r skiver', 'stk', '35.00'], ['Frosne multeb√¶r hele', 'stk', '38.00'],
          ['Frosne multeb√¶r halve', 'stk', '37.00'], ['Frosne multeb√¶r skiver', 'stk', '36.00'], ['Frosne solb√¶r hele', 'stk', '40.00'],
          ['Frosne solb√¶r halve', 'stk', '39.00'], ['Frosne solb√¶r skiver', 'stk', '38.00'], ['Frosne stikkelsb√¶r hele', 'stk', '39.00'],
          ['Frosne stikkelsb√¶r halve', 'stk', '38.00'], ['Frosne stikkelsb√¶r skiver', 'stk', '37.00'], ['Frosne ribs hele', 'stk', '30.00'],
          ['Frosne ribs halve', 'stk', '29.00'], ['Frosne ribs skiver', 'stk', '28.00'], ['Frosne b√¶rmix', 'stk', '32.00'],
          ['Frosne b√¶rsalat', 'stk', '35.00'], ['Frosne b√¶rsmoothie', 'L', '45.00'], ['Frosne b√¶rsorbet', 'L', '50.00']
        ],
        reolStart: 9, reolSlut: 9, hylderPerReol: 5, varerPerHylle: 5
      },
      is: {
        varer: [
          ['Frosne is', 'L', '35.00'], ['Frosne ispinde', 'stk', '8.00'], ['Frosne sorbet', 'L', '32.00'],
          ['Frosne gelato', 'L', '38.00'], ['Frosne vaniljeis', 'L', '36.00'], ['Frosne chokoladeis', 'L', '38.00'],
          ['Frosne jordb√¶ris', 'L', '37.00'], ['Frosne bl√•b√¶ris', 'L', '39.00'], ['Frosne hindb√¶ris', 'L', '40.00'],
          ['Frosne bromb√¶ris', 'L', '41.00'], ['Frosne boysenb√¶ris', 'L', '42.00'], ['Frosne loganb√¶ris', 'L', '41.00'],
          ['Frosne tayb√¶ris', 'L', '43.00'], ['Frosne multeb√¶ris', 'L', '44.00'], ['Frosne solb√¶ris', 'L', '45.00'],
          ['Frosne stikkelsb√¶ris', 'L', '44.00'], ['Frosne ribs is', 'L', '38.00'], ['Frosne citronis', 'L', '35.00'],
          ['Frosne limeis', 'L', '36.00'], ['Frosne appelsinis', 'L', '37.00'], ['Frosne grapefrugtis', 'L', '38.00'],
          ['Frosne ananasis', 'L', '39.00'], ['Frosne mangois', 'L', '40.00'], ['Frosne passionsfrugtis', 'L', '41.00'],
          ['Frosne guavais', 'L', '40.00'], ['Frosne papayais', 'L', '39.00'], ['Frosne granat√¶bleis', 'L', '42.00'],
          ['Frosne kranberis', 'L', '41.00'], ['Frosne kirseb√¶ris', 'L', '40.00'], ['Frosne ferskenis', 'L', '39.00'],
          ['Frosne nektarinis', 'L', '38.00'], ['Frosne p√¶reis', 'L', '37.00'], ['Frosne drueis', 'L', '36.00'],
          ['Frosne melonis', 'L', '37.00'], ['Frosne vandmelonis', 'L', '36.00'], ['Frosne kiwiis', 'L', '39.00'],
          ['Frosne kokosis', 'L', '42.00'], ['Frosne pistacieis', 'L', '45.00'], ['Frosne mandelis', 'L', '44.00'],
          ['Frosne hasseln√∏ddis', 'L', '43.00'], ['Frosne valn√∏ddis', 'L', '42.00'], ['Frosne pekanis', 'L', '41.00'],
          ['Frosne macadamiais', 'L', '46.00'], ['Frosne cashewn√∏ddis', 'L', '44.00'], ['Frosne kokosn√∏ddis', 'L', '43.00'],
          ['Frosne karamelis', 'L', '40.00'], ['Frosne karamel is', 'L', '41.00'], ['Frosne toffeeis', 'L', '42.00'],
          ['Frosne nougatis', 'L', '43.00'], ['Frosne pralineis', 'L', '44.00'], ['Frosne fudgeis', 'L', '45.00'],
          ['Frosne brownieis', 'L', '46.00'], ['Frosne cookie dough is', 'L', '47.00'], ['Frosne cheesecake is', 'L', '48.00'],
          ['Frosne tiramisu is', 'L', '49.00'], ['Frosne cr√®me br√ªl√©e is', 'L', '50.00'], ['Frosne fl√∏deis', 'L', '38.00']
        ],
        reolStart: 10, reolSlut: 10, hylderPerReol: 5, varerPerHylle: 5
      }
    };
    
    // T√∏revare: Mel/Gryn (reol 1), Krydderier (reol 2), Konserves (reol 3), N√∏dder/Fr√∏ (reol 4)
    const toereKategorier = {
      mel_gryn: {
        varer: [
          ['Mel', 'kg', '8.50'], ['Ris', 'kg', '15.00'], ['Pasta', 'kg', '18.00'],
          ['Spaghetti', 'kg', '16.00'], ['Lasagneplader', 'kg', '22.00'], ['Havregryn', 'kg', '14.00'],
          ['Cornflakes', 'kg', '25.00'], ['M√ºsli', 'kg', '35.00'], ['Quinoa', 'kg', '65.00'],
          ['Bulgur', 'kg', '28.00'], ['Couscous', 'kg', '32.00'], ['Kartoffelmel', 'kg', '12.00'],
          ['Majsstivelse', 'kg', '15.00'], ['Rismel', 'kg', '25.00'], ['Majsmel', 'kg', '22.00'],
          ['Mandelmel', 'kg', '125.00'], ['Kokosmel', 'kg', '45.00'], ['Kastanjemel', 'kg', '55.00'],
          ['Jobst√•rsmel', 'kg', '35.00'], ['Hvedemel', 'kg', '9.00'], ['Rugmel', 'kg', '10.00'],
          ['Havremel', 'kg', '12.00'], ['Majsmel', 'kg', '11.00'], ['Rismel', 'kg', '13.00'],
          ['Buchweizenmel', 'kg', '15.00'], ['Speltmel', 'kg', '14.00'], ['Emmer mel', 'kg', '16.00'],
          ['Kamut mel', 'kg', '17.00'], ['Frikah mel', 'kg', '18.00'], ['Farro mel', 'kg', '19.00'],
          ['Freekeh mel', 'kg', '20.00'], ['Sorghum mel', 'kg', '13.00'], ['Millet mel', 'kg', '12.00'],
          ['Hirse mel', 'kg', '11.00'], ['Teff mel', 'kg', '22.00'], ['Amaranth mel', 'kg', '18.00'],
          ['Chia mel', 'kg', '25.00'], ['H√∏rfr√∏ mel', 'kg', '15.00'], ['Sesamfr√∏ mel', 'kg', '20.00'],
          ['Solsikkefr√∏ mel', 'kg', '16.00'], ['Gr√¶skarkerner mel', 'kg', '17.00'], ['Kokosn√∏d mel', 'kg', '19.00'],
          ['Mandel mel', 'kg', '28.00'], ['Cashewn√∏d mel', 'kg', '30.00'], ['Valn√∏d mel', 'kg', '26.00'],
          ['Hasseln√∏d mel', 'kg', '24.00'], ['Pistacien√∏d mel', 'kg', '32.00'], ['Macadamian√∏d mel', 'kg', '35.00'],
          ['Pecann√∏d mel', 'kg', '33.00'], ['Brasiliansk n√∏d mel', 'kg', '36.00'], ['Paran√∏d mel', 'kg', '34.00'],
          ['Kastanje mel', 'kg', '22.00'], ['Kokosn√∏d mel', 'kg', '19.00'], ['Mandel mel', 'kg', '28.00'],
          ['Cashewn√∏d mel', 'kg', '30.00'], ['Valn√∏d mel', 'kg', '26.00'], ['Hasseln√∏d mel', 'kg', '24.00'],
          ['Pistacien√∏d mel', 'kg', '32.00'], ['Macadamian√∏d mel', 'kg', '35.00'], ['Pecann√∏d mel', 'kg', '33.00'],
          ['Brasiliansk n√∏d mel', 'kg', '36.00'], ['Paran√∏d mel', 'kg', '34.00'], ['Kastanje mel', 'kg', '22.00']
        ],
        reolStart: 1, reolSlut: 1, hylderPerReol: 5, varerPerHylle: 5
      },
      krydderier: {
        varer: [
          ['Salt', 'kg', '3.50'], ['Peber', 'kg', '45.00'], ['Kakao', 'kg', '28.00'],
          ['Kaffe', 'kg', '85.00'], ['Te', 'kg', '95.00'], ['Bagepulver', 'kg', '18.00'],
          ['Natron', 'kg', '14.00'], ['G√¶r', 'kg', '25.00'], ['T√∏rg√¶r', 'kg', '22.00'],
          ['Fersk g√¶r', 'stk', '8.00'], ['Vaniljesukker', 'kg', '85.00'], ['Vaniljepulver', 'kg', '195.00'],
          ['Vaniljestang', 'stk', '45.00'], ['Kanel', 'kg', '55.00'], ['Kanelstang', 'stk', '12.00'],
          ['Nelliker', 'kg', '125.00'], ['Kardemomme', 'kg', '145.00'], ['Ingef√¶r', 'kg', '65.00'],
          ['Kurkuma', 'kg', '75.00'], ['Spidskommen', 'kg', '85.00'], ['Korianderfr√∏', 'kg', '95.00'],
          ['Fennikelfr√∏', 'kg', '105.00'], ['Anisfr√∏', 'kg', '115.00'], ['Stjerneanis', 'kg', '125.00'],
          ['Muskatn√∏d', 'kg', '135.00'], ['Muskatblomme', 'kg', '145.00'], ['Alleh√•nde', 'kg', '155.00'],
          ['Piment', 'kg', '165.00'], ['Juniperb√¶r', 'kg', '175.00'], ['Timian', 'kg', '85.00'],
          ['Rosmarin', 'kg', '95.00'], ['Oregano', 'kg', '75.00'], ['Basilikum', 'kg', '65.00'],
          ['Persille', 'kg', '55.00'], ['Dild', 'kg', '45.00'], ['Laurb√¶rblade', 'kg', '35.00'],
          ['Salvie', 'kg', '85.00'], ['Estragon', 'kg', '95.00'], ['Mynte', 'kg', '75.00'],
          ['Citronmelisse', 'kg', '65.00'], ['Lavendel', 'kg', '55.00'], ['Koriander', 'kg', '45.00']
        ],
        reolStart: 2, reolSlut: 2, hylderPerReol: 5, varerPerHylle: 5
      },
      konserves: {
        varer: [
          ['Honning', 'kg', '65.00'], ['Syltet√∏j', 'kg', '35.00'], ['Marmelade', 'kg', '32.00'],
          ['Nutella', 'kg', '45.00'], ['Peanutbutter', 'kg', '38.00'], ['Olivenolie', 'L', '55.00'],
          ['Rapsolie', 'L', '25.00'], ['Eddike', 'L', '15.00'], ['Sojasovs', 'L', '22.00'],
          ['Fiskesovs', 'L', '18.00'], ['Tomatpur√©', 'kg', '28.00'], ['Hakkede tomater', 'kg', '20.00'],
          ['Kik√¶rter', 'kg', '18.00'], ['B√∏nner', 'kg', '16.00'], ['Linser', 'kg', '22.00'],
          ['Honning akacie', 'kg', '68.00'], ['Honning lind', 'kg', '70.00'], ['Honning kl√∏ver', 'kg', '66.00'],
          ['Honning blomster', 'kg', '65.00'], ['Honning birk', 'kg', '72.00'], ['Honning eukalyptus', 'kg', '75.00'],
          ['Honning manuka', 'kg', '195.00'], ['Honning buckwheat', 'kg', '78.00'], ['Honning orange', 'kg', '80.00'],
          ['Honning lavendel', 'kg', '85.00'], ['Syltet√∏j jordb√¶r', 'kg', '36.00'], ['Syltet√∏j bl√•b√¶r', 'kg', '38.00'],
          ['Syltet√∏j hindb√¶r', 'kg', '40.00'], ['Syltet√∏j bromb√¶r', 'kg', '42.00'], ['Syltet√∏j boysenb√¶r', 'kg', '44.00'],
          ['Syltet√∏j loganb√¶r', 'kg', '43.00'], ['Syltet√∏j tayb√¶r', 'kg', '45.00'], ['Syltet√∏j multeb√¶r', 'kg', '46.00'],
          ['Syltet√∏j solb√¶r', 'kg', '48.00'], ['Syltet√∏j stikkelsb√¶r', 'kg', '47.00'], ['Syltet√∏j ribs', 'kg', '38.00'],
          ['Marmelade appelsin', 'kg', '33.00'], ['Marmelade citron', 'kg', '34.00'], ['Marmelade lime', 'kg', '35.00'],
          ['Marmelade grapefrugt', 'kg', '36.00'], ['Marmelade ananas', 'kg', '37.00'], ['Marmelade mango', 'kg', '38.00'],
          ['Marmelade passionsfrugt', 'kg', '39.00'], ['Marmelade guava', 'kg', '40.00'], ['Marmelade papaya', 'kg', '41.00'],
          ['Marmelade granat√¶ble', 'kg', '42.00'], ['Marmelade kranber', 'kg', '43.00'], ['Marmelade kirseb√¶r', 'kg', '44.00'],
          ['Marmelade fersken', 'kg', '45.00'], ['Marmelade nektarin', 'kg', '46.00'], ['Marmelade p√¶re', 'kg', '47.00'],
          ['Marmelade drue', 'kg', '48.00'], ['Marmelade melon', 'kg', '49.00'], ['Marmelade vandmelon', 'kg', '50.00'],
          ['Marmelade kiwi', 'kg', '51.00'], ['Marmelade kokos', 'kg', '52.00'], ['Nutella original', 'kg', '46.00'],
          ['Nutella crunchy', 'kg', '48.00'], ['Nutella white', 'kg', '50.00'], ['Peanutbutter smooth', 'kg', '39.00'],
          ['Peanutbutter crunchy', 'kg', '41.00'], ['Peanutbutter natural', 'kg', '42.00'], ['Olivenolie ekstra jomfru', 'L', '58.00'],
          ['Olivenolie jomfru', 'L', '56.00'], ['Olivenolie raffineret', 'L', '54.00'], ['Olivenolie pomace', 'L', '52.00']
        ],
        reolStart: 3, reolSlut: 3, hylderPerReol: 5, varerPerHylle: 5
      },
      n√∏dder_fr√∏: {
        varer: [
          ['N√∏dder', 'kg', '95.00'], ['Mandler', 'kg', '125.00'], ['Cashewn√∏dder', 'kg', '145.00'],
          ['Valn√∏dder', 'kg', '135.00'], ['Hasseln√∏dder', 'kg', '155.00'], ['Pistacien√∏dder', 'kg', '165.00'],
          ['Macadamian√∏dder', 'kg', '185.00'], ['Pecann√∏dder', 'kg', '175.00'], ['Brasilianske n√∏dder', 'kg', '195.00'],
          ['Paran√∏dder', 'kg', '185.00'], ['Kokosn√∏dder', 'stk', '25.00'], ['Kokosflager', 'kg', '35.00'],
          ['Kokosm√¶lk', 'L', '28.00'], ['Kokosolie', 'L', '45.00'], ['Sesamfr√∏', 'kg', '55.00'],
          ['Solsikkefr√∏', 'kg', '28.00'], ['Gr√¶skarkerner', 'kg', '35.00'], ['Chiafr√∏', 'kg', '85.00'],
          ['H√∏rfr√∏', 'kg', '45.00'], ['Amaranth', 'kg', '65.00'], ['Teff', 'kg', '75.00'],
          ['Buchweizen', 'kg', '55.00'], ['Spelt', 'kg', '42.00'], ['Emmer', 'kg', '48.00'],
          ['Kamut', 'kg', '52.00'], ['Frikah', 'kg', '58.00'], ['Farro', 'kg', '62.00'],
          ['Freekeh', 'kg', '68.00'], ['Sorghum', 'kg', '38.00'], ['Millet', 'kg', '32.00'],
          ['Hirse', 'kg', '28.00']
        ],
        reolStart: 4, reolSlut: 4, hylderPerReol: 5, varerPerHylle: 5
      }
    };
    
    // Gr√∏nt: Frugter (reol 1), Salater (reol 2), Gr√∏nsager (reol 3), Krydderier/Urter (reol 4)
    const groentKategorier = {
      frugter: {
        varer: [
          ['Tomater', 'kg', '35.00'], ['Cherrytomater', 'kg', '45.00'], ['Roma tomater', 'kg', '38.00'],
          ['Beefsteak tomater', 'kg', '42.00'], ['Kirseb√¶rtomater', 'kg', '48.00'], ['Druetomater', 'kg', '52.00'],
          ['P√¶retomater', 'kg', '50.00'], ['Cocktailtomater', 'kg', '55.00'], ['Dattertomater', 'kg', '58.00'],
          ['Plumtomater', 'kg', '40.00'], ['Oxheart tomater', 'kg', '45.00'], ['Brandywine tomater', 'kg', '50.00'],
          ['Heirloom tomater', 'kg', '65.00'], ['San Marzano tomater', 'kg', '48.00'], ['Appelsiner', 'kg', '25.00'],
          ['Clementiner', 'kg', '28.00'], ['Mandariner', 'kg', '26.00'], ['Satsuma', 'kg', '27.00'],
          ['Tangeriner', 'kg', '29.00'], ['Citroner', 'kg', '35.00'], ['Limes', 'kg', '38.00'],
          ['Grapefrugter', 'kg', '32.00'], ['Pomelo', 'kg', '40.00'], ['Kumquat', 'kg', '45.00'],
          ['√Übler', 'kg', '22.00'], ['P√¶rer', 'kg', '28.00'], ['Ferskner', 'kg', '35.00'],
          ['Nektariner', 'kg', '36.00'], ['Aprikoser', 'kg', '38.00'], ['Kirseb√¶r', 'kg', '45.00'],
          ['Blommer', 'kg', '32.00'], ['Druer', 'kg', '28.00'], ['Meloner', 'kg', '25.00'],
          ['Vandmeloner', 'kg', '24.00'], ['Ananas', 'kg', '35.00'], ['Mangoer', 'kg', '42.00'],
          ['Papayaer', 'kg', '38.00'], ['Guavaer', 'kg', '40.00'], ['Passionsfrugter', 'kg', '45.00'],
          ['Granat√¶bler', 'kg', '48.00'], ['Kiwifrugter', 'kg', '42.00'], ['Kokosn√∏dder', 'stk', '25.00'],
          ['Daddler', 'kg', '35.00'], ['Figen', 'kg', '45.00'], ['Kastanjer', 'kg', '38.00'],
          ['Kastanjer ristede', 'kg', '42.00'], ['Kastanjer kogte', 'kg', '40.00'], ['Kastanjer pur√©', 'kg', '45.00'],
          ['Kastanjer mel', 'kg', '48.00'], ['Kastanjer flager', 'kg', '46.00'], ['Kastanjer stykker', 'kg', '44.00']
        ],
        reolStart: 1, reolSlut: 1, hylderPerReol: 5, varerPerHylle: 5
      },
      salater: {
        varer: [
          ['Salat', 'stk', '12.00'], ['Spinat', 'stk', '15.00'], ['Rucola', 'stk', '18.00'],
          ['Iceberg salat', 'stk', '10.00'], ['Romaine salat', 'stk', '14.00'], ['Mizuna', 'stk', '14.00'],
          ['Tatsoi', 'stk', '13.00'], ['Komatsuna', 'stk', '15.00'], ['Choy sum', 'stk', '16.00'],
          ['Bok choy', 'stk', '17.00'], ['Kinesisk k√•l', 'stk', '15.00'], ['Savoyk√•l', 'stk', '18.00'],
          ['Gr√∏nk√•l', 'stk', '14.00'], ['K√•lrabi', 'stk', '12.00'], ['Mangold', 'stk', '15.00'],
          ['R√∏dbede blade', 'stk', '12.00'], ['Karse', 'stk', '11.00'], ['B√∏rneradiser', 'stk', '9.00'],
          ['Butterhead salat', 'stk', '13.00'], ['Oak leaf salat', 'stk', '15.00'], ['Lollo rosso salat', 'stk', '16.00'],
          ['Lollo bionda salat', 'stk', '15.00'], ['Frisee salat', 'stk', '17.00'], ['Endive salat', 'stk', '18.00'],
          ['Radicchio salat', 'stk', '19.00'], ['Belgian endive', 'stk', '20.00'], ['Watercress', 'stk', '16.00'],
          ['Arugula', 'stk', '18.00'], ['Baby spinach', 'stk', '19.00'], ['Baby kale', 'stk', '17.00'],
          ['Baby chard', 'stk', '18.00'], ['Baby bok choy', 'stk', '19.00'], ['Baby romaine', 'stk', '16.00'],
          ['Baby arugula', 'stk', '20.00'], ['Baby watercress', 'stk', '21.00'], ['Baby mizuna', 'stk', '19.00'],
          ['Baby tatsoi', 'stk', '18.00'], ['Baby komatsuna', 'stk', '20.00'], ['Baby choy sum', 'stk', '21.00'],
          ['Baby kinesisk k√•l', 'stk', '19.00'], ['Baby savoyk√•l', 'stk', '20.00'], ['Baby gr√∏nk√•l', 'stk', '18.00'],
          ['Baby k√•lrabi', 'stk', '16.00'], ['Baby mangold', 'stk', '19.00'], ['Baby r√∏dbede blade', 'stk', '17.00'],
          ['Baby karse', 'stk', '16.00'], ['Baby b√∏rneradiser', 'stk', '14.00'], ['Baby butterhead salat', 'stk', '18.00'],
          ['Baby oak leaf salat', 'stk', '20.00'], ['Baby lollo rosso salat', 'stk', '21.00'], ['Baby lollo bionda salat', 'stk', '20.00'],
          ['Baby frisee salat', 'stk', '22.00'], ['Baby endive salat', 'stk', '23.00'], ['Baby radicchio salat', 'stk', '24.00'],
          ['Baby belgian endive', 'stk', '25.00'], ['Baby watercress', 'stk', '21.00'], ['Baby arugula', 'stk', '20.00']
        ],
        reolStart: 2, reolSlut: 2, hylderPerReol: 5, varerPerHylle: 5
      },
      gr√∏nsager: {
        varer: [
          ['Agurk', 'stk', '6.00'], ['Peberfrugt', 'kg', '55.00'], ['Chili', 'kg', '85.00'],
          ['L√∏g', 'kg', '12.00'], ['R√∏dl√∏g', 'kg', '15.00'], ['Hvidl√∏g', 'kg', '45.00'],
          ['Porrer', 'stk', '8.00'], ['Guler√∏dder', 'kg', '14.00'], ['Selleri', 'stk', '12.00'],
          ['Broccoli', 'stk', '18.00'], ['Blomk√•l', 'stk', '16.00'], ['Rosenk√•l', 'kg', '28.00'],
          ['Asparges', 'kg', '65.00'], ['Zucchini', 'kg', '25.00'], ['Aubergine', 'kg', '35.00'],
          ['Squash', 'kg', '22.00'], ['Kartofler', 'kg', '12.00'], ['S√∏de kartofler', 'kg', '18.00'],
          ['R√∏dbeder', 'kg', '20.00'], ['Guler√∏dder baby', 'kg', '28.00'], ['Radiser', 'stk', '8.00'],
          ['K√•l', 'stk', '14.00'], ['R√∏dk√•l', 'stk', '16.00'], ['Spidsk√•l', 'stk', '12.00'],
          ['Pak choi', 'stk', '18.00'], ['Pastinak', 'kg', '22.00'], ['Palerods', 'kg', '18.00'],
          ['Knoldselleri', 'kg', '25.00'], ['R√∏d peber', 'kg', '45.00'], ['Gul peber', 'kg', '42.00'],
          ['Orange peber', 'kg', '44.00'], ['Gr√∏n peber', 'kg', '38.00'], ['Lille peber', 'kg', '48.00'],
          ['Cherry peber', 'kg', '52.00'], ['Jalape√±o', 'kg', '65.00'], ['Habanero', 'kg', '85.00'],
          ['Serrano', 'kg', '55.00'], ['Poblano', 'kg', '45.00'], ['Anaheim', 'kg', '42.00'],
          ['Cubanelle', 'kg', '38.00'], ['Banana peber', 'kg', '35.00'], ['Shishito', 'kg', '48.00'],
          ['Padron', 'kg', '52.00'], ['Fresno', 'kg', '58.00'], ['Cayenne', 'kg', '62.00'],
          ['Thai chili', 'kg', '68.00'], ['Birds eye', 'kg', '72.00'], ['Scotch bonnet', 'kg', '78.00'],
          ['Ghost peber', 'kg', '95.00'], ['Carolina reaper', 'kg', '125.00'], ['Trinidad scorpion', 'kg', '115.00'],
          ['7 pot', 'kg', '105.00'], ['Bhut jolokia', 'kg', '98.00'], ['Habanero orange', 'kg', '88.00'],
          ['Habanero r√∏d', 'kg', '85.00'], ['Habanero gul', 'kg', '82.00'], ['Habanero chokolade', 'kg', '92.00'],
          ['Habanero hvid', 'kg', '78.00'], ['Habanero perle', 'kg', '75.00'], ['Habanero peach', 'kg', '88.00'],
          ['Habanero mango', 'kg', '85.00'], ['Habanero pineapple', 'kg', '82.00'], ['Habanero citrus', 'kg', '78.00'],
          ['Habanero tropical', 'kg', '75.00'], ['Habanero fruity', 'kg', '72.00'], ['Habanero sweet', 'kg', '68.00'],
          ['Habanero mild', 'kg', '65.00'], ['Habanero hot', 'kg', '95.00'], ['Habanero extra hot', 'kg', '125.00'],
          ['Habanero extreme', 'kg', '155.00'], ['Habanero insane', 'kg', '185.00'], ['Habanero death', 'kg', '225.00'],
          ['Habanero inferno', 'kg', '275.00'], ['Habanero hellfire', 'kg', '325.00'], ['Habanero apocalypse', 'kg', '425.00']
        ],
        reolStart: 3, reolSlut: 3, hylderPerReol: 5, varerPerHylle: 5
      },
      krydderier: {
        varer: [
          ['Koriander', 'stk', '12.00'], ['Basilikum', 'stk', '15.00'], ['Persille', 'stk', '10.00'],
          ['Dild', 'stk', '11.00'], ['Timian', 'stk', '14.00'], ['Rosmarin', 'stk', '16.00'],
          ['Oregano', 'stk', '13.00'], ['Mynte', 'stk', '12.00'], ['Citronmelisse', 'stk', '14.00'],
          ['Lavendel', 'stk', '16.00'], ['Salvie', 'stk', '15.00'], ['Estragon', 'stk', '13.00'],
          ['Laurb√¶r', 'stk', '18.00'], ['Basilikum lilla', 'stk', '16.00'], ['Basilikum thai', 'stk', '17.00'],
          ['Basilikum holy', 'stk', '18.00'], ['Basilikum lemon', 'stk', '15.00'], ['Basilikum cinnamon', 'stk', '16.00'],
          ['Basilikum anis', 'stk', '17.00'], ['Oregano gr√¶sk', 'stk', '14.00'], ['Oregano mexicansk', 'stk', '15.00'],
          ['Oregano italiensk', 'stk', '14.00'], ['Tymian citron', 'stk', '15.00'], ['Tymian orange', 'stk', '16.00'],
          ['Tymian caraway', 'stk', '17.00'], ['Rosmarin prostrate', 'stk', '17.00'], ['Rosmarin arp', 'stk', '18.00'],
          ['Rosmarin tuscan blue', 'stk', '19.00'], ['Persille flad', 'stk', '11.00'], ['Persille kr√∏llet', 'stk', '10.00'],
          ['Persille italiensk', 'stk', '12.00'], ['Dild bouquet', 'stk', '12.00'], ['Dill fernleaf', 'stk', '13.00'],
          ['Dill mammoth', 'stk', '14.00'], ['Mynte spearmint', 'stk', '13.00'], ['Mynte peppermint', 'stk', '14.00'],
          ['Mynte applemint', 'stk', '15.00'], ['Mynte chocolate mint', 'stk', '16.00'], ['Mynte orange mint', 'stk', '17.00'],
          ['Mynte pineapple mint', 'stk', '18.00'], ['Koriander vietnamesisk', 'stk', '13.00'], ['Koriander mexicansk', 'stk', '14.00'],
          ['Koriander indisk', 'stk', '15.00'], ['Estragon fransk', 'stk', '14.00'], ['Estragon russisk', 'stk', '15.00'],
          ['Estragon mexicansk', 'stk', '16.00'], ['Salvie gr√∏n', 'stk', '16.00'], ['Salvie lilla', 'stk', '17.00'],
          ['Salvie gul', 'stk', '18.00'], ['Salvie tricolored', 'stk', '19.00'], ['Laurb√¶rblade gr√¶sk', 'stk', '19.00'],
          ['Laurb√¶rblade tyrkisk', 'stk', '20.00'], ['Laurb√¶rblade californisk', 'stk', '21.00'], ['Citronmelisse citron', 'stk', '15.00'],
          ['Citronmelisse lime', 'stk', '16.00'], ['Lavendel engelsk', 'stk', '17.00'], ['Lavendel fransk', 'stk', '18.00'],
          ['Lavendel spansk', 'stk', '19.00'], ['Karse persisk', 'stk', '12.00'], ['Karse libanesisk', 'stk', '13.00'],
          ['Karse marokkansk', 'stk', '14.00']
        ],
        reolStart: 4, reolSlut: 4, hylderPerReol: 5, varerPerHylle: 5
      }
    };
  
    // Generate items using category-based organization
    const koelVarer = genererKategoriseredeVarer('K√∏l', koelKategorier);
    const frostVarer = genererKategoriseredeVarer('Frost', frostKategorier);
    const toereVarer = genererKategoriseredeVarer('T√∏revare', toereKategorier);
    const groentVarer = genererKategoriseredeVarer('Gr√∏nt', groentKategorier);
    
    // Sort all items by location, reol, hylle, r√¶kkef√∏lge
    function sorterVarer(varer) {
      return varer.sort((a, b) => {
        if(a.Placering !== b.Placering) return a.Placering.localeCompare(b.Placering);
        if(parseInt(a.Reol) !== parseInt(b.Reol)) return parseInt(a.Reol) - parseInt(b.Reol);
        if(parseInt(a.Hylle) !== parseInt(b.Hylle)) return parseInt(a.Hylle) - parseInt(b.Hylle);
        return parseInt(a.R√¶kkef√∏lge) - parseInt(b.R√¶kkef√∏lge);
      });
    }
    
    // Helper function to configure Excel sheet with frozen panes, auto-size columns, and formatting
    function konfigurerSheet(ws, sheetName) {
      if(!ws || !ws['!ref']) return; // Safety check
      
      const range = XLSX.utils.decode_range(ws['!ref'] || 'A1');
      
      // Freeze first row (header) - SheetJS uses '!freeze' property
      // Freeze at row 1 (after header row)
      ws['!freeze'] = { xSplit: 0, ySplit: 1, topLeftCell: 'A2', activePane: 'bottomLeft', state: 'frozen' };
      
      // Auto-size columns - calculate optimal width for each column
      const colWidths = [];
      const columnHeaders = ['Navn', 'M√•leenhed', 'Pris', 'Placering', 'Reol', 'Hylle', 'R√¶kkef√∏lge'];
      
      // Header row is always first row (row 0)
      const headerRow = range.s.r;
      const dataStartRow = range.s.r + 1;
      
      for(let C = range.s.c; C <= range.e.c; C++) {
        let maxWidth = columnHeaders[C] ? columnHeaders[C].length : 10;
        
        // Check header row
        const headerCell = XLSX.utils.encode_cell({r: headerRow, c: C});
        if(ws[headerCell] && ws[headerCell].v) {
          maxWidth = Math.max(maxWidth, String(ws[headerCell].v).length);
        }
        
        // Check all data rows
        for(let R = dataStartRow; R <= range.e.r; R++) {
          const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
          const cell = ws[cellAddress];
          if(cell && cell.v !== null && cell.v !== undefined) {
            const cellValue = String(cell.v);
            maxWidth = Math.max(maxWidth, cellValue.length);
          }
        }
        
        // Add padding and set reasonable limits
        colWidths.push({ wch: Math.min(Math.max(maxWidth + 2, 8), 50) });
      }
      ws['!cols'] = colWidths;
      
      // Note: Cell styling (colors, fonts, borders) requires SheetJS Pro
      // The free version supports frozen panes and column widths, but not cell styling
      // We'll add styling anyway - it may work if Pro features are available, otherwise it will be ignored
      
      // Style header row (bold, background color)
      const actualHeaderRow = range.s.r;
      for(let C = range.s.c; C <= range.e.c; C++) {
        const cellAddress = XLSX.utils.encode_cell({r: actualHeaderRow, c: C});
        if(!ws[cellAddress]) {
          // Create cell if it doesn't exist
          ws[cellAddress] = { t: 's', v: columnHeaders[C] || '' };
        }
        if(!ws[cellAddress].s) ws[cellAddress].s = {};
        ws[cellAddress].s.font = { bold: true, sz: 11 };
        ws[cellAddress].s.fill = { fgColor: { rgb: 'D3D3D3' } }; // Light gray background
        ws[cellAddress].s.alignment = { vertical: 'center', horizontal: 'center', wrapText: true };
        ws[cellAddress].s.border = {
          top: { style: 'thin', color: { rgb: '000000' } },
          bottom: { style: 'thin', color: { rgb: '000000' } },
          left: { style: 'thin', color: { rgb: '000000' } },
          right: { style: 'thin', color: { rgb: '000000' } }
        };
      }
      
      // Add visual grouping by reol - alternate row colors for better visibility
      // Column order: Navn (A=0), M√•leenhed (B=1), Pris (C=2), Placering (D=3), Reol (E=4), Hylle (F=5), R√¶kkef√∏lge (G=6)
      let currentReol = '';
      let reolColorIndex = 0;
      const reolColors = ['FFFFFF', 'E8F4F8']; // White and light blue for better visibility
      
      // Start from data rows (skip header row)
      const startRow = range.s.r + 1;
      for(let R = startRow; R <= range.e.r; R++) {
        const reolCell = XLSX.utils.encode_cell({r: R, c: 4}); // Column E (Reol) is index 4 (0-based)
        const reolValue = ws[reolCell] ? String(ws[reolCell].v || '') : '';
        
        if(reolValue !== currentReol && reolValue !== '') {
          currentReol = reolValue;
          reolColorIndex = (reolColorIndex + 1) % reolColors.length;
        }
        
        // Apply background color to entire row (skip header row)
        for(let C = range.s.c; C <= range.e.c; C++) {
          const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
          if(!ws[cellAddress]) continue;
          if(!ws[cellAddress].s) ws[cellAddress].s = {};
          ws[cellAddress].s.fill = { fgColor: { rgb: reolColors[reolColorIndex] } };
        }
      }
    }
    
    // Create "Alle data" sheet with ALL items - simple single sheet template
    // IMPORTANT: Column order must match import function: Varenavn, Varenummer, M√•leenhed, Pris, Placering, Reol, Hylle, R√¶kkef√∏lge
    const alleVarer = [...koelVarer, ...frostVarer, ...toereVarer, ...groentVarer];
    const sortedVarer = sorterVarer([...alleVarer]);
    
    const columnOrder = ['Varenavn', 'Varenummer', 'M√•leenhed', 'Pris', 'Placering', 'Reol', 'Hylle', 'R√¶kkef√∏lge'];
    
    // Create sheet with explicit column order to match import format - Varenummer right after Varenavn
    const alleDataSheet = XLSX.utils.json_to_sheet(sortedVarer, {
      header: columnOrder,
      skipHeader: false
    });
    
    konfigurerSheet(alleDataSheet, 'Alle data');
    
    // Add only "Alle data" sheet to workbook (simple single sheet template)
    XLSX.utils.book_append_sheet(wb, alleDataSheet, 'Alle data');
    
    // Write XLSX file with version number in filename
    const filenameXlsx = `varelager_skabelon_v${APP_VERSION}.xlsx`;
    XLSX.writeFile(wb, filenameXlsx);
    
    // ALSO write a CSV copy with semicolon separator to make import easy
    const csvRows = [];
    csvRows.push(columnOrder.join(';'));
    sortedVarer.forEach(row => {
      const cells = columnOrder.map(col => {
        const val = row[col] !== undefined && row[col] !== null ? String(row[col]) : '';
        // Escape quotes by doubling them
        const escaped = val.replace(/"/g, '""');
        return `"${escaped}"`;
      });
      csvRows.push(cells.join(';'));
    });
    const csvContent = '\uFEFF' + csvRows.join('\n'); // BOM for √¶√∏√•
    const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8;'});
    const filenameCsv = `varelager_skabelon_v${APP_VERSION}.csv`;
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filenameCsv;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`‚úÖ Skabelon downloadet! (v${APP_VERSION})\n\nDer er lavet TO filer:\n‚Ä¢ Excel: ${filenameXlsx}\n‚Ä¢ CSV (klar til import): ${filenameCsv}\n\nStruktur:\n‚Ä¢ Varenavn; Varenummer; M√•leenhed; Pris; Placering; Reol; Hylle; R√¶kkef√∏lge\n‚Ä¢ Alle varer fra alle lokationer (K√∏l, Frost, T√∏revare, Gr√∏nt)\n‚Ä¢ Varer organiseret efter kategori\n\nS√•dan bruger du skabelonen:\n1) Rediger i Excel-filen, gem som CSV eller brug den medf√∏lgende CSV direkte\n2) Import√©r CSV-filen via Import/Export i programmet`);
    
  } catch(err) {
    console.error('Fejl ved generering af Excel skabelon:', err);
    alert('‚ùå Fejl ved generering af Excel skabelon: ' + err.message + '\n\nPr√∏v at genindl√¶se siden (Ctrl+F5).');
  }
}

function exportCSV(){ 
  let csv = "Navn;M√•leenhed;Pris;Placering;Reol;Hylle;R√¶kkef√∏lge\n"; 
  masterVarelager.forEach(v=> {
    const reol = v.reolNr || '';
    const hylle = v.hylleNr || '';
    const raekkefoelge = v.raekkefoelge || 0;
    csv += `${v.navn};${v.maaleenhed};${v.pris};${v.placering || ''};${reol};${hylle};${raekkefoelge}\n`;
  });
  
  // Tilf√∏j BOM for at sikre UTF-8 encoding i Excel
  const BOM = '\uFEFF';
  const csvWithBOM = BOM + csv;
  
  const blob = new Blob([csvWithBOM], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'master_varelager.csv';
  a.click();
  URL.revokeObjectURL(url);
}

let selectedImportFile = null;
let selectedImportType = null;

function importCSV(){ 
  const f = $('csvImport')?.files[0]; 
  if(!f) return alert('V√¶lg CSV eller Excel fil'); 
  
  const fileName = f.name.toLowerCase();
  const isExcel = fileName.endsWith('.xlsx') || fileName.endsWith('.xls');
  
  if(isExcel){
    alert('Excel-filer (.xlsx/.xls) skal f√∏rst gemmes som CSV format i Excel.\n\nI Excel: V√¶lg "Gem som" ‚Üí "CSV (semikolon adskilt)" eller "CSV UTF-8 (semikolon adskilt)" for at bevare danske tegn.');
    return;
  }
  
  // Gem filen og vis valg-modal
  selectedImportFile = f;
  showImportModal();
}

function showImportModal(){
  const modal = $('importModal');
  if(!modal) return;
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
}

function closeImportModal(){
  const modal = $('importModal');
  if(!modal) return;
  modal.classList.add('hidden');
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
  // Nulstil kun hvis import ikke er i gang
  if(!selectedImportType){
    selectedImportFile = null;
  }
}

/* ================================
   [JS 11] PHONE LINK GENERATOR
   ================================ */
async function showPhoneLinkModal(appType = 'manuel'){
  const modal = $('phoneLinkModal');
  const status = $('phoneLinkStatus');
  const content = $('phoneLinkContent');
  const qrContainer = $('qrcode');
  const linkInput = $('phoneLinkInput');
  
  if(!modal || !status || !content) return;
  
  // Gem app type for senere brug
  modal.dataset.appType = appType;
  
  // Vis modal
  modal.classList.remove('hidden');
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden', 'false');
  
  // Opdater titel baseret p√• app type
  const modalTitle = modal.querySelector('h3');
  if(modalTitle) {
    if(appType === 'scanner') {
      modalTitle.textContent = 'üì∑ Stregkode Scanner link til telefon';
    } else {
      modalTitle.textContent = 'üì± Manuel Opt√¶lling link til telefon';
    }
  }
  
  // Skjul indhold indtil IP er fundet
  content.style.display = 'none';
  status.textContent = 'Finder din IP-adresse...';
  status.style.background = '#f0f0f0';
  
  // Ryd QR-kode container
  if(qrContainer) qrContainer.innerHTML = '';
  
  try {
    // Pr√∏v at finde lokal IP via WebRTC
    const ip = await getLocalIPAddress();
    
    if(!ip){
      // Vis manuel indtastning
      const manualDiv = $('phoneLinkManual');
      if(manualDiv) manualDiv.style.display = 'block';
      status.textContent = 'Kunne ikke finde IP-adresse automatisk. Indtast den manuelt nedenfor.';
      status.style.background = '#fff3cd';
      return;
    }
    
    // Detekter om vi er p√• HTTPS eller HTTP
    const isHTTPS = window.location.protocol === 'https:';
    const defaultPort = isHTTPS ? '8443' : '8000';
    const currentPort = window.location.port || defaultPort;
    
    // Brug fundet IP
    generatePhoneLink(ip, currentPort, isHTTPS, appType);
    
  } catch(err){
    console.error('Fejl ved IP lookup:', err);
    // Vis manuel indtastning ved fejl
    const manualDiv = $('phoneLinkManual');
    if(manualDiv) manualDiv.style.display = 'block';
    status.textContent = 'Fejl ved opslag af IP-adresse. Indtast den manuelt nedenfor.';
    status.style.background = '#fff3cd';
  }
}

function generatePhoneLink(ip, port, useHTTPS = false, appType = 'manuel'){
  const status = $('phoneLinkStatus');
  const content = $('phoneLinkContent');
  const qrContainer = $('qrcode');
  const linkInput = $('phoneLinkInput');
  const manualDiv = $('phoneLinkManual');
  const modal = $('phoneLinkModal');
  
  // Hent app type fra modal hvis ikke angivet
  if(!appType && modal) {
    appType = modal.dataset.appType || 'manuel';
  }
  
  // Skjul manuel indtastning
  if(manualDiv) manualDiv.style.display = 'none';
  
  // Bestem protocol og port
  const protocol = useHTTPS ? 'https' : 'http';
  const finalPort = port || (useHTTPS ? '8443' : '8000');
  
  // Generer link baseret p√• app type
  let fileName, link, appName, labelText;
  if(appType === 'scanner') {
    fileName = 'stregkode-scanner.html';
    appName = 'Stregkode Scanner';
    labelText = 'Link til Stregkode Scanner:';
  } else {
    fileName = 'manuel-optaelling.html';
    appName = 'Manuel Opt√¶lling';
    labelText = 'Link til Manuel Opt√¶lling:';
  }
  
  // Hvis vi er p√• GitHub Pages, brug GitHub URL i stedet
  if(window.location.hostname.includes('github.io')) {
    const repoPath = window.location.pathname.split('/').slice(0, 3).join('/');
    link = `${window.location.protocol}//${window.location.hostname}${repoPath}/salg k√∏kkenopt√¶lling/${fileName}`;
  } else {
    link = `${protocol}://${ip}:${finalPort}/${fileName}`;
  }
  
  // Vis link
  if(linkInput){
    linkInput.value = link;
  }
  
  // Opdater label og beskrivelse
  const label = content.querySelector('label');
  if(label) {
    label.textContent = labelText;
  }
  
  const contentDesc = content.querySelector('p');
  if(contentDesc && contentDesc.textContent.includes('üì±')) {
    contentDesc.textContent = `üì± ${appName} til din telefon - Scan QR-koden eller kopi√©r linket nedenfor:`;
  }
  
  // Generer QR-kode
  if(qrContainer && typeof QRCode !== 'undefined'){
    qrContainer.innerHTML = '';
    new QRCode(qrContainer, {
      text: link,
      width: 256,
      height: 256,
      colorDark: '#000000',
      colorLight: '#ffffff',
      correctLevel: QRCode.CorrectLevel.H
    });
  } else if(qrContainer){
    // Fallback hvis QRCode library ikke er indl√¶st
    qrContainer.innerHTML = `<div style="padding:20px; text-align:center;">
      <p style="color:#666;">QR-kode library ikke indl√¶st.</p>
      <p style="margin-top:10px; font-size:12px;">Brug linket nedenfor i stedet.</p>
    </div>`;
  }
  
  // Vis indhold
  if(status){
    const protocolText = useHTTPS ? 'HTTPS (Kamera virker!)' : 'HTTP';
    status.textContent = `${protocolText} - IP: ${ip}:${finalPort}`;
    status.style.background = useHTTPS ? '#E3F2FD' : '#fff3cd';
    
    // Tilf√∏j note om HTTPS for kamera (kun hvis den ikke allerede findes)
    if(!useHTTPS){
      let note = status.parentNode.querySelector('.https-tip-note');
      if(!note){
        note = document.createElement('div');
        note.className = 'https-tip-note';
        note.style.marginTop = '10px';
        note.style.padding = '10px';
        note.style.background = '#fff3cd';
        note.style.borderRadius = '4px';
        note.style.fontSize = '13px';
        note.innerHTML = '<strong>üí° Tip:</strong> Brug HTTPS serveren (START_HTTPS_SERVER.bat) for at scanne med kameraet p√• telefonen!';
        status.parentNode.insertBefore(note, status.nextSibling);
      }
    } else {
      // Fjern note hvis vi bruger HTTPS
      const note = status.parentNode.querySelector('.https-tip-note');
      if(note) note.remove();
    }
  }
  if(content) content.style.display = 'block';
}

function useManualIP(){
  const ipInput = $('manualIPInput');
  const portInput = $('manualPortInput');
  const httpsCheckbox = $('useHTTPS');
  const modal = $('phoneLinkModal');
  const appType = modal ? (modal.dataset.appType || 'manuel') : 'manuel';
  
  if(!ipInput) return;
  
  const ip = ipInput.value.trim();
  let port = (portInput && portInput.value.trim()) || '8443';
  
  // Valider IP format
  const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
  if(!ipRegex.test(ip)){
    alert('Ugyldig IP-adresse format. Brug formatet: 192.168.1.100');
    return;
  }
  
  // Valider port
  const portNum = parseInt(port);
  if(isNaN(portNum) || portNum < 1 || portNum > 65535){
    alert('Ugyldig port. Brug et tal mellem 1 og 65535');
    return;
  }
  
  // Detekter om vi skal bruge HTTPS baseret p√• checkbox eller port
  const useHTTPS = (httpsCheckbox && httpsCheckbox.checked) || portNum === 8443 || window.location.protocol === 'https:';
  
  // Opdater port hvis HTTPS er valgt og port ikke er 8443
  if(useHTTPS && portNum !== 8443){
    port = '8443';
    if(portInput) portInput.value = '8443';
  }
  
  generatePhoneLink(ip, port, useHTTPS, appType);
}

function retryIPDetection(){
  const status = $('phoneLinkStatus');
  const manualDiv = $('phoneLinkManual');
  const content = $('phoneLinkContent');
  
  if(manualDiv) manualDiv.style.display = 'none';
  if(content) content.style.display = 'none';
  if(status){
    status.textContent = 'Finder din IP-adresse...';
    status.style.background = '#f0f0f0';
  }
  
  // Pr√∏v igen
  showPhoneLinkModal();
}

async function getLocalIPAddress(){
  return new Promise((resolve) => {
    // Metode 1: Pr√∏v window.location.hostname f√∏rst (hvis vi allerede er p√• en server)
    const hostname = window.location.hostname;
    if(hostname && hostname !== 'localhost' && hostname !== '127.0.0.1' && hostname !== '0.0.0.0'){
      // Tjek om det er en IP-adresse
      const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
      if(ipRegex.test(hostname)){
        resolve(hostname);
        return;
      }
      // Eller pr√∏v at resolve hostname (kan v√¶re langsomt)
    }
    
    // Metode 2: Pr√∏v WebRTC metode
    const RTCPeerConnection = window.RTCPeerConnection || window.mozRTCPeerConnection || window.webkitRTCPeerConnection;
    
    if(!RTCPeerConnection){
      resolve(null);
      return;
    }
    
    let foundIP = null;
    const pc = new RTCPeerConnection({
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' }
      ]
    });
    
    pc.createDataChannel('');
    
    pc.onicecandidate = (event) => {
      if(event.candidate && !foundIP){
        const candidate = event.candidate.candidate;
        // Match IPv4 addresses
        const match = candidate.match(/([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})/);
        if(match){
          const ip = match[1];
          // Filtrer private IPs (LAN addresses)
          if(ip.startsWith('192.168.') || 
             ip.startsWith('10.') || 
             (ip.startsWith('172.') && parseInt(ip.split('.')[1]) >= 16 && parseInt(ip.split('.')[1]) <= 31)){
            foundIP = ip;
            pc.close();
            resolve(ip);
          }
        }
      }
    };
    
    pc.onicegatheringstatechange = () => {
      if(pc.iceGatheringState === 'complete' && !foundIP){
        pc.close();
        // Hvis vi stadig ikke har fundet noget, pr√∏v hostname igen
        if(hostname && hostname !== 'localhost' && hostname !== '127.0.0.1'){
          resolve(hostname);
        } else {
          resolve(null);
        }
      }
    };
    
    pc.createOffer()
      .then(offer => pc.setLocalDescription(offer))
      .catch(() => {
        pc.close();
        if(hostname && hostname !== 'localhost' && hostname !== '127.0.0.1'){
          resolve(hostname);
        } else {
          resolve(null);
        }
      });
    
    // Timeout efter 5 sekunder
    setTimeout(() => {
      if(!foundIP){
        pc.close();
        if(hostname && hostname !== 'localhost' && hostname !== '127.0.0.1'){
          resolve(hostname);
        } else {
          resolve(null);
        }
      }
    }, 5000);
  });
}

function copyPhoneLink(){
  const linkInput = $('phoneLinkInput');
  if(!linkInput) return;
  
  linkInput.select();
  linkInput.setSelectionRange(0, 99999); // For mobile
  
  try {
    document.execCommand('copy');
    alert('Link kopieret til udklipsholder!');
  } catch(err){
    // Fallback for nye browsers
    navigator.clipboard.writeText(linkInput.value).then(() => {
      alert('Link kopieret til udklipsholder!');
    }).catch(() => {
      alert('Kunne ikke kopiere. Kopi√©r linket manuelt.');
    });
  }
}

function closePhoneLinkModal(){
  const modal = $('phoneLinkModal');
  const manualDiv = $('phoneLinkManual');
  const content = $('phoneLinkContent');
  const ipInput = $('manualIPInput');
  const portInput = $('manualPortInput');
  const testResult = $('serverTestResult');
  
  if(!modal) return;
  modal.classList.add('hidden');
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden', 'true');
  
  // Nulstil felter
  if(manualDiv) manualDiv.style.display = 'none';
  if(content) content.style.display = 'none';
  if(ipInput) ipInput.value = '';
  if(portInput) portInput.value = '8000';
  if(testResult){
    testResult.style.display = 'none';
    testResult.innerHTML = '';
  }
}

function showConnectionHelp(){
  const helpDiv = $('connectionErrorHelp');
  if(helpDiv){
    helpDiv.style.display = helpDiv.style.display === 'none' ? 'block' : 'none';
  }
}

async function testServerConnection(){
  const linkInput = $('phoneLinkInput');
  const testResult = $('serverTestResult');
  
  if(!linkInput || !testResult) return;
  
  const link = linkInput.value.trim();
  if(!link){
    testResult.style.display = 'block';
    testResult.style.background = '#ffebee';
    testResult.innerHTML = '<strong>Fejl:</strong> Ingen link at teste. Generer linket f√∏rst.';
    return;
  }
  
  testResult.style.display = 'block';
  testResult.style.background = '#fff3cd';
  testResult.innerHTML = 'Tester server forbindelse...';
  
  try {
    // Pr√∏v at √•bne linket i et nyt vindue for at teste
    const testWindow = window.open(link, '_blank');
    
    if(testWindow){
      // Vent lidt og tjek om siden loaded
      setTimeout(() => {
        try {
          // Hvis vi kan tilg√• location, er siden loaded
          if(testWindow.location.href){
            testResult.style.background = '#E3F2FD';
            testResult.innerHTML = '<strong>‚úì Server virker!</strong> Linket √•bnede korrekt. Pr√∏v nu at √•bne det p√• din telefon.';
          }
        } catch(e){
          // Cross-origin fejl er normalt - betyder at siden loaded
          testResult.style.background = '#E3F2FD';
          testResult.innerHTML = '<strong>‚úì Server virker!</strong> Linket √•bnede korrekt. Pr√∏v nu at √•bne det p√• din telefon.';
        }
      }, 2000);
    } else {
      // Popup blev blokeret - pr√∏v fetch i stedet
      try {
        const response = await fetch(link, { 
          method: 'GET',
          mode: 'no-cors',
          cache: 'no-cache'
        });
        
        testResult.style.background = '#E3F2FD';
        testResult.innerHTML = '<strong>‚úì Server ser ud til at v√¶re tilg√¶ngelig.</strong> Pr√∏v at √•bne linket p√• din telefon.';
      } catch(e){
        throw new Error('Forbindelse n√¶gtet');
      }
    }
    
  } catch(err){
    testResult.style.background = '#ffebee';
    testResult.innerHTML = `<strong>‚úó Forbindelse n√¶gtet!</strong><br><br>
      <strong>Dette betyder at webserveren ikke k√∏rer eller firewall blokerer.</strong><br><br>
      <strong>L√∏sning:</strong><br>
      1. <strong>Dobbeltklik p√• START_WEBSERVER.bat</strong> - vinduet skal v√¶re √•bent<br>
      2. <strong>Tjek at du ser "Serving HTTP on 0.0.0.0 port 8000"</strong> i vinduet<br>
      3. <strong>Pr√∏v linket p√• computeren f√∏rst:</strong> Kopi√©r linket og √•bn det i browseren<br>
      4. <strong>Hvis det virker p√• computeren:</strong> Tjek Windows Firewall - tillad port 8000<br>
      5. <strong>Hvis det ikke virker p√• computeren:</strong> Serveren k√∏rer ikke - start START_WEBSERVER.bat igen<br><br>
      <button onclick="showConnectionHelp()" style="padding:6px 12px; background:#0078D4; color:white; border:none; border-radius:4px; cursor:pointer; margin-top:8px;">Se detaljeret guide</button>`;
    
    // Vis hj√¶lp automatisk
    showConnectionHelp();
  }
}

function selectImportType(type){
  selectedImportType = type;
  
  if(!selectedImportFile) {
    closeImportModal();
    alert('Filen blev ikke fundet. Pr√∏v at v√¶lge filen igen.');
    return;
  }
  
  const f = selectedImportFile;
  closeImportModal();
  
  const r = new FileReader(); 
  
  // Pr√∏v f√∏rst UTF-8, derefter Windows-1252 hvis det fejler
  r.onload = ()=>{
    try {
      let text = r.result;
      
      if(!text || text.length === 0){
        alert('Filen er tom eller kunne ikke l√¶ses.');
        return;
      }
      
      // Hvis tekst ser forkert ud (manglede tegn), pr√∏v Windows-1252 encoding
      if(text.includes('') || (text.length > 0 && !/[a-zA-Z√¶√∏√•√Ü√ò√Ö]/.test(text.substring(0, Math.min(100, text.length))))){
        // Pr√∏v at l√¶se igen med Windows-1252
        const r2 = new FileReader();
        r2.onload = () => {
          processImportText(r2.result, type);
        };
        r2.onerror = () => {
          processImportText(text, type); // Brug original tekst hvis det fejler
        };
        // L√¶s med Windows-1252 encoding (ISO-8859-1)
        const blob = f.slice(0, f.size, 'text/plain;charset=iso-8859-1');
        r2.readAsText(blob, 'ISO-8859-1');
        return;
      }
      
      processImportText(text, type);
    } catch(err) {
      alert('Fejl ved import: ' + err.message);
      console.error('Import fejl:', err);
    }
  };
  
  r.onerror = ()=>{
    alert('Kunne ikke l√¶se filen. Tjek at filen er en gyldig CSV fil.');
    console.error('FileReader fejl:', r.error);
  };
  
  // L√¶s med UTF-8 encoding f√∏rst
  r.readAsText(f, 'UTF-8');
}

function processImportText(text, importType = 'add'){
  // Sikr at importType er sat
  if(!importType){
    importType = 'add';
  }
  
  if(!text || text.length === 0){
    alert('Filen er tom eller kunne ikke l√¶ses.');
    return;
  }
  
  console.log('Import type:', importType);
  console.log('Text length:', text.length);
  
  // Fjern BOM (Byte Order Mark) hvis det findes
  if(text.charCodeAt(0) === 0xFEFF) {
    text = text.slice(1);
  }
  
  const lines = text.split(/\r?\n/);
  if(lines.length < 2){
    alert('Filen indeholder ikke nok data. Tjek at filen har en header-r√¶kke og mindst √©n vare.');
    return;
  }
  
  let imported = 0;
  let updated = 0;
  let skipped = 0;
  let errors = [];
  
  // Detekter separator (semikolon eller komma)
  const firstLine = lines[0] || '';
  const hasSemicolon = firstLine.includes(';');
  const hasComma = firstLine.includes(',');
  const separator = hasSemicolon ? ';' : (hasComma ? ',' : ';');
  
  // Parse alle varer fra filen
  const fileVarer = [];
  lines.forEach((l, i)=>{
    // Spring over header (f√∏rste linje)
    if(i === 0) return;
    
    // Spring over tomme linjer
    if(!l.trim()) return;
    
    // Split p√• separator
    const parts = l.split(separator);
    if(parts.length < 1) return;
    
    // Trim alle dele og fjern quotes
    const cleanParts = parts.map(p => p.trim().replace(/^["']|["']$/g, ''));
    
    // New column order: Varenavn, Varenummer, M√•leenhed, Pris, Placering, Reol, Hylle, R√¶kkef√∏lge
    const navn = cleanParts[0] || '';
    if(!navn || navn === '') return;
    
    const varenummer = cleanParts[1]?.trim() || null;
    const maale = cleanParts[2]?.trim() || 'stk';
    // H√•ndter b√•de komma og punktum som decimal-separator
    const prisStr = (cleanParts[3] || '0').replace(',', '.');
    const pris = parseFloat(prisStr) || 0;
    const placering = cleanParts[4]?.trim() || '';
    // L√¶s reol, hylle og r√¶kkef√∏lge kolonnerne (hvis de findes)
    const reol = cleanParts[5]?.trim() || null;
    const hylle = cleanParts[6]?.trim() || null;
    const raekkefoelgeStr = cleanParts[7]?.trim() || '0';
    const raekkefoelge = parseFloat(raekkefoelgeStr) || 0;
    
    fileVarer.push({ navn, maaleenhed: maale, pris, placering, reolNr: reol, hylleNr: hylle, raekkefoelge, varenummer: varenummer });
  });
  
  if(fileVarer.length === 0){
    alert('Ingen varer fundet i filen. Tjek at filen har korrekt format:\nVarenavn;Varenummer;M√•leenhed;Pris;Placering;Reol;Hylle;R√¶kkef√∏lge\n\nVarenummer, Reol, hylle og r√¶kkef√∏lge er valgfrie.');
    return;
  }
  
  console.log('Varer fundet i fil:', fileVarer.length);
  console.log('Eksisterende varer f√∏r import:', masterVarelager.length);
  
  // Find alle unikke placeringer i filen
  const unikkePlaceringer = [...new Set(fileVarer.map(v => v.placering).filter(p => p && p.trim()))];
  const nyePlaceringer = unikkePlaceringer.filter(p => !lagerLokationer.includes(p));
  
  // Hvis der er nye placeringer, sp√∏rg om de skal oprettes
  if(nyePlaceringer.length > 0){
    const placeringerTekst = nyePlaceringer.join(', ');
    const bekr√¶ft = confirm(`Der er fundet nye placeringer i filen som ikke findes i systemet:\n\n${placeringerTekst}\n\nSkal disse placeringer automatisk oprettes?\n\nOK = Opret automatisk\nAnnuller = Spring over varer med ukendte placeringer`);
    
    if(bekr√¶ft){
      // Opret nye placeringer
      nyePlaceringer.forEach(placering => {
        if(!lagerLokationer.includes(placering)){
          lagerLokationer.push(placering);
          lagerData[placering] = {};
        }
      });
    } else {
      // Fjern varer med ukendte placeringer (iterer bagl√¶ns for at undg√• index-problemer)
      const oprindeligLaengde = fileVarer.length;
      for(let i = fileVarer.length - 1; i >= 0; i--){
        if(nyePlaceringer.includes(fileVarer[i].placering)){
          fileVarer.splice(i, 1);
        }
      }
      if(fileVarer.length < oprindeligLaengde){
        alert(`${oprindeligLaengde - fileVarer.length} varer er blevet sprunget over da de har ukendte placeringer.`);
      }
    }
  }
  
  // H√•ndter forskellige import-typer
  if(importType === 'overwrite'){
    // Overskriv hele varelageret
    masterVarelager = [];
    fileVarer.forEach(v => {
      masterVarelager.push({ id: genId(), navn: v.navn, maaleenhed: v.maaleenhed, pris: v.pris, placering: v.placering, reolNr: v.reolNr || null, hylleNr: v.hylleNr || null, raekkefoelge: v.raekkefoelge || 0, varenummer: v.varenummer || null });
      imported++;
    });
  } else if(importType === 'add'){
    // Tilf√∏j kun nye varer
    fileVarer.forEach(v => {
      const exists = masterVarelager.find(existing => existing.navn.toLowerCase() === v.navn.toLowerCase());
      if(!exists){
        masterVarelager.push({ id: genId(), navn: v.navn, maaleenhed: v.maaleenhed, pris: v.pris, placering: v.placering, reolNr: v.reolNr || null, hylleNr: v.hylleNr || null, raekkefoelge: v.raekkefoelge || 0, varenummer: v.varenummer || null });
        imported++;
      } else {
        skipped++;
      }
    });
  } else if(importType === 'update'){
    // Opdater priser for eksisterende, tilf√∏j nye
    fileVarer.forEach(v => {
      const existing = masterVarelager.find(existing => existing.navn.toLowerCase() === v.navn.toLowerCase());
      if(existing){
        // Opdater pris (og m√•ske m√•leenhed, placering, reol, hylle, r√¶kkef√∏lge, varenummer hvis de er angivet)
        existing.pris = v.pris;
        if(v.maaleenhed) existing.maaleenhed = v.maaleenhed;
        if(v.placering) existing.placering = v.placering;
        if(v.reolNr !== undefined && v.reolNr !== null && v.reolNr !== '') existing.reolNr = v.reolNr;
        if(v.hylleNr !== undefined && v.hylleNr !== null && v.hylleNr !== '') existing.hylleNr = v.hylleNr;
        if(v.raekkefoelge !== undefined) existing.raekkefoelge = v.raekkefoelge || 0;
        if(v.varenummer !== undefined && v.varenummer !== null && v.varenummer !== '') existing.varenummer = v.varenummer;
        updated++;
      } else {
        // Tilf√∏j ny vare
        masterVarelager.push({ id: genId(), navn: v.navn, maaleenhed: v.maaleenhed, pris: v.pris, placering: v.placering, reolNr: v.reolNr || null, hylleNr: v.hylleNr || null, raekkefoelge: v.raekkefoelge || 0, varenummer: v.varenummer || null });
        imported++;
      }
    });
  } else {
    alert('Ukendt import-type: ' + importType);
    return;
  }
  
  console.log('Varer efter import:', masterVarelager.length);
  console.log('Imported:', imported, 'Updated:', updated, 'Skipped:', skipped);
  
  // Opdater UI
  renderMasterTable(); 
  renderLagerOpsaetning(); // Opdater ogs√• lager ops√¶tning hvis nye placeringer er tilf√∏jet
  updateAllSelects();
  // Opdater hylle dropdowns
  updateHylleReolSelect();
  updateHylleHylleSelect();
  renderHylleRaekkefoelge();
  renderLagerTable(); 
  saveAllData();
  
  // Nulstil fil-input og variabler
  if($('csvImport')) $('csvImport').value = '';
  selectedImportFile = null;
  selectedImportType = null;
  
  let msg = `Import gennemf√∏rt!\n\n`;
  if(importType === 'overwrite'){
    msg += `‚úÖ ${imported} varer importeret (hele varelageret er erstattet)`;
  } else if(importType === 'add'){
    msg += `‚úÖ ${imported} nye varer tilf√∏jet`;
    if(skipped > 0) msg += `\n‚ö†Ô∏è ${skipped} varer sprunget over (findes allerede)`;
  } else if(importType === 'update'){
    msg += `‚úÖ ${updated} varer opdateret`;
    if(imported > 0) msg += `\n‚ûï ${imported} nye varer tilf√∏jet`;
  }
  if(errors.length > 0) msg += `\n‚ùå ${errors.length} fejl`;
  alert(msg);
}

/* Backup / restore */
function exportAllBackup(){ const payload={ masterVarelager, lagerData, lagerLokationer, leverandorer, reports, sessionCounter }; downloadFile(JSON.stringify(payload,null,2),'lager_backup.json','application/json'); }
function importAllBackupFromFile(file){ const r = new FileReader(); r.onload = e => { try{ const obj = JSON.parse(e.target.result); masterVarelager = obj.masterVarelager || []; lagerData = obj.lagerData || {}; lagerLokationer = obj.lagerLokationer || ['K√∏l','Frost','T√∏revare','Gr√∏nt']; if(lagerLokationer.includes('Vinlager')){ lagerLokationer = lagerLokationer.filter(loc => loc !== 'Vinlager'); } reports = obj.reports || []; leverandorer = obj.leverandorer || []; sessionCounter = obj.sessionCounter || 0; updateAllSelects(); renderMasterTable(); renderLagerOpsaetning(); renderLagerTable(); renderReports(); updateLogPreview(); alert('Backup importeret'); }catch(err){ alert('Fejl ved import: '+err.message); } }; r.readAsText(file); }

/* Check for manual counting data automatically and refresh reports */
function checkForManualCountingData(){
  try{
    // Check for new reports in localStorage and refresh reports array
    const storageKey = 'k√∏kkenlager_data';
    const mainData = localStorage.getItem(storageKey);
    if(mainData) {
      const data = JSON.parse(mainData);
      if(data.reports && Array.isArray(data.reports)) {
        // Check if reports array has changed
        const currentReportCount = reports.length;
        const newReportCount = data.reports.length;
        
        // If there are new reports, reload the reports array
        if(newReportCount !== currentReportCount || newReportCount > currentReportCount) {
          reports = data.reports;
          
          // Update sessionCounter if it changed
          if(data.sessionCounter !== undefined && data.sessionCounter > sessionCounter) {
            sessionCounter = data.sessionCounter;
          }
          
          // Refresh reports display if we're on the reports page
          const reportsSection = document.getElementById('rapporter');
          if(reportsSection && !reportsSection.classList.contains('hidden')) {
            renderReports();
            updateLogPreview();
          }
          
          console.log('Reports updated from localStorage. New count:', newReportCount);
        }
      }
    }
    
    // Also check for import data (old format)
    const manualDataStr = localStorage.getItem('manuelOptaelData');
    if(manualDataStr) {
      try {
        const manualData = JSON.parse(manualDataStr);
        if(manualData.items && Array.isArray(manualData.items) && manualData.items.length > 0) {
          // Show notification that data is available
          const statusEl = document.getElementById('sessionInfo');
          if(statusEl && !statusEl.textContent.includes('Manuel opt√¶lling klar')){
            const originalText = statusEl.textContent;
            statusEl.innerHTML = `${originalText} <span style="background:#28a745;color:white;padding:4px 8px;border-radius:4px;margin-left:8px;cursor:pointer;" onclick="importManualCountingData()" title="Klik for at importere">üì± Manuel opt√¶lling klar!</span>`;
          }
          return true;
        }
      } catch(e) {
        // Ignore errors
      }
    }
    
    return false;
  } catch(e){
    console.error('Error checking for manual counting data:', e);
    return false;
  }
}

/* Import manual counting data from manuel-optaelling.html */
/* Download Manuel Opt√¶lling file directly */
function downloadManuelOptaeling(){
  try {
    // Try to fetch the file
    fetch('manuel-optaelling.html')
      .then(response => {
        if(!response.ok) {
          throw new Error('Filen blev ikke fundet');
        }
        return response.text();
      })
      .then(html => {
        // Create a blob and download
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'manuel-optaelling.html';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        // Show instructions
        setTimeout(() => {
          alert('‚úÖ Filen er downloadet!\n\nüìã N√¶ste skridt:\n\n1. Find filen i din Downloads-mappe\n2. Send filen til din telefon:\n   - Via email\n   - Via USB\n   - Via OneDrive\n   - Via AirDrop (Mac/iPhone)\n\n3. P√• telefonen:\n   - √Öbn filen med din browser\n   - Tilf√∏j til hjem-sk√¶rmen\n\nüí° Tip: Du kan ogs√• bruge "üì± Send link til telefon" knappen hvis du har webserveren k√∏rende!');
        }, 500);
      })
      .catch(err => {
        console.error('Download error:', err);
        // Fallback: show instructions
        alert('‚ö†Ô∏è Kunne ikke downloade filen automatisk.\n\nüìã G√∏r dette i stedet:\n\n1. G√• til projektmappen p√• din computer\n2. Find filen: "manuel-optaelling.html"\n3. Send filen til din telefon:\n   - H√∏jreklik ‚Üí Send til ‚Üí Mail-modtager\n   - Eller kopi√©r til OneDrive\n   - Eller send via USB\n\n4. P√• telefonen:\n   - √Öbn filen med din browser\n   - Tilf√∏j til hjem-sk√¶rmen');
      });
  } catch(e) {
    console.error('Download error:', e);
    alert('‚ö†Ô∏è Kunne ikke downloade filen automatisk.\n\nüìã G√∏r dette i stedet:\n\n1. G√• til projektmappen p√• din computer\n2. Find filen: "manuel-optaelling.html"\n3. Send filen til din telefon via email, OneDrive eller USB\n\n4. P√• telefonen: √Öbn filen med din browser');
  }
}

// Generate QR code with varelager data for scanner app
function generateVarelagerQR(){
  try {
    // Prepare data - only masterVarelager to keep QR code small
    const installationId = getInstallationId();
    const dataToExport = {
      masterVarelager: masterVarelager || [],
      lagerLokationer: lagerLokationer || [],
      mainInstallationId: installationId, // Include main program installation ID
      version: '1.0',
      exportedAt: Date.now()
    };
    
    if (!dataToExport.masterVarelager || dataToExport.masterVarelager.length === 0) {
      alert('‚ö†Ô∏è Ingen varelager data at eksportere.\n\nTilf√∏j varer i varelager administration f√∏rst.');
      return;
    }
    
    // Convert to JSON string
    const jsonString = JSON.stringify(dataToExport);
    
    // Check size - QR codes can handle up to ~2953 alphanumeric characters
    // For safety, we'll use base64 encoding which is more compact
    const base64Data = btoa(unescape(encodeURIComponent(jsonString)));
    
    // Create data URL with prefix so scanner knows it's varelager data
    const qrData = 'VARELAGER:' + base64Data;
    
    // Check if data is too large for QR code
    if (qrData.length > 2500) {
      // Data too large - offer to download file instead
      if (confirm('‚ö†Ô∏è Varelager data er for stor til QR-kode.\n\nVil du downloade en fil i stedet?\n\n‚úÖ Ja = Download fil til import\n‚ùå Nej = Annuller')) {
        // Download as JSON file for import
        const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `varelager-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('‚úÖ Fil downloadet!\n\nüì± N√¶ste skridt:\n\n1. Send filen til din telefon (email, cloud, etc.)\n2. √Öbn scanner-appen p√• telefonen\n3. Tryk "üì• Import fil" knappen\n4. V√¶lg den downloadede fil\n5. Varelageret importeres automatisk!');
      }
      return;
    }
    
    // Get container
    const container = document.getElementById('varelagerQRContainer');
    const qrCodeDiv = document.getElementById('varelagerQRCode');
    
    if (!container || !qrCodeDiv) {
      alert('‚ö†Ô∏è QR-kode container ikke fundet.');
      return;
    }
    
    // Clear previous QR code
    qrCodeDiv.innerHTML = '';
    
    // Generate QR code
    if (typeof QRCode !== 'undefined') {
      new QRCode(qrCodeDiv, {
        text: qrData,
        width: 300,
        height: 300,
        colorDark: '#000000',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H // High error correction
      });
      
      // Show container
      container.style.display = 'block';
      
      // Scroll to QR code
      container.scrollIntoView({ behavior: 'smooth', block: 'center' });
      
      alert('‚úÖ QR-kode genereret!\n\nüì± N√¶ste skridt:\n\n1. √Öbn scanner-appen p√• telefonen\n2. Tryk "üì• Scan QR-kode" knappen\n3. Scan denne QR-kode\n4. Varelageret importeres automatisk!');
    } else {
      alert('‚ö†Ô∏è QR-kode bibliotek ikke indl√¶st.\n\nGenindl√¶s siden og pr√∏v igen.');
    }
  } catch(err) {
    console.error('Error generating QR code:', err);
    alert('‚ö†Ô∏è Fejl ved generering af QR-kode: ' + err.message);
  }
}

function downloadStregkodeScanner(){
  try {
    // Try to fetch the file
    fetch('stregkode-scanner.html')
      .then(response => {
        if(!response.ok) {
          throw new Error('Filen blev ikke fundet');
        }
        return response.text();
      })
      .then(html => {
        // Create a blob and download
        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'stregkode-scanner.html';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        // Also download manifest if possible
        fetch('stregkode-scanner-manifest.json')
          .then(res => res.text())
          .then(manifest => {
            const manifestBlob = new Blob([manifest], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            const manifestLink = document.createElement('a');
            manifestLink.href = manifestUrl;
            manifestLink.download = 'stregkode-scanner-manifest.json';
            document.body.appendChild(manifestLink);
            manifestLink.click();
            document.body.removeChild(manifestLink);
            URL.revokeObjectURL(manifestUrl);
          })
          .catch(() => {
            // Ignore manifest download errors
          });
        
        // Show instructions
        setTimeout(() => {
          alert('‚úÖ Filen er downloadet!\n\nüìã N√¶ste skridt:\n\n1. Find filen i din Downloads-mappe\n2. Send filen til din telefon:\n   - Via email\n   - Via USB\n   - Via OneDrive\n   - Via AirDrop (Mac/iPhone)\n\n3. P√• telefonen:\n   - √Öbn filen med din browser\n   - Tilf√∏j til hjem-sk√¶rmen\n\nüí° VIGTIGT: Scanner appen kr√¶ver HTTPS eller localhost for at bruge kameraet!\n\nüí° Tip: Du kan ogs√• bruge "üì± Send link til telefon" knappen hvis du har webserveren k√∏rende!');
        }, 500);
      })
      .catch(err => {
        console.error('Download error:', err);
        // Fallback: show instructions
        alert('‚ö†Ô∏è Kunne ikke downloade filen automatisk.\n\nüìã G√∏r dette i stedet:\n\n1. G√• til projektmappen p√• din computer\n2. Find filen: "stregkode-scanner.html"\n3. Send filen til din telefon:\n   - H√∏jreklik ‚Üí Send til ‚Üí Mail-modtager\n   - Eller kopi√©r til OneDrive\n   - Eller send via USB\n\n4. P√• telefonen:\n   - √Öbn filen med din browser\n   - Tilf√∏j til hjem-sk√¶rmen\n\nüí° VIGTIGT: Scanner appen kr√¶ver HTTPS eller localhost for at bruge kameraet!');
      });
  } catch(e) {
    console.error('Download error:', e);
    alert('‚ö†Ô∏è Kunne ikke downloade filen automatisk.\n\nüìã G√∏r dette i stedet:\n\n1. G√• til projektmappen p√• din computer\n2. Find filen: "stregkode-scanner.html"\n3. Send filen til din telefon via email, OneDrive eller USB\n\n4. P√• telefonen: √Öbn filen med din browser\n\nüí° VIGTIGT: Scanner appen kr√¶ver HTTPS eller localhost for at bruge kameraet!');
  }
}

function importManualCountingData(){
  try{
    // Check for manual counting data
    const manualDataStr = localStorage.getItem('manuelOptaelData');
    if(!manualDataStr){
      alert('Ingen manuel opt√¶lling data fundet.\n\nBrug manuel opt√¶lling app p√• telefon/tablet f√∏rst.');
      return;
    }
    
    const manualData = JSON.parse(manualDataStr);
    if(!manualData.items || !Array.isArray(manualData.items) || manualData.items.length === 0){
      alert('Ingen varer i manuel opt√¶lling data.');
      return;
    }
    
    // Find or create active session
    if(!activeSession){
      sessionCounter++;
      activeSession = {
        id: genId(),
        name: `Manuel opt√¶lling ${new Date().toLocaleString()}`,
        scope: manualData.location || '',
        tsStart: Date.now(),
        counts: {}
      };
      const info = $('sessionInfo');
      if(info){
        info.classList.remove('hidden');
        info.textContent = `${activeSession.name} ‚Äî ${activeSession.scope || 'Alle lokationer'}`;
      }
      const finishBtn = $('finishSessionBtn');
      if(finishBtn) finishBtn.disabled = false;
    }
    
    const location = manualData.location || activeSession.scope || '';
    if(!activeSession.counts[location]) activeSession.counts[location] = {};
    
    let imported = 0;
    let notFound = 0;
    
    manualData.items.forEach(item => {
      const vare = masterVarelager.find(v => v.id === item.id);
      if(vare){
        const currentCount = Number(activeSession.counts[location][item.id]) || 0;
        activeSession.counts[location][item.id] = currentCount + (Number(item.quantity) || 0);
        imported++;
      } else {
        notFound++;
      }
    });
    
    if(imported > 0){
      renderLagerTable();
      updateLogPreview();
      saveAllData();
      
      // Clear imported data
      localStorage.removeItem('manuelOptaelData');
      
      alert(`‚úÖ Manuel opt√¶lling importeret!\n\nüìä Total varer: ${manualData.items.length}\n‚úÖ Importeret: ${imported}\n‚ö†Ô∏è Ikke fundet i varelager: ${notFound}\n\nLokation: ${location || 'Ikke angivet'}`);
    } else {
      alert(`Ingen varer kunne importeres.\n\nTotal varer: ${manualData.items.length}\nIkke fundet: ${notFound}\n\nTip: Tjek at varerne findes i varelager administration.`);
    }
    
  } catch(err){
    console.error('Fejl ved import af manuel opt√¶lling:', err);
    alert('Fejl ved import af manuel opt√¶lling: ' + err.message);
  }
}

/* Import scanner data from scanner app */
function importScannerData(){
  try{
    // First, try to import from file (exported reports)
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
      const file = e.target.files[0];
      if (!file) {
        // User cancelled - try localStorage method
        importScannerDataFromStorage();
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          // Check if this is a scanner reports export
          if (importedData.reports && Array.isArray(importedData.reports) && (importedData.source === 'stregkode-scanner' || importedData.reports.some(r => r.handling && r.handling.startsWith('OPTA-')))) {
            // Import reports directly
            const storageKey = 'k√∏kkenlager_data';
            let data = {};
            const existingData = localStorage.getItem(storageKey);
            if (existingData) {
              try {
                data = JSON.parse(existingData);
              } catch(err) {
                console.warn('Could not parse existing data:', err);
              }
            }
            
            if (!data.reports || !Array.isArray(data.reports)) {
              data.reports = [];
            }
            
            // Add imported reports (avoid duplicates by handling name and timestamp)
            let added = 0;
            let skipped = 0;
            importedData.reports.forEach(report => {
              // Check for duplicates by handling name (OPTA-000004) or timestamp
              const exists = data.reports.some(r => 
                (r.handling === report.handling) || 
                (Math.abs(r.ts - report.ts) < 1000 && r.handling && report.handling && r.handling.startsWith('OPTA-'))
              );
              
              if (!exists) {
                // Ensure report has all required fields
                if (!report.type) report.type = 'session';
                if (!report.details) report.details = [];
                if (!report.total) report.total = 0;
                
                data.reports.unshift(report);
                added++;
                console.log('‚úÖ Imported report:', report.handling, 'with', report.details ? report.details.length : 0, 'items');
              } else {
                skipped++;
                console.log('‚ö†Ô∏è Skipped duplicate report:', report.handling);
              }
            });
            
            // Update sessionCounter if needed (use highest value)
            if (importedData.sessionCounter) {
              const currentCounter = data.sessionCounter || sessionCounter || 0;
              if (importedData.sessionCounter > currentCounter) {
                data.sessionCounter = importedData.sessionCounter;
                sessionCounter = importedData.sessionCounter;
              }
            }
            
            // Store scanner installation ID for tracking
            if (importedData.installationId) {
              if (!data.scannerInstallationIds) data.scannerInstallationIds = [];
              if (!data.scannerInstallationIds.includes(importedData.installationId)) {
                data.scannerInstallationIds.push(importedData.installationId);
              }
            }
            
            // Save data
            localStorage.setItem(storageKey, JSON.stringify(data));
            
            // Reload reports
            reports = data.reports;
            if (data.sessionCounter) sessionCounter = data.sessionCounter;
            
            renderReports();
            updateLogPreview();
            saveAllData();
            
            let message = `‚úÖ ${added} rapport(er) importeret!`;
            if (skipped > 0) {
              message += `\n‚ö†Ô∏è ${skipped} rapport(er) sprunget over (findes allerede)`;
            }
            message += `\n\nRapporterne er nu tilg√¶ngelige under "Rapporter" fanen.`;
            if (importedData.installationId) {
              message += `\n\nüîó Installation ID: ${importedData.installationId.substring(0, 20)}...`;
            }
            
            alert(message);
            return;
          }
        } catch(err) {
          console.error('Error importing from file:', err);
          alert('‚ùå Fejl ved import: ' + err.message + '\n\nPr√∏ver localStorage metode...');
        }
        
        // If file import failed, try localStorage
        importScannerDataFromStorage();
      };
      reader.readAsText(file);
    };
    input.click();
    
  } catch(err){
    console.error('Fejl ved import af scanner data:', err);
    alert('Fejl ved import: ' + err.message);
  }
}

function importScannerDataFromStorage(){
  try{
    // Find alle localStorage keys der starter med 'lager_scans_'
    const scannerKeys = [];
    for(let i = 0; i < localStorage.length; i++){
      const key = localStorage.key(i);
      if(key && key.startsWith('lager_scans_')){
        scannerKeys.push(key);
      }
    }
    
    if(scannerKeys.length === 0){
      alert('Ingen scanner data fundet.\n\nBrug scanner app til at scanne stregkoder f√∏rst, eller eksporter rapporter fra scanner-appen.');
      return;
    }
    
    let totalScans = 0;
    let imported = 0;
    let notFound = 0;
    
    scannerKeys.forEach(key => {
      try{
        const dataStr = localStorage.getItem(key);
        if(!dataStr) return;
        
        const data = JSON.parse(dataStr);
        if(!data.scans || !Array.isArray(data.scans)) return;
        
        data.scans.forEach(scan => {
          totalScans++;
          const vare = masterVarelager.find(v => v.id === scan.code);
          
          if(vare){
            // Find eller opret aktiv session
            if(!activeSession){
              sessionCounter++;
              activeSession = {
                id: genId(),
                name: `Importeret scan ${new Date().toLocaleString()}`,
                scope: scan.location || '',
                tsStart: Date.now(),
                counts: {}
              };
              const info = $('sessionInfo');
              if(info){
                info.classList.remove('hidden');
                info.textContent = `${activeSession.name} ‚Äî ${activeSession.scope || 'Alle lokationer'}`;
              }
              const finishBtn = $('finishSessionBtn');
              if(finishBtn) finishBtn.disabled = false;
            }
            
            const loc = scan.location || vare.placering || '';
            if(!activeSession.counts[loc]) activeSession.counts[loc] = {};
            activeSession.counts[loc][vare.id] = (Number(activeSession.counts[loc][vare.id])||0) + 1;
            imported++;
          } else {
            notFound++;
          }
        });
        
        // Slet importeret data
        localStorage.removeItem(key);
      } catch(err){
        console.warn('Fejl ved import af scanner data:', key, err);
      }
    });
    
    if(imported > 0){
      renderLagerTable();
      updateLogPreview();
      saveAllData();
      alert(`‚úÖ Scanner data importeret!\n\nüìä Total scans: ${totalScans}\n‚úÖ Importeret: ${imported}\n‚ö†Ô∏è Ikke fundet i varelager: ${notFound}\n\nTip: Varer der ikke blev fundet skal f√∏rst tilf√∏jes til varelager administration.`);
    } else {
      alert(`Ingen varer kunne importeres.\n\nTotal scans: ${totalScans}\nIkke fundet: ${notFound}\n\nTip: Tjek at stregkoderne i scanner appen matcher vare IDs i varelager administration.`);
    }
    
  } catch(err){
    console.error('Fejl ved import af scanner data:', err);
    alert('Fejl ved import: ' + err.message);
  }
}

/* Refresh reports from localStorage manually */
function refreshReportsFromStorage(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const mainData = localStorage.getItem(storageKey);
    if(mainData) {
      const data = JSON.parse(mainData);
      if(data.reports && Array.isArray(data.reports)) {
        const oldCount = reports.length;
        reports = data.reports;
        
        // Update sessionCounter
        if(data.sessionCounter !== undefined) {
          sessionCounter = data.sessionCounter;
        }
        
        // Always refresh display
        renderReports();
        updateLogPreview();
        
        const newCount = reports.length;
        if(newCount > oldCount) {
          // Silent update - no alert needed
          console.log(`Rapporter opdateret: ${newCount - oldCount} ny(e) rapport(er) tilf√∏jet. Total: ${newCount}`);
        }
        console.log('Reports refreshed manually. Count:', reports.length);
        return;
      }
    }
    alert('Ingen rapporter fundet i localStorage.');
  } catch(e) {
    console.error('Error refreshing reports:', e);
    alert('Fejl ved opdatering: ' + e.message);
  }
}

/* Sync reports from scanner app - checks both localStorage and prompts for file import */
function syncReportsFromScanner(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const mainData = localStorage.getItem(storageKey);
    let foundNew = false;
    let newCount = 0;
    
    // First check localStorage (if same domain)
    if(mainData) {
      try {
        const data = JSON.parse(mainData);
        if(data.reports && Array.isArray(data.reports)) {
          const oldCount = reports.length;
          
          // Check for new reports - find both OPTA- format and old "Stregkode scanner" format
          data.reports.forEach(report => {
            const exists = reports.some(r => 
              r.handling === report.handling && 
              Math.abs(r.ts - report.ts) < 1000
            );
            
            // Check if this is a scanner report (OPTA- format or old format)
            const isScannerReport = report.handling && (
              report.handling.startsWith('OPTA-') || 
              report.handling.startsWith('Stregkode scanner') ||
              (report.source === 'stregkode-scanner') ||
              (report.installationId && report.installationId.startsWith('SCANNER-'))
            );
            
            if (!exists && isScannerReport) {
              reports.unshift(report);
              foundNew = true;
              newCount++;
              console.log('‚úÖ Found new scanner report:', report.handling);
            }
          });
          
          if(foundNew) {
            // Update sessionCounter
            if(data.sessionCounter !== undefined && data.sessionCounter > sessionCounter) {
              sessionCounter = data.sessionCounter;
            }
            
            // Save updated reports
            data.reports = reports;
            localStorage.setItem(storageKey, JSON.stringify(data));
            saveAllData();
            
            renderReports();
            updateLogPreview();
            
            alert(`‚úÖ ${newCount} ny(e) rapport(er) synkroniseret fra scanner-appen!\n\nRapporterne er nu tilg√¶ngelige under "Rapporter" fanen.`);
            return;
          }
        }
      } catch(e) {
        console.error('Error checking localStorage:', e);
      }
    }
    
    // If no new reports in localStorage, check if there are any scanner reports we haven't imported yet
    if(!foundNew) {
      // Check if there are any scanner reports in data that we might have missed
      if(mainData) {
        try {
          const data = JSON.parse(mainData);
          if(data.reports && Array.isArray(data.reports)) {
            // Find all scanner reports (OPTA- format)
            const allScannerReports = data.reports.filter(r => 
              r.handling && (
                r.handling.startsWith('OPTA-') || 
                r.handling.startsWith('Stregkode scanner') ||
                (r.source === 'stregkode-scanner') ||
                (r.installationId && r.installationId.startsWith('SCANNER-'))
              )
            );
            
            // Find which ones we already have
            const existingScannerReports = reports.filter(r => 
              r.handling && (
                r.handling.startsWith('OPTA-') || 
                r.handling.startsWith('Stregkode scanner') ||
                (r.source === 'stregkode-scanner') ||
                (r.installationId && r.installationId.startsWith('SCANNER-'))
              )
            );
            
            // Find missing reports
            const missingReports = allScannerReports.filter(scannerReport => 
              !existingScannerReports.some(existing => 
                existing.handling === scannerReport.handling && 
                Math.abs(existing.ts - scannerReport.ts) < 1000
              )
            );
            
            if(missingReports.length > 0) {
              // There are scanner reports we haven't imported yet
              if(confirm(`Fundet ${missingReports.length} scanner rapport(er) der ikke er importeret endnu.\n\nVil du importere dem nu?`)) {
                // Import all missing scanner reports
                missingReports.forEach(report => {
                  reports.unshift(report);
                  newCount++;
                  console.log('‚úÖ Importing missing scanner report:', report.handling);
                });
                
                if(newCount > 0) {
                  // Update sessionCounter
                  if(data.sessionCounter !== undefined && data.sessionCounter > sessionCounter) {
                    sessionCounter = data.sessionCounter;
                  }
                  
                  // Save updated reports
                  data.reports = reports;
                  localStorage.setItem(storageKey, JSON.stringify(data));
                  saveAllData();
                  
                  renderReports();
                  updateLogPreview();
                  
                  alert(`‚úÖ ${newCount} rapport(er) importeret!\n\nRapporterne er nu tilg√¶ngelige under "Rapporter" fanen.`);
                  return;
                }
              }
            }
          }
        } catch(e) {
          console.error('Error checking for missed reports:', e);
        }
      }
      
      // If still no new reports, offer to import from file
      if(!foundNew) {
        if(confirm('Ingen nye rapporter fundet i localStorage.\n\nHvis scanner-appen k√∏rer p√• en anden enhed/dom√¶ne, skal du:\n\n1. Eksportere rapporter fra scanner-appen (üì§ Eksport rapporter)\n2. Importere filen her\n\nVil du importere fra fil nu?')) {
          importScannerData();
        } else {
          alert('üí° Tip:\n\n‚Ä¢ Hvis scanner-appen k√∏rer p√• samme enhed: Rapporterne skulle synkroniseres automatisk\n‚Ä¢ Hvis scanner-appen k√∏rer p√• telefon: Brug "üì§ Eksport rapporter" i scanner-appen og "üì∑ Importer Scanner Data" her\n‚Ä¢ Tjek at begge programmer bruger samme installation ID');
        }
      }
    }
  } catch(e) {
    console.error('Error syncing reports:', e);
    alert('Fejl ved synkronisering: ' + e.message);
  }
}

/* Export login and license data for backup */
function exportLoginAndLicense(){
  try {
    const loginData = {
      passwordHash: localStorage.getItem(PASSWORD_KEY),
      recoveryEmail: localStorage.getItem(RECOVERY_EMAIL_KEY),
      recoveryEmailHash: localStorage.getItem(RECOVERY_EMAIL_HASH_KEY),
      userName: localStorage.getItem('user_name'),
      installationId: getInstallationId(),
      license: localStorage.getItem('app_license'),
      exportedAt: Date.now(),
      version: '1.0'
    };
    
    // Check if there's any data to export
    if (!loginData.passwordHash && !loginData.license) {
      alert('‚ö†Ô∏è Ingen login eller licens data at eksportere.\n\nOpret f√∏rst en konto og/eller aktiv√©r en licens.');
      return;
    }
    
    const dataStr = JSON.stringify(loginData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `k√∏kkenlager-login-licens-backup-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Login og licens data eksporteret!\n\n‚ö†Ô∏è VIGTIGT:\n‚Ä¢ Gem denne fil p√• et sikkert sted\n‚Ä¢ Uden denne fil kan du ikke logge ind igen hvis cache slettes\n‚Ä¢ Del IKKE denne fil med andre\n\nüí° Tip: Gem filen i en sikker mappe eller cloud storage.');
  } catch(err) {
    console.error('Error exporting login/license:', err);
    alert('‚ùå Fejl ved eksport: ' + err.message);
  }
}

/* Import login and license data from backup */
function importLoginAndLicense(){
  try {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          // Validate data structure
          if (!importedData.version) {
            alert('‚ö†Ô∏è Filen ser ikke ud til at v√¶re en gyldig backup fil.');
            return;
          }
          
          let restored = [];
          
          // Restore password data
          if (importedData.passwordHash) {
            localStorage.setItem(PASSWORD_KEY, importedData.passwordHash);
            restored.push('Password');
          }
          
          if (importedData.recoveryEmail) {
            localStorage.setItem(RECOVERY_EMAIL_KEY, importedData.recoveryEmail);
            restored.push('Recovery Email');
          }
          
          if (importedData.recoveryEmailHash) {
            localStorage.setItem(RECOVERY_EMAIL_HASH_KEY, importedData.recoveryEmailHash);
          }
          
          if (importedData.userName) {
            localStorage.setItem('user_name', importedData.userName);
            restored.push('Bruger Navn');
          }
          
          // Restore installation ID if it matches or is compatible
          if (importedData.installationId) {
            const currentId = getInstallationId();
            if (importedData.installationId !== currentId) {
              // Store the imported ID as backup, but keep current if different
              localStorage.setItem('backup_installation_id', importedData.installationId);
            }
          }
          
          // Restore license data
          if (importedData.license) {
            try {
              const license = JSON.parse(importedData.license);
              localStorage.setItem('app_license', importedData.license);
              restored.push('Licens');
            } catch(e) {
              console.warn('Could not parse license data:', e);
            }
          }
          
          if (restored.length === 0) {
            alert('‚ö†Ô∏è Ingen data at gendanne fra filen.');
            return;
          }
          
          alert(`‚úÖ Data gendannet!\n\nGendannet:\n${restored.map(r => '‚Ä¢ ' + r).join('\n')}\n\nüí° Tip: Genindl√¶s siden og log ind med dit password.`);
          
          // Reload page to apply changes
          if (confirm('Vil du genindl√¶se siden nu for at anvende √¶ndringerne?')) {
            location.reload();
          }
        } catch(err) {
          console.error('Error importing login/license:', err);
          alert('‚ùå Fejl ved import: ' + err.message + '\n\nTjek at filen er en gyldig backup fil.');
        }
      };
      reader.readAsText(file);
    };
    input.click();
  } catch(err) {
    console.error('Error setting up import:', err);
    alert('‚ùå Fejl: ' + err.message);
  }
}

/* Show and sync scanner installation ID */
function showScannerInstallationId(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const mainData = localStorage.getItem(storageKey);
    const mainInstallationId = getInstallationId();
    
    let info = 'üîë Installation ID Information:\n\n';
    info += 'üíª Hovedprogram (PC):\n' + mainInstallationId + '\n\n';
    
    if (mainData) {
      const data = JSON.parse(mainData);
      
      // Get scanner installation IDs from reports
      const scannerIds = new Set();
      if (data.reports && Array.isArray(data.reports)) {
        data.reports.forEach(r => {
          if (r.installationId && r.installationId.startsWith('SCANNER-')) {
            scannerIds.add(r.installationId);
          }
        });
      }
      
      // Get scanner ID from data if exists
      if (data.scannerInstallationIds && Array.isArray(data.scannerInstallationIds)) {
        data.scannerInstallationIds.forEach(id => scannerIds.add(id));
      }
      
      if (scannerIds.size > 0) {
        info += 'üì± Scanner Installation ID(er):\n';
        scannerIds.forEach(id => {
          info += id + '\n';
        });
        info += '\n';
        
        // Check if they match
        const scannerIdArray = Array.from(scannerIds);
        if (scannerIdArray.length === 1) {
          const scannerId = scannerIdArray[0];
          // Extract numeric part for comparison
          const mainIdNum = mainInstallationId.replace(/[^0-9]/g, '');
          const scannerIdNum = scannerId.replace(/[^0-9]/g, '');
          
          if (mainIdNum === scannerIdNum || scannerId.includes(mainIdNum)) {
            info += '‚úÖ ID\'erne matcher!\n\n';
          } else {
            info += '‚ö†Ô∏è ID\'erne matcher ikke.\n\n';
            info += 'üí° Tip: For at synkronisere:\n';
            info += '1. I scanner-appen: Klik "üîë Vis ID"\n';
            info += '2. Kopi√©r scanner ID\n';
            info += '3. Indtast det her nedenfor\n\n';
            
            if (confirm(info + 'Vil du indtaste scanner ID manuelt?')) {
              const manualId = prompt('Indtast scanner installation ID fra telefonen:', scannerId);
              if (manualId && manualId.trim()) {
                if (!data.scannerInstallationIds) data.scannerInstallationIds = [];
                if (!data.scannerInstallationIds.includes(manualId.trim())) {
                  data.scannerInstallationIds.push(manualId.trim());
                }
                data.scannerInstallationId = manualId.trim();
                localStorage.setItem(storageKey, JSON.stringify(data));
                alert('‚úÖ Scanner ID gemt: ' + manualId.trim() + '\n\nID\'erne er nu synkroniseret!');
                return;
              }
            }
            return;
          }
        } else {
          info += '‚ö†Ô∏è Flere scanner ID\'er fundet.\n\n';
        }
      } else {
        info += 'üì± Ingen scanner ID fundet endnu.\n\n';
        info += 'üí° Tip: Eksporter en rapport fra scanner-appen for at se ID.\n\n';
        
        if (confirm(info + 'Vil du indtaste scanner ID manuelt?')) {
          const manualId = prompt('Indtast scanner installation ID fra telefonen:', '');
          if (manualId && manualId.trim()) {
            if (!data.scannerInstallationIds) data.scannerInstallationIds = [];
            if (!data.scannerInstallationIds.includes(manualId.trim())) {
              data.scannerInstallationIds.push(manualId.trim());
            }
            data.scannerInstallationId = manualId.trim();
            localStorage.setItem(storageKey, JSON.stringify(data));
            alert('‚úÖ Scanner ID gemt: ' + manualId.trim());
          }
          return;
        }
      }
    } else {
      info += 'üì± Ingen data fundet.\n\n';
    }
    
    info += 'üí° Tip: Brug samme installation ID p√• begge enheder for bedre synkronisering.';
    alert(info);
    
  } catch(err) {
    console.error('Error showing scanner installation ID:', err);
    alert('‚ùå Fejl: ' + err.message);
  }
}

/* ================================
   [JS 10] UTIL & UI helpers
   ================================ */
function navClick(e){ document.querySelectorAll('nav .menu-item').forEach(it=>it.classList.remove('active')); e.target.classList.add('active'); showPage(e.target.dataset.target); }
function showPage(id){ 
  document.querySelectorAll('#content section').forEach(s=>s.classList.add('hidden')); 
  const el = $(id); 
  if(el) el.classList.remove('hidden'); 
  
  // Reset manual sections when leaving systemOpsaetning page
  if (id !== 'systemOpsaetning') {
    const allContents = document.querySelectorAll('[id^="manualContent"]');
    const allArrows = document.querySelectorAll('[id^="manualArrow"]');
    allContents.forEach(content => {
      if (content) content.style.display = 'none';
    });
    allArrows.forEach(arrow => {
      if (arrow) arrow.style.transform = 'rotate(0deg)';
    });
  }
  
  // Skjul eller vis menubaren baseret p√• hvilken side vi er p√•
  const nav = document.querySelector('nav#topnav');
  if(nav) {
    if(id === 'vinlager') {
      nav.style.display = 'none'; // Skjul menubaren i vinlager
    } else {
      nav.style.display = 'flex'; // Vis menubaren i k√∏kken
    }
  }
  
  if(id==='lageropt') renderLagerTable(); 
  if(id==='opsaetning') { 
    // Fjern Vinlager fra lagerLokationer hvis det findes (kun for ops√¶tning lager)
    if(lagerLokationer.includes('Vinlager')){
      lagerLokationer = lagerLokationer.filter(loc => loc !== 'Vinlager');
      saveAllData();
    }
    renderLagerOpsaetning(); 
    updateAllSelects(); 
  } 
  if(id==='rapporter') { refreshReportsFromStorage(); renderReports(); renderArchivedReports(); showReportsSection('active'); } 
  if(id==='vinlager') { 
    // Vinlager sektion - klar til at tilf√∏je funktioner senere
  } 
  if(id==='labels') { updateAllSelects(); renderMasterTable(); updateLabelReolSelect(); } 
  if(id==='leverandor') renderLeverandorTable(); 
  if(id==='master') { showMasterSection('add'); updateAllSelects(); } 
  if(id==='scanner') { loadScannerIntoPage(); }
  if(id==='systemOpsaetning') { showSettingsSection('password'); } 
  if(id==='licens') { updateLicenseStatusDisplay(); } 
}
function toggleSidebar(sidebarId){
  try {
    const sidebar = document.getElementById(sidebarId);
    if(!sidebar) {
      console.error('Sidebar ikke fundet:', sidebarId);
      return;
    }
    
    const isCollapsed = sidebar.classList.contains('collapsed');
    
    // Find toggle-knappen baseret p√• sidebar ID
    let toggleBtn = null;
    if(sidebarId === 'reportsSidebar') {
      toggleBtn = document.getElementById('reportsToggleBtn');
    } else if(sidebarId === 'masterSidebar') {
      toggleBtn = document.getElementById('masterToggleBtn');
    } else if(sidebarId === 'settingsSidebar') {
      toggleBtn = document.getElementById('settingsToggleBtn');
    }
    
    if(isCollapsed){
      // √Öbn sidebar
      sidebar.classList.remove('collapsed');
      if(toggleBtn) toggleBtn.setAttribute('data-state', 'open');
    } else {
      // Luk sidebar
      sidebar.classList.add('collapsed');
      if(toggleBtn) toggleBtn.setAttribute('data-state', 'closed');
    }
  } catch(error) {
    console.error('Fejl ved toggle sidebar:', error);
  }
}

function showMasterSection(sectionId){
  // Skjul alle master sektioner
  document.querySelectorAll('#master .settings-section').forEach(s => {
    s.classList.remove('active');
    s.style.display = 'none';
  });
  
  // Skjul alle sidebar items i master
  document.querySelectorAll('#master .settings-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Vis valgt sektion
  const section = $(`master-section-${sectionId}`);
  if(section){
    section.classList.add('active');
    section.style.display = 'block';
  }
  
  // Marker sidebar item som aktiv
  const sidebarItems = document.querySelectorAll('#master .settings-item');
  if(sectionId === 'add' && sidebarItems[0]){
    sidebarItems[0].classList.add('active');
  } else if(sectionId === 'shelf' && sidebarItems[1]){
    sidebarItems[1].classList.add('active');
  } else if(sectionId === 'view' && sidebarItems[2]){
    sidebarItems[2].classList.add('active');
    renderMasterTable(); // Opdater tabel n√•r sektionen vises
  }
  
  // Auto-collapse sidebar efter valg
  const sidebar = $('masterSidebar');
  if(sidebar && !sidebar.classList.contains('collapsed')){
    setTimeout(() => toggleSidebar('masterSidebar'), 300);
  }
}

function showReportsSection(sectionId){
  // Skjul alle rapporter sektioner
  document.querySelectorAll('#rapporter .settings-section').forEach(s => {
    s.classList.remove('active');
    s.style.display = 'none';
  });
  
  // Skjul alle sidebar items i rapporter
  document.querySelectorAll('#rapporter .settings-item').forEach(item => {
    item.classList.remove('active');
  });
  
  // Vis valgt sektion
  const section = $(`reports-section-${sectionId}`);
  if(section){
    section.classList.add('active');
    section.style.display = 'block';
  }
  
  // Marker sidebar item som aktiv
  const sidebarItems = document.querySelectorAll('#rapporter .settings-item');
  if(sectionId === 'active' && sidebarItems[0]){
    sidebarItems[0].classList.add('active');
  } else if(sectionId === 'archived' && sidebarItems[1]){
    sidebarItems[1].classList.add('active');
  }
  
  // Opdater arkiverede rapporter hvis den sektion vises
  if(sectionId === 'archived'){
    renderArchivedReports();
  }
  
  // Auto-collapse sidebar efter valg
  const sidebar = document.getElementById('reportsSidebar');
  if(sidebar && !sidebar.classList.contains('collapsed')){
    setTimeout(() => toggleSidebar('reportsSidebar'), 300);
  }
}

function showSettingsSection(sectionId){
  // Hide all sections (kun i systemOpsaetning)
  document.querySelectorAll('#systemOpsaetning .settings-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('#systemOpsaetning .settings-item').forEach(i=>i.classList.remove('active'));
  
  // Reset manual sections when leaving manual page
  if (sectionId !== 'manual') {
    const allContents = document.querySelectorAll('[id^="manualContent"]');
    const allArrows = document.querySelectorAll('[id^="manualArrow"]');
    allContents.forEach(content => {
      if (content) content.style.display = 'none';
    });
    allArrows.forEach(arrow => {
      if (arrow) arrow.style.transform = 'rotate(0deg)';
    });
  }
  
  // Show selected section (kun i systemOpsaetning)
  const section = document.getElementById('settings-' + sectionId);
  if(section) section.classList.add('active');
  
  // Highlight menu item - find by section mapping (kun i systemOpsaetning)
  const sectionMap = {
    'manual': 'Manual',
    'password': 'Skift password',
    'backup': 'Backup',
    'import': 'Import',
    'mobile': 'Mobil',
    'branding': 'Logo'
  };
  const searchText = sectionMap[sectionId] || sectionId;
  const menuItems = Array.from(document.querySelectorAll('#systemOpsaetning .settings-item'));
  const menuItem = menuItems.find(item => {
    const text = item.textContent.toLowerCase();
    return text.includes(searchText.toLowerCase());
  });
  if(menuItem) menuItem.classList.add('active');
  
  // Auto-collapse sidebar efter valg
  const sidebar = $('settingsSidebar');
  if(sidebar && !sidebar.classList.contains('collapsed')){
    setTimeout(() => toggleSidebar('settingsSidebar'), 300);
  }
}

/* ================================
   [JS 13] MANUAL & VEJLEDNING
   ================================ */
// Initialize manual content on page load
function initializeManual() {
  const manualContent = document.getElementById('manualContent');
  if (!manualContent) return;
  
  const manualSections = [
    {
      title: 'üì¶ Lager Opt√¶lling',
      content: `
        <h4>Hvad er Lager Opt√¶lling?</h4>
        <p>Lager Opt√¶lling er hovedfunktionen i programmet. Her kan du opt√¶lle varer i dit lager ved at indtaste antal manuelt.</p>
        <h4>S√•dan bruger du det:</h4>
        <ol>
          <li>Klik p√• "Lager opt√¶lling" i menuen</li>
          <li>V√¶lg en lokation (K√∏l, Frost, T√∏revare, Gr√∏nt) eller v√¶lg "Alle lokationer"</li>
          <li>Indtast antal for hver vare ved at klikke p√• antallet i tabellen</li>
          <li>N√•r du er f√¶rdig, klik p√• "Afslut opt√¶lling"</li>
          <li>En rapport genereres automatisk med alle optalte varer</li>
        </ol>
        <h4>Tips:</h4>
        <ul>
          <li>Du kan se total v√¶rdi af optalte varer i bunden af siden</li>
          <li>Rapporter gemmes automatisk og kan ses under "Rapporter"</li>
          <li>Du kan eksportere rapporter som PDF</li>
        </ul>
      `
    },
    {
      title: '‚öôÔ∏è Ops√¶tning Lager',
      content: `
        <h4>Hvad er Ops√¶tning Lager?</h4>
        <p>Her kan du administrere lagerlokationer, reoler og hylder. Du kan ogs√• arrangere varer ved hj√¶lp af drag & drop.</p>
        <h4>S√•dan bruger du det:</h4>
        <ol>
          <li>Tilf√∏j eller fjern lagerlokationer (K√∏l, Frost, T√∏revare, Gr√∏nt)</li>
          <li>Tilf√∏j reoler og hylder til hver lokation</li>
          <li>Tr√¶k og slip varer for at arrangere dem i den √∏nskede r√¶kkef√∏lge</li>
          <li>R√¶kkef√∏lgen bruges n√•r du genererer labels og rapporter</li>
        </ol>
        <h4>Tips:</h4>
        <ul>
          <li>Du kan ikke fjerne en lokation hvis der er varer i den</li>
          <li>R√¶kkef√∏lgen p√•virker hvordan varer vises i rapporter</li>
        </ul>
      `
    },
    {
      title: 'üìã Varelager Administration',
      content: `
        <h4>Hvad er Varelager Administration?</h4>
        <p>Her administrerer du alle varer i dit lager. Du kan tilf√∏je nye varer, redigere eksisterende, og s√∏ge efter varer.</p>
        <h4>S√•dan bruger du det:</h4>
        <ol>
          <li><strong>Tilf√∏j ny vare:</strong> Udfyld formularen med varenavn, m√•leenhed, pris, placering, reol og hylle</li>
          <li><strong>S√∏g og se varelager:</strong> Brug s√∏gefeltet til at finde specifikke varer</li>
          <li><strong>Rediger vare:</strong> Klik p√• en vare i tabellen for at redigere den</li>
          <li><strong>Upload billede:</strong> Klik p√• billede-pladsholderen for at uploade et billede</li>
          <li><strong>Import/Export Excel:</strong> Download skabelon, udfyld den, og import√©r den igen</li>
        </ol>
        <h4>Tips:</h4>
        <ul>
          <li>Varenummer genereres automatisk ved import, men kan redigeres manuelt</li>
          <li>Du kan uploade varelager til serveren s√• scanner-appen kan hente det</li>
          <li>Excel-skabelonen indeholder alle n√∏dvendige kolonner</li>
        </ul>
      `
    },
    {
      title: 'üìä Rapporter',
      content: `
        <h4>Hvad er Rapporter?</h4>
        <p>Rapporter viser alle dine opt√¶llinger. Du kan se detaljer, eksportere som PDF, og hente rapporter fra scanner-appen.</p>
        <h4>S√•dan bruger du det:</h4>
        <ol>
          <li>Se alle rapporter i listen</li>
          <li>Klik p√• en rapport for at se detaljer</li>
          <li>Eksporter som PDF ved at klikke p√• "Eksporter PDF"</li>
          <li>Hent rapporter fra serveren ved at klikke p√• "‚òÅÔ∏è Hent fra Server"</li>
          <li>Arkiver gamle rapporter for at holde listen ren</li>
        </ol>
        <h4>Rapport typer:</h4>
        <ul>
          <li><strong>OPTA-XXXXXX:</strong> Rapporter fra hovedprogrammet</li>
          <li><strong>SPTA-XXXXXX:</strong> Rapporter fra scanner-appen</li>
        </ul>
      `
    },
    {
      title: 'üè∑Ô∏è Labels',
      content: `
        <h4>Hvad er Labels?</h4>
        <p>Her kan du generere og printe labels og QR-koder til dine varer. Labels indeholder varenavn, m√•leenhed, placering, reol og hylle.</p>
        <h4>S√•dan bruger du det:</h4>
        <ol>
          <li>V√¶lg en lokation eller en specifik vare</li>
          <li>V√¶lg antal labels per vare</li>
          <li>Klik p√• "Generer labels" eller "Generer QR-koder"</li>
          <li>Print labels ved at klikke p√• "Print labels"</li>
        </ol>
        <h4>Tips:</h4>
        <ul>
          <li>Labels er optimeret til A4 papir</li>
          <li>QR-koder kan scannes med scanner-appen</li>
          <li>Du kan generere labels for alle varer i en lokation p√• √©n gang</li>
        </ul>
      `
    },
    {
      title: 'üöö Leverand√∏rer',
      content: `
        <h4>Hvad er Leverand√∏rer?</h4>
        <p>Her kan du administrere leverand√∏rer og deres kontaktinformation.</p>
        <h4>S√•dan bruger du det:</h4>
        <ol>
          <li>Tilf√∏j nye leverand√∏rer med navn, telefon, email og adresse</li>
          <li>Rediger eksisterende leverand√∏rer</li>
          <li>Slet leverand√∏rer der ikke l√¶ngere bruges</li>
        </ol>
      `
    },
    {
      title: 'üì± Scanner App',
      content: `
        <h4>Hvad er Scanner App?</h4>
        <p>Scanner-appen er en mobil app til at scanne stregkoder og opt√¶lle varer. Den synkroniseres med hovedprogrammet.</p>
        <h4>S√•dan s√¶tter du det op:</h4>
        <ol>
          <li>G√• til "Ops√¶tning" ‚Üí "Mobil tilgang"</li>
          <li>Klik p√• "üì± Vis Scanner Link" for at f√• linket til scanner-appen</li>
          <li>Scan QR-koden med din telefon eller √•bn linket</li>
          <li>Tilf√∏j scanner-appen til din telefons hjemmesk√¶rm</li>
          <li>Upload varelager til serveren s√• scanner-appen kan hente det</li>
          <li>Synkroniser Installation ID mellem hovedprogram og scanner</li>
        </ol>
        <h4>Tips:</h4>
        <ul>
          <li>Scanner-appen bruger samme data som hovedprogrammet</li>
          <li>Rapporter fra scanner-appen vises i hovedprogrammet</li>
          <li>Du kan uploade rapporter fra scanner-appen til serveren</li>
        </ul>
      `
    },
    {
      title: 'üíæ Backup & Sikkerhed',
      content: `
        <h4>Hvad er Backup?</h4>
        <p>Backup sikrer at du ikke mister data hvis browser cache slettes eller computeren g√•r i stykker.</p>
        <h4>S√•dan bruger du det:</h4>
        <ol>
          <li><strong>Backup til Server:</strong> Upload en komplet backup til serveren. Alle backups gemmes i en dedikeret mappe.</li>
          <li><strong>Hent Backup fra Server:</strong> Hent en tidligere backup fra serveren og gendan data.</li>
          <li><strong>Download Backup (Lokal):</strong> Download en JSON fil med al data til lokal gemning.</li>
          <li><strong>Backup Login & Licens:</strong> Download login og licens data. VIGTIGT: Gem denne fil sikkert!</li>
          <li><strong>Gendan Login & Licens:</strong> Gendan login og licens fra en backup fil.</li>
        </ol>
        <h4>Tips:</h4>
        <ul>
          <li>Lav regelm√¶ssige backups til serveren</li>
          <li>Gem login/licens backup p√• et sikkert sted</li>
          <li>Hvis du sletter browser cache, kan du gendanne fra backup</li>
        </ul>
      `
    },
    {
      title: 'üîë Login & Password',
      content: `
        <h4>Hvad er Login Systemet?</h4>
        <p>Programmet bruger et login system med brugernavn og password for at beskytte dine data.</p>
        <h4>S√•dan bruger du det:</h4>
        <ol>
          <li><strong>F√∏rste gang:</strong> Opret et password n√•r du √•bner programmet f√∏rste gang</li>
          <li><strong>Skift password:</strong> G√• til "Ops√¶tning" ‚Üí "Skift password"</li>
          <li><strong>Glemt password:</strong> Brug "Gendan Login & Licens" hvis du har en backup</li>
        </ol>
        <h4>Tips:</h4>
        <ul>
          <li>Brug et st√¶rkt password</li>
          <li>Lav backup af login data regelm√¶ssigt</li>
          <li>Uden login backup kan du ikke logge ind hvis cache slettes</li>
        </ul>
      `
    }
  ];
  
  let html = '';
  manualSections.forEach((section, index) => {
    html += `
      <div class="manual-item" style="margin-bottom:20px; border:1px solid #e6e6e6; border-radius:8px; overflow:hidden;">
        <div class="manual-header" onclick="toggleManualSection(${index})" style="padding:16px 20px; background:#f5f5f5; cursor:pointer; display:flex; align-items:center; justify-content:space-between; font-weight:700; font-size:18px; border-bottom:1px solid #e6e6e6;">
          <span>${section.title}</span>
          <span class="manual-arrow" id="manualArrow${index}" style="font-size:20px; transition:transform 0.3s;">‚ñº</span>
        </div>
        <div class="manual-content" id="manualContent${index}" style="display:none; padding:20px; background:white; line-height:1.8;">
          ${section.content}
        </div>
      </div>
    `;
  });
  
  manualContent.innerHTML = html;
  
  // Ensure all sections are closed when page is shown
  const allContents = document.querySelectorAll('[id^="manualContent"]');
  const allArrows = document.querySelectorAll('[id^="manualArrow"]');
  allContents.forEach(content => {
    if (content) content.style.display = 'none';
  });
  allArrows.forEach(arrow => {
    if (arrow) arrow.style.transform = 'rotate(0deg)';
  });
}

function toggleManualSection(index) {
  // Close all other sections first
  const allContents = document.querySelectorAll('[id^="manualContent"]');
  const allArrows = document.querySelectorAll('[id^="manualArrow"]');
  
  allContents.forEach((content, idx) => {
    if (idx !== index) {
      content.style.display = 'none';
    }
  });
  
  allArrows.forEach((arrow, idx) => {
    if (idx !== index) {
      arrow.style.transform = 'rotate(0deg)';
    }
  });
  
  // Toggle the clicked section
  const content = document.getElementById(`manualContent${index}`);
  const arrow = document.getElementById(`manualArrow${index}`);
  
  if (content && arrow) {
    if (content.style.display === 'none' || !content.style.display) {
      content.style.display = 'block';
      arrow.style.transform = 'rotate(180deg)';
    } else {
      content.style.display = 'none';
      arrow.style.transform = 'rotate(0deg)';
    }
  }
}

// Download manual as PDF
function downloadManualPDF() {
  try {
    // Check if jsPDF is loaded
    if (typeof jsPDF === 'undefined') {
      alert('‚ö†Ô∏è PDF bibliotek ikke indl√¶st. Genindl√¶s siden og pr√∏v igen.');
      return;
    }
    
    const doc = new jsPDF();
    let y = 20;
    
    // Title
    doc.setFontSize(20);
    doc.setFont(undefined, 'bold');
    doc.text('K√∏kkenlager Program - Komplet Manual', 14, y);
    y += 15;
    
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(`Version: ${APP_VERSION} | Dato: ${BUILD_DATE} ${BUILD_TIME}`, 14, y);
    y += 20;
    
    // Manual sections
    const manualSections = [
      {
        title: 'üì¶ Lager Opt√¶lling',
        content: `Hvad er Lager Opt√¶lling?
Lager Opt√¶lling er hovedfunktionen i programmet. Her kan du opt√¶lle varer i dit lager ved at indtaste antal manuelt.

S√•dan bruger du det:
1. Klik p√• "Lager opt√¶lling" i menuen
2. V√¶lg en lokation (K√∏l, Frost, T√∏revare, Gr√∏nt) eller v√¶lg "Alle lokationer"
3. Indtast antal for hver vare ved at klikke p√• antallet i tabellen
4. N√•r du er f√¶rdig, klik p√• "Afslut opt√¶lling"
5. En rapport genereres automatisk med alle optalte varer

Tips:
‚Ä¢ Du kan se total v√¶rdi af optalte varer i bunden af siden
‚Ä¢ Rapporter gemmes automatisk og kan ses under "Rapporter"
‚Ä¢ Du kan eksportere rapporter som PDF`
      },
      {
        title: '‚öôÔ∏è Ops√¶tning Lager',
        content: `Hvad er Ops√¶tning Lager?
Her kan du administrere lagerlokationer, reoler og hylder. Du kan ogs√• arrangere varer ved hj√¶lp af drag & drop.

S√•dan bruger du det:
1. Tilf√∏j eller fjern lagerlokationer (K√∏l, Frost, T√∏revare, Gr√∏nt)
2. Tilf√∏j reoler og hylder til hver lokation
3. Tr√¶k og slip varer for at arrangere dem i den √∏nskede r√¶kkef√∏lge
4. R√¶kkef√∏lgen bruges n√•r du genererer labels og rapporter

Tips:
‚Ä¢ Du kan ikke fjerne en lokation hvis der er varer i den
‚Ä¢ R√¶kkef√∏lgen p√•virker hvordan varer vises i rapporter`
      },
      {
        title: 'üìã Varelager Administration',
        content: `Hvad er Varelager Administration?
Her administrerer du alle varer i dit lager. Du kan tilf√∏je nye varer, redigere eksisterende, og s√∏ge efter varer.

S√•dan bruger du det:
1. Tilf√∏j ny vare: Udfyld formularen med varenavn, m√•leenhed, pris, placering, reol og hylle
2. S√∏g og se varelager: Brug s√∏gefeltet til at finde specifikke varer
3. Rediger vare: Klik p√• en vare i tabellen for at redigere den
4. Upload billede: Klik p√• billede-pladsholderen for at uploade et billede
5. Import/Export Excel: Download skabelon, udfyld den, og import√©r den igen

Tips:
‚Ä¢ Varenummer genereres automatisk ved import, men kan redigeres manuelt
‚Ä¢ Du kan uploade varelager til serveren s√• scanner-appen kan hente det
‚Ä¢ Excel-skabelonen indeholder alle n√∏dvendige kolonner`
      },
      {
        title: 'üìä Rapporter',
        content: `Hvad er Rapporter?
Rapporter viser alle dine opt√¶llinger. Du kan se detaljer, eksportere som PDF, og hente rapporter fra scanner-appen.

S√•dan bruger du det:
1. Se alle rapporter i listen
2. Klik p√• en rapport for at se detaljer
3. Eksporter som PDF ved at klikke p√• "Eksporter PDF"
4. Hent rapporter fra serveren ved at klikke p√• "‚òÅÔ∏è Hent fra Server"
5. Arkiver gamle rapporter for at holde listen ren

Rapport typer:
‚Ä¢ OPTA-XXXXXX: Rapporter fra hovedprogrammet
‚Ä¢ SPTA-XXXXXX: Rapporter fra scanner-appen`
      },
      {
        title: 'üè∑Ô∏è Labels',
        content: `Hvad er Labels?
Her kan du generere og printe labels og QR-koder til dine varer. Labels indeholder varenavn, m√•leenhed, placering, reol og hylle.

S√•dan bruger du det:
1. V√¶lg en lokation eller en specifik vare
2. V√¶lg antal labels per vare
3. Klik p√• "Generer labels" eller "Generer QR-koder"
4. Print labels ved at klikke p√• "Print labels"

Tips:
‚Ä¢ Labels er optimeret til A4 papir
‚Ä¢ QR-koder kan scannes med scanner-appen
‚Ä¢ Du kan generere labels for alle varer i en lokation p√• √©n gang`
      },
      {
        title: 'üì± Scanner App',
        content: `Hvad er Scanner App?
Scanner-appen er en mobil app til at scanne stregkoder og opt√¶lle varer. Den synkroniseres med hovedprogrammet.

S√•dan s√¶tter du det op:
1. G√• til "Ops√¶tning" ‚Üí "Mobil tilgang"
2. Klik p√• "üì± Vis Scanner Link" for at f√• linket til scanner-appen
3. Scan QR-koden med din telefon eller √•bn linket
4. Tilf√∏j scanner-appen til din telefons hjemmesk√¶rm
5. Upload varelager til serveren s√• scanner-appen kan hente det
6. Synkroniser Installation ID mellem hovedprogram og scanner

Tips:
‚Ä¢ Scanner-appen bruger samme data som hovedprogrammet
‚Ä¢ Rapporter fra scanner-appen vises i hovedprogrammet
‚Ä¢ Du kan uploade rapporter fra scanner-appen til serveren`
      },
      {
        title: 'üíæ Backup & Sikkerhed',
        content: `Hvad er Backup?
Backup sikrer at du ikke mister data hvis browser cache slettes eller computeren g√•r i stykker.

S√•dan bruger du det:
1. Backup til Server: Upload en komplet backup til serveren. Alle backups gemmes i en dedikeret mappe.
2. Hent Backup fra Server: Hent en tidligere backup fra serveren og gendan data.
3. Download Backup (Lokal): Download en JSON fil med al data til lokal gemning.
4. Backup Login & Licens: Download login og licens data. VIGTIGT: Gem denne fil sikkert!
5. Gendan Login & Licens: Gendan login og licens fra en backup fil.

Tips:
‚Ä¢ Lav regelm√¶ssige backups til serveren
‚Ä¢ Gem login/licens backup p√• et sikkert sted
‚Ä¢ Hvis du sletter browser cache, kan du gendanne fra backup`
      },
      {
        title: 'üîë Login & Password',
        content: `Hvad er Login Systemet?
Programmet bruger et login system med brugernavn og password for at beskytte dine data.

S√•dan bruger du det:
1. F√∏rste gang: Opret et password n√•r du √•bner programmet f√∏rste gang
2. Skift password: G√• til "Ops√¶tning" ‚Üí "Skift password"
3. Glemt password: Brug "Gendan Login & Licens" hvis du har en backup

Tips:
‚Ä¢ Brug et st√¶rkt password
‚Ä¢ Lav backup af login data regelm√¶ssigt
‚Ä¢ Uden login backup kan du ikke logge ind hvis cache slettes`
      }
    ];
    
    manualSections.forEach((section, index) => {
      // Check if we need a new page
      if (y > 250) {
        doc.addPage();
        y = 20;
      }
      
      // Section title
      doc.setFontSize(16);
      doc.setFont(undefined, 'bold');
      doc.text(section.title, 14, y);
      y += 10;
      
      // Section content
      doc.setFontSize(11);
      doc.setFont(undefined, 'normal');
      const lines = doc.splitTextToSize(section.content, 180);
      lines.forEach(line => {
        if (y > 270) {
          doc.addPage();
          y = 20;
        }
        doc.text(line, 14, y);
        y += 7;
      });
      
      y += 10; // Space between sections
    });
    
    // Save PDF
    const filename = `K√∏kkenlager_Manual_v${APP_VERSION}_${BUILD_DATE.replace(/-/g, '')}.pdf`;
    doc.save(filename);
    
    alert(`‚úÖ Manual downloadet som PDF!\n\nüìÑ Filnavn: ${filename}`);
    
  } catch(err) {
    console.error('Fejl ved PDF generering:', err);
    alert('‚ùå Fejl ved generering af PDF: ' + err.message);
  }
}

/* ================================
   [JS 14] BACKUP TIL SERVER
   ================================ */
// Upload backup to server
async function uploadBackupToServer() {
  try {
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    
    if (!dataStr) {
      alert('‚ö†Ô∏è Ingen data fundet at uploade.');
      return;
    }
    
    const data = JSON.parse(dataStr);
    
    // Get GitHub token
    let githubToken = localStorage.getItem('github_gist_token');
    if (!githubToken) {
      const token = prompt('üîë Indtast GitHub Personal Access Token:\n\n' +
        '1. G√• til: https://github.com/settings/tokens\n' +
        '2. Klik "Generate new token (classic)"\n' +
        '3. V√¶lg "gist" scope\n' +
        '4. Kopi√©r token og indtast her\n\n' +
        'üí° Token gemmes lokalt og bruges til fremtidige uploads.');
      if (!token || !token.trim()) {
        alert('‚ùå Ingen token indtastet. Upload annulleret.');
        return;
      }
      githubToken = token.trim();
      localStorage.setItem('github_gist_token', githubToken);
    }
    
    // Create backup data
    const backupData = {
      ...data,
      backupType: 'full',
      backupVersion: APP_VERSION,
      backupDate: new Date().toISOString(),
      backupDescription: `Komplet backup - ${new Date().toLocaleString('da-DK')}`
    };
    
    // Check for existing backup gist
    let existingGistId = null;
    try {
      const gistsResponse = await fetch('https://api.github.com/gists', {
        headers: { 'Authorization': `Bearer ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (gistsResponse.ok) {
        const allGists = await gistsResponse.json();
        const backupGists = allGists.filter(gist => 
          gist.description && gist.description.includes('K√∏kkenlager Backup')
        );
        if (backupGists.length > 0) {
          // Find the most recent backup gist
          backupGists.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          existingGistId = backupGists[0].id;
        }
      }
    } catch (err) {
      console.warn('Could not check for existing backup gists, will create new one:', err);
    }
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `k√∏kkenlager_backup_${timestamp}.json`;
    
    const gistData = {
      description: `K√∏kkenlager Backup - ${new Date().toLocaleString('da-DK')} - v${APP_VERSION}`,
      public: false,
      files: {
        [filename]: {
          content: JSON.stringify(backupData, null, 2)
        }
      }
    };
    
    // If existing gist, add to it instead of replacing
    if (existingGistId) {
      try {
        const existingGistResponse = await fetch(`https://api.github.com/gists/${existingGistId}`, {
          headers: { 'Authorization': `Bearer ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (existingGistResponse.ok) {
          const existingGist = await existingGistResponse.json();
          // Add new file to existing gist
          Object.keys(existingGist.files).forEach(key => {
            if (!gistData.files[key]) {
              gistData.files[key] = existingGist.files[key];
            }
          });
        }
      } catch (err) {
        console.warn('Could not fetch existing gist, will create new one:', err);
        existingGistId = null;
      }
    }
    
    const url = existingGistId ? `https://api.github.com/gists/${existingGistId}` : 'https://api.github.com/gists';
    const method = existingGistId ? 'PATCH' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify(gistData)
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      let errorData;
      try { errorData = JSON.parse(errorText); } catch { errorData = { message: errorText || `HTTP ${response.status}: ${response.statusText}` }; }
      if (response.status === 401) {
        localStorage.removeItem('github_gist_token');
        throw new Error('Ugyldig GitHub token. Token er blevet slettet. Pr√∏v igen og indtast en ny token.');
      }
      throw new Error(errorData.message || errorData.error || `HTTP ${response.status}: ${response.statusText}`);
    }
    
    const gist = await response.json();
    const gistUrl = gist.html_url;
    const updateText = existingGistId ? 'opdateret' : 'uploadet';
    
    alert(`‚úÖ Backup ${updateText} til serveren!\n\nüîó Gist URL: ${gistUrl}\n\nüí° Du kan nu hente denne backup igen via "Hent Backup fra Server".`);
    
  } catch(err) {
    console.error('Fejl ved upload af backup:', err);
    alert('‚ùå Fejl ved upload af backup: ' + err.message);
  }
}

// Fetch backups from server
async function fetchBackupsFromServer() {
  try {
    let githubToken = localStorage.getItem('github_gist_token');
    if (!githubToken) {
      const token = prompt('üîë Indtast GitHub Personal Access Token:\n\n' +
        '1. G√• til: https://github.com/settings/tokens\n' +
        '2. Klik "Generate new token (classic)"\n' +
        '3. V√¶lg "gist" scope\n' +
        '4. Kopi√©r token og indtast her');
      if (!token || !token.trim()) {
        alert('‚ùå Ingen token indtastet. Hentning annulleret.');
        return;
      }
      githubToken = token.trim();
      localStorage.setItem('github_gist_token', githubToken);
    }
    
    const response = await fetch('https://api.github.com/gists', {
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        localStorage.removeItem('github_gist_token');
        throw new Error('Ugyldig GitHub token. Token er blevet slettet. Pr√∏v igen og indtast en ny token.');
      }
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const allGists = await response.json();
    const backupGists = allGists.filter(gist => 
      gist.description && gist.description.includes('K√∏kkenlager Backup')
    );
    
    if (backupGists.length === 0) {
      alert('‚ö†Ô∏è Ingen backups fundet p√• serveren.\n\nUpload en backup f√∏rst via "Backup til Server".');
      return;
    }
    
    // Sort by date (newest first)
    backupGists.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    // Show modal with backup list
    showBackupSelectionModal(backupGists, githubToken);
    
  } catch(err) {
    console.error('Fejl ved hentning af backups:', err);
    alert('‚ùå Fejl ved hentning af backups: ' + err.message);
  }
}

// Show backup selection modal
function showBackupSelectionModal(backupGists, githubToken) {
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.id = 'backupSelectionModal';
  modal.innerHTML = `
    <div class="modal" style="max-width:700px;">
      <h3>üì• V√¶lg Backup at Gendanne</h3>
      <p style="color:#666; margin-bottom:20px;">V√¶lg hvilken backup du vil gendanne fra serveren:</p>
      <div id="backupList" style="max-height:400px; overflow-y:auto; margin-bottom:20px;">
        ${backupGists.map((gist, index) => {
          const date = new Date(gist.created_at);
          const dateStr = date.toLocaleString('da-DK');
          const fileCount = Object.keys(gist.files || {}).length;
          return `
            <div style="padding:15px; margin-bottom:10px; background:#f5f5f5; border-radius:8px; border:1px solid #ddd; cursor:pointer;" 
                 onclick="selectBackupFromServer('${gist.id}', '${githubToken}')"
                 onmouseover="this.style.background='#e8f4f8'" 
                 onmouseout="this.style.background='#f5f5f5'">
              <strong style="font-size:16px; display:block; margin-bottom:5px;">${gist.description || 'K√∏kkenlager Backup'}</strong>
              <span style="font-size:13px; color:#666;">üìÖ ${dateStr} ‚Ä¢ ${fileCount} fil(er)</span>
            </div>
          `;
        }).join('')}
      </div>
      <div class="actions">
        <button onclick="document.getElementById('backupSelectionModal').remove()">Annuller</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}

// Select and restore backup from server
async function selectBackupFromServer(gistId, githubToken) {
  try {
    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const gist = await response.json();
    const files = Object.values(gist.files || {});
    
    if (files.length === 0) {
      alert('‚ö†Ô∏è Ingen backup filer fundet i denne gist.');
      return;
    }
    
    // Find the most recent backup file
    const backupFiles = files.filter(f => f.filename && f.filename.includes('backup'));
    if (backupFiles.length === 0) {
      alert('‚ö†Ô∏è Ingen backup filer fundet i denne gist.');
      return;
    }
    
    // Get the content of the first backup file
    const backupFile = backupFiles[0];
    const backupContent = backupFile.content;
    
    // Parse and restore
    const backupData = JSON.parse(backupContent);
    
    // Confirm restore
    const confirmRestore = confirm(`‚ö†Ô∏è ADVARSEL: Dette vil erstatte al nuv√¶rende data!\n\n` +
      `Vil du forts√¶tte med at gendanne backup fra:\n${gist.description || 'Ukendt backup'}\n\n` +
      `Dato: ${new Date(gist.created_at).toLocaleString('da-DK')}\n\n` +
      `Tryk OK for at forts√¶tte, eller Annuller for at afbryde.`);
    
    if (!confirmRestore) {
      return;
    }
    
    // Restore data
    const storageKey = 'k√∏kkenlager_data';
    
    // Preserve login and license if they exist in current data
    const currentDataStr = localStorage.getItem(storageKey);
    if (currentDataStr) {
      try {
        const currentData = JSON.parse(currentDataStr);
        if (currentData.loginHash) backupData.loginHash = currentData.loginHash;
        if (currentData.licenseKey) backupData.licenseKey = currentData.licenseKey;
        if (currentData.username) backupData.username = currentData.username;
      } catch (e) {
        console.warn('Could not preserve login/license:', e);
      }
    }
    
    localStorage.setItem(storageKey, JSON.stringify(backupData));
    
    // Reload page to apply changes
    alert('‚úÖ Backup gendannet!\n\nSiden genindl√¶ses nu for at anvende √¶ndringerne.');
    location.reload();
    
  } catch(err) {
    console.error('Fejl ved gendannelse af backup:', err);
    alert('‚ùå Fejl ved gendannelse af backup: ' + err.message);
  }
}

// Initialize manual when settings page is shown
document.addEventListener('DOMContentLoaded', function() {
  // Initialize manual when systemOpsaetning page is shown
  const observer = new MutationObserver(function(mutations) {
    const manualSection = document.getElementById('settings-manual');
    if (manualSection && manualSection.classList.contains('active')) {
      const manualContent = document.getElementById('manualContent');
      if (manualContent && manualContent.children.length === 0) {
        initializeManual();
      }
    }
  });
  
  const systemOpsaetning = document.getElementById('systemOpsaetning');
  if (systemOpsaetning) {
    observer.observe(systemOpsaetning, { childList: true, subtree: true, attributes: true, attributeFilter: ['class'] });
  }
});

/* small preview update */
function updateLogPreview(){ const p=$('logPreview'); if(!p) return; if(reports.length===0){ p.textContent='Ingen opt√¶llinger endnu.'; return;} const latest = reports.slice(0,5).map(r=> `${formatTime(r.ts)} ‚Äî ${r.handling} ‚Äî ${r.type==='session' ? r.details.length+' linjer' : (r.vare||'') } ‚Äî ${r.scope||r.placering||''}`).join('\n'); p.textContent = latest; }

/* ================================
   [JS 15] LOGIN TRACKING & AUTOMATISK BACKUP
   ================================ */
// Track login count and perform automatic backup after 3 logins
function trackLoginCount() {
  try {
    const LOGIN_COUNT_KEY = 'k√∏kkenlager_login_count';
    const LAST_BACKUP_KEY = 'k√∏kkenlager_last_auto_backup';
    
    // Get current login count
    let loginCount = parseInt(localStorage.getItem(LOGIN_COUNT_KEY) || '0', 10);
    loginCount++;
    localStorage.setItem(LOGIN_COUNT_KEY, loginCount.toString());
    
    console.log(`Login count: ${loginCount}`);
    
    // Check if we should perform automatic backup (every 3 logins)
    if (loginCount % 3 === 0) {
      const lastBackup = localStorage.getItem(LAST_BACKUP_KEY);
      const now = Date.now();
      
      // Only backup if last backup was more than 1 hour ago (to avoid too frequent backups)
      if (!lastBackup || (now - parseInt(lastBackup, 10)) > 3600000) {
        console.log('Automatisk backup efter 3. login...');
        performAutomaticBackup();
        localStorage.setItem(LAST_BACKUP_KEY, now.toString());
      }
    }
  } catch(err) {
    console.error('Fejl ved login tracking:', err);
  }
}

// Perform automatic backup (silent, in background)
async function performAutomaticBackup() {
  try {
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    
    if (!dataStr) {
      console.warn('Ingen data at backupe');
      return;
    }
    
    const data = JSON.parse(dataStr);
    
    // Get GitHub token
    let githubToken = localStorage.getItem('github_gist_token');
    if (!githubToken) {
      console.log('Ingen GitHub token fundet - springer automatisk backup over');
      return; // Silent fail - don't bother user if no token
    }
    
    // Create backup data
    const backupData = {
      ...data,
      backupType: 'automatic',
      backupVersion: APP_VERSION,
      backupDate: new Date().toISOString(),
      backupDescription: `Automatisk backup - ${new Date().toLocaleString('da-DK')}`
    };
    
    // Check for existing backup gist
    let existingGistId = null;
    try {
      const gistsResponse = await fetch('https://api.github.com/gists', {
        headers: { 'Authorization': `Bearer ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }
      });
      if (gistsResponse.ok) {
        const allGists = await gistsResponse.json();
        const backupGists = allGists.filter(gist => 
          gist.description && gist.description.includes('K√∏kkenlager Backup')
        );
        if (backupGists.length > 0) {
          backupGists.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          existingGistId = backupGists[0].id;
        }
      }
    } catch (err) {
      console.warn('Could not check for existing backup gists:', err);
    }
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `k√∏kkenlager_backup_auto_${timestamp}.json`;
    
    const gistData = {
      description: `K√∏kkenlager Backup - ${new Date().toLocaleString('da-DK')} - v${APP_VERSION}`,
      public: false,
      files: {
        [filename]: {
          content: JSON.stringify(backupData, null, 2)
        }
      }
    };
    
    // If existing gist, add to it
    if (existingGistId) {
      try {
        const existingGistResponse = await fetch(`https://api.github.com/gists/${existingGistId}`, {
          headers: { 'Authorization': `Bearer ${githubToken}`, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (existingGistResponse.ok) {
          const existingGist = await existingGistResponse.json();
          Object.keys(existingGist.files).forEach(key => {
            if (!gistData.files[key]) {
              gistData.files[key] = existingGist.files[key];
            }
          });
        }
      } catch (err) {
        console.warn('Could not fetch existing gist:', err);
        existingGistId = null;
      }
    }
    
    const url = existingGistId ? `https://api.github.com/gists/${existingGistId}` : 'https://api.github.com/gists';
    const method = existingGistId ? 'PATCH' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify(gistData)
    });
    
    if (response.ok) {
      console.log('‚úÖ Automatisk backup gennemf√∏rt');
      // Show subtle notification (optional)
      const notification = document.createElement('div');
      notification.style.cssText = 'position:fixed;top:20px;right:20px;background:#28a745;color:white;padding:12px 20px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:10000;font-weight:700;';
      notification.textContent = '‚úÖ Automatisk backup gennemf√∏rt';
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transition = 'opacity 0.5s';
        setTimeout(() => notification.remove(), 500);
      }, 3000);
    } else {
      console.warn('Automatisk backup fejlede:', response.status);
    }
    
  } catch(err) {
    console.error('Fejl ved automatisk backup:', err);
    // Silent fail - don't bother user
  }
}

/* ================================
   [JS 16] SIKKERHEDSTJEK VED LOGIN
   ================================ */
// Perform security check on every login
function performLoginSecurityCheck() {
  try {
    console.log('Udf√∏rer sikkerhedstjek...');
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    
    if (!dataStr) {
      console.warn('Ingen data fundet ved sikkerhedstjek');
      return;
    }
    
    let data;
    try {
      data = JSON.parse(dataStr);
    } catch (e) {
      console.error('Fejl ved parsing af data:', e);
      alert('‚ö†Ô∏è ADVARSEL: Data er korrupt. Pr√∏v at gendanne fra backup.');
      return;
    }
    
    const issues = [];
    
    // Check 1: Verify data structure
    if (!data.masterVarelager || !Array.isArray(data.masterVarelager)) {
      issues.push('masterVarelager mangler eller er ikke en array');
    }
    
    if (!data.reports || !Array.isArray(data.reports)) {
      issues.push('reports mangler eller er ikke en array');
    }
    
    if (!data.lagerData || typeof data.lagerData !== 'object') {
      issues.push('lagerData mangler eller er ikke et objekt');
    }
    
    if (!data.lagerLokationer || !Array.isArray(data.lagerLokationer)) {
      issues.push('lagerLokationer mangler eller er ikke en array');
    }
    
    // Check 2: Verify critical data integrity
    if (data.masterVarelager) {
      const invalidItems = data.masterVarelager.filter(item => 
        !item.id || !item.navn || typeof item.pris !== 'number'
      );
      if (invalidItems.length > 0) {
        issues.push(`${invalidItems.length} ugyldige varer i masterVarelager`);
      }
    }
    
    // Check 3: Verify reports structure
    if (data.reports) {
      const invalidReports = data.reports.filter(report => 
        !report.ts || !report.handling
      );
      if (invalidReports.length > 0) {
        issues.push(`${invalidReports.length} ugyldige rapporter`);
      }
    }
    
    // Check 4: Verify version compatibility
    if (data.version && data.version !== APP_VERSION) {
      console.log(`Version mismatch: Data version ${data.version}, App version ${APP_VERSION}`);
      // Not a critical issue, just log it
    }
    
    // Check 5: Verify localStorage size (warn if getting large)
    const dataSize = new Blob([dataStr]).size;
    const maxSize = 5 * 1024 * 1024; // 5MB
    if (dataSize > maxSize) {
      issues.push(`Data st√∏rrelse er stor (${(dataSize / 1024 / 1024).toFixed(2)}MB). Overvej at arkivere gamle rapporter.`);
    }
    
    // Report issues
    if (issues.length > 0) {
      console.warn('Sikkerhedstjek fundet problemer:', issues);
      const criticalIssues = issues.filter(issue => 
        issue.includes('mangler') || issue.includes('ikke en') || issue.includes('ikke et')
      );
      
      if (criticalIssues.length > 0) {
        alert('‚ö†Ô∏è ADVARSEL: Sikkerhedstjek fundet kritiske problemer:\n\n' + 
              criticalIssues.join('\n') + 
              '\n\nPr√∏v at gendanne fra backup eller kontakt support.');
      } else {
        console.log('Sikkerhedstjek: Mindre problemer fundet (ikke kritiske):', issues);
      }
    } else {
      console.log('‚úÖ Sikkerhedstjek gennemf√∏rt - ingen problemer fundet');
    }
    
    // Update data version if needed
    if (!data.version || data.version !== APP_VERSION) {
      data.version = APP_VERSION;
      data.lastUpdated = Date.now();
      localStorage.setItem(storageKey, JSON.stringify(data));
      console.log('Data version opdateret til', APP_VERSION);
    }
    
  } catch(err) {
    console.error('Fejl ved sikkerhedstjek:', err);
    alert('‚ö†Ô∏è Fejl ved sikkerhedstjek. Kontakt support hvis problemet forts√¶tter.');
  }
}

/* ================================
   [JS 11] Demo seed (starter indhold)
   ================================ */
function seedDemo(){
  masterVarelager = [
    {id:genId(), navn:'Sm√∏r', maaleenhed:'stk', pris:12.5, placering:'K√∏l'},
    {id:genId(), navn:'Mel 1kg', maaleenhed:'kg', pris:6.9, placering:'T√∏revare'},
    {id:genId(), navn:'Frosne √¶rter', maaleenhed:'stk', pris:20, placering:'Frost'},
    {id:genId(), navn:'Salat', maaleenhed:'kg', pris:15, placering:'Gr√∏nt'}
  ];
  lagerData = {}; lagerLokationer.forEach(l=> lagerData[l] = {});
  if(masterVarelager[0]) lagerData['K√∏l'][masterVarelager[0].id] = 10;
  if(masterVarelager[1]) lagerData['T√∏revare'][masterVarelager[1].id] = 25;
  reports = [];
  updateAllSelects();
}

/* ================================
   [JS 12] Small keyboard helpers (Esc closes modals)
   ================================ */
document.addEventListener('keydown', (e)=>{
  if(e.key === 'Escape'){
    try{ closeStartModal(); }catch(e){}
    try{ closeFinishModal(); }catch(e){}
    try{ closeImportModal(); }catch(e){}
  }
});

/* Fetch reports from server (GitHub Gist) */
async function fetchReportsFromServer(){
  try {
    // Get GitHub token from localStorage or prompt
    let githubToken = localStorage.getItem('github_gist_token');
    
    if (!githubToken) {
      const token = prompt('üîë Indtast GitHub Personal Access Token:\n\n' +
        '1. G√• til: https://github.com/settings/tokens\n' +
        '2. Klik "Generate new token (classic)"\n' +
        '3. V√¶lg "gist" scope\n' +
        '4. Kopi√©r token og indtast her\n\n' +
        'üí° Token gemmes lokalt og bruges til fremtidige downloads.\n' +
        'üí° Du kan slette token i indstillinger hvis n√∏dvendigt.');
      
      if (!token || !token.trim()) {
        alert('‚ùå Ingen token indtastet. Hentning annulleret.');
        return;
      }
      
      githubToken = token.trim();
      localStorage.setItem('github_gist_token', githubToken);
    }
    
    // Show loading
    showServerReportsModal('loading');
    
    // Fetch all user's gists
    const response = await fetch('https://api.github.com/gists', {
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        localStorage.removeItem('github_gist_token');
        hideServerReportsModal();
        throw new Error('Ugyldig GitHub token. Token er blevet slettet. Pr√∏v igen og indtast en ny token.');
      }
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const gists = await response.json();
    
    // Filter for scanner reports and get details
    const scannerGists = [];
    for (const gist of gists) {
      if (gist.description && gist.description.includes('Scanner rapporter')) {
        // Try to get report count from description
        const reportCount = gist.description.match(/(\d+)\s+rapport/)?.[1] || '?';
        
        // Try to get report names from gist files and check if already imported
        let reportNames = [];
        let reportDetails = [];
        let alreadyImported = false;
        let importedCount = 0;
        try {
          const files = Object.values(gist.files);
          if (files.length > 0 && files[0].content) {
            const content = JSON.parse(files[0].content);
            if (content.reports && Array.isArray(content.reports)) {
              content.reports.forEach(gistReport => {
                const reportName = gistReport.handling || 'Ukendt';
                const exists = reports.some(r => 
                  (r.handling === gistReport.handling) || 
                  (Math.abs(r.ts - gistReport.ts) < 1000 && r.handling && gistReport.handling && r.handling.startsWith('OPTA-'))
                );
                
                reportDetails.push({
                  name: reportName,
                  imported: exists,
                  ts: gistReport.ts
                });
                
                if (exists) {
                  importedCount++;
                }
              });
              
              reportNames = reportDetails.map(r => r.name).slice(0, 3);
              
              if (importedCount === content.reports.length && content.reports.length > 0) {
                alreadyImported = true;
              }
            }
          }
        } catch(e) {
          // Ignore errors parsing content
        }
        
        scannerGists.push({
          id: gist.id,
          description: gist.description,
          createdAt: gist.created_at,
          updatedAt: gist.updated_at,
          reportCount: reportCount,
          reportNames: reportNames,
          reportDetails: reportDetails,
          url: gist.html_url,
          alreadyImported: alreadyImported,
          importedCount: importedCount
        });
      }
    }
    
    // Sort by date (newest first)
    scannerGists.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    if (scannerGists.length === 0) {
      hideServerReportsModal();
      alert('‚ö†Ô∏è Ingen scanner rapporter fundet i dine gists.\n\nUpload rapporter fra scanner-appen f√∏rst.');
      return;
    }
    
    // Automatically fetch the most recent report
    const mostRecentGist = scannerGists[0];
    
    // Check if it's already imported
    if (mostRecentGist.alreadyImported && mostRecentGist.importedCount === mostRecentGist.reportCount) {
      hideServerReportsModal();
      alert('‚úÖ Den seneste rapport er allerede importeret!\n\nüìã Rapport: ' + mostRecentGist.reportNames);
      return;
    }
    
    // Automatically import the most recent report
    try {
      await selectServerReport(mostRecentGist.id, githubToken);
      hideServerReportsModal();
      
      const reportName = mostRecentGist.reportNames || 'Ukendt';
      alert(`‚úÖ Seneste rapport hentet!\n\nüìã Rapport: ${reportName}\n\nüí° Rapporten er nu tilg√¶ngelig under "Rapporter" fanen.`);
    } catch(err) {
      hideServerReportsModal();
      throw err;
    }
    
  } catch(err) {
    console.error('Fejl ved hentning fra server:', err);
    hideServerReportsModal();
    
    if (err.name === 'TypeError' && err.message.includes('fetch')) {
      alert('‚ùå Fejl ved hentning: Ingen internetforbindelse.\n\nTjek din internetforbindelse og pr√∏v igen.');
      return;
    }
    
    if (err.message.includes('401') || err.message.includes('Bad credentials') || err.message.includes('Ugyldig') || err.message.includes('Unauthorized')) {
      localStorage.removeItem('github_gist_token');
      alert('‚ùå Ugyldig GitHub token.\n\nToken er blevet slettet. Pr√∏v igen og indtast en ny token.\n\n' +
        'üí° G√• til: https://github.com/settings/tokens\n' +
        'üí° Opret et nyt token med "gist" scope.');
      return;
    }
    
    if (err.message.includes('404')) {
      alert('‚ùå Gist ikke fundet.\n\nTjek at Gist ID er korrekt.');
      return;
    }
    
    alert('‚ùå Fejl ved hentning: ' + err.message + '\n\nTjek din internetforbindelse og pr√∏v igen.');
  }
}

/* Show server reports modal */
function showServerReportsModal(mode, gists = [], githubToken = '') {
  const modalEl = document.getElementById('serverReportsModal');
  const contentEl = document.getElementById('serverReportsModalContent');
  
  if (!modalEl || !contentEl) {
    console.error('Server reports modal not found');
    return;
  }
  
  if (mode === 'loading') {
    contentEl.innerHTML = '<p style="text-align:center; padding:40px;">üîÑ Henter rapporter fra serveren...</p>';
    modalEl.classList.remove('hidden');
    modalEl.style.display = 'flex';
    modalEl.setAttribute('aria-hidden', 'false');
    return;
  }
}

/* Hide server reports modal */
function hideServerReportsModal() {
  const modal = document.getElementById('serverReportsModal');
  if (modal) {
    modal.classList.add('hidden');
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden', 'true');
  }
}

/* Select and fetch a server report */
async function selectServerReport(gistId, githubToken) {
  try {
    hideServerReportsModal();
    showServerReportsModal('loading');
    
    await fetchAndImportGist(gistId, githubToken);
    
    hideServerReportsModal();
  } catch(err) {
    hideServerReportsModal();
    throw err;
  }
}

/* Fetch and import a specific Gist */
async function fetchAndImportGist(gistId, githubToken) {
  try {
    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      let errorData;
      try {
        errorData = JSON.parse(errorText);
      } catch {
        errorData = { message: errorText || `HTTP ${response.status}: ${response.statusText}` };
      }
      
      if (response.status === 401) {
        localStorage.removeItem('github_gist_token');
        throw new Error('Ugyldig GitHub token. Token er blevet slettet. Pr√∏v igen og indtast en ny token.');
      }
      
      throw new Error(errorData.message || errorData.error || `HTTP ${response.status}: ${response.statusText}`);
    }
    
    const gist = await response.json();
    
    // Find the JSON file in the gist
    const files = Object.values(gist.files);
    const jsonFile = files.find(f => f.filename.endsWith('.json'));
    
    if (!jsonFile) {
      throw new Error('Ingen JSON fil fundet i gist');
    }
    
    // Parse the content
    const importedData = JSON.parse(jsonFile.content);
    
    // Check if this is scanner reports
    if (!importedData.reports || !Array.isArray(importedData.reports)) {
      throw new Error('Filen indeholder ikke scanner rapporter');
    }
    
    // Import reports (same logic as file import)
    const storageKey = 'k√∏kkenlager_data';
    let data = {};
    const existingData = localStorage.getItem(storageKey);
    if (existingData) {
      try {
        data = JSON.parse(existingData);
      } catch(err) {
        console.warn('Could not parse existing data:', err);
      }
    }
    
    if (!data.reports || !Array.isArray(data.reports)) {
      data.reports = [];
    }
    
    // Add imported reports (avoid duplicates)
    let added = 0;
    let skipped = 0;
    importedData.reports.forEach(report => {
      const exists = data.reports.some(r => 
        (r.handling === report.handling) || 
        (Math.abs(r.ts - report.ts) < 1000 && r.handling && report.handling && r.handling.startsWith('OPTA-'))
      );
      
      if (!exists) {
        if (!report.type) report.type = 'session';
        if (!report.details) report.details = [];
        if (!report.total) report.total = 0;
        
        report.importedFromServer = true;
        report.gistId = gistId;
        report.importedAt = Date.now();
        
        data.reports.unshift(report);
        added++;
        console.log('‚úÖ Imported report from server:', report.handling);
      } else {
        skipped++;
      }
    });
    
    // Update sessionCounter
    if (importedData.sessionCounter) {
      const currentCounter = data.sessionCounter || sessionCounter || 0;
      if (importedData.sessionCounter > currentCounter) {
        data.sessionCounter = importedData.sessionCounter;
        sessionCounter = importedData.sessionCounter;
      }
    }
    
    // Store scanner installation ID
    if (importedData.installationId) {
      if (!data.scannerInstallationIds) data.scannerInstallationIds = [];
      if (!data.scannerInstallationIds.includes(importedData.installationId)) {
        data.scannerInstallationIds.push(importedData.installationId);
      }
    }
    
    // Save data
    localStorage.setItem(storageKey, JSON.stringify(data));
    reports = data.reports;
    if (data.sessionCounter) sessionCounter = data.sessionCounter;
    
    renderReports();
    updateLogPreview();
    saveAllData();
    
    let message = `‚úÖ ${added} rapport(er) hentet fra server!`;
    if (skipped > 0) {
      message += `\n‚ö†Ô∏è ${skipped} rapport(er) sprunget over (findes allerede)`;
    }
    message += `\n\nRapporterne er nu tilg√¶ngelige under "Rapporter" fanen.`;
    if (importedData.installationId) {
      message += `\n\nüîó Installation ID: ${importedData.installationId.substring(0, 20)}...`;
    }
    
    alert(message);
    
  } catch(err) {
    console.error('Error fetching gist:', err);
    throw err;
  }
}

/* Upload varelager to server (GitHub Gist) */
async function uploadVarelagerToServer(){
  try {
    if (!masterVarelager || masterVarelager.length === 0) {
      alert('‚ö†Ô∏è Ingen varelager data at uploade.\n\nTilf√∏j varer i varelager administration f√∏rst.');
      return;
    }
    
    // Get GitHub token from localStorage or prompt
    let githubToken = localStorage.getItem('github_gist_token');
    
    if (!githubToken) {
      const token = prompt('üîë Indtast GitHub Personal Access Token:\n\n' +
        '1. G√• til: https://github.com/settings/tokens\n' +
        '2. Klik "Generate new token (classic)"\n' +
        '3. V√¶lg "gist" scope\n' +
        '4. Kopi√©r token og indtast her\n\n' +
        'üí° Token gemmes lokalt og bruges til fremtidige uploads.\n' +
        'üí° Du kan slette token i indstillinger hvis n√∏dvendigt.');
      
      if (!token || !token.trim()) {
        alert('‚ùå Ingen token indtastet. Upload annulleret.');
        return;
      }
      
      githubToken = token.trim();
      localStorage.setItem('github_gist_token', githubToken);
    }
    
    // Prepare export data
    const installationId = getInstallationId();
    const exportData = {
      masterVarelager: masterVarelager || [],
      lagerLokationer: lagerLokationer || [],
      mainInstallationId: installationId,
      version: '1.0',
      exportedAt: Date.now()
    };
    
    // Show loading
    const originalButton = event?.target;
    if (originalButton) {
      originalButton.disabled = true;
      originalButton.textContent = '‚è≥ Uploader...';
    }
    
    // First, try to find existing varelager gist to update it
    let existingGistId = null;
    try {
      const gistsResponse = await fetch('https://api.github.com/gists', {
        headers: {
          'Authorization': `Bearer ${githubToken}`,
          'Accept': 'application/vnd.github.v3+json'
        }
      });
      
      if (gistsResponse.ok) {
        const allGists = await gistsResponse.json();
        // Find the most recent varelager gist
        const varelagerGists = allGists.filter(gist => 
          gist.description && gist.description.includes('Varelager skabelon')
        );
        
        if (varelagerGists.length > 0) {
          // Sort by date (newest first) and use the newest one
          varelagerGists.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          existingGistId = varelagerGists[0].id;
          console.log('Found existing varelager gist to update:', existingGistId);
        }
      }
    } catch (err) {
      console.warn('Could not check for existing gists, will create new one:', err);
    }
    
    // Prepare gist data
    const gistData = {
      description: `Varelager skabelon - ${masterVarelager.length} varer - ${new Date().toLocaleString('da-DK')}`,
      public: false, // Private gist
      files: {}
    };
    
    // If updating existing gist, get the filename from the existing gist
    if (existingGistId) {
      try {
        const existingGistResponse = await fetch(`https://api.github.com/gists/${existingGistId}`, {
          headers: {
            'Authorization': `Bearer ${githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });
        
        if (existingGistResponse.ok) {
          const existingGist = await existingGistResponse.json();
          const existingFiles = Object.keys(existingGist.files || {});
          if (existingFiles.length > 0) {
            // Use the same filename as the existing gist
            gistData.files[existingFiles[0]] = {
              content: JSON.stringify(exportData, null, 2)
            };
          } else {
            // Fallback to new filename
            gistData.files[`varelager-${Date.now()}.json`] = {
              content: JSON.stringify(exportData, null, 2)
            };
          }
        }
      } catch (err) {
        console.warn('Could not get existing gist details, using new filename:', err);
        gistData.files[`varelager-${Date.now()}.json`] = {
          content: JSON.stringify(exportData, null, 2)
        };
      }
    } else {
      // New gist - use timestamp filename
      gistData.files[`varelager-${Date.now()}.json`] = {
        content: JSON.stringify(exportData, null, 2)
      };
    }
    
    // Upload or update GitHub Gist
    const url = existingGistId 
      ? `https://api.github.com/gists/${existingGistId}` 
      : 'https://api.github.com/gists';
    const method = existingGistId ? 'PATCH' : 'POST';
    
    const response = await fetch(url, {
      method: method,
      headers: {
        'Authorization': `Bearer ${githubToken}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify(gistData)
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      let errorData;
      try {
        errorData = JSON.parse(errorText);
      } catch {
        errorData = { message: errorText || `HTTP ${response.status}: ${response.statusText}` };
      }
      
      if (response.status === 401) {
        localStorage.removeItem('github_gist_token');
        throw new Error('Ugyldig GitHub token. Token er blevet slettet. Pr√∏v igen og indtast en ny token.');
      }
      
      throw new Error(errorData.message || errorData.error || `HTTP ${response.status}: ${response.statusText}`);
    }
    
    const gist = await response.json();
    const gistUrl = gist.html_url;
    const gistId = gist.id;
    
    const updateText = existingGistId ? 'opdateret' : 'uploadet';
    alert(`‚úÖ Varelager ${updateText} til server!\n\nüì¶ ${masterVarelager.length} varer uploadet\n\n` +
      `üîó Gist URL: ${gistUrl}\n\n` +
      `üí° I scanner-appen:\n` +
      `1. Klik "‚òÅÔ∏è Hent varelager"\n` +
      `2. Varelageret hentes automatisk!\n\n` +
      `üîë Gist ID: ${gistId.substring(0, 20)}...`);
    
    if (originalButton) {
      originalButton.disabled = false;
      originalButton.textContent = '‚òÅÔ∏è Upload Varelager til Server';
    }
    
  } catch(err) {
    console.error('Error uploading varelager:', err);
    
    if (event?.target) {
      event.target.disabled = false;
      event.target.textContent = '‚òÅÔ∏è Upload Varelager til Server';
    }
    
    // Check for network errors
    if (err.name === 'TypeError' && err.message.includes('fetch')) {
      alert('‚ùå Fejl ved upload: Ingen internetforbindelse.\n\nTjek din internetforbindelse og pr√∏v igen.');
      return;
    }
    
    // Check for invalid token
    if (err.message.includes('401') || err.message.includes('Bad credentials') || err.message.includes('Ugyldig') || err.message.includes('Unauthorized')) {
      localStorage.removeItem('github_gist_token');
      alert('‚ùå Ugyldig GitHub token.\n\nToken er blevet slettet. Pr√∏v igen og indtast en ny token.\n\n' +
        'üí° G√• til: https://github.com/settings/tokens\n' +
        'üí° Opret et nyt token med "gist" scope.');
      return;
    }
    
    alert('‚ùå Fejl ved upload: ' + err.message + '\n\nTjek din internetforbindelse og pr√∏v igen.');
  }
}

/* =============
   END SCRIPT
   ============= */
</script>

  <!-- Server Reports Modal -->
  <div id="serverReportsModal" class="modal hidden" aria-hidden="true" style="display:none;">
    <div class="modal-content" style="max-width:700px; width:90%;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">‚òÅÔ∏è Hent Rapporter fra Server</h2>
        <button onclick="hideServerReportsModal()" style="background:none; border:none; font-size:24px; cursor:pointer; color:#666; padding:0; width:30px; height:30px; display:flex; align-items:center; justify-content:center;">&times;</button>
      </div>
      <div id="serverReportsModalContent"></div>
    </div>
  </div>

</body>
</html>
