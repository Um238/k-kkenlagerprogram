<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<meta name="theme-color" content="#4CAF50" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Stregkode Scanner" />
<link rel="manifest" href="stregkode-scanner-manifest.json" />
<title>Stregkode Scanner - Telefon</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f5f5f5;padding:10px;max-width:600px;margin:0 auto}
.header{background:#4CAF50;color:#fff;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center}
.header h1{font-size:20px;margin-bottom:5px}
.header p{font-size:13px;opacity:0.9}
.scanner-container{background:#fff;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
#scannerVideo{width:100%;max-height:60vh;border:3px solid #4CAF50;border-radius:8px;background:#000;display:none;position:relative}
.status{padding:10px;margin:10px 0;border-radius:6px;text-align:center;font-weight:700;min-height:50px;display:flex;align-items:center;justify-content:center}
.status.waiting{background:#fff3cd;color:#856404}
.status.scanning{background:#d4edda;color:#155724}
.status.success{background:#d1ecf1;color:#0c5460}
.status.error{background:#f8d7da;color:#721c24;white-space:pre-line}
.button{width:100%;padding:15px;margin:8px 0;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;background:#4CAF50;color:#fff}
.button:active{opacity:0.8}
.button.secondary{background:#6c757d}
.button.danger{background:#dc3545}
.scanned-list{background:#fff;border-radius:8px;padding:15px;margin-top:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1);max-height:40vh;overflow-y:auto}
.scanned-item{padding:10px;margin:5px 0;background:#f8f9fa;border-radius:6px;border-left:4px solid #4CAF50;display:flex;justify-content:space-between;align-items:center}
.scanned-item .info{flex:1}
.scanned-item .name{font-weight:700;font-size:16px;color:#333}
.scanned-item .details{font-size:12px;color:#666;margin-top:3px}
.scanned-item .count{font-size:20px;font-weight:700;color:#4CAF50;margin-left:10px;min-width:40px;text-align:center}
.scanned-item .remove{background:#dc3545;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:12px;margin-left:5px}
.actions{display:flex;gap:10px;margin-top:15px}
.actions .button{flex:1}
.empty{text-align:center;padding:20px;color:#999}
.stats{display:flex;gap:15px;margin:15px 0;padding:15px;background:#f8f9fa;border-radius:8px}
.stat{text-align:center;flex:1}
.stat-value{font-size:24px;font-weight:700;color:#4CAF50}
.stat-label{font-size:12px;color:#666;margin-top:5px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal.hidden{display:none}
.modal-content{background:white;padding:25px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.modal-content h3{margin:0 0 15px 0;font-size:20px;color:#333}
.modal-content input[type="number"]{width:100%;padding:15px;font-size:24px;text-align:center;border:2px solid #4CAF50;border-radius:8px;margin:10px 0}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-buttons button{flex:1;padding:12px;font-size:16px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
</style>
</head>
<body>
<div class="header">
  <h1>üì± Stregkode Scanner</h1>
  <p>Scan stregkoder med din telefon - V 3.6</p>
</div>

<div class="scanner-container">
  <div id="status" class="status waiting">Klik "Start Scanner" for at begynde</div>
  <div id="scannerVideo"></div>
  <button id="startBtn" class="button" onclick="startScanner()">üì∑ Start Scanner</button>
  <button id="stopBtn" class="button secondary" onclick="stopScanner()" style="display:none">‚èπ Stop Scanner</button>
</div>

<div class="stats" id="stats" style="display:none">
  <div class="stat">
    <div class="stat-value" id="totalScanned">0</div>
    <div class="stat-label">Total scannet</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="uniqueItems">0</div>
    <div class="stat-label">Unikke varer</div>
  </div>
</div>

<div class="scanned-list">
  <h3 style="margin-bottom:10px">Scannede varer (<span id="count">0</span>)</h3>
  <div id="scannedList">
    <div class="empty">Ingen varer scannet endnu</div>
  </div>
  <div class="actions">
    <button class="button secondary" onclick="clearAll()">üóë Ryd alt</button>
    <button class="button secondary" onclick="checkDataConnection()" style="font-size:14px; padding:10px;">üîç Tjek data</button>
    <button class="button secondary" onclick="scanVarelagerQR()" style="font-size:14px; padding:10px; background:#4CAF50;">üì• Scan QR-kode</button>
    <button class="button secondary" onclick="importVarelager()" style="font-size:14px; padding:10px;">üì• Import fil</button>
    <button class="button secondary" onclick="exportReports()" style="font-size:14px; padding:10px; background:#2196F3;">üì§ Eksport rapporter</button>
    <button class="button secondary" onclick="showInstallationId()" style="font-size:14px; padding:10px; background:#FF9800;">üîë Vis ID</button>
    <button class="button" onclick="finishSession()">‚úÖ Afslut opt√¶lling</button>
  </div>
</div>

<!-- Modal til antalsindtastning -->
<div id="quantityModal" class="modal hidden">
  <div class="modal-content">
    <h3>Indtast antal</h3>
    <p id="scannedCodeDisplay" style="font-size:16px;font-weight:600;margin:15px 0;color:#4CAF50;"></p>
    <div style="margin:20px 0">
      <label for="quantityInput" style="display:block;margin-bottom:8px;font-weight:600;">Antal:</label>
      <input type="number" id="quantityInput" min="1" value="1" style="width:100%;padding:15px;font-size:24px;text-align:center;border:2px solid #4CAF50;border-radius:8px;" autofocus onkeypress="if(event.key==='Enter') confirmQuantityInput()">
    </div>
    <div class="modal-buttons">
      <button onclick="cancelQuantityInput()" style="background:#6c757d;color:white;">Annuller</button>
      <button onclick="confirmQuantityInput()" style="background:#4CAF50;color:white;">Gem</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let scannerActive = false;
let html5QrCode = null;
let scannedItems = {};
let allItems = [];
let lastScannedCode = null;
let lastScanTime = 0;
let pendingScannedCode = null; // For quantity dialog
const SCAN_COOLDOWN = 1000;

// Load items from main app
function loadItemsFromMainApp(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    
    console.log('Checking localStorage for key:', storageKey);
    console.log('Data found:', !!dataStr);
    
    if (!dataStr) {
      // No data found - allow scanning anyway but warn user
      const currentDomain = window.location.hostname;
      const isGitHub = currentDomain.includes('github.io');
      
      if (isGitHub) {
        updateStatus('‚ö†Ô∏è Ingen varelager data fundet.\n\nDu kan stadig scanne stregkoder, men varer vil ikke blive matchet.\n\nüí° Tip: Eksporter data fra hovedprogrammet og importer her.', 'error');
      } else {
        updateStatus('‚ö†Ô∏è Ingen varelager data fundet.\n\nDu kan stadig scanne stregkoder.\n\nüí° Tip: √Öbn hovedprogrammet p√• samme enhed f√∏rst.', 'error');
      }
      
      allItems = [];
      return false; // Return false but don't block the app
    }
    
    const data = JSON.parse(dataStr);
    console.log('Parsed data keys:', Object.keys(data));
    console.log('masterVarelager length:', data.masterVarelager ? data.masterVarelager.length : 0);
    
    allItems = data.masterVarelager || [];
    
    if (allItems.length === 0) {
      updateStatus('‚ö†Ô∏è Varelageret er tomt.\n\nDu kan stadig scanne stregkoder.', 'error');
      return false;
    }
    
    console.log('‚úÖ Indl√¶st ' + allItems.length + ' varer fra hovedprogrammet');
    return true;
  } catch (err) {
    console.error('Fejl ved indl√¶sning af varer:', err);
    updateStatus('Fejl ved indl√¶sning af varer: ' + err.message + '\n\nDu kan stadig scanne stregkoder.', 'error');
    allItems = [];
    return false;
  }
}

function updateStatus(text, type){
  const status = document.getElementById('status');
  status.textContent = text;
  status.className = 'status ' + (type || 'waiting');
}

async function startScanner(){
  if(scannerActive){
    stopScanner();
    return;
  }
  
  // Try to load items, but don't block if not found
  loadItemsFromMainApp();
  
  // Allow scanning even without varelager data
  if (allItems.length === 0) {
    console.warn('No varelager data - scanning will work but items won\'t be matched');
  }
  
  const status = document.getElementById('status');
  const video = document.getElementById('scannerVideo');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  
  const isSecure = window.location.protocol === 'https:' || 
                   window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1';
  
  if(!isSecure && window.location.protocol === 'file:'){
    updateStatus('‚ö†Ô∏è KAMERA KR√ÜVER WEBSERVER\n\nFilen skal hostes p√• en webserver for at kameraet virker.\n\nBrug webserveren fra hovedprogrammet eller GitHub Pages.', 'error');
    return;
  }
  
  if(typeof Html5Qrcode === 'undefined'){
    updateStatus('‚ö†Ô∏è Scanner bibliotek ikke indl√¶st.\n\nGenindl√¶s siden og tjek din internetforbindelse.', 'error');
    console.error('Html5Qrcode library not available');
    return;
  }
  
  updateStatus('Starter kamera...', 'waiting');
  
  try {
    // Stop existing scanning first if active
    if (html5QrCode && html5QrCode.isScanning) {
      try {
        await html5QrCode.stop();
        html5QrCode.clear();
      } catch (stopErr) {
        console.warn('Fejl ved stop af eksisterende scanning:', stopErr);
      }
    }
    
    video.style.display = 'block';
    scannerActive = true;
    
    // Clear video container first
    video.innerHTML = '';
    
    html5QrCode = new Html5Qrcode("scannerVideo");
    
    // Configuration optimized for mobile
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const qrboxSize = isMobile ? Math.min(250, window.innerWidth * 0.8) : 250;
    
    const config = {
      fps: 10,
      qrbox: { width: qrboxSize, height: qrboxSize },
      aspectRatio: 1.0
    };
    
    // Try to get back camera first
    let cameraId = { facingMode: "environment" };
    try {
      const devices = await Html5Qrcode.getCameras();
      if (devices && devices.length > 0) {
        const backCamera = devices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('rear') ||
          device.label.toLowerCase().includes('environment')
        );
        if (backCamera) {
          cameraId = backCamera.id;
          console.log('Using back camera:', backCamera.label);
        } else {
          cameraId = devices[0].id;
          console.log('Using first available camera:', devices[0].label);
        }
      }
    } catch (camErr) {
      console.warn('Could not enumerate cameras, using default:', camErr);
      // Continue with default facingMode
    }
    
    await html5QrCode.start(
      cameraId,
      config,
      (decodedText, decodedResult) => {
        console.log('‚úÖ Scannet stregkode/QR-kode:', decodedText);
        const now = Date.now();
        
        if (now - lastScanTime < SCAN_COOLDOWN && decodedText === lastScannedCode) {
          return;
        }
        
        lastScannedCode = decodedText;
        lastScanTime = now;
        
        // Check if this is a varelager QR code
        if (qrScanMode && decodedText.startsWith('VARELAGER:')) {
          handleVarelagerQR(decodedText);
        } else if (!qrScanMode) {
          // Show quantity dialog without stopping scanner
          // Scanner continues in background
          showQuantityDialog(decodedText);
        }
      },
      (errorMessage) => {
        // Ignorer scanning fejl - de er normale n√•r der ikke er fundet noget
      }
    );
    
    updateStatus('Peger p√• stregkoden...', 'scanning');
    startBtn.style.display = 'none';
    stopBtn.style.display = 'block';
    document.getElementById('stats').style.display = 'flex';
    
  } catch(err){
    console.error('Kamera fejl:', err);
    scannerActive = false;
    let errorMsg = '';
    let instructions = '';
    if(err.name === 'NotAllowedError'){
      errorMsg = 'Kamera tilladelse n√¶gtet.';
      instructions = 'Giv tilladelse til kamera:\n1. Klik p√• kamera-ikonet i browserens adresselinje\n2. V√¶lg "Tillad" for kamera\n3. Genindl√¶s siden og pr√∏v igen';
    } else if(err.name === 'NotFoundError'){
      errorMsg = 'Ingen kamera fundet.';
      instructions = 'Tjek at dit kamera er tilsluttet og ikke bruges af andre programmer.';
    } else {
      errorMsg = 'Kunne ikke starte scanner: ' + (err.message || err.name);
      instructions = 'Pr√∏v:\n1. Genindl√¶s siden\n2. Tjek browser tilladelser for kamera\n3. S√∏rg for at filen hostes p√• en webserver';
    }
    updateStatus(errorMsg + '\n\n' + instructions, 'error');
    startBtn.style.display = 'block';
    stopBtn.style.display = 'none';
    video.style.display = 'none';
  }
}

// Show quantity dialog when barcode is scanned
function showQuantityDialog(barcode){
  pendingScannedCode = barcode;
  const modal = document.getElementById('quantityModal');
  const codeDisplay = document.getElementById('scannedCodeDisplay');
  const quantityInput = document.getElementById('quantityInput');
  
  // Find item to show name
  const item = allItems.find(v => v.id === barcode);
  if (item) {
    codeDisplay.textContent = item.navn + ' (' + barcode + ')';
  } else {
    codeDisplay.textContent = 'Stregkode: ' + barcode;
  }
  
  quantityInput.value = '1';
  quantityInput.focus();
  quantityInput.select();
  
  modal.classList.remove('hidden');
}

// Confirm quantity and add item
function confirmQuantityInput(){
  const modal = document.getElementById('quantityModal');
  const quantityInput = document.getElementById('quantityInput');
  const quantity = parseInt(quantityInput.value) || 1;
  
  if (quantity <= 0) {
    alert('‚ö†Ô∏è Antal skal v√¶re st√∏rre end 0');
    quantityInput.focus();
    return;
  }
  
  if (pendingScannedCode) {
    handleScannedBarcode(pendingScannedCode, quantity);
    pendingScannedCode = null;
  }
  
  modal.classList.add('hidden');
  
  // Scanner continues automatically - no need to restart
  if (scannerActive && !qrScanMode) {
    updateStatus('Peger p√• stregkoden...', 'scanning');
  }
}

// Cancel quantity input
function cancelQuantityInput(){
  const modal = document.getElementById('quantityModal');
  pendingScannedCode = null;
  modal.classList.add('hidden');
  
  // Scanner continues automatically - no need to restart
  if (scannerActive && !qrScanMode) {
    updateStatus('Peger p√• stregkoden...', 'scanning');
  }
}

function handleScannedBarcode(barcode, quantity = 1){
  // Try to find item in varelager
  const item = allItems.find(v => v.id === barcode);
  
  if (!item) {
    // Item not found - still add it but with limited info
    if (!scannedItems[barcode]) {
      scannedItems[barcode] = {
        vare: {
          id: barcode,
          navn: 'Ukendt vare (' + barcode + ')',
          placering: 'Ikke angivet',
          maaleenhed: 'stk',
          pris: 0
        },
        count: 0
      };
    }
    
    scannedItems[barcode].count += quantity;
    updateStatus('‚ö†Ô∏è Vare ikke fundet: ' + barcode + '\n(Tilf√∏jet: ' + quantity + ')', 'error');
    
    updateStats();
    renderList();
    
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
    
    return;
  }
  
  // Item found - add normally
  if (!scannedItems[barcode]) {
    scannedItems[barcode] = {
      vare: item,
      count: 0
    };
  }
  
  scannedItems[barcode].count += quantity;
  
  updateStatus('‚úÖ ' + item.navn + ' tilf√∏jet: ' + quantity, 'success');
  
  updateStats();
  renderList();
  
  if (navigator.vibrate) {
    navigator.vibrate(50);
  }
}

function updateStats(){
  const total = Object.values(scannedItems).reduce((sum, item) => sum + item.count, 0);
  const unique = Object.keys(scannedItems).length;
  
  document.getElementById('totalScanned').textContent = total;
  document.getElementById('uniqueItems').textContent = unique;
  document.getElementById('count').textContent = total;
}

function renderList(){
  const list = document.getElementById('scannedList');
  const items = Object.values(scannedItems);
  
  if(items.length === 0){
    list.innerHTML = '<div class="empty">Ingen varer scannet endnu</div>';
    return;
  }
  
  // Group by location
  const itemsByLocation = {};
  items.forEach(item => {
    const location = item.vare.placering || 'Ikke angivet';
    if (!itemsByLocation[location]) {
      itemsByLocation[location] = [];
    }
    itemsByLocation[location].push(item);
  });
  
  let html = '';
  Object.keys(itemsByLocation).sort().forEach(location => {
    html += `<div style="margin-bottom:15px; padding:10px; background:#f0f0f0; border-radius:6px;">`;
    html += `<div style="font-weight:700; font-size:14px; color:#4CAF50; margin-bottom:8px;">üìç ${location}</div>`;
    
    itemsByLocation[location].forEach((item, idx) => {
      const v = item.vare;
      const key = Object.keys(scannedItems).find(k => scannedItems[k] === item);
      html += `
        <div class="scanned-item">
          <div class="info">
            <div class="name">${v.navn}</div>
            <div class="details">${v.maaleenhed || 'stk'}${v.reolNr ? ' ‚Ä¢ Reol ' + v.reolNr : ''}${v.hylleNr ? ' ‚Ä¢ Hylle ' + v.hylleNr : ''}</div>
          </div>
          <div class="count">${item.count}</div>
          <button class="remove" onclick="removeItem('${key}')">Slet</button>
        </div>
      `;
    });
    
    html += `</div>`;
  });
  
  list.innerHTML = html;
}

function removeItem(key){
  delete scannedItems[key];
  updateStats();
  renderList();
}

function clearAll(){
  if(confirm('Er du sikker p√• at du vil slette alle scannede varer?')){
    scannedItems = {};
    updateStats();
    renderList();
    updateStatus('Alle varer ryddet', 'waiting');
  }
}

// Check data connection
function checkDataConnection(){
  const storageKey = 'k√∏kkenlager_data';
  const dataStr = localStorage.getItem(storageKey);
  const currentDomain = window.location.hostname;
  
  let info = 'üìä Data Status:\n\n';
  info += 'üìç Dom√¶ne: ' + (currentDomain || 'file://') + '\n';
  info += 'üîë Storage key: ' + storageKey + '\n';
  info += 'üì¶ Data fundet: ' + (dataStr ? 'Ja' : 'Nej') + '\n\n';
  
  if (dataStr) {
    try {
      const data = JSON.parse(dataStr);
      const itemCount = data.masterVarelager ? data.masterVarelager.length : 0;
      info += '‚úÖ Varelager: ' + itemCount + ' varer\n';
      info += 'üìã Rapporter: ' + (data.reports ? data.reports.length : 0) + '\n';
      info += 'üî¢ Session counter: ' + (data.sessionCounter || 0) + '\n';
    } catch(e) {
      info += '‚ùå Fejl ved parsing: ' + e.message;
    }
  } else {
    info += '‚ö†Ô∏è Ingen data fundet.\n\n';
    if (currentDomain.includes('github.io')) {
      info += 'üí° Tip: Data deles ikke mellem dom√¶ner.\n';
      info += 'Brug hovedprogrammet p√• samme enhed f√∏rst.';
    }
  }
  
  alert(info);
  console.log('Data check:', {
    domain: currentDomain,
    hasData: !!dataStr,
    dataLength: dataStr ? dataStr.length : 0
  });
}

// Check data connection
function checkDataConnection(){
  const storageKey = 'k√∏kkenlager_data';
  const dataStr = localStorage.getItem(storageKey);
  const currentDomain = window.location.hostname;
  
  let info = 'üìä Data Status:\n\n';
  info += 'üìç Dom√¶ne: ' + (currentDomain || 'file://') + '\n';
  info += 'üîë Storage key: ' + storageKey + '\n';
  info += 'üì¶ Data fundet: ' + (dataStr ? 'Ja' : 'Nej') + '\n\n';
  
  if (dataStr) {
    try {
      const data = JSON.parse(dataStr);
      const itemCount = data.masterVarelager ? data.masterVarelager.length : 0;
      info += '‚úÖ Varelager: ' + itemCount + ' varer\n';
      info += 'üìã Rapporter: ' + (data.reports ? data.reports.length : 0) + '\n';
      info += 'üî¢ Session counter: ' + (data.sessionCounter || 0) + '\n';
    } catch(e) {
      info += '‚ùå Fejl ved parsing: ' + e.message;
    }
  } else {
    info += '‚ö†Ô∏è Ingen data fundet.\n\n';
    if (currentDomain.includes('github.io')) {
      info += 'üí° Tip: Data deles ikke mellem dom√¶ner.\n';
      info += 'Brug hovedprogrammet p√• samme enhed f√∏rst.';
    }
  }
  
  alert(info);
  console.log('Data check:', {
    domain: currentDomain,
    hasData: !!dataStr,
    dataLength: dataStr ? dataStr.length : 0
  });
}

// Scan QR code to import varelager
let qrScanMode = false;
function scanVarelagerQR(){
  if (scannerActive) {
    alert('‚ö†Ô∏è Stop scanneren f√∏rst for at scanne QR-kode.');
    return;
  }
  
  qrScanMode = true;
  updateStatus('üì± Scan QR-koden fra hovedprogrammet...', 'waiting');
  
  // Start scanner in QR mode
  startScanner();
}

// Handle varelager QR code scan
function handleVarelagerQR(qrData){
  try {
    // Remove prefix
    const base64Data = qrData.replace('VARELAGER:', '');
    
    // Decode base64
    const jsonString = decodeURIComponent(escape(atob(base64Data)));
    
    // Parse JSON
    const importedData = JSON.parse(jsonString);
    
    if (!importedData.masterVarelager || !Array.isArray(importedData.masterVarelager)) {
      updateStatus('‚ùå QR-koden indeholder ikke varelager data.', 'error');
      qrScanMode = false;
      return;
    }
    
    // Load existing data or create new
    const storageKey = 'k√∏kkenlager_data';
    let existingData = {};
    const existingStr = localStorage.getItem(storageKey);
    if (existingStr) {
      try {
        existingData = JSON.parse(existingStr);
      } catch(err) {
        console.warn('Could not parse existing data:', err);
      }
    }
    
    // Merge imported varelager with existing data
    existingData.masterVarelager = importedData.masterVarelager;
    if (importedData.lagerLokationer) {
      existingData.lagerLokationer = importedData.lagerLokationer;
    }
    
    // Save merged data
    localStorage.setItem(storageKey, JSON.stringify(existingData));
    
    // Reload items
    allItems = importedData.masterVarelager;
    
    // Store lagerLokationer for reference
    if (importedData.lagerLokationer && Array.isArray(importedData.lagerLokationer)) {
      console.log('Imported locations:', importedData.lagerLokationer);
    }
    
    // Stop scanner
    stopScanner();
    qrScanMode = false;
    
    const locationInfo = importedData.lagerLokationer && importedData.lagerLokationer.length > 0 
      ? '\nüìç Placeringer: ' + importedData.lagerLokationer.join(', ')
      : '';
    
    alert('‚úÖ Varelager importeret!\n\n' + allItems.length + ' varer er nu tilg√¶ngelige.' + locationInfo);
    updateStatus('‚úÖ Varelager importeret: ' + allItems.length + ' varer' + locationInfo, 'success');
    
    console.log('Imported varelager from QR:', allItems.length, 'items');
    console.log('Imported locations:', importedData.lagerLokationer);
  } catch(err) {
    console.error('Error importing from QR:', err);
    updateStatus('‚ùå Fejl ved import: ' + err.message, 'error');
    qrScanMode = false;
    setTimeout(() => {
      if(scannerActive){
        updateStatus('Peger p√• stregkoden...', 'scanning');
      }
    }, 3000);
  }
}

// Parse CSV to varelager format
function parseCSVToVarelager(csvContent) {
  try {
    // Remove BOM if present
    if (csvContent.charCodeAt(0) === 0xFEFF) {
      csvContent = csvContent.substring(1);
    }
    
    const lines = csvContent.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
      throw new Error('CSV filen er tom eller mangler data');
    }
    
    // Parse header
    const header = lines[0].split(';').map(h => h.trim());
    const navnIdx = header.findIndex(h => h.toLowerCase().includes('navn'));
    const maaleenhedIdx = header.findIndex(h => h.toLowerCase().includes('m√•leenhed') || h.toLowerCase().includes('maaleenhed'));
    const prisIdx = header.findIndex(h => h.toLowerCase().includes('pris'));
    const placeringIdx = header.findIndex(h => h.toLowerCase().includes('placering'));
    const reolIdx = header.findIndex(h => h.toLowerCase().includes('reol'));
    const hylleIdx = header.findIndex(h => h.toLowerCase().includes('hylle'));
    const raekkefoelgeIdx = header.findIndex(h => h.toLowerCase().includes('r√¶kkef√∏lge') || h.toLowerCase().includes('raekkefoelge'));
    
    if (navnIdx === -1) {
      throw new Error('CSV filen mangler "Navn" kolonne');
    }
    
    const masterVarelager = [];
    const locations = new Set();
    
    // Parse data rows
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(';').map(v => v.trim());
      if (values.length === 0 || !values[navnIdx]) continue;
      
      const navn = values[navnIdx];
      const maaleenhed = maaleenhedIdx >= 0 ? values[maaleenhedIdx] : 'stk';
      const pris = prisIdx >= 0 ? parseFloat(values[prisIdx].replace(',', '.')) || 0 : 0;
      const placering = placeringIdx >= 0 ? values[placeringIdx] : '';
      const reolNr = reolIdx >= 0 ? values[reolIdx] : '';
      const hylleNr = hylleIdx >= 0 ? values[hylleIdx] : '';
      const raekkefoelge = raekkefoelgeIdx >= 0 ? parseInt(values[raekkefoelgeIdx]) || 0 : 0;
      
      if (placering) locations.add(placering);
      
      // Generate ID from name (simple hash)
      const id = navn.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') + '_' + Date.now() + '_' + i;
      
      masterVarelager.push({
        id: id,
        navn: navn,
        maaleenhed: maaleenhed,
        pris: pris,
        placering: placering,
        reolNr: reolNr || undefined,
        hylleNr: hylleNr || undefined,
        raekkefoelge: raekkefoelge || undefined
      });
    }
    
    return {
      masterVarelager: masterVarelager,
      lagerLokationer: Array.from(locations).filter(l => l)
    };
  } catch(err) {
    throw new Error('Fejl ved parsing af CSV: ' + err.message);
  }
}

// Import varelager from JSON or CSV file
function importVarelager(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,.csv';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const fileContent = e.target.result;
        const fileName = file.name.toLowerCase();
        
        let importedData = null;
        
        // Check if CSV file
        if (fileName.endsWith('.csv')) {
          importedData = parseCSVToVarelager(fileContent);
        } else {
          // Try JSON
          importedData = JSON.parse(fileContent);
        }
        
        if (!importedData || !importedData.masterVarelager || !Array.isArray(importedData.masterVarelager)) {
          alert('‚ùå Filen indeholder ikke varelager data i korrekt format.\n\nForventet format:\n‚Ä¢ JSON: {masterVarelager: [...], lagerLokationer: [...]}\n‚Ä¢ CSV: Navn;M√•leenhed;Pris;Placering;Reol;Hylle;R√¶kkef√∏lge');
          return;
        }
        
        // Load existing data or create new
        const storageKey = 'k√∏kkenlager_data';
        let existingData = {};
        const existingStr = localStorage.getItem(storageKey);
        if (existingStr) {
          try {
            existingData = JSON.parse(existingStr);
          } catch(err) {
            console.warn('Could not parse existing data:', err);
          }
        }
        
        // Merge imported varelager with existing data
        existingData.masterVarelager = importedData.masterVarelager;
        if (importedData.lagerLokationer) {
          existingData.lagerLokationer = importedData.lagerLokationer;
        }
        
        // Save merged data
        localStorage.setItem(storageKey, JSON.stringify(existingData));
        
        // Reload items
        allItems = importedData.masterVarelager;
        
        const locationInfo = importedData.lagerLokationer && importedData.lagerLokationer.length > 0 
          ? '\nüìç Placeringer: ' + importedData.lagerLokationer.join(', ')
          : '';
        
        alert('‚úÖ Varelager importeret!\n\n' + allItems.length + ' varer er nu tilg√¶ngelige.' + locationInfo);
        updateStatus('‚úÖ Varelager importeret: ' + allItems.length + ' varer' + locationInfo, 'success');
        
        if (importedData.lagerLokationer && Array.isArray(importedData.lagerLokationer)) {
          console.log('Imported locations:', importedData.lagerLokationer);
        }
        
        console.log('Imported varelager:', allItems.length, 'items');
      } catch(err) {
        alert('‚ùå Fejl ved import: ' + err.message);
        console.error('Import error:', err);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

async function stopScanner(){
  scannerActive = false;
  const status = document.getElementById('status');
  const video = document.getElementById('scannerVideo');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  
  if(html5QrCode){
    try {
      if(html5QrCode.isScanning){
        await html5QrCode.stop();
      }
      html5QrCode.clear();
    } catch(err){
      console.warn('Fejl ved stop:', err);
    }
    html5QrCode = null;
  }
  
  video.style.display = 'none';
  startBtn.style.display = 'block';
  stopBtn.style.display = 'none';
  updateStatus('Scanner stoppet', 'waiting');
}

function finishSession(){
  const items = Object.values(scannedItems);
  if(items.length === 0){
    updateStatus('‚ö†Ô∏è Ingen varer scannet. Tilf√∏j varer f√∏r du afslutter.', 'error');
    return;
  }
  
  if(scannerActive){
    stopScanner();
  }
  
  try {
    // Group items by location
    const itemsByLocation = {};
    items.forEach(item => {
      const location = item.vare.placering || 'Ikke angivet';
      if (!itemsByLocation[location]) {
        itemsByLocation[location] = [];
      }
      itemsByLocation[location].push(item);
    });
    
    // Get session counter from main app
    const storageKey = 'k√∏kkenlager_data';
    let data = {};
    const existingData = localStorage.getItem(storageKey);
    if (existingData) {
      try {
        data = JSON.parse(existingData);
      } catch (e) {
        console.error('Error parsing existing data:', e);
        data = {};
      }
    }
    
    // Get current sessionCounter and increment
    let currentSessionCounter = data.sessionCounter || 0;
    currentSessionCounter++;
    const sessionCounter = currentSessionCounter;
    
    // Create ONE report with all items (not one per location)
    const details = [];
    let grandTotal = 0;
    
    // Process all items and group by location for scope
    const allLocations = new Set();
    
    items.forEach(item => {
      const v = item.vare;
      const antal = Number(item.count) || 0;
      if (antal <= 0) return; // Skip items with zero count
      
      const pris = Number(v.pris) || 0;
      const linjetotal = antal * pris;
      grandTotal += linjetotal;
      
      const placering = v.placering || 'Ikke angivet';
      allLocations.add(placering);
      
      const detailItem = {
        vareId: v.id,
        navn: v.navn || 'Ukendt',
        maaleenhed: v.maaleenhed || 'stk',
        pris: pris,
        antal: antal,
        linjetotal: linjetotal,
        placering: placering
      };
      
      // Add reol and hylle if they exist
      if (v.reolNr) detailItem.reolNr = v.reolNr;
      if (v.hylleNr) detailItem.hylleNr = v.hylleNr;
      
      details.push(detailItem);
    });
    
    // Generate unique report name: OPTA-000004 format
    const reportName = `OPTA-${String(sessionCounter).padStart(6, '0')}`;
    
    // Determine scope (all locations or single location)
    const scope = allLocations.size === 1 ? Array.from(allLocations)[0] : Array.from(allLocations).join(', ');
    
    // Create ONE report with all items
    const report = {
      ts: Date.now(),
      handling: reportName,
      type: 'session',
      scope: scope,
      details: details,
      total: grandTotal
    };
    
    const reports = [report]; // Only one report
    
    // Preserve ALL existing data
    if (!data.reports || !Array.isArray(data.reports)) {
      data.reports = [];
    }
    
    // Check if report already exists (by name and timestamp)
    const reportExists = data.reports.some(r => 
      r.handling === report.handling && 
      Math.abs(r.ts - report.ts) < 1000
    );
    
    if (!reportExists) {
      // Add report to beginning of reports array
      data.reports.unshift(report);
      console.log('‚úÖ New report added:', report.handling, 'with', details.length, 'items');
    } else {
      console.log('‚ö†Ô∏è Report already exists:', report.handling);
    }
    
    // Update sessionCounter
    data.sessionCounter = sessionCounter;
    
    // Clear active session
    data.activeSession = null;
    
    // Add/update metadata
    data.version = data.version || '1.0';
    data.savedAt = Date.now();
    
    // Add unique installation ID for tracking
    if (!data.installationId) {
      // Generate unique ID if not exists
      data.installationId = 'SCANNER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
    }
    
    // Add report metadata
    report.source = 'stregkode-scanner';
    report.installationId = data.installationId;
    
    // Save all data to localStorage
    const savedData = JSON.stringify(data);
    try {
      localStorage.setItem(storageKey, savedData);
      localStorage.removeItem('activeSession');
      
      // Verify save was successful
      const verifyData = localStorage.getItem(storageKey);
      if (!verifyData) {
        throw new Error('Kunne ikke gemme data i localStorage');
      }
      
      console.log('‚úÖ Data saved and verified. Report:', reportName, 'Items:', details.length);
    } catch(saveErr) {
      console.error('Save error:', saveErr);
      alert('‚ö†Ô∏è Fejl ved gemning af rapport!\n\n' + saveErr.message + '\n\nPr√∏v at genindl√¶se siden og pr√∏v igen.');
      throw saveErr;
    }
    
    const totalItems = items.reduce((sum, item) => sum + item.count, 0);
    const uniqueItems = items.length;
    const locationsCount = allLocations.size;
    
    updateStatus(`‚úÖ Rapport oprettet! ${reportName} - ${uniqueItems} unikke varer, ${totalItems} total antal i ${locationsCount} lokation(er)`, 'success');
    
    console.log('‚úÖ Report saved successfully:', reportName, 'with', details.length, 'items, total:', grandTotal);
    
    // Clear scanned items
    scannedItems = {};
    updateStats();
    renderList();
    
    // Check if running on same domain as main program
    const currentDomain = window.location.hostname;
    const isSameDomain = currentDomain && !currentDomain.includes('github.io') && currentDomain !== '';
    
    let exportInfo = '';
    if (isSameDomain) {
      exportInfo = `\n\n‚úÖ Rapporterne er automatisk synkroniseret med hovedprogrammet!\n\nüí° Tip: G√• til hovedprogrammet og klik "üîÑ Synkroniser Rapporter" for at opdatere listen.`;
    } else {
      exportInfo = `\n\nüí° Tip: For at f√• rapporterne ind i hovedprogrammet:\n\n1. Klik "üì§ Eksport rapporter" knappen nedenfor\n2. I hovedprogrammet: "Ops√¶tning" ‚Üí "Import data" ‚Üí "üì∑ Importer Scanner Data"\n3. V√¶lg den downloadede fil\n\nEller brug "üîÑ Synkroniser Rapporter" i hovedprogrammet hvis begge k√∏rer p√• samme enhed.`;
    }
    
    // Verify report was saved
    const verifyData = localStorage.getItem(storageKey);
    let saveStatus = '';
    if (verifyData) {
      try {
        const verify = JSON.parse(verifyData);
        const found = verify.reports && verify.reports.some(r => r.handling === reportName);
        if (found) {
          saveStatus = '\n\n‚úÖ Rapport gemt og verificeret!';
        } else {
          saveStatus = '\n\n‚ö†Ô∏è Rapport gemt, men verificering fejlede.';
        }
      } catch(e) {
        saveStatus = '\n\n‚ö†Ô∏è Kunne ikke verificere gemning.';
      }
    }
    
    alert(`‚úÖ Opt√¶lling afsluttet!\n\nüìã Rapport: ${reportName}\nüìä ${uniqueItems} unikke varer, ${totalItems} total antal\nüìç ${locationsCount} lokation(er)\nüí∞ Total v√¶rdi: ${grandTotal.toFixed(2)} kr.${saveStatus}${exportInfo}`);
    
  } catch(err){
    console.error('Fejl ved oprettelse af rapport:', err);
    updateStatus('Fejl ved oprettelse af rapport: ' + err.message, 'error');
  }
}

// Export reports for transfer to main program
function exportReports(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    
    if (!dataStr) {
      alert('‚ö†Ô∏è Ingen data fundet at eksportere.');
      return;
    }
    
    const data = JSON.parse(dataStr);
    
    if (!data.reports || !Array.isArray(data.reports) || data.reports.length === 0) {
      alert('‚ö†Ô∏è Ingen rapporter at eksportere.\n\nAfslut en opt√¶lling f√∏rst.');
      return;
    }
    
    // Filter only scanner reports (reports created by this app - OPTA- format)
    const scannerReports = data.reports.filter(r => 
      r.handling && (r.handling.startsWith('OPTA-') || r.handling.startsWith('Stregkode scanner'))
    );
    
    if (scannerReports.length === 0) {
      alert('‚ö†Ô∏è Ingen scanner rapporter at eksportere.\n\nAfslut en opt√¶lling f√∏rst.');
      return;
    }
    
    // Get or create installation ID
    if (!data.installationId) {
      data.installationId = 'SCANNER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      // Save installation ID
      localStorage.setItem(storageKey, JSON.stringify(data));
    }
    const installationId = data.installationId;
    
    // Create export data
    const exportData = {
      reports: scannerReports,
      sessionCounter: data.sessionCounter || 0,
      exportedAt: Date.now(),
      version: '1.0',
      source: 'stregkode-scanner',
      installationId: installationId
    };
    
    // Create download
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `scanner-rapporter-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    const reportNames = scannerReports.map(r => r.handling || 'Ukendt').join(', ');
    alert(`‚úÖ ${scannerReports.length} rapport(er) eksporteret!\n\nüìã Rapporter: ${reportNames}\nüì• Filen er downloadet.\n\nüí° I hovedprogrammet:\n1. G√• til "Ops√¶tning" ‚Üí "Import data"\n2. Klik "üì∑ Importer Scanner Data"\n3. V√¶lg den downloadede fil\n4. Rapporterne importeres automatisk!\n\nüîó Installation ID: ${installationId.substring(0, 20)}...`);
    
  } catch(err) {
    console.error('Fejl ved eksport:', err);
    alert('‚ùå Fejl ved eksport: ' + err.message);
  }
}

// Wait for DOM and library to load
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing scanner...');
  
  // Check if Html5Qrcode library is loaded
  if (typeof Html5Qrcode === 'undefined') {
    console.warn('Html5Qrcode library not loaded yet, waiting...');
    // Wait a bit for library to load
    setTimeout(function() {
      if (typeof Html5Qrcode === 'undefined') {
        updateStatus('‚ö†Ô∏è Scanner bibliotek ikke indl√¶st. Genindl√¶s siden.', 'error');
        console.error('Html5Qrcode library still not loaded after timeout');
      } else {
        console.log('Html5Qrcode library loaded successfully');
        initializeApp();
      }
    }, 1000);
  } else {
    console.log('Html5Qrcode library already loaded');
    initializeApp();
  }
});

function initializeApp() {
  console.log('Initializing app...');
  
  if(loadItemsFromMainApp()){
    updateStatus('Klar til scanning - Klik "Start Scanner"', 'waiting');
    console.log('App initialized successfully');
  } else {
    updateStatus('‚ö†Ô∏è Ingen varelager data fundet. Opret varer i hovedprogrammet f√∏rst.', 'error');
    console.warn('No varelager data found');
  }
}

// Also try to initialize immediately (in case DOM is already loaded)
if (document.readyState === 'loading') {
  // DOM is still loading, wait for DOMContentLoaded
  console.log('DOM still loading, waiting for DOMContentLoaded...');
} else {
  // DOM is already loaded
  console.log('DOM already loaded, initializing immediately...');
  if (typeof Html5Qrcode === 'undefined') {
    setTimeout(function() {
      if (typeof Html5Qrcode !== 'undefined') {
        initializeApp();
      }
    }, 500);
  } else {
    initializeApp();
  }
}
</script>
</body>
</html>
