<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<meta name="theme-color" content="#4CAF50" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Stregkode Scanner" />
<link rel="manifest" href="stregkode-scanner-manifest.json" />
<title>Stregkode Scanner - Telefon</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f5f5f5;padding:10px;max-width:600px;margin:0 auto}
.header{background:#4CAF50;color:#fff;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center}
.header h1{font-size:20px;margin-bottom:5px}
.header p{font-size:13px;opacity:0.9}
.scanner-container{background:#fff;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
#scannerVideo{width:100%;max-height:60vh;border:3px solid #4CAF50;border-radius:8px;background:#000;display:none;position:relative}
.status{padding:10px;margin:10px 0;border-radius:6px;text-align:center;font-weight:700;min-height:50px;display:flex;align-items:center;justify-content:center}
.status.waiting{background:#fff3cd;color:#856404}
.status.scanning{background:#d4edda;color:#155724}
.status.success{background:#d1ecf1;color:#0c5460}
.status.error{background:#f8d7da;color:#721c24;white-space:pre-line}
.button{width:100%;padding:15px;margin:8px 0;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;background:#4CAF50;color:#fff}
.button:active{opacity:0.8}
.button.secondary{background:#6c757d}
.button.danger{background:#dc3545}
.scanned-list{background:#fff;border-radius:8px;padding:15px;margin-top:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1);max-height:40vh;overflow-y:auto}
.scanned-item{padding:10px;margin:5px 0;background:#f8f9fa;border-radius:6px;border-left:4px solid #4CAF50;display:flex;justify-content:space-between;align-items:center}
.scanned-item .info{flex:1}
.scanned-item .name{font-weight:700;font-size:16px;color:#333}
.scanned-item .details{font-size:12px;color:#666;margin-top:3px}
.scanned-item .count{font-size:20px;font-weight:700;color:#4CAF50;margin-left:10px;min-width:40px;text-align:center}
.scanned-item .remove{background:#dc3545;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:12px;margin-left:5px}
.actions{display:flex;gap:10px;margin-top:15px}
.actions .button{flex:1}
.empty{text-align:center;padding:20px;color:#999}
.stats{display:flex;gap:15px;margin:15px 0;padding:15px;background:#f8f9fa;border-radius:8px}
.stat{text-align:center;flex:1}
.stat-value{font-size:24px;font-weight:700;color:#4CAF50}
.stat-label{font-size:12px;color:#666;margin-top:5px}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:1000}
.modal.hidden{display:none}
.modal-content{background:white;padding:25px;border-radius:12px;max-width:400px;width:90%;box-shadow:0 4px 20px rgba(0,0,0,0.3)}
.modal-content h3{margin:0 0 15px 0;font-size:20px;color:#333}
.modal-content input[type="number"]{width:100%;padding:15px;font-size:24px;text-align:center;border:2px solid #4CAF50;border-radius:8px;margin:10px 0}
.modal-buttons{display:flex;gap:10px;margin-top:20px}
.modal-buttons button{flex:1;padding:12px;font-size:16px;border-radius:8px;border:none;cursor:pointer;font-weight:600}
</style>
</head>
<body>
<div class="header">
  <h1>üì± Stregkode Scanner</h1>
  <p>Scan stregkoder med din telefon - V 3.9</p>
</div>

<div class="scanner-container">
  <div id="status" class="status waiting">Klik "Start Scanner" for at begynde</div>
  <div id="scannerVideo"></div>
  <button id="startBtn" class="button" onclick="showLocationSelection()">üì∑ Start Opt√¶lling</button>
  <button id="stopBtn" class="button secondary" onclick="stopScanner()" style="display:none">‚èπ Stop Scanner</button>
</div>

<div class="stats" id="stats" style="display:none">
  <div class="stat">
    <div class="stat-value" id="totalScanned">0</div>
    <div class="stat-label">Total scannet</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="uniqueItems">0</div>
    <div class="stat-label">Unikke varer</div>
  </div>
</div>

<div class="scanned-list">
  <h3 style="margin-bottom:10px">Scannede varer (<span id="count">0</span>)</h3>
  <div id="scannedList">
    <div class="empty">Ingen varer scannet endnu</div>
  </div>
  <div class="actions">
    <button class="button secondary" onclick="clearAll()" style="font-size:14px; padding:12px 18px; border-radius:8px; font-weight:600;">üóë Ryd alt</button>
    <button class="button secondary" onclick="scanVarelagerQR()" style="font-size:14px; padding:12px 18px; background:#4CAF50; color:white; border-radius:8px; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">üì• Scan QR-kode</button>
    <button class="button secondary" onclick="fetchVarelagerFromServer()" style="font-size:14px; padding:12px 18px; background:#17a2b8; color:white; border-radius:8px; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">‚òÅÔ∏è Hent varelager fra server</button>
    <button class="button secondary" onclick="uploadReportsToServer()" style="font-size:14px; padding:12px 18px; background:#28a745; color:white; border-radius:8px; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">‚òÅÔ∏è Upload til server</button>
    <button class="button" onclick="finishSession()" style="font-size:16px; padding:14px 24px; border-radius:8px; font-weight:700; box-shadow:0 3px 6px rgba(0,0,0,0.3);">‚úÖ Afslut opt√¶lling</button>
  </div>
</div>

<!-- Modal til lokationsvalg -->
<div id="locationModal" class="modal hidden">
  <div class="modal-content">
    <h3>üìç V√¶lg Lokation</h3>
    <p style="margin-bottom:15px; color:#666; font-size:14px;">V√¶lg hvilken lokation du vil opt√¶lle. Du kan v√¶lge "Alle lokationer" for at opt√¶lle alle.</p>
    <div style="margin:20px 0">
      <label for="locationSelect" style="display:block;margin-bottom:8px;font-weight:600;">Lokation:</label>
      <select id="locationSelect" style="width:100%;padding:15px;font-size:16px;border:2px solid #4CAF50;border-radius:8px;">
        <option value="">Alle lokationer</option>
      </select>
    </div>
    <div class="modal-buttons">
      <button onclick="cancelLocationSelection()" style="background:#6c757d;color:white;">Annuller</button>
      <button onclick="confirmLocationSelection()" style="background:#4CAF50;color:white;">Start Opt√¶lling</button>
    </div>
  </div>
</div>

<!-- Modal til antalsindtastning -->
<div id="quantityModal" class="modal hidden">
  <div class="modal-content">
    <h3>Indtast antal</h3>
    <p id="scannedCodeDisplay" style="font-size:16px;font-weight:600;margin:15px 0;color:#4CAF50;"></p>
    <div style="margin:20px 0">
      <label for="quantityInput" style="display:block;margin-bottom:8px;font-weight:600;">Antal:</label>
      <input type="number" id="quantityInput" min="1" value="1" style="width:100%;padding:15px;font-size:24px;text-align:center;border:2px solid #4CAF50;border-radius:8px;" autofocus onkeypress="if(event.key==='Enter') confirmQuantityInput()">
    </div>
    <div class="modal-buttons">
      <button onclick="cancelQuantityInput()" style="background:#6c757d;color:white;">Annuller</button>
      <button onclick="confirmQuantityInput()" style="background:#4CAF50;color:white;">Gem</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let scannerActive = false;
let html5QrCode = null;
let scannedItems = {};
let allItems = [];
let lastScannedCode = null;
let lastScanTime = 0;
let selectedLocation = ''; // Selected location for current session
let availableLocations = []; // Available locations from varelager
let pendingScannedCode = null; // For quantity dialog
const SCAN_COOLDOWN = 1000;

// Load items from main app
function loadItemsFromMainApp(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    
    console.log('Checking localStorage for key:', storageKey);
    console.log('Data found:', !!dataStr);
    
    if (!dataStr) {
      // No data found - allow scanning anyway but warn user
      const currentDomain = window.location.hostname;
      const isGitHub = currentDomain.includes('github.io');
      
      if (isGitHub) {
        updateStatus('‚ö†Ô∏è Ingen varelager data fundet.\n\nDu kan stadig scanne stregkoder, men varer vil ikke blive matchet.\n\nüí° Tip: Eksporter data fra hovedprogrammet og importer her.', 'error');
      } else {
        updateStatus('‚ö†Ô∏è Ingen varelager data fundet.\n\nDu kan stadig scanne stregkoder.\n\nüí° Tip: √Öbn hovedprogrammet p√• samme enhed f√∏rst.', 'error');
      }
      
      allItems = [];
      return false; // Return false but don't block the app
    }
    
    const data = JSON.parse(dataStr);
    console.log('Parsed data keys:', Object.keys(data));
    console.log('masterVarelager length:', data.masterVarelager ? data.masterVarelager.length : 0);
    
    allItems = data.masterVarelager || [];
    
    // Load available locations from lagerLokationer
    availableLocations = data.lagerLokationer || [];
    if (availableLocations.length === 0 && allItems.length > 0) {
      // Extract unique locations from items if lagerLokationer is not available
      const uniqueLocs = [...new Set(allItems.map(item => item.placering).filter(p => p))];
      availableLocations = uniqueLocs;
    }
    
    // Sync installation ID from main program if available - ALWAYS update to match
    if (data.mainInstallationId) {
      // Extract numeric part from main ID (e.g., "INST-123456" -> "123456")
      const mainIdNum = data.mainInstallationId.replace(/[^0-9]/g, '');
      // Create matching scanner ID
      const newScannerId = 'SCANNER-' + mainIdNum;
      // Always update to ensure they match
      if (data.scannerInstallationId !== newScannerId || !data.installationId || !data.installationId.startsWith('SCANNER-')) {
        data.scannerInstallationId = newScannerId;
        data.installationId = newScannerId;
        localStorage.setItem(storageKey, JSON.stringify(data));
        console.log('‚úÖ ID synkroniseret fra hovedprogram:', {
          main: data.mainInstallationId,
          scanner: newScannerId
        });
      }
    }
    
    if (allItems.length === 0) {
      updateStatus('‚ö†Ô∏è Varelageret er tomt.\n\nDu kan stadig scanne stregkoder.', 'error');
      return false;
    }
    
    console.log('‚úÖ Indl√¶st ' + allItems.length + ' varer fra hovedprogrammet');
    return true;
  } catch (err) {
    console.error('Fejl ved indl√¶sning af varer:', err);
    updateStatus('Fejl ved indl√¶sning af varer: ' + err.message + '\n\nDu kan stadig scanne stregkoder.', 'error');
    allItems = [];
    return false;
  }
}

function updateStatus(text, type){
  const status = document.getElementById('status');
  status.textContent = text;
  status.className = 'status ' + (type || 'waiting');
}

// Show location selection modal
function showLocationSelection() {
  // Load items first to get locations
  loadItemsFromMainApp();
  
  const modal = document.getElementById('locationModal');
  const select = document.getElementById('locationSelect');
  
  if (!modal || !select) return;
  
  // Populate location dropdown
  select.innerHTML = '<option value="">Alle lokationer</option>';
  availableLocations.forEach(loc => {
    const option = document.createElement('option');
    option.value = loc;
    option.textContent = loc;
    select.appendChild(option);
  });
  
  // If no locations available, show message
  if (availableLocations.length === 0) {
    select.innerHTML = '<option value="">Ingen lokationer fundet - brug "Alle lokationer"</option>';
  }
  
  modal.classList.remove('hidden');
}

// Confirm location selection and start scanner
function confirmLocationSelection() {
  const select = document.getElementById('locationSelect');
  if (!select) return;
  
  selectedLocation = select.value || '';
  hideLocationModal();
  
  // Start scanner after location is selected
  startScannerAfterLocation();
}

// Cancel location selection
function cancelLocationSelection() {
  hideLocationModal();
}

// Hide location modal
function hideLocationModal() {
  const modal = document.getElementById('locationModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

// Start scanner after location is selected
async function startScannerAfterLocation(){
  if(scannerActive){
    stopScanner();
    return;
  }
  
  // Allow scanning even without varelager data
  if (allItems.length === 0) {
    console.warn('No varelager data - scanning will work but items won\'t be matched');
  }
  
  const status = document.getElementById('status');
  const video = document.getElementById('scannerVideo');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  
  const isSecure = window.location.protocol === 'https:' || 
                   window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1';
  
  if(!isSecure && window.location.protocol === 'file:'){
    updateStatus('‚ö†Ô∏è KAMERA KR√ÜVER WEBSERVER\n\nFilen skal hostes p√• en webserver for at kameraet virker.\n\nBrug webserveren fra hovedprogrammet eller GitHub Pages.', 'error');
    return;
  }
  
  if(typeof Html5Qrcode === 'undefined'){
    updateStatus('‚ö†Ô∏è Scanner bibliotek ikke indl√¶st.\n\nGenindl√¶s siden og tjek din internetforbindelse.', 'error');
    console.error('Html5Qrcode library not available');
    return;
  }
  
  updateStatus('Starter kamera...', 'waiting');
  
  try {
    // Stop existing scanning first if active
    if (html5QrCode && html5QrCode.isScanning) {
      try {
        await html5QrCode.stop();
        html5QrCode.clear();
      } catch (stopErr) {
        console.warn('Fejl ved stop af eksisterende scanning:', stopErr);
      }
    }
    
    video.style.display = 'block';
    scannerActive = true;
    
    // Clear video container first
    video.innerHTML = '';
    
    html5QrCode = new Html5Qrcode("scannerVideo");
    
    // Configuration optimized for mobile
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    const qrboxSize = isMobile ? Math.min(250, window.innerWidth * 0.8) : 250;
    
    const config = {
      fps: 10,
      qrbox: { width: qrboxSize, height: qrboxSize },
      aspectRatio: 1.0
    };
    
    // Try to get back camera first
    let cameraId = { facingMode: "environment" };
    try {
      const devices = await Html5Qrcode.getCameras();
      if (devices && devices.length > 0) {
        const backCamera = devices.find(device => 
          device.label.toLowerCase().includes('back') || 
          device.label.toLowerCase().includes('rear') ||
          device.label.toLowerCase().includes('environment')
        );
        if (backCamera) {
          cameraId = backCamera.id;
          console.log('Using back camera:', backCamera.label);
        } else {
          cameraId = devices[0].id;
          console.log('Using first available camera:', devices[0].label);
        }
      }
    } catch (camErr) {
      console.warn('Could not enumerate cameras, using default:', camErr);
      // Continue with default facingMode
    }
    
    await html5QrCode.start(
      cameraId,
      config,
      (decodedText, decodedResult) => {
        console.log('‚úÖ Scannet stregkode/QR-kode:', decodedText);
        const now = Date.now();
        
        if (now - lastScanTime < SCAN_COOLDOWN && decodedText === lastScannedCode) {
          return;
        }
        
        lastScannedCode = decodedText;
        lastScanTime = now;
        
        // Check if this is a varelager QR code
        if (qrScanMode && decodedText.startsWith('VARELAGER:')) {
          handleVarelagerQR(decodedText);
        } else if (!qrScanMode) {
          // Show quantity dialog without stopping scanner
          // Scanner continues in background
          showQuantityDialog(decodedText);
        }
      },
      (errorMessage) => {
        // Ignorer scanning fejl - de er normale n√•r der ikke er fundet noget
      }
    );
    
    updateStatus('Peger p√• stregkoden...', 'scanning');
    startBtn.style.display = 'none';
    stopBtn.style.display = 'block';
    document.getElementById('stats').style.display = 'flex';
    
  } catch(err){
    console.error('Kamera fejl:', err);
    scannerActive = false;
    let errorMsg = '';
    let instructions = '';
    if(err.name === 'NotAllowedError'){
      errorMsg = 'Kamera tilladelse n√¶gtet.';
      instructions = 'Giv tilladelse til kamera:\n1. Klik p√• kamera-ikonet i browserens adresselinje\n2. V√¶lg "Tillad" for kamera\n3. Genindl√¶s siden og pr√∏v igen';
    } else if(err.name === 'NotFoundError'){
      errorMsg = 'Ingen kamera fundet.';
      instructions = 'Tjek at dit kamera er tilsluttet og ikke bruges af andre programmer.';
    } else {
      errorMsg = 'Kunne ikke starte scanner: ' + (err.message || err.name);
      instructions = 'Pr√∏v:\n1. Genindl√¶s siden\n2. Tjek browser tilladelser for kamera\n3. S√∏rg for at filen hostes p√• en webserver';
    }
    updateStatus(errorMsg + '\n\n' + instructions, 'error');
    startBtn.style.display = 'block';
    stopBtn.style.display = 'none';
    video.style.display = 'none';
  }
}

// Show quantity dialog when barcode is scanned
function showQuantityDialog(barcode){
  pendingScannedCode = barcode;
  const modal = document.getElementById('quantityModal');
  const codeDisplay = document.getElementById('scannedCodeDisplay');
  const quantityInput = document.getElementById('quantityInput');
  
  // Find item to show name
  const item = allItems.find(v => v.id === barcode);
  if (item) {
    codeDisplay.textContent = item.navn + ' (' + barcode + ')';
  } else {
    codeDisplay.textContent = 'Stregkode: ' + barcode;
  }
  
  quantityInput.value = '1';
  quantityInput.focus();
  quantityInput.select();
  
  modal.classList.remove('hidden');
}

// Confirm quantity and add item
function confirmQuantityInput(){
  const modal = document.getElementById('quantityModal');
  const quantityInput = document.getElementById('quantityInput');
  const quantity = parseInt(quantityInput.value) || 1;
  
  if (quantity <= 0) {
    alert('‚ö†Ô∏è Antal skal v√¶re st√∏rre end 0');
    quantityInput.focus();
    return;
  }
  
  if (pendingScannedCode) {
    handleScannedBarcode(pendingScannedCode, quantity);
    pendingScannedCode = null;
  }
  
  modal.classList.add('hidden');
  
  // Scanner continues automatically - no need to restart
  if (scannerActive && !qrScanMode) {
    updateStatus('Peger p√• stregkoden...', 'scanning');
  }
}

// Cancel quantity input
function cancelQuantityInput(){
  const modal = document.getElementById('quantityModal');
  pendingScannedCode = null;
  modal.classList.add('hidden');
  
  // Scanner continues automatically - no need to restart
  if (scannerActive && !qrScanMode) {
    updateStatus('Peger p√• stregkoden...', 'scanning');
  }
}

function handleScannedBarcode(barcode, quantity = 1){
  // Try to find item in varelager
  const item = allItems.find(v => v.id === barcode);
  
  if (!item) {
    // Item not found - still add it but with limited info
    if (!scannedItems[barcode]) {
      scannedItems[barcode] = {
        vare: {
          id: barcode,
          navn: 'Ukendt vare (' + barcode + ')',
          placering: 'Ikke angivet',
          maaleenhed: 'stk',
          pris: 0,
          reolNr: null, // Explicitly set to null
          hylleNr: null // Explicitly set to null
        },
        count: 0
      };
    }
    
    scannedItems[barcode].count += quantity;
    updateStatus('‚ö†Ô∏è Vare ikke fundet: ' + barcode + '\n(Tilf√∏jet: ' + quantity + ')', 'error');
    
    updateStats();
    renderList();
    
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
    
    return;
  }
  
  // Item found - add normally
  // Ensure all fields are present from varelager
  if (!scannedItems[barcode]) {
    scannedItems[barcode] = {
      vare: {
        id: item.id,
        navn: item.navn || 'Ukendt vare',
        placering: item.placering || 'Ikke angivet',
        maaleenhed: item.maaleenhed || 'stk',
        pris: item.pris || 0,
        reolNr: item.reolNr || null,
        hylleNr: item.hylleNr || null
      },
      count: 0
    };
  }
  
  scannedItems[barcode].count += quantity;
  
  const itemName = item.navn || 'Ukendt vare';
  updateStatus('‚úÖ ' + itemName + ' tilf√∏jet: ' + quantity, 'success');
  
  updateStats();
  renderList();
  
  if (navigator.vibrate) {
    navigator.vibrate(50);
  }
}

function updateStats(){
  const total = Object.values(scannedItems).reduce((sum, item) => sum + item.count, 0);
  const unique = Object.keys(scannedItems).length;
  
  document.getElementById('totalScanned').textContent = total;
  document.getElementById('uniqueItems').textContent = unique;
  document.getElementById('count').textContent = total;
}

function renderList(){
  const list = document.getElementById('scannedList');
  const items = Object.values(scannedItems);
  
  if(items.length === 0){
    list.innerHTML = '<div class="empty">Ingen varer scannet endnu</div>';
    return;
  }
  
  // Group by location
  const itemsByLocation = {};
  items.forEach(item => {
    const location = item.vare.placering || 'Ikke angivet';
    if (!itemsByLocation[location]) {
      itemsByLocation[location] = [];
    }
    itemsByLocation[location].push(item);
  });
  
  let html = '';
  Object.keys(itemsByLocation).sort().forEach(location => {
    html += `<div style="margin-bottom:15px; padding:10px; background:#f0f0f0; border-radius:6px;">`;
    html += `<div style="font-weight:700; font-size:14px; color:#4CAF50; margin-bottom:8px;">üìç ${location}</div>`;
    
    itemsByLocation[location].forEach((item, idx) => {
      const v = item.vare;
      const key = Object.keys(scannedItems).find(k => scannedItems[k] === item);
      html += `
        <div class="scanned-item">
          <div class="info">
            <div class="name">${v.navn}</div>
            <div class="details">${v.maaleenhed || 'stk'}${v.reolNr ? ' ‚Ä¢ Reol ' + v.reolNr : ''}${v.hylleNr ? ' ‚Ä¢ Hylle ' + v.hylleNr : ''}</div>
          </div>
          <div class="count">${item.count}</div>
          <button class="remove" onclick="removeItem('${key}')">Slet</button>
        </div>
      `;
    });
    
    html += `</div>`;
  });
  
  list.innerHTML = html;
}

function removeItem(key){
  delete scannedItems[key];
  updateStats();
  renderList();
}

function clearAll(){
  if(confirm('Er du sikker p√• at du vil slette alle scannede varer?')){
    scannedItems = {};
    selectedLocation = ''; // Reset location
    updateStats();
    renderList();
    updateStatus('Alle varer ryddet', 'waiting');
  }
}

// Check data connection
// checkDataConnection function removed - not needed

// Scan QR code to import varelager
let qrScanMode = false;
function scanVarelagerQR(){
  if (scannerActive) {
    alert('‚ö†Ô∏è Stop scanneren f√∏rst for at scanne QR-kode.');
    return;
  }
  
  qrScanMode = true;
  updateStatus('üì± Scan QR-koden fra hovedprogrammet...', 'waiting');
  
  // Start scanner in QR mode
  startScanner();
}

// Handle varelager QR code scan
function handleVarelagerQR(qrData){
  try {
    // Remove prefix
    const base64Data = qrData.replace('VARELAGER:', '');
    
    // Decode base64
    const jsonString = decodeURIComponent(escape(atob(base64Data)));
    
    // Parse JSON
    const importedData = JSON.parse(jsonString);
    
    if (!importedData.masterVarelager || !Array.isArray(importedData.masterVarelager)) {
      updateStatus('‚ùå QR-koden indeholder ikke varelager data.', 'error');
      qrScanMode = false;
      return;
    }
    
    // Load existing data or create new
    const storageKey = 'k√∏kkenlager_data';
    let existingData = {};
    const existingStr = localStorage.getItem(storageKey);
    if (existingStr) {
      try {
        existingData = JSON.parse(existingStr);
      } catch(err) {
        console.warn('Could not parse existing data:', err);
      }
    }
    
    // Merge imported varelager with existing data
    existingData.masterVarelager = importedData.masterVarelager;
    if (importedData.lagerLokationer) {
      existingData.lagerLokationer = importedData.lagerLokationer;
    }
    
    // Sync installation ID from main program - ALWAYS update to match
    if (importedData.mainInstallationId) {
      existingData.mainInstallationId = importedData.mainInstallationId;
      // Extract numeric part from main ID (e.g., "INST-123456" -> "123456")
      const mainIdNum = importedData.mainInstallationId.replace(/[^0-9]/g, '');
      // Create matching scanner ID
      const newScannerId = 'SCANNER-' + mainIdNum;
      existingData.scannerInstallationId = newScannerId;
      existingData.installationId = newScannerId;
      console.log('‚úÖ ID synkroniseret fra hovedprogram:', {
        main: importedData.mainInstallationId,
        scanner: newScannerId
      });
    }
    
    // Save merged data
    localStorage.setItem(storageKey, JSON.stringify(existingData));
    
    // Reload items
    allItems = importedData.masterVarelager;
    
    // Store lagerLokationer for reference
    if (importedData.lagerLokationer && Array.isArray(importedData.lagerLokationer)) {
      console.log('Imported locations:', importedData.lagerLokationer);
    }
    
    // Stop scanner
    stopScanner();
    qrScanMode = false;
    
    const locationInfo = importedData.lagerLokationer && importedData.lagerLokationer.length > 0 
      ? '\nüìç Placeringer: ' + importedData.lagerLokationer.join(', ')
      : '';
    
    alert('‚úÖ Varelager importeret!\n\n' + allItems.length + ' varer er nu tilg√¶ngelige.' + locationInfo);
    updateStatus('‚úÖ Varelager importeret: ' + allItems.length + ' varer' + locationInfo, 'success');
    
    console.log('Imported varelager from QR:', allItems.length, 'items');
    console.log('Imported locations:', importedData.lagerLokationer);
  } catch(err) {
    console.error('Error importing from QR:', err);
    updateStatus('‚ùå Fejl ved import: ' + err.message, 'error');
    qrScanMode = false;
    setTimeout(() => {
      if(scannerActive){
        updateStatus('Peger p√• stregkoden...', 'scanning');
      }
    }, 3000);
  }
}

// Parse CSV to varelager format
function parseCSVToVarelager(csvContent) {
  try {
    // Remove BOM if present
    if (csvContent.charCodeAt(0) === 0xFEFF) {
      csvContent = csvContent.substring(1);
    }
    
    const lines = csvContent.split('\n').filter(line => line.trim());
    if (lines.length < 2) {
      throw new Error('CSV filen er tom eller mangler data');
    }
    
    // Parse header
    const header = lines[0].split(';').map(h => h.trim());
    const navnIdx = header.findIndex(h => h.toLowerCase().includes('navn'));
    const maaleenhedIdx = header.findIndex(h => h.toLowerCase().includes('m√•leenhed') || h.toLowerCase().includes('maaleenhed'));
    const prisIdx = header.findIndex(h => h.toLowerCase().includes('pris'));
    const placeringIdx = header.findIndex(h => h.toLowerCase().includes('placering'));
    const reolIdx = header.findIndex(h => h.toLowerCase().includes('reol'));
    const hylleIdx = header.findIndex(h => h.toLowerCase().includes('hylle'));
    const raekkefoelgeIdx = header.findIndex(h => h.toLowerCase().includes('r√¶kkef√∏lge') || h.toLowerCase().includes('raekkefoelge'));
    
    if (navnIdx === -1) {
      throw new Error('CSV filen mangler "Navn" kolonne');
    }
    
    const masterVarelager = [];
    const locations = new Set();
    
    // Parse data rows
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(';').map(v => v.trim());
      if (values.length === 0 || !values[navnIdx]) continue;
      
      const navn = values[navnIdx];
      const maaleenhed = maaleenhedIdx >= 0 ? values[maaleenhedIdx] : 'stk';
      const pris = prisIdx >= 0 ? parseFloat(values[prisIdx].replace(',', '.')) || 0 : 0;
      const placering = placeringIdx >= 0 ? values[placeringIdx] : '';
      const reolNr = reolIdx >= 0 ? values[reolIdx] : '';
      const hylleNr = hylleIdx >= 0 ? values[hylleIdx] : '';
      const raekkefoelge = raekkefoelgeIdx >= 0 ? parseInt(values[raekkefoelgeIdx]) || 0 : 0;
      
      if (placering) locations.add(placering);
      
      // Generate ID from name (simple hash)
      const id = navn.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '') + '_' + Date.now() + '_' + i;
      
      masterVarelager.push({
        id: id,
        navn: navn,
        maaleenhed: maaleenhed,
        pris: pris,
        placering: placering,
        reolNr: reolNr || undefined,
        hylleNr: hylleNr || undefined,
        raekkefoelge: raekkefoelge || undefined
      });
    }
    
    return {
      masterVarelager: masterVarelager,
      lagerLokationer: Array.from(locations).filter(l => l)
    };
  } catch(err) {
    throw new Error('Fejl ved parsing af CSV: ' + err.message);
  }
}

// Import varelager from JSON or CSV file
function importVarelager(){
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,.csv';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const fileContent = e.target.result;
        const fileName = file.name.toLowerCase();
        
        let importedData = null;
        
        // Check if CSV file
        if (fileName.endsWith('.csv')) {
          importedData = parseCSVToVarelager(fileContent);
        } else {
          // Try JSON
          importedData = JSON.parse(fileContent);
        }
        
        if (!importedData || !importedData.masterVarelager || !Array.isArray(importedData.masterVarelager)) {
          alert('‚ùå Filen indeholder ikke varelager data i korrekt format.\n\nForventet format:\n‚Ä¢ JSON: {masterVarelager: [...], lagerLokationer: [...]}\n‚Ä¢ CSV: Navn;M√•leenhed;Pris;Placering;Reol;Hylle;R√¶kkef√∏lge');
          return;
        }
        
        // Load existing data or create new
        const storageKey = 'k√∏kkenlager_data';
        let existingData = {};
        const existingStr = localStorage.getItem(storageKey);
        if (existingStr) {
          try {
            existingData = JSON.parse(existingStr);
          } catch(err) {
            console.warn('Could not parse existing data:', err);
          }
        }
        
        // Merge imported varelager with existing data
        existingData.masterVarelager = importedData.masterVarelager;
        if (importedData.lagerLokationer) {
          existingData.lagerLokationer = importedData.lagerLokationer;
        }
        
        // Sync installation ID from main program - ALWAYS update to match
        if (importedData.mainInstallationId) {
          existingData.mainInstallationId = importedData.mainInstallationId;
          // Extract numeric part from main ID (e.g., "INST-123456" -> "123456")
          const mainIdNum = importedData.mainInstallationId.replace(/[^0-9]/g, '');
          // Create matching scanner ID
          const newScannerId = 'SCANNER-' + mainIdNum;
          existingData.scannerInstallationId = newScannerId;
          existingData.installationId = newScannerId;
          console.log('‚úÖ ID synkroniseret fra hovedprogram:', {
            main: importedData.mainInstallationId,
            scanner: newScannerId
          });
        }
        
        // Save merged data
        localStorage.setItem(storageKey, JSON.stringify(existingData));
        
        // Reload items
        allItems = importedData.masterVarelager;
        
        const locationInfo = importedData.lagerLokationer && importedData.lagerLokationer.length > 0 
          ? '\nüìç Placeringer: ' + importedData.lagerLokationer.join(', ')
          : '';
        
        alert('‚úÖ Varelager importeret!\n\n' + allItems.length + ' varer er nu tilg√¶ngelige.' + locationInfo);
        updateStatus('‚úÖ Varelager importeret: ' + allItems.length + ' varer' + locationInfo, 'success');
        
        if (importedData.lagerLokationer && Array.isArray(importedData.lagerLokationer)) {
          console.log('Imported locations:', importedData.lagerLokationer);
        }
        
        console.log('Imported varelager:', allItems.length, 'items');
      } catch(err) {
        alert('‚ùå Fejl ved import: ' + err.message);
        console.error('Import error:', err);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

async function stopScanner(){
  scannerActive = false;
  const status = document.getElementById('status');
  const video = document.getElementById('scannerVideo');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  
  if(html5QrCode){
    try {
      if(html5QrCode.isScanning){
        await html5QrCode.stop();
      }
      html5QrCode.clear();
    } catch(err){
      console.warn('Fejl ved stop:', err);
    }
    html5QrCode = null;
  }
  
  video.style.display = 'none';
  startBtn.style.display = 'block';
  stopBtn.style.display = 'none';
  updateStatus('Scanner stoppet', 'waiting');
}

function finishSession(){
  const items = Object.values(scannedItems);
  if(items.length === 0){
    updateStatus('‚ö†Ô∏è Ingen varer scannet. Tilf√∏j varer f√∏r du afslutter.', 'error');
    return;
  }
  
  if(scannerActive){
    stopScanner();
  }
  
  try {
    // Filter items by selected location if a location was selected
    let filteredItems = items;
    if (selectedLocation && selectedLocation !== '') {
      filteredItems = items.filter(item => {
        const itemLocation = item.vare?.placering || '';
        return itemLocation === selectedLocation;
      });
      
      if (filteredItems.length === 0) {
        alert('‚ö†Ô∏è Ingen varer fundet for den valgte lokation.\n\nTjek at du har scannet varer fra den korrekte lokation.');
        return;
      }
    }
    
    // Get session counter from main app
    const storageKey = 'k√∏kkenlager_data';
    let data = {};
    const existingData = localStorage.getItem(storageKey);
    if (existingData) {
      try {
        data = JSON.parse(existingData);
      } catch (e) {
        console.error('Error parsing existing data:', e);
        data = {};
      }
    }
    
    // Get current sessionCounter and increment
    let currentSessionCounter = data.sessionCounter || 0;
    currentSessionCounter++;
    const sessionCounter = currentSessionCounter;
    
    // Create ONE report with all items
    const details = [];
    let grandTotal = 0;
    
    // Process all items and track locations
    const allLocations = new Set();
    
    filteredItems.forEach(item => {
      const v = item.vare;
      const antal = Number(item.count) || 0;
      if (antal <= 0) return; // Skip items with zero count
      
      // Ensure all required fields are present
      const pris = Number(v.pris) || 0;
      const linjetotal = antal * pris; // Calculate line total: price * quantity
      grandTotal += linjetotal;
      
      const placering = v.placering || 'Ikke angivet';
      allLocations.add(placering);
      
      // Create detail item with ALL required fields
      const detailItem = {
        vareId: v.id || item.vare?.id || 'ukendt',
        navn: v.navn || 'Ukendt vare',
        maaleenhed: v.maaleenhed || 'stk',
        pris: pris, // Price per unit
        antal: antal, // Quantity scanned
        linjetotal: linjetotal, // Calculated: pris * antal
        placering: placering,
        reolNr: v.reolNr || null, // Always include, even if null
        hylleNr: v.hylleNr || null // Always include, even if null
      };
      
      details.push(detailItem);
      
      // Debug log to verify data
      console.log('Detail item created:', {
        navn: detailItem.navn,
        reolNr: detailItem.reolNr,
        hylleNr: detailItem.hylleNr,
        antal: detailItem.antal,
        pris: detailItem.pris,
        linjetotal: detailItem.linjetotal
      });
    });
    
    // Generate unique report name: OPTA-000004 format
    const reportName = `OPTA-${String(sessionCounter).padStart(6, '0')}`;
    
    // Determine scope based on selected location or actual locations found
    let scope = '';
    if (selectedLocation && selectedLocation !== '') {
      scope = selectedLocation; // Use selected location
    } else if (allLocations.size === 1) {
      scope = Array.from(allLocations)[0]; // Single location found
    } else if (allLocations.size > 1) {
      scope = 'Alle lokationer'; // Multiple locations
    } else {
      scope = 'Ikke angivet';
    }
    
    // Create ONE report with all items
    const report = {
      ts: Date.now(),
      handling: reportName,
      type: 'session',
      scope: scope,
      details: details,
      total: grandTotal
    };
    
    const reports = [report]; // Only one report
    
    // Preserve ALL existing data
    if (!data.reports || !Array.isArray(data.reports)) {
      data.reports = [];
    }
    
    // Check if report already exists (by name and timestamp)
    const reportExists = data.reports.some(r => 
      r.handling === report.handling && 
      Math.abs(r.ts - report.ts) < 1000
    );
    
    if (!reportExists) {
      // Add report to beginning of reports array
      data.reports.unshift(report);
      console.log('‚úÖ New report added:', report.handling, 'with', details.length, 'items');
    } else {
      console.log('‚ö†Ô∏è Report already exists:', report.handling);
    }
    
    // Update sessionCounter
    data.sessionCounter = sessionCounter;
    
    // Clear active session
    data.activeSession = null;
    
    // Add/update metadata
    data.version = data.version || '1.0';
    data.savedAt = Date.now();
    
    // Add unique installation ID for tracking
    // ALWAYS try to sync with main program first, otherwise generate new
    const mainInstallationId = data.mainInstallationId || null;
    if (mainInstallationId && mainInstallationId.startsWith('INST-')) {
      // Use main program's ID as base - extract numeric part and create matching scanner ID
      const mainIdNum = mainInstallationId.replace(/[^0-9]/g, '');
      const newScannerId = 'SCANNER-' + mainIdNum;
      // Always update to ensure they match
      data.installationId = newScannerId;
      data.scannerInstallationId = newScannerId;
      console.log('‚úÖ Synced scanner ID with main program:', {
        main: mainInstallationId,
        scanner: newScannerId
      });
    } else if (!data.installationId || !data.installationId.startsWith('SCANNER-')) {
      // Generate unique ID if main program ID not available
      data.installationId = 'SCANNER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      data.scannerInstallationId = data.installationId;
      console.log('‚ö†Ô∏è Generated new scanner ID (main program ID not found):', data.installationId);
    }
    
    // Add report metadata
    report.source = 'stregkode-scanner';
    report.installationId = data.installationId;
    
    // Save all data to localStorage
    const savedData = JSON.stringify(data);
    try {
      localStorage.setItem(storageKey, savedData);
      localStorage.removeItem('activeSession');
      
      // Verify save was successful
      const verifyData = localStorage.getItem(storageKey);
      if (!verifyData) {
        throw new Error('Kunne ikke gemme data i localStorage');
      }
      
      console.log('‚úÖ Data saved and verified. Report:', reportName, 'Items:', details.length);
    } catch(saveErr) {
      console.error('Save error:', saveErr);
      alert('‚ö†Ô∏è Fejl ved gemning af rapport!\n\n' + saveErr.message + '\n\nPr√∏v at genindl√¶se siden og pr√∏v igen.');
      throw saveErr;
    }
    
    const totalItems = filteredItems.reduce((sum, item) => sum + item.count, 0);
    const uniqueItems = filteredItems.length;
    const locationsCount = allLocations.size;
    
    const locationInfo = selectedLocation && selectedLocation !== '' 
      ? ` for lokation: ${selectedLocation}` 
      : ` i ${locationsCount} lokation(er)`;
    
    updateStatus(`‚úÖ Rapport oprettet! ${reportName} - ${uniqueItems} unikke varer, ${totalItems} total antal${locationInfo}`, 'success');
    
    console.log('‚úÖ Report saved successfully:', reportName, 'with', details.length, 'items, total:', grandTotal);
    
    // Clear scanned items and reset location
    scannedItems = {};
    selectedLocation = ''; // Reset location for next session
    updateStats();
    renderList();
    
    // Check if running on same domain as main program
    const currentDomain = window.location.hostname;
    const isSameDomain = currentDomain && !currentDomain.includes('github.io') && currentDomain !== '';
    
    let exportInfo = '';
    if (isSameDomain) {
      exportInfo = `\n\n‚úÖ Rapporterne er automatisk synkroniseret med hovedprogrammet!\n\nüí° Tip: G√• til hovedprogrammet og klik "üîÑ Synkroniser Rapporter" for at opdatere listen.`;
    } else {
      exportInfo = `\n\nüí° Tip: For at f√• rapporterne ind i hovedprogrammet:\n\n1. Klik "üì§ Eksport rapporter" knappen nedenfor\n2. I hovedprogrammet: "Ops√¶tning" ‚Üí "Import data" ‚Üí "üì∑ Importer Scanner Data"\n3. V√¶lg den downloadede fil\n\nEller brug "üîÑ Synkroniser Rapporter" i hovedprogrammet hvis begge k√∏rer p√• samme enhed.`;
    }
    
    // Verify report was saved
    const verifyData = localStorage.getItem(storageKey);
    let saveStatus = '';
    if (verifyData) {
      try {
        const verify = JSON.parse(verifyData);
        const found = verify.reports && verify.reports.some(r => r.handling === reportName);
        if (found) {
          saveStatus = '\n\n‚úÖ Rapport gemt og verificeret!';
        } else {
          saveStatus = '\n\n‚ö†Ô∏è Rapport gemt, men verificering fejlede.';
        }
      } catch(e) {
        saveStatus = '\n\n‚ö†Ô∏è Kunne ikke verificere gemning.';
      }
    }
    
    const locationText = selectedLocation && selectedLocation !== '' 
      ? `üìç Lokation: ${selectedLocation}` 
      : `üìç ${locationsCount} lokation(er)`;
    
    alert(`‚úÖ Opt√¶lling afsluttet!\n\nüìã Rapport: ${reportName}\nüìä ${uniqueItems} unikke varer, ${totalItems} total antal\n${locationText}\nüí∞ Total v√¶rdi: ${grandTotal.toFixed(2)} kr.${saveStatus}${exportInfo}`);
    
  } catch(err){
    console.error('Fejl ved oprettelse af rapport:', err);
    updateStatus('Fejl ved oprettelse af rapport: ' + err.message, 'error');
  }
}

// Upload reports to server (GitHub Gist)
async function uploadReportsToServer(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    
    if (!dataStr) {
      alert('‚ö†Ô∏è Ingen data fundet at uploade.');
      return;
    }
    
    const data = JSON.parse(dataStr);
    
    if (!data.reports || !Array.isArray(data.reports) || data.reports.length === 0) {
      alert('‚ö†Ô∏è Ingen rapporter at uploade.\n\nAfslut en opt√¶lling f√∏rst.');
      return;
    }
    
    // Filter only scanner reports
    const scannerReports = data.reports.filter(r => 
      r.handling && (r.handling.startsWith('OPTA-') || r.handling.startsWith('Stregkode scanner'))
    );
    
    if (scannerReports.length === 0) {
      alert('‚ö†Ô∏è Ingen scanner rapporter at uploade.\n\nAfslut en opt√¶lling f√∏rst.');
      return;
    }
    
    // Get GitHub token from localStorage or prompt
    let githubToken = localStorage.getItem('github_gist_token');
    
    if (!githubToken) {
      const token = prompt('üîë Indtast GitHub Personal Access Token:\n\n' +
        '1. G√• til: https://github.com/settings/tokens\n' +
        '2. Klik "Generate new token (classic)"\n' +
        '3. V√¶lg "gist" scope\n' +
        '4. Kopi√©r token og indtast her\n\n' +
        'üí° Token gemmes lokalt og bruges til fremtidige uploads.\n' +
        'üí° Du kan slette token i indstillinger hvis n√∏dvendigt.');
      
      if (!token || !token.trim()) {
        alert('‚ùå Ingen token indtastet. Upload annulleret.');
        return;
      }
      
      githubToken = token.trim();
      localStorage.setItem('github_gist_token', githubToken);
    }
    
    // Create export data
    const exportData = {
      reports: scannerReports,
      sessionCounter: data.sessionCounter || 0,
      exportedAt: Date.now(),
      version: '1.0',
      source: 'stregkode-scanner',
      installationId: data.installationId || 'SCANNER-UNKNOWN'
    };
    
    // Show loading
    updateStatus('Uploader rapporter til server...', 'scanning');
    
    // Upload to GitHub Gist
    const gistData = {
      description: `Scanner rapporter - ${scannerReports.length} rapport(er) - ${new Date().toLocaleString('da-DK')}`,
      public: false, // Private gist
      files: {
        [`scanner-reports-${Date.now()}.json`]: {
          content: JSON.stringify(exportData, null, 2)
        }
      }
    };
    
    const response = await fetch('https://api.github.com/gists', {
      method: 'POST',
      headers: {
        'Authorization': `token ${githubToken}`,
        'Content-Type': 'application/json',
        'Accept': 'application/vnd.github.v3+json'
      },
      body: JSON.stringify(gistData)
    });
    
    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.message || `HTTP ${response.status}: ${response.statusText}`);
    }
    
    const gist = await response.json();
    const gistUrl = gist.html_url;
    const gistId = gist.id;
    
    // Store gist ID for later retrieval
    if (!data.uploadedGists) data.uploadedGists = [];
    data.uploadedGists.push({
      id: gistId,
      url: gistUrl,
      uploadedAt: Date.now(),
      reportCount: scannerReports.length
    });
    localStorage.setItem(storageKey, JSON.stringify(data));
    
    const reportNames = scannerReports.map(r => r.handling || 'Ukendt').join(', ');
    
    updateStatus(`‚úÖ ${scannerReports.length} rapport(er) uploadet til server!`, 'success');
    
    alert(`‚úÖ Rapporter uploadet!\n\nüìã Rapporter: ${reportNames}\n\n` +
      `üîó Gist URL: ${gistUrl}\n\n` +
      `üí° I hovedprogrammet:\n` +
      `1. G√• til "Ops√¶tning" ‚Üí "Import data"\n` +
      `2. Klik "‚òÅÔ∏è Hent fra server"\n` +
      `3. Rapporterne hentes automatisk!\n\n` +
      `üîë Gist ID: ${gistId.substring(0, 20)}...`);
    
  } catch(err) {
    console.error('Fejl ved upload:', err);
    updateStatus('‚ùå Fejl ved upload: ' + err.message, 'error');
    
    if (err.message.includes('401') || err.message.includes('Bad credentials')) {
      // Invalid token - remove it
      localStorage.removeItem('github_gist_token');
      alert('‚ùå Ugyldig GitHub token.\n\nToken er blevet slettet. Pr√∏v igen og indtast en ny token.');
    } else {
      alert('‚ùå Fejl ved upload: ' + err.message + '\n\nTjek din internetforbindelse og pr√∏v igen.');
    }
  }
}

// Export reports for transfer to main program
function exportReports(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    
    if (!dataStr) {
      alert('‚ö†Ô∏è Ingen data fundet at eksportere.');
      return;
    }
    
    const data = JSON.parse(dataStr);
    
    if (!data.reports || !Array.isArray(data.reports) || data.reports.length === 0) {
      alert('‚ö†Ô∏è Ingen rapporter at eksportere.\n\nAfslut en opt√¶lling f√∏rst.');
      return;
    }
    
    // Filter only scanner reports (reports created by this app - OPTA- format)
    const scannerReports = data.reports.filter(r => 
      r.handling && (r.handling.startsWith('OPTA-') || r.handling.startsWith('Stregkode scanner'))
    );
    
    if (scannerReports.length === 0) {
      alert('‚ö†Ô∏è Ingen scanner rapporter at eksportere.\n\nAfslut en opt√¶lling f√∏rst.');
      return;
    }
    
    // Get or create installation ID
    if (!data.installationId) {
      data.installationId = 'SCANNER-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      // Save installation ID
      localStorage.setItem(storageKey, JSON.stringify(data));
    }
    const installationId = data.installationId;
    
    // Create export data
    const exportData = {
      reports: scannerReports,
      sessionCounter: data.sessionCounter || 0,
      exportedAt: Date.now(),
      version: '1.0',
      source: 'stregkode-scanner',
      installationId: installationId
    };
    
    // Create download
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `scanner-rapporter-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    const reportNames = scannerReports.map(r => r.handling || 'Ukendt').join(', ');
    alert(`‚úÖ ${scannerReports.length} rapport(er) eksporteret!\n\nüìã Rapporter: ${reportNames}\nüì• Filen er downloadet.\n\nüí° I hovedprogrammet:\n1. G√• til "Ops√¶tning" ‚Üí "Import data"\n2. Klik "üì∑ Importer Scanner Data"\n3. V√¶lg den downloadede fil\n4. Rapporterne importeres automatisk!\n\nüîó Installation ID: ${installationId.substring(0, 20)}...`);
    
  } catch(err) {
    console.error('Fejl ved eksport:', err);
    alert('‚ùå Fejl ved eksport: ' + err.message);
  }
}

// showInstallationId function removed - not needed

/* Fetch varelager from server (GitHub Gist) */
async function fetchVarelagerFromServer(){
  try {
    // Get GitHub token from localStorage or prompt
    let githubToken = localStorage.getItem('github_gist_token');
    
    if (!githubToken) {
      const token = prompt('üîë Indtast GitHub Personal Access Token:\n\n' +
        '1. G√• til: https://github.com/settings/tokens\n' +
        '2. Klik "Generate new token (classic)"\n' +
        '3. V√¶lg "gist" scope\n' +
        '4. Kopi√©r token og indtast her\n\n' +
        'üí° Token gemmes lokalt og bruges til fremtidige downloads.\n' +
        'üí° Du kan slette token i indstillinger hvis n√∏dvendigt.');
      
      if (!token || !token.trim()) {
        alert('‚ùå Ingen token indtastet. Hentning annulleret.');
        return;
      }
      
      githubToken = token.trim();
      localStorage.setItem('github_gist_token', githubToken);
    }
    
    // Show loading
    updateStatus('Henter varelager fra server...', 'waiting');
    
    // Fetch all user's gists
    const response = await fetch('https://api.github.com/gists', {
      headers: {
        'Authorization': `token ${githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!response.ok) {
      if (response.status === 401) {
        localStorage.removeItem('github_gist_token');
        throw new Error('Ugyldig GitHub token. Token er blevet slettet. Pr√∏v igen og indtast en ny token.');
      }
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const gists = await response.json();
    
    // Filter for varelager gists (description contains "Varelager skabelon")
    const varelagerGists = gists.filter(gist => 
      gist.description && gist.description.includes('Varelager skabelon')
    );
    
    if (varelagerGists.length === 0) {
      updateStatus('‚ö†Ô∏è Ingen varelager skabeloner fundet p√• serveren.', 'error');
      alert('‚ö†Ô∏è Ingen varelager skabeloner fundet i dine gists.\n\nUpload varelager fra hovedprogrammet f√∏rst:\n\n1. G√• til "Varelager administration" ‚Üí "S√∏g & Se hele Varelager"\n2. Klik "‚òÅÔ∏è Upload Varelager til Server"');
      return;
    }
    
    // Sort by date (newest first)
    varelagerGists.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    // If multiple, let user choose, otherwise use the newest
    let selectedGist = varelagerGists[0];
    
    if (varelagerGists.length > 1) {
      const gistList = varelagerGists.map((gist, idx) => {
        const date = new Date(gist.created_at).toLocaleString('da-DK');
        const files = Object.keys(gist.files || {});
        const fileCount = files.length;
        return `${idx + 1}. ${date} (${fileCount} fil(er))`;
      }).join('\n');
      
      const choice = prompt(`üìã Fundet ${varelagerGists.length} varelager skabelon(er):\n\n${gistList}\n\nIndtast nummer (1-${varelagerGists.length}) for at v√¶lge, eller tryk OK for at bruge den nyeste:`);
      
      if (choice && choice.trim()) {
        const num = parseInt(choice.trim());
        if (num >= 1 && num <= varelagerGists.length) {
          selectedGist = varelagerGists[num - 1];
        }
      }
    }
    
    // Fetch the selected gist content
    const gistResponse = await fetch(`https://api.github.com/gists/${selectedGist.id}`, {
      headers: {
        'Authorization': `token ${githubToken}`,
        'Accept': 'application/vnd.github.v3+json'
      }
    });
    
    if (!gistResponse.ok) {
      throw new Error(`HTTP ${gistResponse.status}: ${gistResponse.statusText}`);
    }
    
    const gistDetails = await gistResponse.json();
    
    // Get the first file content
    const files = Object.values(gistDetails.files || {});
    if (files.length === 0) {
      throw new Error('Ingen filer fundet i gist');
    }
    
    const fileContent = files[0].content;
    const importedData = JSON.parse(fileContent);
    
    if (!importedData || !importedData.masterVarelager || !Array.isArray(importedData.masterVarelager)) {
      throw new Error('Filen indeholder ikke varelager data i korrekt format.');
    }
    
    // Load existing data or create new
    const storageKey = 'k√∏kkenlager_data';
    let existingData = {};
    const existingStr = localStorage.getItem(storageKey);
    if (existingStr) {
      try {
        existingData = JSON.parse(existingStr);
      } catch(err) {
        console.warn('Could not parse existing data:', err);
      }
    }
    
    // Merge imported varelager with existing data
    existingData.masterVarelager = importedData.masterVarelager;
    if (importedData.lagerLokationer) {
      existingData.lagerLokationer = importedData.lagerLokationer;
    }
    
    // Sync installation ID from main program - ALWAYS update to match
    if (importedData.mainInstallationId) {
      existingData.mainInstallationId = importedData.mainInstallationId;
      const mainIdNum = importedData.mainInstallationId.replace(/[^0-9]/g, '');
      const newScannerId = 'SCANNER-' + mainIdNum;
      existingData.scannerInstallationId = newScannerId;
      existingData.installationId = newScannerId;
      console.log('‚úÖ ID synkroniseret fra hovedprogram:', {
        main: importedData.mainInstallationId,
        scanner: newScannerId
      });
    }
    
    // Save merged data
    localStorage.setItem(storageKey, JSON.stringify(existingData));
    
    // Reload items
    allItems = importedData.masterVarelager;
    availableLocations = importedData.lagerLokationer || [];
    if (availableLocations.length === 0 && allItems.length > 0) {
      const uniqueLocs = [...new Set(allItems.map(item => item.placering).filter(p => p))];
      availableLocations = uniqueLocs;
    }
    
    const locationInfo = availableLocations.length > 0 
      ? '\nüìç Placeringer: ' + availableLocations.join(', ')
      : '';
    
    updateStatus(`‚úÖ Varelager hentet fra server! ${allItems.length} varer${locationInfo}`, 'success');
    
    alert(`‚úÖ Varelager hentet fra server!\n\n` +
      `üì¶ ${allItems.length} varer er nu tilg√¶ngelige.${locationInfo}\n\n` +
      `üí° Du kan nu starte opt√¶lling!`);
    
    console.log('Varelager fetched from server:', allItems.length, 'items');
    
  } catch(err) {
    console.error('Fejl ved hentning:', err);
    updateStatus('‚ùå Fejl ved hentning: ' + err.message, 'error');
    
    if (err.message.includes('401') || err.message.includes('Bad credentials') || err.message.includes('Ugyldig')) {
      localStorage.removeItem('github_gist_token');
      alert('‚ùå ' + err.message);
    } else if (err.message.includes('404')) {
      alert('‚ùå Gist ikke fundet.\n\nTjek at Gist ID er korrekt.');
    } else {
      alert('‚ùå Fejl ved hentning: ' + err.message + '\n\nTjek din internetforbindelse og pr√∏v igen.');
    }
  }
}

// Wait for DOM and library to load
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM loaded, initializing scanner...');
  
  // Check if Html5Qrcode library is loaded
  if (typeof Html5Qrcode === 'undefined') {
    console.warn('Html5Qrcode library not loaded yet, waiting...');
    // Wait a bit for library to load
    setTimeout(function() {
      if (typeof Html5Qrcode === 'undefined') {
        updateStatus('‚ö†Ô∏è Scanner bibliotek ikke indl√¶st. Genindl√¶s siden.', 'error');
        console.error('Html5Qrcode library still not loaded after timeout');
      } else {
        console.log('Html5Qrcode library loaded successfully');
        initializeApp();
      }
    }, 1000);
  } else {
    console.log('Html5Qrcode library already loaded');
    initializeApp();
  }
});

function initializeApp() {
  console.log('Initializing app...');
  
  if(loadItemsFromMainApp()){
    updateStatus('Klar til scanning - Klik "Start Scanner"', 'waiting');
    console.log('App initialized successfully');
  } else {
    updateStatus('‚ö†Ô∏è Ingen varelager data fundet. Opret varer i hovedprogrammet f√∏rst.', 'error');
    console.warn('No varelager data found');
  }
}

// Also try to initialize immediately (in case DOM is already loaded)
if (document.readyState === 'loading') {
  // DOM is still loading, wait for DOMContentLoaded
  console.log('DOM still loading, waiting for DOMContentLoaded...');
} else {
  // DOM is already loaded
  console.log('DOM already loaded, initializing immediately...');
  if (typeof Html5Qrcode === 'undefined') {
    setTimeout(function() {
      if (typeof Html5Qrcode !== 'undefined') {
        initializeApp();
      }
    }, 500);
  } else {
    initializeApp();
  }
}
</script>
</body>
</html>

