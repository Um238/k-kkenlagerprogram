<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta name="theme-color" content="#0078D4" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Stregkode Scanner" />
<link rel="manifest" href="stregkode-scanner-manifest.json" />
<title>Stregkode Scanner</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f5f5f5;
  color: #333;
  padding: 10px;
}

.container {
  max-width: 600px;
  margin: 0 auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  overflow: hidden;
}

.header {
  background: linear-gradient(135deg, #0078D4 0%, #005A9E 100%);
  color: white;
  padding: 20px;
  text-align: center;
}

.header h1 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 5px;
}

.session-info {
  background: #E3F2FD;
  padding: 15px 20px;
  border-bottom: 2px solid #0078D4;
}

.session-info.active {
  background: #FFF3CD;
  border-bottom-color: #FFC107;
}

.session-name {
  font-weight: 600;
  font-size: 16px;
  color: #0078D4;
}

.session-info.active .session-name {
  color: #856404;
}

.session-location {
  font-size: 14px;
  color: #666;
  margin-top: 5px;
}

.scanner-section {
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
}

#scannerVideo {
  width: 100%;
  max-height: 400px;
  background: #000;
  border-radius: 8px;
  display: none;
}

.scanner-controls {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.btn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  flex: 1;
  min-width: 120px;
}

.btn-primary {
  background: #0078D4;
  color: white;
}

.btn-primary:active {
  background: #005A9E;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-success {
  background: #28a745;
  color: white;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.status-message {
  padding: 15px 20px;
  margin: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  display: none;
}

.status-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.status-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.status-info {
  background: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

.scanned-items {
  padding: 20px;
  border-top: 2px solid #e0e0e0;
  max-height: 400px;
  overflow-y: auto;
}

.scanned-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f9f9f9;
  border-radius: 8px;
  margin-bottom: 10px;
  border-left: 4px solid #0078D4;
}

.scanned-item-info {
  flex: 1;
}

.scanned-item-name {
  font-weight: 600;
  font-size: 16px;
  color: #333;
  margin-bottom: 4px;
}

.scanned-item-details {
  font-size: 13px;
  color: #666;
}

.scanned-item-count {
  font-size: 24px;
  font-weight: 700;
  color: #0078D4;
  min-width: 60px;
  text-align: center;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 10px;
}

.footer-actions {
  padding: 20px;
  background: #f9f9f9;
  border-top: 1px solid #e0e0e0;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.stats {
  padding: 15px 20px;
  background: #E3F2FD;
  border-bottom: 1px solid #0078D4;
  display: flex;
  justify-content: space-around;
  text-align: center;
}

.stat-item {
  flex: 1;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  color: #0078D4;
}

.stat-label {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.location-section {
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
}

.location-select {
  width: 100%;
  padding: 15px;
  font-size: 16px;
  border: 2px solid #ddd;
  border-radius: 8px;
  outline: none;
  margin-bottom: 10px;
}

.location-select:focus {
  border-color: #0078D4;
}

.manual-input-section {
  padding: 20px;
  border-top: 1px solid #e0e0e0;
  background: #f9f9f9;
}

.manual-input {
  width: 100%;
  padding: 15px;
  font-size: 16px;
  border: 2px solid #ddd;
  border-radius: 8px;
  outline: none;
  margin-bottom: 10px;
}

.manual-input:focus {
  border-color: #0078D4;
}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì∑ Stregkode Scanner</h1>
      <div style="font-size:14px; opacity:0.9;">Scan stregkoder og opt√¶l varer</div>
    </div>

    <div id="sessionInfo" class="session-info">
      <div class="session-name" id="sessionName">Ingen aktiv opt√¶lling</div>
      <div class="session-location" id="sessionLocation">V√¶lg lokation for at starte</div>
    </div>

    <div id="locationSection" class="location-section">
      <label style="display:block; margin-bottom:10px; font-weight:600;">üìç V√¶lg lokation:</label>
      <select id="locationSelect" class="location-select">
        <option value="">V√¶lg lokation...</option>
      </select>
      <button class="btn btn-primary" onclick="startSession()" style="width:100%;">‚ñ∂Ô∏è Start opt√¶lling</button>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div id="scannerSection" class="scanner-section" style="display:none;">
      <video id="scannerVideo" autoplay playsinline></video>
      <div class="scanner-controls">
        <button id="startScannerBtn" class="btn btn-primary" onclick="startScanner()">üì∑ Start scanner</button>
        <button id="stopScannerBtn" class="btn btn-secondary" onclick="stopScanner()" style="display:none;">‚èπÔ∏è Stop scanner</button>
        <button id="manualInputBtn" class="btn btn-secondary" onclick="toggleManualInput()">‚úèÔ∏è Indtast manuelt</button>
      </div>
      
      <div id="manualInputSection" class="manual-input-section" style="display:none;">
        <input 
          type="text" 
          id="manualBarcodeInput" 
          class="manual-input" 
          placeholder="Indtast stregkode..."
          onkeypress="if(event.key==='Enter') handleManualBarcode()"
        />
        <button class="btn btn-primary" onclick="handleManualBarcode()" style="width:100%;">Tilf√∏j stregkode</button>
      </div>
    </div>

    <div id="stats" class="stats" style="display:none;">
      <div class="stat-item">
        <div class="stat-value" id="totalScanned">0</div>
        <div class="stat-label">Total scannet</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="uniqueItems">0</div>
        <div class="stat-label">Unikke varer</div>
      </div>
    </div>

    <div id="scannedItems" class="scanned-items" style="display:none;">
      <div id="scannedItemsList"></div>
    </div>

    <div id="footerActions" class="footer-actions" style="display:none;">
      <button class="btn btn-success" onclick="finishSession()" style="flex:2;">‚úÖ Afslut opt√¶lling</button>
      <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Ryd alt</button>
    </div>
  </div>

  <!-- ZXing for barcode scanning -->
  <script src="https://unpkg.com/@zxing/library@0.19.1"></script>

  <script>
    // State
    let selectedLocation = '';
    let scannedItems = {}; // { barcode: { vare, count } }
    let scannerActive = false;
    let codeReader = null;
    let scannerStream = null;
    let allItems = []; // masterVarelager

    // Helper functions
    function $(id) {
      return document.getElementById(id);
    }

    function showStatus(message, type = 'info') {
      const statusEl = $('statusMessage');
      if (!statusEl) return;
      
      statusEl.textContent = message;
      statusEl.className = 'status-message status-' + type;
      statusEl.style.display = 'block';
      
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }

    // Load items from main app
    function loadItemsFromMainApp() {
      try {
        const storageKey = 'k√∏kkenlager_data';
        const dataStr = localStorage.getItem(storageKey);
        if (!dataStr) {
          showStatus('‚ö†Ô∏è Ingen varelager data fundet. Opret varer i hovedprogrammet f√∏rst.', 'error');
          return false;
        }
        
        const data = JSON.parse(dataStr);
        allItems = data.masterVarelager || [];
        
        if (allItems.length === 0) {
          showStatus('‚ö†Ô∏è Varelageret er tomt. Tilf√∏j varer i hovedprogrammet f√∏rst.', 'error');
          return false;
        }
        
        console.log('Indl√¶st ' + allItems.length + ' varer fra hovedprogrammet');
        return true;
      } catch (err) {
        console.error('Fejl ved indl√¶sning af varer:', err);
        showStatus('Fejl ved indl√¶sning af varer: ' + err.message, 'error');
        return false;
      }
    }

    // Load locations from main app
    function loadLocations() {
      try {
        const storageKey = 'k√∏kkenlager_data';
        const dataStr = localStorage.getItem(storageKey);
        if (!dataStr) return;
        
        const data = JSON.parse(dataStr);
        const locations = data.lagerLokationer || ['K√∏l', 'Frost', 'T√∏revare', 'Gr√∏nt'];
        
        const select = $('locationSelect');
        if (!select) return;
        
        select.innerHTML = '<option value="">V√¶lg lokation...</option>';
        locations.forEach(loc => {
          const option = document.createElement('option');
          option.value = loc;
          option.textContent = loc;
          select.appendChild(option);
        });
      } catch (err) {
        console.error('Fejl ved indl√¶sning af lokationer:', err);
      }
    }

    // Start session
    function startSession() {
      const location = $('locationSelect').value;
      if (!location) {
        showStatus('V√¶lg en lokation f√∏rst', 'error');
        return;
      }
      
      if (!loadItemsFromMainApp()) {
        return;
      }
      
      selectedLocation = location;
      
      // Update UI
      $('sessionInfo').classList.add('active');
      $('sessionName').textContent = 'Opt√¶lling i gang';
      $('sessionLocation').textContent = 'Lokation: ' + location;
      
      $('locationSection').style.display = 'none';
      $('scannerSection').style.display = 'block';
      $('stats').style.display = 'flex';
      $('scannedItems').style.display = 'block';
      $('footerActions').style.display = 'flex';
      
      updateStats();
      renderScannedItems();
    }

    // Start scanner
    async function startScanner() {
      if (scannerActive) {
        stopScanner();
        return;
      }
      
      if (typeof ZXing === 'undefined' || !ZXing.BrowserMultiFormatReader) {
        showStatus('Barcode scanner library ikke indl√¶st. Genindl√¶s siden og pr√∏v igen.', 'error');
        return;
      }
      
      const video = $('scannerVideo');
      if (!video) return;
      
      try {
        // Check for camera access
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showStatus('Kamera API ikke tilg√¶ngelig. Brug HTTPS eller localhost.', 'error');
          return;
        }
        
        // Get camera access
        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'environment', // Back camera on mobile
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        scannerStream = stream;
        video.srcObject = stream;
        video.style.display = 'block';
        scannerActive = true;
        
        // Wait for video to start
        await new Promise((resolve) => {
          const timeout = setTimeout(resolve, 2000);
          video.onloadedmetadata = () => {
            clearTimeout(timeout);
            video.play().then(resolve).catch(resolve);
          };
        });
        
        // Initialize ZXing
        const { BrowserMultiFormatReader } = ZXing;
        codeReader = new BrowserMultiFormatReader();
        
        // Update buttons
        $('startScannerBtn').style.display = 'none';
        $('stopScannerBtn').style.display = 'inline-block';
        
        // Start scanning
        codeReader.decodeFromVideoDevice(null, video, (result, err) => {
          if (result) {
            let code = null;
            if (typeof result === 'string') {
              code = result;
            } else if (result.text) {
              code = result.text;
            } else if (result.getText) {
              code = result.getText();
            } else {
              code = String(result);
            }
            
            if (code) {
              handleScannedBarcode(code);
            }
          }
          if (err) {
            // Ignore NotFoundException - it's normal
            const isNormalError = err.name === 'NotFoundException' || 
                                 err.name === 'NotFoundError' || 
                                 (err.message && err.message.includes('not found'));
            if (!isNormalError) {
              console.error('Scan fejl:', err);
            }
          }
        });
        
        showStatus('Scanner aktiv - Peg p√• stregkoden', 'info');
      } catch (err) {
        console.error('Fejl ved start af scanner:', err);
        showStatus('Fejl ved start af scanner: ' + err.message, 'error');
        scannerActive = false;
      }
    }

    // Stop scanner
    function stopScanner() {
      if (codeReader) {
        try {
          codeReader.reset();
        } catch (e) {
          console.warn('Fejl ved reset af scanner:', e);
        }
        codeReader = null;
      }
      
      if (scannerStream) {
        scannerStream.getTracks().forEach(track => track.stop());
        scannerStream = null;
      }
      
      const video = $('scannerVideo');
      if (video) {
        video.srcObject = null;
        video.style.display = 'none';
      }
      
      scannerActive = false;
      $('startScannerBtn').style.display = 'inline-block';
      $('stopScannerBtn').style.display = 'none';
      showStatus('Scanner stoppet', 'info');
    }

    // Toggle manual input
    function toggleManualInput() {
      const section = $('manualInputSection');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        $('manualBarcodeInput').focus();
      } else {
        section.style.display = 'none';
        $('manualBarcodeInput').value = '';
      }
    }

    // Handle manual barcode input
    function handleManualBarcode() {
      const input = $('manualBarcodeInput');
      const barcode = input.value.trim();
      if (!barcode) return;
      
      handleScannedBarcode(barcode);
      input.value = '';
    }

    // Handle scanned barcode
    function handleScannedBarcode(barcode) {
      // Find item by barcode (id)
      const item = allItems.find(v => v.id === barcode);
      
      if (!item) {
        showStatus('‚ö†Ô∏è Vare ikke fundet: ' + barcode, 'error');
        return;
      }
      
      // Add to scanned items
      if (!scannedItems[barcode]) {
        scannedItems[barcode] = {
          vare: item,
          count: 0
        };
      }
      
      scannedItems[barcode].count++;
      
      // Visual feedback
      showStatus('‚úÖ ' + item.navn + ' tilf√∏jet', 'success');
      
      // Update UI
      updateStats();
      renderScannedItems();
      
      // Vibrate if available
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    // Update stats
    function updateStats() {
      const total = Object.values(scannedItems).reduce((sum, item) => sum + item.count, 0);
      const unique = Object.keys(scannedItems).length;
      
      $('totalScanned').textContent = total;
      $('uniqueItems').textContent = unique;
    }

    // Render scanned items
    function renderScannedItems() {
      const container = $('scannedItemsList');
      if (!container) return;
      
      const items = Object.values(scannedItems);
      
      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div>Ingen varer scannet endnu</div></div>';
        return;
      }
      
      container.innerHTML = items.map(item => {
        const v = item.vare;
        return `
          <div class="scanned-item">
            <div class="scanned-item-info">
              <div class="scanned-item-name">${v.navn}</div>
              <div class="scanned-item-details">
                ${v.maaleenhed || 'stk'} ‚Ä¢ ${v.placering || 'Ingen placering'}
                ${v.reolNr ? ' ‚Ä¢ Reol ' + v.reolNr : ''}
                ${v.hylleNr ? ' ‚Ä¢ Hylle ' + v.hylleNr : ''}
              </div>
            </div>
            <div class="scanned-item-count">${item.count}</div>
          </div>
        `;
      }).join('');
    }

    // Clear all
    function clearAll() {
      if (!confirm('Er du sikker p√• at du vil rydde alle scannede varer?')) {
        return;
      }
      
      scannedItems = {};
      updateStats();
      renderScannedItems();
      showStatus('Alle varer ryddet', 'success');
    }

    // Finish session
    function finishSession() {
      if (!selectedLocation) {
        showStatus('V√¶lg en lokation f√∏rst', 'error');
        return;
      }
      
      const items = Object.values(scannedItems);
      if (items.length === 0) {
        showStatus('‚ö†Ô∏è Ingen varer scannet. Tilf√∏j varer f√∏r du afslutter.', 'error');
        return;
      }
      
      // Stop scanner if active
      if (scannerActive) {
        stopScanner();
      }
      
      try {
        // Prepare data in same format as manuel-optaelling
        const manualData = {
          location: selectedLocation,
          items: items.map(item => ({
            id: item.vare.id,
            navn: item.vare.navn,
            maaleenhed: item.vare.maaleenhed || 'stk',
            quantity: item.count
          }))
        };
        
        // Save to localStorage (same key as manuel-optaelling uses)
        localStorage.setItem('manuelOptaelData', JSON.stringify(manualData));
        
        showStatus('‚úÖ Opt√¶lling gemt! Du kan nu importere den i hovedprogrammet.', 'success');
        
        // Reset after 3 seconds
        setTimeout(() => {
          if (confirm('Opt√¶lling gemt! Vil du starte en ny opt√¶lling?')) {
            location.reload();
          }
        }, 3000);
        
      } catch (err) {
        console.error('Fejl ved afslutning:', err);
        showStatus('Fejl ved afslutning: ' + err.message, 'error');
      }
    }

    // Initialize
    function init() {
      loadLocations();
      loadItemsFromMainApp();
    }

    // Start when page loads
    init();
  </script>
</body>
</html>

