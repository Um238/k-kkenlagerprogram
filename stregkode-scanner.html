<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<meta name="theme-color" content="#4CAF50" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Stregkode Scanner" />
<link rel="manifest" href="stregkode-scanner-manifest.json" />
<title>Stregkode Scanner - Telefon</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f5f5f5;padding:10px;max-width:600px;margin:0 auto}
.header{background:#4CAF50;color:#fff;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center}
.header h1{font-size:20px;margin-bottom:5px}
.header p{font-size:13px;opacity:0.9}
.scanner-container{background:#fff;border-radius:8px;padding:15px;margin-bottom:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
#scannerVideo{width:100%;max-height:60vh;border:3px solid #4CAF50;border-radius:8px;background:#000;display:none;position:relative}
.status{padding:10px;margin:10px 0;border-radius:6px;text-align:center;font-weight:700;min-height:50px;display:flex;align-items:center;justify-content:center}
.status.waiting{background:#fff3cd;color:#856404}
.status.scanning{background:#d4edda;color:#155724}
.status.success{background:#d1ecf1;color:#0c5460}
.status.error{background:#f8d7da;color:#721c24;white-space:pre-line}
.button{width:100%;padding:15px;margin:8px 0;border:none;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer;background:#4CAF50;color:#fff}
.button:active{opacity:0.8}
.button.secondary{background:#6c757d}
.button.danger{background:#dc3545}
.scanned-list{background:#fff;border-radius:8px;padding:15px;margin-top:15px;box-shadow:0 2px 4px rgba(0,0,0,0.1);max-height:40vh;overflow-y:auto}
.scanned-item{padding:10px;margin:5px 0;background:#f8f9fa;border-radius:6px;border-left:4px solid #4CAF50;display:flex;justify-content:space-between;align-items:center}
.scanned-item .info{flex:1}
.scanned-item .name{font-weight:700;font-size:16px;color:#333}
.scanned-item .details{font-size:12px;color:#666;margin-top:3px}
.scanned-item .count{font-size:20px;font-weight:700;color:#4CAF50;margin-left:10px;min-width:40px;text-align:center}
.scanned-item .remove{background:#dc3545;color:#fff;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;font-size:12px;margin-left:5px}
.actions{display:flex;gap:10px;margin-top:15px}
.actions .button{flex:1}
.empty{text-align:center;padding:20px;color:#999}
.stats{display:flex;gap:15px;margin:15px 0;padding:15px;background:#f8f9fa;border-radius:8px}
.stat{text-align:center;flex:1}
.stat-value{font-size:24px;font-weight:700;color:#4CAF50}
.stat-label{font-size:12px;color:#666;margin-top:5px}
</style>
</head>
<body>
<div class="header">
  <h1>üì± Stregkode Scanner</h1>
  <p>Scan stregkoder med din telefon - V 2.5</p>
</div>

<div class="scanner-container">
  <div id="status" class="status waiting">Klik "Start Scanner" for at begynde</div>
  <div id="scannerVideo"></div>
  <button id="startBtn" class="button" onclick="startScanner()">üì∑ Start Scanner</button>
  <button id="stopBtn" class="button secondary" onclick="stopScanner()" style="display:none">‚èπ Stop Scanner</button>
</div>

<div class="stats" id="stats" style="display:none">
  <div class="stat">
    <div class="stat-value" id="totalScanned">0</div>
    <div class="stat-label">Total scannet</div>
  </div>
  <div class="stat">
    <div class="stat-value" id="uniqueItems">0</div>
    <div class="stat-label">Unikke varer</div>
  </div>
</div>

<div class="scanned-list">
  <h3 style="margin-bottom:10px">Scannede varer (<span id="count">0</span>)</h3>
  <div id="scannedList">
    <div class="empty">Ingen varer scannet endnu</div>
  </div>
  <div class="actions">
    <button class="button secondary" onclick="clearAll()">üóë Ryd alt</button>
    <button class="button" onclick="finishSession()">‚úÖ Afslut opt√¶lling</button>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
let scannerActive = false;
let html5QrCode = null;
let scannedItems = {};
let allItems = [];
let lastScannedCode = null;
let lastScanTime = 0;
const SCAN_COOLDOWN = 1000;

// Load items from main app
function loadItemsFromMainApp(){
  try {
    const storageKey = 'k√∏kkenlager_data';
    const dataStr = localStorage.getItem(storageKey);
    if (!dataStr) {
      updateStatus('‚ö†Ô∏è Ingen varelager data fundet. Opret varer i hovedprogrammet f√∏rst.', 'error');
      return false;
    }
    
    const data = JSON.parse(dataStr);
    allItems = data.masterVarelager || [];
    
    if (allItems.length === 0) {
      updateStatus('‚ö†Ô∏è Varelageret er tomt. Tilf√∏j varer i hovedprogrammet f√∏rst.', 'error');
      return false;
    }
    
    console.log('Indl√¶st ' + allItems.length + ' varer fra hovedprogrammet');
    return true;
  } catch (err) {
    console.error('Fejl ved indl√¶sning af varer:', err);
    updateStatus('Fejl ved indl√¶sning af varer: ' + err.message, 'error');
    return false;
  }
}

function updateStatus(text, type){
  const status = document.getElementById('status');
  status.textContent = text;
  status.className = 'status ' + (type || 'waiting');
}

async function startScanner(){
  if(scannerActive){
    stopScanner();
    return;
  }
  
  if(!loadItemsFromMainApp()){
    return;
  }
  
  const status = document.getElementById('status');
  const video = document.getElementById('scannerVideo');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  
  const isSecure = window.location.protocol === 'https:' || 
                   window.location.hostname === 'localhost' || 
                   window.location.hostname === '127.0.0.1';
  
  if(!isSecure && window.location.protocol === 'file:'){
    updateStatus('‚ö†Ô∏è KAMERA KR√ÜVER WEBSERVER\n\nFilen skal hostes p√• en webserver for at kameraet virker.\n\nBrug webserveren fra hovedprogrammet eller GitHub Pages.', 'error');
    return;
  }
  
  if(typeof Html5Qrcode === 'undefined'){
    updateStatus('Scanner library ikke indl√¶st. Genindl√¶s siden og pr√∏v igen.', 'error');
    return;
  }
  
  updateStatus('Starter kamera...', 'waiting');
  
  try {
    // Stop existing scanning first if active
    if (html5QrCode && html5QrCode.isScanning) {
      try {
        await html5QrCode.stop();
        html5QrCode.clear();
      } catch (stopErr) {
        console.warn('Fejl ved stop af eksisterende scanning:', stopErr);
      }
    }
    
    video.style.display = 'block';
    scannerActive = true;
    
    html5QrCode = new Html5Qrcode("scannerVideo");
    
    const config = {
      fps: 10,
      qrbox: { width: 250, height: 250 },
      aspectRatio: 1.0
    };
    
    await html5QrCode.start(
      { facingMode: "environment" },
      config,
      (decodedText, decodedResult) => {
        console.log('‚úÖ Scannet stregkode/QR-kode:', decodedText);
        const now = Date.now();
        
        if (now - lastScanTime < SCAN_COOLDOWN && decodedText === lastScannedCode) {
          return;
        }
        
        lastScannedCode = decodedText;
        lastScanTime = now;
        
        handleScannedBarcode(decodedText);
      },
      (errorMessage) => {
        // Ignorer scanning fejl - de er normale n√•r der ikke er fundet noget
      }
    );
    
    updateStatus('Peger p√• stregkoden...', 'scanning');
    startBtn.style.display = 'none';
    stopBtn.style.display = 'block';
    document.getElementById('stats').style.display = 'flex';
    
  } catch(err){
    console.error('Kamera fejl:', err);
    scannerActive = false;
    let errorMsg = '';
    let instructions = '';
    if(err.name === 'NotAllowedError'){
      errorMsg = 'Kamera tilladelse n√¶gtet.';
      instructions = 'Giv tilladelse til kamera:\n1. Klik p√• kamera-ikonet i browserens adresselinje\n2. V√¶lg "Tillad" for kamera\n3. Genindl√¶s siden og pr√∏v igen';
    } else if(err.name === 'NotFoundError'){
      errorMsg = 'Ingen kamera fundet.';
      instructions = 'Tjek at dit kamera er tilsluttet og ikke bruges af andre programmer.';
    } else {
      errorMsg = 'Kunne ikke starte scanner: ' + (err.message || err.name);
      instructions = 'Pr√∏v:\n1. Genindl√¶s siden\n2. Tjek browser tilladelser for kamera\n3. S√∏rg for at filen hostes p√• en webserver';
    }
    updateStatus(errorMsg + '\n\n' + instructions, 'error');
    startBtn.style.display = 'block';
    stopBtn.style.display = 'none';
    video.style.display = 'none';
  }
}

function handleScannedBarcode(barcode){
  const item = allItems.find(v => v.id === barcode);
  
  if (!item) {
    updateStatus('‚ö†Ô∏è Vare ikke fundet: ' + barcode, 'error');
    setTimeout(() => {
      if(scannerActive){
        updateStatus('Peger p√• stregkoden...', 'scanning');
      }
    }, 2000);
    return;
  }
  
  if (!scannedItems[barcode]) {
    scannedItems[barcode] = {
      vare: item,
      count: 0
    };
  }
  
  scannedItems[barcode].count++;
  
  updateStatus('‚úÖ ' + item.navn + ' tilf√∏jet', 'success');
  
  updateStats();
  renderList();
  
  if (navigator.vibrate) {
    navigator.vibrate(50);
  }
  
  setTimeout(() => {
    if(scannerActive){
      updateStatus('Peger p√• stregkoden...', 'scanning');
    }
  }, 1000);
}

function updateStats(){
  const total = Object.values(scannedItems).reduce((sum, item) => sum + item.count, 0);
  const unique = Object.keys(scannedItems).length;
  
  document.getElementById('totalScanned').textContent = total;
  document.getElementById('uniqueItems').textContent = unique;
  document.getElementById('count').textContent = total;
}

function renderList(){
  const list = document.getElementById('scannedList');
  const items = Object.values(scannedItems);
  
  if(items.length === 0){
    list.innerHTML = '<div class="empty">Ingen varer scannet endnu</div>';
    return;
  }
  
  // Group by location
  const itemsByLocation = {};
  items.forEach(item => {
    const location = item.vare.placering || 'Ikke angivet';
    if (!itemsByLocation[location]) {
      itemsByLocation[location] = [];
    }
    itemsByLocation[location].push(item);
  });
  
  let html = '';
  Object.keys(itemsByLocation).sort().forEach(location => {
    html += `<div style="margin-bottom:15px; padding:10px; background:#f0f0f0; border-radius:6px;">`;
    html += `<div style="font-weight:700; font-size:14px; color:#4CAF50; margin-bottom:8px;">üìç ${location}</div>`;
    
    itemsByLocation[location].forEach((item, idx) => {
      const v = item.vare;
      const key = Object.keys(scannedItems).find(k => scannedItems[k] === item);
      html += `
        <div class="scanned-item">
          <div class="info">
            <div class="name">${v.navn}</div>
            <div class="details">${v.maaleenhed || 'stk'}${v.reolNr ? ' ‚Ä¢ Reol ' + v.reolNr : ''}${v.hylleNr ? ' ‚Ä¢ Hylle ' + v.hylleNr : ''}</div>
          </div>
          <div class="count">${item.count}</div>
          <button class="remove" onclick="removeItem('${key}')">Slet</button>
        </div>
      `;
    });
    
    html += `</div>`;
  });
  
  list.innerHTML = html;
}

function removeItem(key){
  delete scannedItems[key];
  updateStats();
  renderList();
}

function clearAll(){
  if(confirm('Er du sikker p√• at du vil slette alle scannede varer?')){
    scannedItems = {};
    updateStats();
    renderList();
    updateStatus('Alle varer ryddet', 'waiting');
  }
}

async function stopScanner(){
  scannerActive = false;
  const status = document.getElementById('status');
  const video = document.getElementById('scannerVideo');
  const startBtn = document.getElementById('startBtn');
  const stopBtn = document.getElementById('stopBtn');
  
  if(html5QrCode){
    try {
      if(html5QrCode.isScanning){
        await html5QrCode.stop();
      }
      html5QrCode.clear();
    } catch(err){
      console.warn('Fejl ved stop:', err);
    }
    html5QrCode = null;
  }
  
  video.style.display = 'none';
  startBtn.style.display = 'block';
  stopBtn.style.display = 'none';
  updateStatus('Scanner stoppet', 'waiting');
}

function finishSession(){
  const items = Object.values(scannedItems);
  if(items.length === 0){
    updateStatus('‚ö†Ô∏è Ingen varer scannet. Tilf√∏j varer f√∏r du afslutter.', 'error');
    return;
  }
  
  if(scannerActive){
    stopScanner();
  }
  
  try {
    // Group items by location
    const itemsByLocation = {};
    items.forEach(item => {
      const location = item.vare.placering || 'Ikke angivet';
      if (!itemsByLocation[location]) {
        itemsByLocation[location] = [];
      }
      itemsByLocation[location].push(item);
    });
    
    // Get session counter from main app
    const storageKey = 'k√∏kkenlager_data';
    let data = {};
    const existingData = localStorage.getItem(storageKey);
    if (existingData) {
      try {
        data = JSON.parse(existingData);
      } catch (e) {
        console.error('Error parsing existing data:', e);
        data = {};
      }
    }
    
    let sessionCounter = (data.sessionCounter || 0) + 1;
    
    // Create report for each location (grouped)
    const reports = [];
    Object.keys(itemsByLocation).sort().forEach(location => {
      const locationItems = itemsByLocation[location];
      const details = [];
      let grandTotal = 0;
      
      locationItems.forEach(item => {
        const v = item.vare;
        const antal = Number(item.count) || 0;
        const pris = Number(v.pris) || 0;
        const linjetotal = antal * pris;
        grandTotal += linjetotal;
        
        const detailItem = {
          vareId: v.id,
          navn: v.navn || 'Ukendt',
          maaleenhed: v.maaleenhed || 'stk',
          pris: pris,
          antal: antal,
          linjetotal: linjetotal,
          placering: location
        };
        
        if (v.reolNr) detailItem.reolNr = v.reolNr;
        if (v.hylleNr) detailItem.hylleNr = v.hylleNr;
        
        details.push(detailItem);
      });
      
      const report = {
        ts: Date.now(),
        handling: `Stregkode scanner - ${location}`,
        type: 'session',
        scope: location,
        details: details,
        total: grandTotal
      };
      
      reports.push(report);
    });
    
    // Preserve ALL existing data
    if (!data.reports || !Array.isArray(data.reports)) {
      data.reports = [];
    }
    
    // Add all reports to beginning of reports array
    reports.forEach(report => {
      const reportExists = data.reports.some(r => 
        r.handling === report.handling && 
        Math.abs(r.ts - report.ts) < 1000
      );
      
      if (!reportExists) {
        data.reports.unshift(report);
        console.log('‚úÖ New report added:', report.handling);
      }
    });
    
    // Update sessionCounter
    data.sessionCounter = sessionCounter;
    
    // Clear active session
    data.activeSession = null;
    
    // Add/update metadata
    data.version = data.version || '1.0';
    data.savedAt = Date.now();
    
    // Save all data to localStorage
    const savedData = JSON.stringify(data);
    localStorage.setItem(storageKey, savedData);
    localStorage.removeItem('activeSession');
    
    const totalItems = items.reduce((sum, item) => sum + item.count, 0);
    const locationsCount = Object.keys(itemsByLocation).length;
    
    updateStatus(`‚úÖ Rapport oprettet! ${totalItems} varer i ${locationsCount} lokation(er)`, 'success');
    
    console.log('‚úÖ Reports saved successfully:', reports.length);
    
    // Clear scanned items
    scannedItems = {};
    updateStats();
    renderList();
    
    alert(`‚úÖ Opt√¶lling afsluttet!\n\nüìä Total varer: ${totalItems}\nüìç Lokationer: ${locationsCount}\n\nRapporten er nu tilg√¶ngelig i hovedprogrammet under "Rapporter".`);
    
  } catch(err){
    console.error('Fejl ved oprettelse af rapport:', err);
    updateStatus('Fejl ved oprettelse af rapport: ' + err.message, 'error');
  }
}

// Initialize on load
if(loadItemsFromMainApp()){
  updateStatus('Klar til scanning - Klik "Start Scanner"', 'waiting');
} else {
  updateStatus('‚ö†Ô∏è Ingen varelager data fundet. Opret varer i hovedprogrammet f√∏rst.', 'error');
}
</script>
</body>
</html>
