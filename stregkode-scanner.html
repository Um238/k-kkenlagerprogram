<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta name="theme-color" content="#0078D4" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Stregkode Scanner" />
<link rel="manifest" href="stregkode-scanner-manifest.json" />
<title>Stregkode Scanner</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  background: #f5f5f5;
  color: #333;
  padding: 10px;
}

.container {
  max-width: 600px;
  margin: 0 auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  overflow: hidden;
}

.header {
  background: linear-gradient(135deg, #0078D4 0%, #005A9E 100%);
  color: white;
  padding: 20px;
  text-align: center;
}

.header h1 {
  font-size: 24px;
  font-weight: 600;
  margin-bottom: 5px;
}

.session-info {
  background: #E3F2FD;
  padding: 15px 20px;
  border-bottom: 2px solid #0078D4;
}

.session-info.active {
  background: #FFF3CD;
  border-bottom-color: #FFC107;
}

.session-name {
  font-weight: 600;
  font-size: 16px;
  color: #0078D4;
}

.session-info.active .session-name {
  color: #856404;
}

.session-location {
  font-size: 14px;
  color: #666;
  margin-top: 5px;
}

.scanner-section {
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
}

#scannerVideo {
  width: 100%;
  max-height: 400px;
  background: #000;
  border-radius: 8px;
  display: none;
}

.scanner-controls {
  display: flex;
  gap: 10px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.btn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  flex: 1;
  min-width: 120px;
}

.btn-primary {
  background: #0078D4;
  color: white;
}

.btn-primary:active {
  background: #005A9E;
}

.btn-secondary {
  background: #6c757d;
  color: white;
}

.btn-success {
  background: #28a745;
  color: white;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.status-message {
  padding: 15px 20px;
  margin: 10px 20px;
  border-radius: 8px;
  font-size: 14px;
  display: none;
}

.status-success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.status-error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.status-info {
  background: #d1ecf1;
  color: #0c5460;
  border: 1px solid #bee5eb;
}

.scanned-items {
  padding: 20px;
  border-top: 2px solid #e0e0e0;
  max-height: 400px;
  overflow-y: auto;
}

.scanned-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: #f9f9f9;
  border-radius: 8px;
  margin-bottom: 10px;
  border-left: 4px solid #0078D4;
}

.scanned-item-info {
  flex: 1;
}

.scanned-item-name {
  font-weight: 600;
  font-size: 16px;
  color: #333;
  margin-bottom: 4px;
}

.scanned-item-details {
  font-size: 13px;
  color: #666;
}

.scanned-item-count {
  font-size: 24px;
  font-weight: 700;
  color: #0078D4;
  min-width: 60px;
  text-align: center;
}

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: #999;
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 10px;
}

.footer-actions {
  padding: 20px;
  background: #f9f9f9;
  border-top: 1px solid #e0e0e0;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.stats {
  padding: 15px 20px;
  background: #E3F2FD;
  border-bottom: 1px solid #0078D4;
  display: flex;
  justify-content: space-around;
  text-align: center;
}

.stat-item {
  flex: 1;
}

.stat-value {
  font-size: 24px;
  font-weight: 700;
  color: #0078D4;
}

.stat-label {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.manual-input-section {
  padding: 20px;
  border-top: 1px solid #e0e0e0;
  background: #f9f9f9;
}

.manual-input {
  width: 100%;
  padding: 15px;
  font-size: 16px;
  border: 2px solid #ddd;
  border-radius: 8px;
  outline: none;
  margin-bottom: 10px;
}

.manual-input:focus {
  border-color: #0078D4;
}
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì∑ Stregkode Scanner <span style="color:#ff0000; font-weight:bold; font-size:28px;">V 2.0</span></h1>
      <div style="font-size:14px; opacity:0.9;">Scan stregkoder og opt√¶l varer</div>
    </div>

    <div id="sessionInfo" class="session-info active">
      <div class="session-name" id="sessionName">Stregkode Scanner</div>
      <div class="session-location" id="sessionLocation">Scan stregkoder - lokation findes automatisk</div>
    </div>

    <div id="installPrompt" style="display:none; padding:15px 20px; background:#E3F2FD; border-bottom:2px solid #0078D4; text-align:center;">
      <div style="font-size:14px; margin-bottom:10px; color:#0078D4; font-weight:600;">üì± Tilf√∏j til hjem-sk√¶rmen for nem adgang</div>
      <button id="installBtn" class="btn btn-primary" style="width:100%; max-width:300px; margin:0 auto;">‚ûï Tilf√∏j til hjem-sk√¶rm</button>
      <div id="installInstructions" style="display:none; margin-top:15px; padding:10px; background:white; border-radius:8px; font-size:12px; color:#666; text-align:left;">
        <strong>Android (Chrome):</strong><br>
        1. Tryk p√• ‚ãÆ menu (√∏verst til h√∏jre)<br>
        2. V√¶lg "Tilf√∏j til hjem-sk√¶rm" eller "Install√©r app"<br>
        3. Bekr√¶ft installation<br><br>
        <strong>iPhone (Safari):</strong><br>
        1. Tryk p√• del-knappen (nederst i midten)<br>
        2. Scroll ned og v√¶lg "Tilf√∏j til hjem-sk√¶rm"<br>
        3. Bekr√¶ft
      </div>
    </div>

    <div id="statusMessage" class="status-message"></div>

    <div id="scannerSection" class="scanner-section">
      <div id="scannerVideo" style="width: 100%; max-height: 400px; background: #000; border-radius: 8px;"></div>
      <div class="scanner-controls">
        <button id="startScannerBtn" class="btn btn-primary" onclick="startScanner()">üì∑ Start scanner</button>
        <button id="stopScannerBtn" class="btn btn-secondary" onclick="stopScanner()" style="display:none;">‚èπÔ∏è Stop scanner</button>
        <button id="manualInputBtn" class="btn btn-secondary" onclick="toggleManualInput()">‚úèÔ∏è Indtast manuelt</button>
        <button class="btn btn-secondary" onclick="testLibraries()" style="margin-top:10px; background:#6c757d;">üß™ Test Biblioteker</button>
        <div id="testResult" style="margin-top:10px; font-size:12px; color:#666; padding:10px; background:#f9f9f9; border-radius:6px; display:none;"></div>
      </div>
      
      <div id="manualInputSection" class="manual-input-section" style="display:none;">
        <input 
          type="text" 
          id="manualBarcodeInput" 
          class="manual-input" 
          placeholder="Indtast stregkode..."
          onkeypress="if(event.key==='Enter') handleManualBarcode()"
        />
        <button class="btn btn-primary" onclick="handleManualBarcode()" style="width:100%;">Tilf√∏j stregkode</button>
      </div>
    </div>

    <div id="stats" class="stats">
      <div class="stat-item">
        <div class="stat-value" id="totalScanned">0</div>
        <div class="stat-label">Total scannet</div>
      </div>
      <div class="stat-item">
        <div class="stat-value" id="uniqueItems">0</div>
        <div class="stat-label">Unikke varer</div>
      </div>
    </div>

    <div id="scannedItems" class="scanned-items">
      <div id="scannedItemsList"></div>
    </div>

    <div id="footerActions" class="footer-actions">
      <button class="btn btn-success" onclick="finishSession()" style="flex:2;">‚úÖ Afslut opt√¶lling</button>
      <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Ryd alt</button>
    </div>
  </div>

  <!-- Html5Qrcode - virker bedre p√• Android mobile -->
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

  <script>
    // State
    let scannedItems = {}; // { barcode: { vare, count } }
    let scannerActive = false;
    let html5QrCode = null;
    let allItems = []; // masterVarelager
    let lastScannedCode = null;
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 1500; // 1.5 sekunder mellem scans

    // Helper functions
    function $(id) {
      return document.getElementById(id);
    }

    function showStatus(message, type = 'info') {
      const statusEl = $('statusMessage');
      if (!statusEl) return;
      
      statusEl.textContent = message;
      statusEl.className = 'status-message status-' + type;
      statusEl.style.display = 'block';
      
      setTimeout(() => {
        statusEl.style.display = 'none';
      }, 3000);
    }

    // Load items from main app
    function loadItemsFromMainApp() {
      try {
        const storageKey = 'k√∏kkenlager_data';
        const dataStr = localStorage.getItem(storageKey);
        if (!dataStr) {
          showStatus('‚ö†Ô∏è Ingen varelager data fundet. Opret varer i hovedprogrammet f√∏rst.', 'error');
          return false;
        }
        
        const data = JSON.parse(dataStr);
        allItems = data.masterVarelager || [];
        
        if (allItems.length === 0) {
          showStatus('‚ö†Ô∏è Varelageret er tomt. Tilf√∏j varer i hovedprogrammet f√∏rst.', 'error');
          return false;
        }
        
        console.log('Indl√¶st ' + allItems.length + ' varer fra hovedprogrammet');
        return true;
      } catch (err) {
        console.error('Fejl ved indl√¶sning af varer:', err);
        showStatus('Fejl ved indl√¶sning af varer: ' + err.message, 'error');
        return false;
      }
    }

    // Initialize scanner - start immediately
    function initScanner() {
      if (!loadItemsFromMainApp()) {
        return;
      }
      
      // Update UI
      $('sessionName').textContent = 'Stregkode Scanner';
      $('sessionLocation').textContent = 'Klar til scanning - lokation findes automatisk';
      
      $('scannerSection').style.display = 'block';
      $('stats').style.display = 'flex';
      $('scannedItems').style.display = 'block';
      $('footerActions').style.display = 'flex';
      
      updateStats();
      renderScannedItems();
    }

    // Start scanner - using Html5Qrcode (works better on Android)
    async function startScanner() {
      // Stop existing scanning first if active
      if (html5QrCode && html5QrCode.isScanning) {
        try {
          await html5QrCode.stop();
          html5QrCode.clear();
        } catch (stopErr) {
          console.warn('Fejl ved stop af eksisterende scanning:', stopErr);
        }
      }
      
      try {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          showStatus('Kamera API ikke tilg√¶ngelig. Brug HTTPS eller localhost.', 'error');
          return;
        }
        
        if (typeof Html5Qrcode === 'undefined') {
          showStatus('Html5Qrcode bibliotek ikke indl√¶st. Genindl√¶s siden og pr√∏v igen.', 'error');
          return;
        }
        
        const video = $('scannerVideo');
        if (!video) return;
        
        showStatus('Starter kamera...', 'info');
        video.style.display = 'block';
        scannerActive = true;
        
        html5QrCode = new Html5Qrcode("scannerVideo");
        
        const config = {
          fps: 10,
          qrbox: { width: 250, height: 250 },
          aspectRatio: 1.0
          // Html5Qrcode scanner automatisk b√•de QR-koder og stregkoder (EAN, UPC, CODE_128, osv.)
        };
        
        try {
          await html5QrCode.start(
            { facingMode: "environment" }, // Brug bagkamera
            config,
            (decodedText, decodedResult) => {
              console.log('‚úÖ Scannet stregkode/QR-kode:', decodedText);
              const now = Date.now();
              
              // Undg√• duplikater
              if (now - lastScanTime < SCAN_COOLDOWN && decodedText === lastScannedCode) {
                return;
              }
              
              lastScannedCode = decodedText;
              lastScanTime = now;
              
              // Handle scanned barcode
              handleScannedBarcode(decodedText);
            },
            (errorMessage) => {
              // Ignorer scanning fejl - de er normale n√•r der ikke er fundet noget
            }
          );
          
          showStatus('Scanner aktiv - Peg p√• stregkoden', 'info');
          $('startScannerBtn').style.display = 'none';
          $('stopScannerBtn').style.display = 'inline-block';
          console.log('‚úÖ Scanning startet med Html5Qrcode');
          
        } catch (scanErr) {
          console.error('Fejl ved start af scanning:', scanErr);
          showStatus('Fejl ved start af scanning: ' + (scanErr.message || scanErr), 'error');
          scannerActive = false;
          video.style.display = 'none';
          $('startScannerBtn').style.display = 'inline-block';
          $('stopScannerBtn').style.display = 'none';
        }
        
      } catch (error) {
        console.error('Kamera fejl:', error);
        showStatus('Fejl: ' + error.message, 'error');
        scannerActive = false;
        $('scannerVideo').style.display = 'none';
        $('startScannerBtn').style.display = 'inline-block';
        $('stopScannerBtn').style.display = 'none';
      }
    }

    // Stop scanner
    async function stopScanner() {
      scannerActive = false;
      
      if (html5QrCode && html5QrCode.isScanning) {
        try {
          await html5QrCode.stop();
          html5QrCode.clear();
        } catch (e) {
          console.warn('Fejl ved stop af scanner:', e);
        }
        html5QrCode = null;
      }
      
      const video = $('scannerVideo');
      if (video) {
        video.style.display = 'none';
      }
      
      $('startScannerBtn').style.display = 'inline-block';
      $('stopScannerBtn').style.display = 'none';
      showStatus('Scanner stoppet', 'info');
    }

    // Toggle manual input
    function toggleManualInput() {
      const section = $('manualInputSection');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        $('manualBarcodeInput').focus();
      } else {
        section.style.display = 'none';
        $('manualBarcodeInput').value = '';
      }
    }

    // Handle manual barcode input
    function handleManualBarcode() {
      const input = $('manualBarcodeInput');
      const barcode = input.value.trim();
      if (!barcode) return;
      
      handleScannedBarcode(barcode);
      input.value = '';
    }

    // Handle scanned barcode
    function handleScannedBarcode(barcode) {
      // Find item by barcode (id)
      const item = allItems.find(v => v.id === barcode);
      
      if (!item) {
        showStatus('‚ö†Ô∏è Vare ikke fundet: ' + barcode, 'error');
        return;
      }
      
      // Add to scanned items
      if (!scannedItems[barcode]) {
        scannedItems[barcode] = {
          vare: item,
          count: 0
        };
      }
      
      scannedItems[barcode].count++;
      
      // Visual feedback
      showStatus('‚úÖ ' + item.navn + ' tilf√∏jet', 'success');
      
      // Update UI
      updateStats();
      renderScannedItems();
      
      // Vibrate if available
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    }

    // Update stats
    function updateStats() {
      const total = Object.values(scannedItems).reduce((sum, item) => sum + item.count, 0);
      const unique = Object.keys(scannedItems).length;
      
      $('totalScanned').textContent = total;
      $('uniqueItems').textContent = unique;
      
      // Update session location info
      const items = Object.values(scannedItems);
      if (items.length > 0) {
        const locations = [...new Set(items.map(item => item.vare.placering || 'Ikke angivet'))];
        const locationText = locations.length === 1 
          ? `Lokation: ${locations[0]}` 
          : `${locations.length} lokationer: ${locations.join(', ')}`;
        $('sessionLocation').textContent = locationText;
      } else {
        $('sessionLocation').textContent = 'Scan stregkoder - lokation findes automatisk';
      }
    }

    // Render scanned items - grouped by location
    function renderScannedItems() {
      const container = $('scannedItemsList');
      if (!container) return;
      
      const items = Object.values(scannedItems);
      
      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì¶</div><div>Ingen varer scannet endnu</div></div>';
        return;
      }
      
      // Group items by location
      const itemsByLocation = {};
      items.forEach(item => {
        const location = item.vare.placering || 'Ingen placering';
        if (!itemsByLocation[location]) {
          itemsByLocation[location] = [];
        }
        itemsByLocation[location].push(item);
      });
      
      // Render grouped
      let html = '';
      Object.keys(itemsByLocation).sort().forEach(location => {
        html += `<div style="margin-bottom:20px; padding:10px; background:#f0f0f0; border-radius:8px;">`;
        html += `<div style="font-weight:700; font-size:16px; color:#0078D4; margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid #0078D4;">üìç ${location}</div>`;
        
        itemsByLocation[location].forEach(item => {
          const v = item.vare;
          html += `
            <div class="scanned-item" style="margin-bottom:8px;">
              <div class="scanned-item-info">
                <div class="scanned-item-name">${v.navn}</div>
                <div class="scanned-item-details">
                  ${v.maaleenhed || 'stk'}
                  ${v.reolNr ? ' ‚Ä¢ Reol ' + v.reolNr : ''}
                  ${v.hylleNr ? ' ‚Ä¢ Hylle ' + v.hylleNr : ''}
                </div>
              </div>
              <div class="scanned-item-count">${item.count}</div>
            </div>
          `;
        });
        
        html += `</div>`;
      });
      
      container.innerHTML = html;
    }

    // Clear all
    function clearAll() {
      if (!confirm('Er du sikker p√• at du vil rydde alle scannede varer?')) {
        return;
      }
      
      scannedItems = {};
      updateStats();
      renderScannedItems();
      showStatus('Alle varer ryddet', 'success');
    }

    // Finish session - create report directly
    function finishSession() {
      const items = Object.values(scannedItems);
      if (items.length === 0) {
        showStatus('‚ö†Ô∏è Ingen varer scannet. Tilf√∏j varer f√∏r du afslutter.', 'error');
        return;
      }
      
      // Stop scanner if active
      if (scannerActive) {
        stopScanner();
      }
      
      try {
        // Group items by location
        const itemsByLocation = {};
        items.forEach(item => {
          const location = item.vare.placering || 'Ikke angivet';
          if (!itemsByLocation[location]) {
            itemsByLocation[location] = [];
          }
          itemsByLocation[location].push(item);
        });
        
        // Get session counter from main app
        const storageKey = 'k√∏kkenlager_data';
        let data = {};
        const existingData = localStorage.getItem(storageKey);
        if (existingData) {
          try {
            data = JSON.parse(existingData);
          } catch (e) {
            console.error('Error parsing existing data:', e);
            data = {};
          }
        }
        
        let sessionCounter = (data.sessionCounter || 0) + 1;
        
        // Create report for each location (grouped)
        const reports = [];
        Object.keys(itemsByLocation).sort().forEach(location => {
          const locationItems = itemsByLocation[location];
          const details = [];
          let grandTotal = 0;
          
          locationItems.forEach(item => {
            const v = item.vare;
            const antal = Number(item.count) || 0;
            const pris = Number(v.pris) || 0;
            const linjetotal = antal * pris;
            grandTotal += linjetotal;
            
            const detailItem = {
              vareId: v.id,
              navn: v.navn || 'Ukendt',
              maaleenhed: v.maaleenhed || 'stk',
              pris: pris,
              antal: antal,
              linjetotal: linjetotal,
              placering: location
            };
            
            // Add reol and hylle if available
            if (v.reolNr) detailItem.reolNr = v.reolNr;
            if (v.hylleNr) detailItem.hylleNr = v.hylleNr;
            
            details.push(detailItem);
          });
          
          // Create report (same format as main app)
          const report = {
            ts: Date.now(),
            handling: `Stregkode scanner - ${location}`,
            type: 'session',
            scope: location,
            details: details,
            total: grandTotal
          };
          
          reports.push(report);
        });
        
        // Preserve ALL existing data
        if (!data.reports || !Array.isArray(data.reports)) {
          data.reports = [];
        }
        
        // Add all reports to beginning of reports array
        reports.forEach(report => {
          // Check if report already exists
          const reportExists = data.reports.some(r => 
            r.handling === report.handling && 
            Math.abs(r.ts - report.ts) < 1000
          );
          
          if (!reportExists) {
            data.reports.unshift(report);
            console.log('‚úÖ New report added:', report.handling);
          }
        });
        
        // Update sessionCounter
        data.sessionCounter = sessionCounter;
        
        // Clear active session
        data.activeSession = null;
        
        // Add/update metadata
        data.version = data.version || '1.0';
        data.savedAt = Date.now();
        
        // Save all data to localStorage
        const savedData = JSON.stringify(data);
        localStorage.setItem(storageKey, savedData);
        localStorage.removeItem('activeSession');
        
        const totalItems = items.reduce((sum, item) => sum + item.count, 0);
        const locationsCount = Object.keys(itemsByLocation).length;
        
        showStatus(`‚úÖ Rapport oprettet! ${totalItems} varer i ${locationsCount} lokation(er)`, 'success');
        
        console.log('‚úÖ Reports saved successfully:', reports.length);
        console.log('Total reports in array:', data.reports.length);
        
        // Reset after 3 seconds
        setTimeout(() => {
          if (confirm(`Rapport oprettet!\n\n${totalItems} varer i ${locationsCount} lokation(er)\n\nVil du starte en ny opt√¶lling?`)) {
            scannedItems = {};
            updateStats();
            renderScannedItems();
            showStatus('Klar til ny opt√¶lling', 'info');
          }
        }, 3000);
        
      } catch (err) {
        console.error('Fejl ved afslutning:', err);
        showStatus('Fejl ved afslutning: ' + err.message, 'error');
      }
    }

    // Test libraries function
    function testLibraries() {
      const testResult = $('testResult');
      if (!testResult) return;
      
      let results = [];
      
      // Test Html5Qrcode
      if (typeof Html5Qrcode !== 'undefined') {
        results.push('‚úÖ Html5Qrcode bibliotek: OK');
      } else {
        results.push('‚ùå Html5Qrcode bibliotek: IKKE INDL√ÜST');
      }
      
      // Test kamera API
      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        results.push('‚úÖ Kamera API: Tilg√¶ngelig');
      } else {
        results.push('‚ùå Kamera API: Ikke tilg√¶ngelig (kr√¶ver HTTPS)');
      }
      
      // Test HTTPS
      const isSecure = window.location.protocol === 'https:' || 
                     window.location.hostname === 'localhost' || 
                     window.location.hostname === '127.0.0.1';
      if (isSecure) {
        results.push(`‚úÖ Sikkerhed: ${window.location.protocol}//${window.location.hostname}`);
      } else {
        results.push(`‚ö†Ô∏è Sikkerhed: ${window.location.protocol} (HTTPS anbefalet)`);
      }
      
      testResult.innerHTML = results.join('<br>');
      testResult.style.display = 'block';
    }

    // PWA Install prompt
    let deferredPrompt;
    const installPromptEl = $('installPrompt');
    const installBtn = $('installBtn');
    const installInstructions = $('installInstructions');

    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Stash the event so it can be triggered later
      deferredPrompt = e;
      // Show install button
      if (installPromptEl) {
        installPromptEl.style.display = 'block';
      }
    });

    if (installBtn) {
      installBtn.addEventListener('click', async () => {
        if (!deferredPrompt) {
          // Show manual instructions
          if (installInstructions) {
            installInstructions.style.display = 'block';
          }
          return;
        }
        
        // Show the install prompt
        deferredPrompt.prompt();
        
        // Wait for the user to respond to the prompt
        const { outcome } = await deferredPrompt.userChoice;
        
        console.log(`User response to install prompt: ${outcome}`);
        
        // Clear the deferredPrompt
        deferredPrompt = null;
        
        // Hide install button
        if (installPromptEl) {
          installPromptEl.style.display = 'none';
        }
      });
    }

    // Check if already installed
    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      if (installPromptEl) {
        installPromptEl.style.display = 'none';
      }
      showStatus('‚úÖ App installeret! Du kan nu √•bne den fra hjem-sk√¶rmen.', 'success');
    });

    // Show install instructions on iOS (Safari doesn't support beforeinstallprompt)
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || 
                        window.navigator.standalone || 
                        document.referrer.includes('android-app://');
    
    if (isIOS && !isStandalone && installPromptEl) {
      installPromptEl.style.display = 'block';
      if (installInstructions) {
        installInstructions.style.display = 'block';
      }
    }

    // Initialize
    function init() {
      initScanner();
      
      // Test libraries automatically after 2 seconds
      setTimeout(() => {
        testLibraries();
      }, 2000);
    }

    // Start when page loads
    init();
  </script>
</body>
</html>
